{% extends 'base.html' %}
{% load static %}

{% block title %}Conteúdo{% endblock %}

{% block extra_css %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
    
    .card-hover {
      transition: all 0.3s ease;
    }
    
    .card-hover:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.4);
    }
    
    .progress-bar {
      overflow: hidden;
      position: relative;
    }
    
    .progress-bar::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 45%;
      background: linear-gradient(90deg, #3B82F6 0%, #1E40AF 100%);
      border-radius: 9999px;
      animation: progressAnimation 1.5s ease-in-out;
    }
    
    @keyframes progressAnimation {
      0% { width: 0%; }
      100% { width: 45%; }
    }
    
    .module-card {
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .module-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.4);
    }
    
    .module-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, #3B82F6 0%, #1E40AF 100%);
    }
    
    .locked-module {
      position: relative;
    }
    
    .locked-module::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      background-image: url("{% static 'imagem/lock_100dp_2682EA_FILL0_wght400_GRAD0_opsz48.png' %}");
      background-repeat: no-repeat;
      background-position: center;
      background-size: 50px;
    }
    
    .floating-element {
      animation: float 6s ease-in-out infinite;
    }
    
    @keyframes float {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
      100% { transform: translateY(0px); }
    }
    
    .circular-chart {
      display: block;
      max-width: 100%;
      max-height: 100%;
    }
    
    .circle-bg {
      fill: none;
      stroke: #EFF6FF;
      stroke-width: 3.8;
    }
    
    .circle {
      fill: none;
      stroke-width: 2.8;
      stroke-linecap: round;
      stroke: #3B82F6;
      animation: progress 1.5s ease-out forwards;
    }
    
    @keyframes progress {
      0% { stroke-dasharray: 0 100; }
    }
    
    .percentage {
      fill: #1E40AF;
      font-size: 0.5em;
      text-anchor: middle;
      font-weight: bold;
    }

    /* Estilos para a descrição expansível */
    .descricao-container {
      position: relative;
    }
    
    .descricao-resumida {
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
    }
    
    .descricao-completa {
      display: none;
    }
    
    .descricao-expandir {
      color: #3B82F6;
      cursor: pointer;
      font-weight: 500;
      font-size: 0.8rem;
      display: inline-flex;
      align-items: center;
      margin-top: 4px;
    }
    
    .descricao-expandir:hover {
      color: #1E40AF;
      text-decoration: underline;
    }

    /* Adicione ao bloco extra_css */
    .pagination-current {
        background: linear-gradient(135deg, #3B82F6 0%, #1E40AF 100%);
        color: white;
    }

    .pagination-link {
        transition: all 0.3s ease;
    }

    .pagination-link:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Função para expandir/recolher a descrição
    function toggleDescricao(button) {
        const container = button.closest('.descricao-container');
        const resumida = container.querySelector('.descricao-resumida');
        const completa = container.querySelector('.descricao-completa');
        
        if (resumida.style.display === 'none') {
            // Recolher
            resumida.style.display = '-webkit-box';
            completa.style.display = 'none';
            button.textContent = 'Mostrar Mais';
        } else {
            // Expandir
            resumida.style.display = 'none';
            completa.style.display = 'block';
            button.textContent = 'Mostrar Menos';
        }
    }
    
    // Adicionar evento de clique a todos os botões de expandir
    document.querySelectorAll('.descricao-expandir').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            toggleDescricao(this);
        });
    });
    
    // Verificar se a descrição precisa ser truncada
    document.querySelectorAll('.descricao-container').forEach(container => {
        const resumida = container.querySelector('.descricao-resumida');
        const textoCompleto = container.querySelector('.descricao-completa').textContent;
        
        // Se o texto tiver mais de 15 palavras, mostra o botão de expandir
        const palavras = textoCompleto.trim().split(/\s+/).length;
        if (palavras > 15) {
            container.querySelector('.descricao-expandir').style.display = 'inline-flex';
        }
    });
});
</script>
{% endblock %}

{% block content %}
<!-- Cabeçalho com título e estatísticas -->
<div class="mb-8">
  <h1 class="text-3xl font-bold text-blue-700 mb-2">Trilha de Aprendizado</h1>
  <p class="text-blue-600">Domine Python através de uma jornada gamificada e divertida</p>
  
  <!-- Cartões de visão geral -->
  <div class="grid md:grid-cols-3 gap-6 mt-6">
    <div class="bg-blue-700 text-white rounded-2xl p-5 shadow-lg flex flex-col items-center">
      <img src="{% static 'imagem/check_circle_35dp_FFFFFF_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Concluídos" class="w-10 h-10 mb-2">
      <h3 class="font-bold text-lg">Capítulos Concluídos</h3>
      <p class="text-4xl font-extrabold mt-1">{{ total_concluidos }}</p>
    </div>
    
    <div class="bg-blue-700 text-white rounded-2xl p-5 shadow-lg flex flex-col items-center">
      <img src="{% static 'imagem/play_circle_35dp_FFFFFF_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Em Progresso" class="w-10 h-10 mb-2">
      <h3 class="font-bold text-lg">Em Progresso</h3>
      <p class="text-4xl font-extrabold mt-1">{{ total_em_progresso }}</p>
    </div>
    
    <div class="bg-blue-700 text-white rounded-2xl p-5 shadow-lg flex flex-col items-center">
      <img src="{% static 'imagem/lock_35dp_FFFFFF_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Bloqueados" class="w-10 h-10 mb-2">
      <h3 class="font-bold text-lg">Bloqueados</h3>
      <p class="text-4xl font-extrabold mt-1">{{ total_bloqueados }}</p>
    </div>
  </div>
</div>

<!-- Dica -->
<div class="bg-gradient-to-r from-blue-100 to-blue-50 border-l-4 border-blue-500 text-blue-700 text-sm rounded-r-xl p-4 mb-8 shadow flex items-start">
  <img src="{% static 'imagem/lightbulb_2_100dp_2682EA_FILL0_wght400_GRAD0_opsz48.png' %}" alt="Dica" class="w-6 h-6 mr-3 flex-shrink-0">
  <p>Complete os capítulos em ordem para uma melhor experiência de aprendizado e desbloqueie conquistas especiais!</p>
</div>

<!-- Grid de capítulos -->
<div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
  {% for cap_stat in capitulos_com_stats %}
  
  {% if cap_stat.bloqueado %}
  <!-- Capítulo Bloqueado -->
  <div class="module-card locked-module bg-white border border-blue-300 rounded-2xl shadow p-5 relative">
    <div class="flex items-center justify-between mb-3">
      <span class="text-xs bg-blue-100 text-blue-600 font-bold px-3 py-1 rounded-full">
        {% if cap_stat.dificuldade == 'beginner' %}Iniciante
        {% elif cap_stat.dificuldade == 'intermediate' %}Intermediário
        {% else %}Avançado{% endif %}
      </span>
    </div>
    
    <div class="flex justify-center mb-4">
      <img src="{% static 'imagem/code_blocks_100dp_2682EA_FILL0_wght400_GRAD0_opsz48.png' %}" alt="{{ cap_stat.capitulo.titulo }}" class="w-16 h-16 opacity-100">
    </div>
    
    <h3 class="font-bold text-lg text-blue-700 mb-2 opacity-50">{{ cap_stat.capitulo.titulo }}</h3>
    
    <div class="descricao-container">
      <p class="text-sm text-blue-600 mb-1 opacity-50 descricao-resumida">{{ cap_stat.capitulo.descricao|truncatewords:15 }}</p>
      <p class="text-sm text-blue-600 mb-1 opacity-50 descricao-completa">{{ cap_stat.capitulo.descricao }}</p>
      <span class="descricao-expandir" style="display: none;">...</span>
    </div>

    <div class="mt-6 text-center">
      <span class="text-xs bg-blue-200 text-blue-700 font-medium px-3 py-1 rounded-full">Complete o capítulo anterior para desbloquear</span>
    </div>
  </div>

  {% else %}
  <!-- Capítulo Disponível -->
  <a href="{% url 'modulos' %}?capitulo={{ cap_stat.capitulo.id }}" class="module-card bg-gradient-to-b from-white to-blue-50 border border-blue-200 rounded-2xl shadow p-5 relative block">
    <div class="flex items-center justify-between mb-3">
      <span class="text-xs {% if cap_stat.dificuldade == 'beginner' %}bg-green-100 text-green-600
                      {% elif cap_stat.dificuldade == 'intermediate' %}bg-yellow-100 text-yellow-600
                      {% else %}bg-red-100 text-red-600{% endif %} font-bold px-3 py-1 rounded-full">
          {% if cap_stat.dificuldade == 'beginner' %}Iniciante
          {% elif cap_stat.dificuldade == 'intermediate' %}Intermediário
          {% else %}Avançado{% endif %}
      </span>
      <div class="w-10 h-10">
        <svg viewBox="0 0 36 36" class="circular-chart">
          <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
          <path class="circle" stroke-dasharray="{{ cap_stat.progresso_percentual }}, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
          <text x="18" y="20.35" class="percentage">{{ cap_stat.progresso_percentual }}%</text>
        </svg>
      </div>
    </div>
    
    <div class="flex justify-center mb-4">
      <img src="{% static 'imagem/code_blocks_100dp_2682EA_FILL0_wght400_GRAD0_opsz48.png' %}" alt="{{ cap_stat.capitulo.titulo }}" class="w-16 h-16 floating-element">
    </div>
    
    <h3 class="font-bold text-lg text-blue-800 mb-2">{{ cap_stat.capitulo.titulo }}</h3>
    
    <div class="descricao-container">
      <p class="text-sm text-blue-600 mb-1 descricao-resumida">{{ cap_stat.capitulo.descricao|truncatewords:15 }}</p>
      <p class="text-sm text-blue-600 mb-1 descricao-completa">{{ cap_stat.capitulo.descricao }}</p>
      <span class="descricao-expandir" style="display: none;">Mostrar Mais</span>
    </div>

    <!-- Barra de progresso -->
    <div class="mt-4">
      <div class="w-full bg-blue-200 rounded-full h-2">
        <div class="bg-gradient-to-r from-blue-500 to-blue-700 h-2 rounded-full" style="width: {{ cap_stat.progresso_percentual }}%"></div>
      </div>
      <p class="text-xs text-blue-500 mt-2">{{ cap_stat.modulos_concluidos }}/{{ cap_stat.total_modulos }} módulos</p>
    </div>
    
    <div class="absolute bottom-3 right-3">
      <img src="{% static 'imagem/arrow_forward_35dp_2682EA_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Abrir" class="w-5 h-5 opacity-0 transition-opacity group-hover:opacity-100">
    </div>
  </a>
  {% endif %}
  
  {% empty %}
  <!-- Mensagem quando não há capítulos -->
  <div class="col-span-3 text-center py-12">
    <img src="{% static 'imagem/code_blocks_100dp_2682EA_FILL0_wght400_GRAD0_opsz48.png' %}" alt="Sem conteúdo" class="w-24 h-24 mx-auto mb-4 opacity-50">
    <h3 class="text-xl font-bold text-blue-700 mb-2">Nenhum capítulo disponível</h3>
    <p class="text-blue-600 mb-4">Os capítulos ainda não foram configurados.</p>
    {% if user.groups.filter.name == 'professores' or user.is_staff %}
    <a href="{% url 'criar_conteudo' %}" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
      Criar Primeiro Capítulo
    </a>
    {% endif %}
  </div>
  {% endfor %}
</div>
<!-- PAGINAÇÃO - ESTILO TAREFAS -->
{% if is_paginated %}
<div class="mt-8 flex justify-between items-center border-t border-blue-200 pt-4">
    <div class="text-sm text-blue-600">
        Mostrando {{ page_obj.end_index }} de {{ page_obj.paginator.count }} capítulos
    </div>
    
    <div class="flex items-center gap-4">
        {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}" class="bg-blue-100 text-blue-600 px-4 py-2 rounded-lg hover:bg-blue-200 transition flex items-center">
              ←
            </a>
        {% endif %}
        
        <span class="text-blue-600 font-medium">
            Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
        </span>
        
        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}" class="bg-blue-100 text-blue-600 px-4 py-2 rounded-lg hover:bg-blue-200 transition flex items-center">
              →
            </a>
        {% endif %}
    </div>
</div>
{% endif %}
{% endblock %}