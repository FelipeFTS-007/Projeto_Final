{% extends "base.html" %}
{% load static %}

{% block title %}Criar Conte√∫do - PyQuest{% endblock %}

{% block extra_css %}
<style>
    /* TODO O SEU CSS EXISTENTE PERMANECE IGUAL */
    .card-hover {
        transition: all 0.3s ease;
    }
    
    .card-hover:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.4);
    }
    
    .module-card {
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .module-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: linear-gradient(90deg, #3B82F6 0%, #1E40AF 100%);
    }
    
    .floating-element {
        animation: float 6s ease-in-out infinite;
    }
    
    @keyframes float {
        0% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
        100% { transform: translateY(0px); }
    }
    
    .interactive-card {
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .interactive-card:hover {
        transform: translateY(-3px) scale(1.02);
        box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.3);
    }
    
    .fade-in {
        animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .form-section {
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .form-section-header {
        background: linear-gradient(135deg, #3B82F6 0%, #1E40AF 100%);
        color: white;
        padding: 1rem 1.5rem;
        margin: -1.5rem -1.5rem 1.5rem -1.5rem;
        border-radius: 12px 12px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .question-item {
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }
    
    .question-item:hover {
        border-color: #3B82F6;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
    }
    
    .drag-handle {
        cursor: move;
        color: #64748b;
        transition: color 0.3s ease;
    }
    
    .drag-handle:hover {
        color: #3B82F6;
    }
    
    .option-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
        padding: 0.5rem;
        border-radius: 4px;
        transition: background-color 0.2s ease;
    }

    .option-item:hover {
        background-color: #f8fafc;
    }

    .option-input {
        flex: 1;
        padding: 0.5rem;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        color: #374151;
        background-color: white;
    }

    .option-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .correct-option {
        background-color: #f0f9ff !important;
        border-left: 4px solid #3b82f6;
        padding-left: 8px;
    }

    .empty-state {
        text-align: center;
        padding: 3rem 2rem;
        color: #64748b;
    }
    
    .empty-state img {
        opacity: 0.5;
        margin-bottom: 1rem;
    }
    
    .step-indicator {
        display: flex;
        justify-content: center;
        margin-bottom: 2rem;
    }
    
    .step {
        display: flex;
        align-items: center;
        color: #64748b;
        font-weight: 500;
    }
    
    .step.active {
        color: #3B82F6;
        font-weight: 600;
    }
    
    .step-number {
        width: 2rem;
        height: 2rem;
        border-radius: 50%;
        background: #e2e8f0;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 0.5rem;
        font-weight: 600;
    }
    
    .step.active .step-number {
        background: #3B82F6;
        color: white;
    }
    
    .step-connector {
        width: 4rem;
        height: 2px;
        background: #e2e8f0;
        margin: 0 1rem;
    }
    
    .step.active ~ .step-connector {
        background: #3B82F6;
    }
    
    .content-preview {
        background: #f8fafc;
        border: 2px dashed #cbd5e1;
        border-radius: 8px;
        padding: 1.5rem;
        min-height: 200px;
    }
    
    .question-preview {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 30px;
    }
    
    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    
    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #cbd5e1;
        transition: .4s;
        border-radius: 34px;
    }
    
    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 22px;
        width: 22px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }
    
    input:checked + .toggle-slider {
        background-color: #3B82F6;
    }
    
    input:checked + .toggle-slider:before {
        transform: translateX(30px);
    }
    
    .step.completed {
        color: #10B981;
    }
    
    .step.completed .step-number {
        background: #10B981;
        color: white;
    }
    
    .question-item.dragging {
        opacity: 0.5;
        transform: rotate(5deg);
    }
    
    .question-item.drag-over {
        border: 2px dashed #3B82F6;
    }
    
    .validation-error {
        color: #EF4444;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }
    
    .form-control.error {
        border-color: #EF4444;
    }
    
    .progress-bar {
        height: 6px;
        background: #E5E7EB;
        border-radius: 3px;
        margin: 1rem 0;
        overflow: hidden;
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #3B82F6 0%, #1E40AF 100%);
        width: 25%;
        transition: width 0.5s ease;
    }
    
    .save-indicator {
        position: fixed;
        top: 1rem;
        right: 1rem;
        background: #10B981;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        display: none;
        align-items: center;
        gap: 0.5rem;
        z-index: 1000;
    }
    
    .question-counter {
        background: #3B82F6;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.875rem;
        font-weight: 600;
    }
    
    .auto-save-toggle {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        color: #64748B;
    }

    /* Estilos para o Modal */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }
    
    .modal-overlay.active {
        opacity: 1;
        visibility: visible;
    }
    
    .modal-content {
        background: white;
        border-radius: 12px;
        padding: 0;
        width: 90%;
        max-width: 500px;
        transform: translateY(-20px);
        transition: transform 0.3s ease;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    .modal-overlay.active .modal-content {
        transform: translateY(0);
    }
    
    .modal-header {
        background: linear-gradient(135deg, #3B82F6 0%, #1E40AF 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 12px 12px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .modal-header h3 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
    }
    
    .modal-close {
        background: none;
        border: none;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background-color 0.3s ease;
    }
    
    .modal-close:hover {
        background: rgba(255, 255, 255, 0.2);
    }
    
    .modal-body {
        padding: 1.5rem;
    }
    
    .modal-footer {
        padding: 1rem 1.5rem 1.5rem;
        display: flex;
        gap: 0.75rem;
        justify-content: flex-end;
        border-top: 1px solid #e2e8f0;
    }

    /* Estilos para o editor estilo Google Docs */
    .editor-container {
        border: 1px solid #dadce0;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .editor-toolbar {
        background: #f8f9fa;
        border-bottom: 1px solid #dadce0;
        padding: 8px 12px;
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        align-items: center;
    }
    
    .toolbar-group {
        display: flex;
        align-items: center;
        gap: 2px;
        padding: 0 8px;
        border-right: 1px solid #e0e0e0;
    }
    
    .toolbar-group:last-child {
        border-right: none;
    }
    
    .toolbar-button {
        background: transparent;
        border: none;
        border-radius: 4px;
        padding: 6px 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #5f6368;
        transition: all 0.2s ease;
        min-width: 32px;
        height: 32px;
    }
    
    .toolbar-button:hover {
        background: #f1f3f4;
        color: #1a73e8;
    }
    
    .toolbar-button.active {
        background: #e8f0fe;
        color: #1a73e8;
    }
    
    .toolbar-select {
        border: 1px solid #dadce0;
        border-radius: 4px;
        padding: 4px 8px;
        background: white;
        color: #3c4043;
        font-size: 13px;
        cursor: pointer;
        height: 32px;
    }
    
    .toolbar-select:focus {
        outline: none;
        border-color: #1a73e8;
    }
    
    .editor-content {
        background: white;
        min-height: 400px;
        padding: 20px;
        line-height: 1.6;
        font-family: 'Arial', sans-serif;
        font-size: 14px;
        color: #202124;
        outline: none;
        overflow-y: auto;
        max-height: 600px;
    }
    
    .editor-content:focus {
        outline: none;
    }
    
    .editor-content h1, .editor-content h2, .editor-content h3 {
        margin: 12px 0;
        color: #202124;
        font-weight: 400;
    }
    
    .editor-content h1 {
        font-size: 24px;
    }
    
    .editor-content h2 {
        font-size: 20px;
    }
    
    .editor-content h3 {
        font-size: 16px;
    }
    
    .editor-content p {
        margin: 8px 0;
    }
    
    .editor-content ul, .editor-content ol {
        margin: 8px 0;
        padding-left: 24px;
    }
    
    .editor-content blockquote {
        border-left: 4px solid #dadce0;
        margin: 12px 0;
        padding-left: 16px;
        color: #5f6368;
        font-style: italic;
    }
    
    .editor-content code {
        background: #f1f3f4;
        padding: 2px 4px;
        border-radius: 3px;
        font-family: 'Courier New', monospace;
        font-size: 13px;
    }
    
    .editor-content pre {
        background: #f8f9fa;
        border: 1px solid #dadce0;
        border-radius: 4px;
        padding: 12px;
        margin: 12px 0;
        overflow-x: auto;
        font-family: 'Courier New', monospace;
        font-size: 13px;
        line-height: 1.4;
    }
    
    .color-picker {
        position: relative;
        display: inline-block;
    }
    
    .color-options {
        position: absolute;
        top: 100%;
        left: 0;
        background: white;
        border: 1px solid #dadce0;
        border-radius: 4px;
        padding: 8px;
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        gap: 4px;
        z-index: 1000;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        display: none;
    }
    
    .color-option {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        cursor: pointer;
        border: 1px solid #e0e0e0;
    }
    
    .color-option:hover {
        transform: scale(1.1);
    }
    
    .toolbar-divider {
        width: 1px;
        height: 20px;
        background: #e0e0e0;
        margin: 0 8px;
    }
    
    .word-count {
        color: #5f6368;
        font-size: 12px;
        margin-left: auto;
        padding: 0 8px;
    }
    
    /* Estilo para texto selecionado */
    .editor-content ::selection {
        background: #c2e7ff;
    }
    
    /* Estilos para imagens no editor */
    .editor-content img {
        max-width: 100%;
        height: auto;
        border-radius: 4px;
        margin: 8px 0;
    }
    
    /* Estilo para links */
    .editor-content a {
        color: #1a73e8;
        text-decoration: underline;
    }
    
    /* Estilo para tabelas */
    .editor-content table {
        border-collapse: collapse;
        width: 100%;
        margin: 12px 0;
    }
    
    .editor-content table, .editor-content th, .editor-content td {
        border: 1px solid #dadce0;
    }
    
    .editor-content th, .editor-content td {
        padding: 8px 12px;
        text-align: left;
    }
    
    .editor-content th {
        background: #f8f9fa;
        font-weight: 500;
    }

    /* Estilos para Completar Lacunas */
    .blank-preview {
        display: inline-block;
        min-width: 80px;
        text-align: center;
        font-weight: 500;
        background: #fef3c7;
        border: 2px dashed #f59e0b;
        border-radius: 6px;
        padding: 2px 8px;
        margin: 0 2px;
        transition: all 0.2s ease;
    }

    .blank-filled {
        background: #d1fae5;
        border: 2px solid #10b981;
        color: #065f46;
        font-weight: 600;
    }

    .word-bank {
        min-height: 60px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 8px;
        margin: 12px 0;
    }

    .word-option {
        background: #dbeafe;
        border: 2px solid #3b82f6;
        border-radius: 8px;
        padding: 8px 12px;
        text-align: center;
        cursor: grab;
        transition: all 0.2s ease;
        user-select: none;
        font-weight: 500;
    }

    .word-option:hover {
        background: #3b82f6;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
    }

    .word-option:active {
        cursor: grabbing;
        transform: scale(0.95);
    }

    .fill-blank-textarea {
        font-family: 'Arial', sans-serif;
        line-height: 1.6;
        min-height: 120px;
    }

    /* Estilos para a se√ß√£o de dicas */
    .hints-container {
        transition: all 0.3s ease;
        border: 1px solid #dbeafe;
    }

    .hints-container.expanded {
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
    }

    .add-hint-btn {
        transition: all 0.3s ease;
        position: relative;
    }

    .add-hint-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(59, 130, 246, 0.2);
    }

    .hint-counter {
        font-size: 0.7rem;
        min-width: 20px;
        height: 20px;
    }

    .hint-item {
        background: white;
        border-radius: 6px;
        padding: 8px 12px;
        border: 1px solid #e2e8f0;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .hint-item:hover {
        border-color: #3b82f6;
        box-shadow: 0 2px 4px rgba(59, 130, 246, 0.1);
    }

    .hint-item input {
        border: none;
        background: transparent;
        flex: 1;
        padding: 4px 0;
        color: #374151;
    }

    .hint-item input:focus {
        outline: none;
        box-shadow: none;
    }

    .remove-hint {
        opacity: 0.7;
        transition: opacity 0.2s ease;
    }

    .remove-hint:hover {
        opacity: 1;
    }

    /* Estilos para c√≥digo */
    .text-preview {
        white-space: pre-wrap;
        font-family: 'Courier New', monospace;
        line-height: 1.5;
        background: #f8f9fa;
        padding: 12px;
        border-radius: 6px;
        border: 1px solid #e9ecef;
    }

    .code-preview, .output-content {
        white-space: pre-wrap;
        font-family: 'Courier New', monospace;
        font-size: 0.875rem;
        line-height: 1.5;
        background: #f8f9fa;
        padding: 12px;
        border-radius: 6px;
        border: 1px solid #e9ecef;
        color: #374151;
    }

    .output-preview {
        background: #1a1a1a !important;
        border: 1px solid #333 !important;
        border-radius: 6px;
        padding: 12px;
        font-family: 'Courier New', monospace;
        font-size: 0.875rem;
        color: #10b981 !important;
    }

    .instruction-preview {
        line-height: 1.6;
        color: #4b5563;
        background: #f8f9fa;
        padding: 12px;
        border-radius: 6px;
        border-left: 4px solid #3b82f6;
    }

    .starter-code, .expected-output {
        font-family: 'Courier New', monospace;
        font-size: 0.875rem;
        line-height: 1.5;
    }

    .run-button {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        transition: all 0.3s ease;
    }

    .run-button:hover:not(:disabled) {
        background: linear-gradient(135deg, #059669 0%, #047857 100%);
        transform: translateY(-1px);
    }

    .run-button:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }


    .code-editor-container {
    position: relative;
    border: 1px solid #cbd5e1;
    border-radius: 6px;
    overflow: hidden;
    font-family: 'Courier New', monospace;
    font-size: 14px;
    line-height: 1.5;
}

.code-editor-wrapper {
    display: flex;
    width: 100%;
    background: #f8f9fa;
}

.line-numbers {
    background: #f1f3f4;
    border-right: 1px solid #e2e8f0;
    padding: 12px 8px;
    text-align: right;
    color: #64748b;
    font-size: 13px;
    user-select: none;
    min-height: 120px;
    line-height: 1.5;
}

.code-textarea {
    flex: 1;
    border: none;
    outline: none;
    padding: 12px;
    font-family: 'Courier New', monospace;
    font-size: 14px;
    line-height: 1.5;
    background: white;
    resize: vertical;
    min-height: 120px;
    white-space: pre;
    overflow-wrap: normal;
    overflow-x: auto;
}

/* Adicione estes estilos ao seu CSS existente */

/* Container para o editor de c√≥digo SEM numera√ß√£o */
.code-editor-container {
    position: relative;
    border: 1px solid #cbd5e1;
    border-radius: 6px;
    overflow: hidden;
    font-family: 'Courier New', monospace;
    font-size: 14px;
    line-height: 1.5;
}

.code-editor-wrapper {
    display: flex;
    width: 100%;
    background: #f8f9fa;
}

/* REMOVER estilos de numera√ß√£o de linhas */
.line-numbers {
    display: none; /* Remove a numera√ß√£o */
}

.code-textarea {
    flex: 1;
    border: none;
    outline: none;
    padding: 12px;
    font-family: 'Courier New', monospace;
    font-size: 14px;
    line-height: 1.5;
    background: white;
    resize: vertical;
    min-height: 120px;
    white-space: pre;
    overflow-wrap: normal;
    overflow-x: auto;
    width: 100%; /* Ocupa toda a largura */
}

/* Estilo para o preview SEM numera√ß√£o */
.code-preview-container {
    position: relative;
    background: #f8f9fa;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    overflow: hidden;
    font-family: 'Courier New', monospace;
    font-size: 14px;
    line-height: 1.5;
}

.code-preview-wrapper {
    display: flex;
    width: 100%;
}

/* REMOVER preview de numera√ß√£o */
.preview-line-numbers {
    display: none; /* Remove a numera√ß√£o do preview */
}

.code-preview-content {
    flex: 1;
    padding: 12px;
    background: white;
    overflow-x: auto;
    white-space: pre;
    min-height: 60px;
    width: 100%; /* Ocupa toda a largura */
}

/* Estilo para lacunas maiores */
.large-textarea {
    min-height: 200px;
    font-size: 16px;
    line-height: 1.8;
}

.large-preview {
    min-height: 200px;
    font-size: 16px;
    line-height: 1.8;
    padding: 16px;
    background: #f8f9fa;
    border-radius: 6px;
    border: 1px solid #e2e8f0;
}

/* Estilos para campos de c√≥digo com Tab */
.starter-code, .expected-output, .fill-blank-textarea {
    font-family: 'Courier New', monospace !important;
    tab-size: 4;
    -moz-tab-size: 4;
}
</style>
{% endblock %}

{% block content %}
<div class="space-y-8 fade-in">
    <!-- Cabe√ßalho -->
    <div class="bg-gradient-to-r from-blue-600 to-blue-800 rounded-2xl p-8 text-white">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold mb-2">Criar Conte√∫do</h1>
                <p class="text-blue-100 text-lg">Desenvolva materiais de aprendizado interativos para seus alunos</p>
            </div>
            <img src="{% static 'imagem/edit_note_100dp_FFFFFF_FILL0_wght400_GRAD0_opsz48.png' %}" alt="Criar Conte√∫do" class="w-16 h-16 floating-element">
        </div>
        
        <!-- Barra de Progresso -->
        <div class="mt-4">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div class="flex justify-between text-blue-200 text-sm">
                <span>Estrutura</span>
                <span>Conte√∫do Te√≥rico</span>
                <span>Exerc√≠cios Pr√°ticos</span>
                <span>Revis√£o</span>
            </div>
        </div>
    </div>

    <!-- Indicador de Passos -->
    <div class="step-indicator">
        <div class="step active" data-step="1">
            <div class="step-number">1</div>
            <span>Estrutura</span>
        </div>
        <div class="step-connector"></div>
        <div class="step" data-step="2">
            <div class="step-number">2</div>
            <span>Conte√∫do Te√≥rico</span>
        </div>
        <div class="step-connector"></div>
        <div class="step" data-step="3">
            <div class="step-number">3</div>
            <span>Exerc√≠cios Pr√°ticos</span>
        </div>
        <div class="step-connector"></div>
        <div class="step" data-step="4">
            <div class="step-number">4</div>
            <span>Revis√£o</span>
        </div>
    </div>

    <!-- Form Principal -->
    <form id="content-form" method="post" action="{% url 'criar_conteudo' %}" class="space-y-6" enctype="multipart/form-data">
        {% csrf_token %}
        
        <!-- Campo hidden para dados dos t√≥picos -->
        <input type="hidden" name="topicos_json" id="topicos-json" value="[]">
        
        <!-- Campo hidden para dados das quest√µes -->
        <input type="hidden" name="questoes_json" id="questoes-json" value="[]">

        <!-- PASSO 1: ESTRUTURA DO CONTE√öDO -->
        <div id="step-1" class="form-section">
            <div class="form-section-header">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-bold">üìö Estrutura do Conte√∫do</h2>
                </div>
                <span class="text-blue-200">Passo 1 de 4</span>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Cap√≠tulo -->
                <div>
                    <label for="chapter-select" class="block text-sm font-medium text-gray-700 mb-2">Cap√≠tulo *</label>
                    <select id="chapter-select" name="capitulo_id" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 form-control" required>
                        <option value="" selected disabled>Selecionar Cap√≠tulo</option>
                        {% for capitulo in capitulos %}
                        <option value="{{ capitulo.id }}">{{ capitulo.titulo }}</option>
                        {% endfor %}
                        <option value="new">+ Criar Novo Cap√≠tulo</option>
                    </select>
                    <div class="validation-error" id="chapter-error"></div>
                </div>
                
                <!-- M√≥dulo -->
                <div>
                    <label for="module-select" class="block text-sm font-medium text-gray-700 mb-2">M√≥dulo *</label>
                    <select id="module-select" name="modulo_id" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 form-control" disabled required>
                        <option value="" selected disabled>Selecione um cap√≠tulo primeiro</option>
                    </select>
                    <div class="validation-error" id="module-error"></div>
                </div>
                
                <!-- T√≠tulo da Aula -->
                <div>
                    <label for="lesson-title" class="block text-sm font-medium text-gray-700 mb-2">T√≠tulo da Aula *</label>
                    <input type="text" id="lesson-title" name="titulo_aula" placeholder="Ex: Introdu√ß√£o ao Python" 
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 form-control" required>
                    <div class="validation-error" id="lesson-title-error"></div>
                </div>
            </div>
            
            <div class="mt-6 flex justify-between">
                <a href="{% url 'gerenciar_conteudo' %}" 
                    class="bg-green-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-700 transition interactive-card flex items-center gap-2">
                    <img src="{% static 'imagem/folder_35dp_FFFFFF_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Gerenciar" class="w-4 h-4">
                    Gerenciar Conte√∫do Existente
                </a>
                <button type="button" onclick="validateStep1()" 
                    class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition interactive-card">
                    Pr√≥ximo ‚Üí Conte√∫do Te√≥rico
                </button>
            </div>
        </div>

        <!-- PASSO 2: CONTE√öDO TE√ìRICO -->
        <div id="step-2" class="form-section hidden">
            <div class="form-section-header">
                <h2 class="text-xl font-bold">üìñ Conte√∫do Te√≥rico</h2>
                <span class="text-blue-200">Passo 2 de 4</span>
            </div>
            
            <div class="space-y-4">
                <!-- T√≠tulo do Conte√∫do Te√≥rico -->
                <div>
                    <label for="titulo-teoria" class="block text-sm font-medium text-gray-700 mb-2">T√≠tulo do Conte√∫do Te√≥rico</label>
                    <input type="text" id="titulo-teoria" name="titulo_teoria" placeholder="Ex: Conceitos Fundamentais" 
                        value="Conte√∫do Te√≥rico" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 form-control">
                </div>
                
                <!-- Descri√ß√£o Breve -->
                <div>
                    <label for="descricao-breve" class="block text-sm font-medium text-gray-700 mb-2">Descri√ß√£o Breve</label>
                    <textarea id="descricao-breve" name="descricao_breve" rows="3" placeholder="Descreva brevemente o conte√∫do desta aula..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 form-control"></textarea>
                </div>
                
                <!-- Conte√∫do Te√≥rico com T√≥picos -->
                <div>
                    <div class="flex justify-between items-center mb-4">
                        <label class="block text-sm font-medium text-gray-700">Conte√∫do Te√≥rico por T√≥picos</label>
                        <button type="button" id="add-topic-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition interactive-card flex items-center gap-2"> 
                            <img src="{% static 'imagem/add_35dp_FFFFFF_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Adicionar" class="w-4 h-4">
                            Adicionar T√≥pico
                        </button>
                    </div>
                    
                    <!-- Container de T√≥picos -->
                    <div id="topics-container" class="space-y-4">
                        <!-- T√≥pico padr√£o -->
                        <div class="topic-item border border-gray-300 rounded-lg overflow-hidden" data-topic-index="0">
                            <div class="topic-header bg-gray-50 p-4 border-b border-gray-300 flex justify-between items-center">
                                <div class="flex items-center gap-3 flex-1">
                                    <div class="drag-handle cursor-move">
                                        <img src="{% static 'imagem/drag_handle_35dp_64748b_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Arrastar" class="w-5 h-5">
                                    </div>
                                    <input type="text" class="topic-title bg-transparent border-none text-lg font-semibold focus:outline-none focus:ring-2 focus:ring-blue-500 rounded px-2 py-1" 
                                        value="Conte√∫do Principal" placeholder="Nome do t√≥pico">
                                </div>
                                <button type="button" class="remove-topic text-red-500 hover:text-red-700 interactive-card" aria-label="Remover t√≥pico">
                                    <img src="{% static 'imagem/delete_35dp_ef4444_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Remover" class="w-5 h-5">
                                </button>
                            </div>
                            <div class="topic-content p-4">
                                <!-- Editor estilo Google Docs -->
                                <div class="editor-container">
                                    <!-- Barra de Ferramentas -->
                                    <div class="editor-toolbar">
                                        <!-- Grupo de Formata√ß√£o B√°sica -->
                                        <div class="toolbar-group">
                                            <button type="button" class="toolbar-button" data-command="bold" title="Negrito">
                                                <strong>B</strong>
                                            </button>
                                            <button type="button" class="toolbar-button" data-command="italic" title="It√°lico">
                                                <em>I</em>
                                            </button>
                                            <button type="button" class="toolbar-button" data-command="underline" title="Sublinhado">
                                                <u>U</u>
                                            </button>
                                        </div>
                                        
                                        <div class="toolbar-divider"></div>
                                        
                                        <!-- Grupo de Listas -->
                                        <div class="toolbar-group">
                                            <button type="button" class="toolbar-button" data-command="insertUnorderedList" title="Lista com marcadores">
                                                <img src="{% static 'imagem/format_list_bulleted_35dp_5f6368_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Lista" class="w-4 h-4">
                                            </button>
                                            <button type="button" class="toolbar-button" data-command="insertOrderedList" title="Lista numerada">
                                                <img src="{% static 'imagem/format_list_numbered_35dp_5f6368_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Lista numerada" class="w-4 h-4">
                                            </button>
                                        </div>
                                        
                                        <div class="toolbar-divider"></div>
                                        
                                        <!-- Grupo de Cores -->
                                        <div class="toolbar-group">
                                            <div class="color-picker">
                                                <button type="button" class="toolbar-button text-color-button" title="Cor do texto">
                                                    <span style="color: #202124;">A</span>
                                                </button>
                                                <div class="color-options text-color-options">
                                                    <div class="color-option" style="background-color: #202124;" data-color="#202124"></div>
                                                    <div class="color-option" style="background-color: #ea4335;" data-color="#ea4335"></div>
                                                    <div class="color-option" style="background-color: #34a853;" data-color="#34a853"></div>
                                                    <div class="color-option" style="background-color: #4285f4;" data-color="#4285f4"></div>
                                                    <div class="color-option" style="background-color: #8e24aa;" data-color="#8e24aa"></div>
                                                    <div class="color-option" style="background-color: #000000;" data-color="#000000"></div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="toolbar-divider"></div>
                                        
                                        <!-- Bot√£o Inserir C√≥digo -->
                                        <div class="toolbar-group">
                                            <button type="button" class="toolbar-button insert-code" title="Inserir bloco de c√≥digo">
                                                <img src="{% static 'imagem/code_35dp_5f6368_FILL0_wght400_GRAD0_opsz40.png' %}" alt="C√≥digo" class="w-4 h-4">
                                            </button>
                                        </div>

                                        <!-- Contador de palavras -->
                                        <div class="word-count">
                                            <span class="word-count-display">0 palavras</span>
                                        </div>
                                    </div>
                                    
                                    <!-- √Årea de Conte√∫do Edit√°vel -->
                                    <div class="editor-content topic-editor" contenteditable="true" placeholder="Comece a escrever o conte√∫do deste t√≥pico aqui..."></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="validation-error" id="theory-content-error"></div>
                </div>
                
                <!-- Tempo Te√≥rico e XP -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="estimated-time-theory" class="block text-sm font-medium text-gray-700 mb-2">
                            Tempo Estimado para Teoria (minutos) *
                            <span class="text-gray-500 text-xs font-normal">(tempo para estudar a parte te√≥rica)</span>
                        </label>
                        <input type="number" id="estimated-time-theory" name="tempo_estimado_teoria" min="1" max="120" placeholder="Ex: 30" 
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 form-control" 
                            required oninput="updateTotalTime()">
                        <div class="validation-error" id="time-theory-error"></div>
                    </div>
                    
                    <!-- XP do Conte√∫do Te√≥rico -->
                    <div>
                        <label for="theory-xp" class="block text-sm font-medium text-gray-700 mb-2">
                            XP por Completar o Conte√∫do Te√≥rico
                            <span class="text-gray-500 text-xs font-normal">(recomendado: 20-50 XP)</span>
                        </label>
                        <input type="number" id="theory-xp" name="theory_xp" min="10" max="100" value="30" 
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 form-control">
                        <div class="text-xs text-gray-500 mt-1">
                            üí° XP que o aluno ganha ao completar toda a parte te√≥rica
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-6 flex justify-between">
                <button type="button" onclick="prevStep(1)" class="bg-gray-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-600 transition interactive-card">
                    ‚Üê Voltar
                </button>
                <button type="button" onclick="validateStep2()" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition interactive-card">
                    Pr√≥ximo ‚Üí Exerc√≠cios Pr√°ticos
                </button>
            </div>
        </div>

        <!-- PASSO 3: EXERC√çCIOS PR√ÅTICOS -->
        <div id="step-3" class="form-section hidden">
            <div class="form-section-header">
                <div class="flex items-center gap-3">
                    <h2 class="text-xl font-bold">üíª Exerc√≠cios Pr√°ticos</h2>
                    <span class="question-counter" id="question-count">0</span>
                </div>
                <span class="text-blue-200">Passo 3 de 4</span>
            </div>
            
            <div class="space-y-6">
                <!-- Cabe√ßalho da Lista de Exerc√≠cios -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-blue-800 mb-4">üìù Configura√ß√£o da Lista de Exerc√≠cios</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="titulo-pratica" class="block text-sm font-medium text-gray-700 mb-2">
                                T√≠tulo da Lista de Exerc√≠cios *
                            </label>
                            <input type="text" id="titulo-pratica" name="titulo_pratica" 
                                placeholder="Ex: Exerc√≠cios de Fixa√ß√£o" 
                                value="Exerc√≠cios Pr√°ticos"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 form-control">
                            <div class="validation-error" id="practice-title-error"></div>
                        </div>
                        
                        <div>
                            <label for="conteudo-pratico" class="block text-sm font-medium text-gray-700 mb-2">
                                Descri√ß√£o da Lista
                            </label>
                            <textarea id="conteudo-pratico" name="conteudo_pratico" rows="3"
                                    placeholder="Descreva o objetivo desta lista de exerc√≠cios..."
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 form-control"></textarea>
                        </div>
                    </div>

                    <!-- Tempo Pr√°tico -->
                    <div class="mt-4">
                        <label for="estimated-time-practice" class="block text-sm font-medium text-gray-700 mb-2">
                            Tempo Estimado para Pr√°tica (minutos) *
                            <span class="text-gray-500 text-xs font-normal">(tempo para resolver os exerc√≠cios)</span>
                        </label>
                        <input type="number" id="estimated-time-practice" name="tempo_estimado_pratica" min="1" max="120" placeholder="Ex: 25" 
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 form-control" 
                            required oninput="updateTotalTime()">
                        <div class="validation-error" id="time-practice-error"></div>
                    </div>
                </div>

                <!-- Seletor de Tipo de Exerc√≠cio -->
                <div class="bg-blue-50 p-4 rounded-lg">
                    <label class="block text-sm font-medium text-gray-700 mb-3">Adicionar Novo Exerc√≠cio</label>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <button type="button" onclick="addQuestion('multiple-choice')" class="p-4 bg-white border-2 border-blue-200 rounded-lg text-center hover:border-blue-400 transition interactive-card">
                            <img src="{% static 'imagem/quiz_35dp_2682EA_FILL0_wght400_GRAD0_opsz40.png' %}" alt="M√∫ltipla Escolha" class="w-8 h-8 mx-auto mb-2">
                            <span class="font-semibold text-blue-700">M√∫ltipla Escolha</span>
                        </button>
                        
                        <button type="button" onclick="addQuestion('code')" class="p-4 bg-white border-2 border-blue-200 rounded-lg text-center hover:border-blue-400 transition interactive-card">
                            <img src="{% static 'imagem/code_35dp_2682EA_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Escrever C√≥digo" class="w-8 h-8 mx-auto mb-2">
                            <span class="font-semibold text-blue-700">Escrever C√≥digo</span>
                        </button>
                        
                        <button type="button" onclick="addQuestion('fill-blank')" class="p-4 bg-white border-2 border-blue-200 rounded-lg text-center hover:border-blue-400 transition interactive-card">
                            <img src="{% static 'imagem/edit_35dp_2682EA_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Completar Lacunas" class="w-8 h-8 mx-auto mb-2">
                            <span class="font-semibold text-blue-700">Completar Lacunas</span>
                        </button>
                    </div>
                </div>
                
                <!-- Lista de Exerc√≠cios -->
                <div id="questions-list" class="space-y-4">
                    <div class="empty-state">
                        <img src="{% static 'imagem/note_stack_100dp_64748b_FILL0_wght400_GRAD0_opsz48.png' %}" alt="Sem exerc√≠cios" class="w-16 h-16 mx-auto">
                        <p class="text-gray-500">Nenhum exerc√≠cio adicionado ainda</p>
                        <p class="text-sm text-gray-400">Clique em um dos tipos acima para come√ßar</p>
                    </div>
                </div>
            </div>
            
            <div class="mt-6 flex justify-between">
                <button type="button" onclick="prevStep(2)" class="bg-gray-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-600 transition interactive-card">
                    ‚Üê Voltar
                </button>
                <button type="button" onclick="validateStep3()" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition interactive-card">
                    Pr√≥ximo ‚Üí Revis√£o
                </button>
            </div>
        </div>

        <!-- PASSO 4: REVIS√ÉO E PUBLICA√á√ÉO -->
        <div id="step-4" class="form-section hidden">
            <div class="form-section-header">
                <h2 class="text-xl font-bold">üëÅÔ∏è Revis√£o Final</h2>
                <span class="text-blue-200">Passo 4 de 4</span>
            </div>
            
            <div class="space-y-8">
                <!-- Resumo do Conte√∫do -->
                <div class="bg-white rounded-lg border border-gray-200 p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">üìã Resumo do Conte√∫do</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-3">
                            <div class="flex justify-between border-b pb-2">
                                <span class="text-gray-600">Cap√≠tulo:</span>
                                <span class="font-medium" id="review-chapter">-</span>
                            </div>
                            <div class="flex justify-between border-b pb-2">
                                <span class="text-gray-600">M√≥dulo:</span>
                                <span class="font-medium" id="review-module">-</span>
                            </div>
                            <div class="flex justify-between border-b pb-2">
                                <span class="text-gray-600">T√≠tulo da Aula:</span>
                                <span class="font-medium" id="review-lesson-title">-</span>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <!-- Tempos -->
                            <div class="flex justify-between border-b pb-2">
                                <span class="text-gray-600">Tempo Te√≥rico:</span>
                                <span class="font-medium" id="review-time-theory">-</span>
                            </div>
                            <div class="flex justify-between border-b pb-2">
                                <span class="text-gray-600">Tempo Pr√°tico:</span>
                                <span class="font-medium" id="review-time-practice">-</span>
                            </div>
                            <div class="flex justify-between border-b pb-2">
                                <span class="text-gray-600 font-semibold">Tempo Total:</span>
                                <span class="font-bold text-blue-600" id="review-total-time">-</span>
                            </div>
                            <div class="flex justify-between border-b pb-2">
                                <span class="text-gray-600">XP Te√≥rico:</span>
                                <span class="font-medium" id="review-theory-xp">0 XP</span>
                            </div>
                            <div class="flex justify-between border-b pb-2">
                                <span class="text-gray-600">XP Pr√°tico:</span>
                                <span class="font-medium" id="review-practice-xp">0 XP</span>
                            </div>
                            <div class="flex justify-between border-b pb-2">
                                <span class="text-gray-600 font-semibold">Total de XP:</span>
                                <span class="font-bold text-green-600" id="review-total-xp">0 XP</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Estrutura dos T√≥picos -->
                <div class="bg-white rounded-lg border border-gray-200 p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">üìö Estrutura dos T√≥picos</h3>
                    <div id="review-topics" class="space-y-3">
                        <div class="text-center text-gray-500 py-4">
                            <img src="{% static 'imagem/note_stack_100dp_64748b_FILL0_wght400_GRAD0_opsz48.png' %}" alt="Sem t√≥picos" class="w-12 h-12 mx-auto mb-2 opacity-50">
                            <p>Nenhum t√≥pico adicionado</p>
                        </div>
                    </div>
                </div>

                <!-- Preview das Quest√µes -->
                <div class="bg-white rounded-lg border border-gray-200 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">üíª Exerc√≠cios Pr√°ticos</h3>
                        <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium" id="review-questions-badge">
                            0 quest√µes
                        </span>
                    </div>
                    <div id="review-questions" class="space-y-4">
                        <div class="text-center text-gray-500 py-4">
                            <img src="{% static 'imagem/quiz_100dp_64748b_FILL0_wght400_GRAD0_opsz48.png' %}" alt="Sem quest√µes" class="w-12 h-12 mx-auto mb-2 opacity-50">
                            <p>Nenhum exerc√≠cio adicionado</p>
                        </div>
                    </div>
                </div>

                <!-- Checklist de Valida√ß√£o -->
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-yellow-800 mb-4">‚úÖ Checklist de Valida√ß√£o</h3>
                    <div class="space-y-3">
                        <div class="flex items-center gap-3">
                            <div id="check-title" class="w-5 h-5 rounded-full border-2 border-gray-300"></div>
                            <span class="text-yellow-700">T√≠tulo da aula preenchido</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <div id="check-topics" class="w-5 h-5 rounded-full border-2 border-gray-300"></div>
                            <span class="text-yellow-700">Pelo menos um t√≥pico com conte√∫do</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <div id="check-questions" class="w-5 h-5 rounded-full border-2 border-gray-300"></div>
                            <span class="text-yellow-700">Pelo menos um exerc√≠cio pr√°tico</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <div id="check-time-theory" class="w-5 h-5 rounded-full border-2 border-gray-300"></div>
                            <span class="text-yellow-700">Tempo te√≥rico definido</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <div id="check-time-practice" class="w-5 h-5 rounded-full border-2 border-gray-300"></div>
                            <span class="text-yellow-700">Tempo pr√°tico definido</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <div id="check-hints" class="w-5 h-5 rounded-full border-2 border-gray-300"></div>
                            <span class="text-yellow-700">3 dicas preenchidas em cada quest√£o</span>
                        </div>
                    </div>
                </div>

                <!-- A√ß√µes Finais -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-blue-800 mb-3">üöÄ Pronto para Publicar</h3>
                    <p class="text-blue-700 mb-4">Revise todo o conte√∫do cuidadosamente. Ap√≥s a publica√ß√£o, o material ficar√° dispon√≠vel para os alunos.</p>
                    
                    <div class="flex items-center gap-4 mb-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="confirm-review" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="text-blue-800 font-medium">Confirmo que revisei todo o conte√∫do</span>
                        </label>
                    </div>

                    <div class="flex items-center gap-2 text-sm text-blue-600">
                        <img src="{% static 'imagem/info_35dp_2682EA_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Info" class="w-4 h-4">
                        <span>O conte√∫do ser√° publicado imediatamente ap√≥s a confirma√ß√£o</span>
                    </div>
                </div>
            </div>
            
            <div class="mt-6 flex justify-between">
                <button type="button" onclick="prevStep(3)" class="bg-gray-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-600 transition interactive-card">
                    ‚Üê Voltar para Exerc√≠cios
                </button>
                <button type="submit" id="publish-button" class="bg-green-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-green-700 transition interactive-card flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                    <img src="{% static 'imagem/publish_35dp_FFFFFF_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Publicar" class="w-5 h-5">
                    Publicar Conte√∫do
                </button>
            </div>
        </div>
    </form>
</div>

<!-- MODAIS FORA DO FORMUL√ÅRIO PRINCIPAL -->
<!-- Modal de Criar Cap√≠tulo -->
<div class="modal-overlay" id="chapter-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Criar Novo Cap√≠tulo</h3>
            <button type="button" class="modal-close" onclick="closeChapterModal()">√ó</button>
        </div>
        
        <div class="modal-body space-y-4">
            <div>
                <label for="new-chapter-title" class="block text-sm font-medium text-gray-700 mb-2">
                    T√≠tulo do Cap√≠tulo *
                </label>
                <input type="text" id="new-chapter-title" 
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 form-control"
                       placeholder="Ex: Introdu√ß√£o ao Python"
                       required>
                <div class="validation-error" id="new-chapter-title-error"></div>
            </div>
            
            <div>
                <label for="new-chapter-description" class="block text-sm font-medium text-gray-700 mb-2">
                    Descri√ß√£o do Cap√≠tulo
                </label>
                <textarea id="new-chapter-description" rows="4"
                          class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 form-control"
                          placeholder="Descreva o objetivo e conte√∫do deste cap√≠tulo..."></textarea>
            </div>

            <div>
                <label for="new-chapter-difficulty" class="block text-sm font-medium text-gray-700 mb-2">
                    N√≠vel de Dificuldade *
                </label>
                <select id="new-chapter-difficulty" 
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 form-control"
                        required>
                    <option value="" selected disabled>Selecione a dificuldade</option>
                    <option value="beginner">Iniciante</option>
                    <option value="intermediate">Intermedi√°rio</option>
                    <option value="advanced">Avan√ßado</option>
                </select>
                <div class="validation-error" id="new-chapter-difficulty-error"></div>
            </div>
        </div>
        
        <div class="modal-footer">
            <button type="button" onclick="closeChapterModal()" class="px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 transition interactive-card">
                Cancelar
            </button>
            <button type="button" onclick="createNewChapter()" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition interactive-card flex items-center gap-2">
                <img src="{% static 'imagem/add_35dp_FFFFFF_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Adicionar" class="w-4 h-4">
                Criar Cap√≠tulo
            </button>
        </div>
    </div>
</div>

<!-- Modal de Criar M√≥dulo -->
<div class="modal-overlay" id="module-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Criar Novo M√≥dulo</h3>
            <button type="button" class="modal-close" onclick="closeModuleModal()">√ó</button>
        </div>
        
        <div class="modal-body space-y-4">
            <div class="bg-blue-50 p-3 rounded-lg">
                <div class="flex items-center gap-2 text-blue-700">
                    <img src="{% static 'imagem/folder_35dp_2682EA_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Cap√≠tulo" class="w-4 h-4">
                    <span class="text-sm font-medium">Cap√≠tulo:</span>
                    <span id="selected-chapter-name" class="text-sm">-</span>
                </div>
            </div>
            
            <div>
                <label for="new-module-title" class="block text-sm font-medium text-gray-700 mb-2">
                    T√≠tulo do M√≥dulo *
                </label>
                <input type="text" id="new-module-title" 
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 form-control"
                       placeholder="Ex: Vari√°veis e Tipos de Dados"
                       required>
                <div class="validation-error" id="new-module-title-error"></div>
            </div>
            
            <div>
                <label for="new-module-description" class="block text-sm font-medium text-gray-700 mb-2">
                    Descri√ß√£o do M√≥dulo
                </label>
                <textarea id="new-module-description" rows="4"
                          class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 form-control"
                          placeholder="Descreva o objetivo e conte√∫do deste m√≥dulo..."></textarea>
            </div>
        </div>
        
        <div class="modal-footer">
            <button type="button" onclick="closeModuleModal()" class="px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 transition interactive-card">
                Cancelar
            </button>
            <button type="button" onclick="createNewModule()" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition interactive-card flex items-center gap-2">
                <img src="{% static 'imagem/add_35dp_FFFFFF_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Adicionar" class="w-4 h-4">
                Criar M√≥dulo
            </button>
        </div>
    </div>
</div>

<!-- Template para novos t√≥picos -->
<template id="topic-template">
    <div class="topic-item border border-gray-300 rounded-lg overflow-hidden">
        <div class="topic-header bg-gray-50 p-4 border-b border-gray-300 flex justify-between items-center">
            <div class="flex items-center gap-3 flex-1">
                <div class="drag-handle cursor-move">
                    <img src="{% static 'imagem/drag_handle_35dp_64748b_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Arrastar" class="w-5 h-5">
                </div>
                <input type="text" class="topic-title bg-transparent border-none text-lg font-semibold focus:outline-none focus:ring-2 focus:ring-blue-500 rounded px-2 py-1" 
                       placeholder="Nome do t√≥pico">
            </div>
            <button type="button" class="remove-topic text-red-500 hover:text-red-700 interactive-card" aria-label="Remover t√≥pico">
                <img src="{% static 'imagem/delete_35dp_ef4444_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Remover" class="w-5 h-5">
            </button>
        </div>
        <div class="topic-content p-4">
            <!-- Editor SIMPLIFICADO estilo Google Docs -->
            <div class="editor-container">
                <!-- Barra de Ferramentas SIMPLIFICADA -->
                <div class="editor-toolbar">
                    <!-- Grupo de Formata√ß√£o B√°sica -->
                    <div class="toolbar-group">
                        <button type="button" class="toolbar-button" data-command="bold" title="Negrito">
                            <strong>B</strong>
                        </button>
                        <button type="button" class="toolbar-button" data-command="italic" title="It√°lico">
                            <em>I</em>
                        </button>
                        <button type="button" class="toolbar-button" data-command="underline" title="Sublinhado">
                            <u>U</u>
                        </button>
                    </div>
                    
                    <div class="toolbar-divider"></div>
                    
                    <!-- Grupo de Listas -->
                    <div class="toolbar-group">
                        <button type="button" class="toolbar-button" data-command="insertUnorderedList" title="Lista com marcadores">
                            <img src="{% static 'imagem/format_list_bulleted_35dp_5f6368_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Lista" class="w-4 h-4">
                        </button>
                        <button type="button" class="toolbar-button" data-command="insertOrderedList" title="Lista numerada">
                            <img src="{% static 'imagem/format_list_numbered_35dp_5f6368_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Lista numerada" class="w-4 h-4">
                        </button>
                    </div>
                    
                    <div class="toolbar-divider"></div>
                    
                    <!-- Grupo de Cores SIMPLIFICADO -->
                    <div class="toolbar-group">
                        <div class="color-picker">
                            <button type="button" class="toolbar-button text-color-button" title="Cor do texto">
                                <span style="color: #202124;">A</span>
                            </button>
                            <div class="color-options text-color-options">
                                <div class="color-option" style="background-color: #202124;" data-color="#202124"></div>
                                <div class="color-option" style="background-color: #ea4335;" data-color="#ea4335"></div>
                                <div class="color-option" style="background-color: #34a853;" data-color="#34a853"></div>
                                <div class="color-option" style="background-color: #4285f4;" data-color="#4285f4"></div>
                                <div class="color-option" style="background-color: #8e24aa;" data-color="#8e24aa"></div>
                                <div class="color-option" style="background-color: #000000;" data-color="#000000"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="toolbar-divider"></div>
                    
                    <!-- Bot√£o Inserir C√≥digo -->
                    <div class="toolbar-group">
                        <button type="button" class="toolbar-button insert-code" title="Inserir bloco de c√≥digo">
                            <img src="{% static 'imagem/code_35dp_5f6368_FILL0_wght400_GRAD0_opsz40.png' %}" alt="C√≥digo" class="w-4 h-4">
                        </button>
                    </div>

                    <!-- Contador de palavras -->
                    <div class="word-count">
                        <span class="word-count-display">0 palavras</span>
                    </div>
                </div>
                
                <!-- √Årea de Conte√∫do Edit√°vel -->
                <div class="editor-content topic-editor" contenteditable="true" placeholder="Comece a escrever o conte√∫do deste t√≥pico aqui..."></div>
            </div>
        </div>
    </div>
</template>

<!-- Template para M√∫ltipla Escolha - ATUALIZADO COM DESCRI√á√ÉO -->
<template id="multiple-choice-template">
    <div class="question-item" data-type="multiple-choice">
        <div class="flex items-start justify-between mb-4">
            <div class="flex items-center gap-3">
                <div class="drag-handle">
                    <img src="{% static 'imagem/drag_handle_35dp_64748b_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Arrastar" class="w-5 h-5">
                </div>
                <h4 class="font-semibold text-blue-700">M√∫ltipla Escolha</h4>
            </div>
            
            <div class="flex items-center gap-2">
                <!-- Bot√£o de Dicas -->
                <div class="hints-section">
                    <button type="button" class="add-hint-btn bg-blue-100 text-blue-700 px-3 py-2 rounded-lg font-medium hover:bg-blue-200 transition interactive-card flex items-center gap-2 text-sm">
                        <img src="{% static 'imagem/lightbulb_35dp_2682EA_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Dicas" class="w-4 h-4">
                        Dicas
                        <span class="hint-counter bg-blue-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">0</span>
                    </button>
                </div>
                
                <button type="button" onclick="removeQuestion(this)" class="text-red-500 hover:text-red-700 interactive-card p-2 rounded-lg hover:bg-red-50 transition" aria-label="Remover quest√£o">
                    <img src="{% static 'imagem/delete_35dp_ef4444_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Remover" class="w-5 h-5">
                </button>
            </div>
        </div>
        
        <!-- Container de Dicas -->
        <div class="hints-container bg-blue-50 p-4 rounded-lg mb-4 hidden">
            <div class="flex justify-between items-center mb-3">
                <label class="font-medium text-blue-800 flex items-center gap-2">
                    <img src="{% static 'imagem/lightbulb_35dp_2682EA_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Dicas" class="w-4 h-4">
                    Dicas para o aluno (m√°x. 3)
                </label>
                <button type="button" class="add-hint bg-blue-600 text-white text-sm px-3 py-1 rounded hover:bg-blue-700 transition flex items-center gap-1">
                    <img src="{% static 'imagem/add_35dp_FFFFFF_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Adicionar" class="w-3 h-3">
                    Adicionar
                </button>
            </div>
            <div class="hints-list space-y-2"></div>
        </div>
        
        <div class="space-y-4">
            <!-- Descri√ß√£o da Quest√£o -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Descri√ß√£o/Contexto da Quest√£o
                    <span class="text-gray-500 text-xs font-normal">(opcional)</span>
                </label>
                <textarea placeholder="Forne√ßa um contexto ou descri√ß√£o para esta quest√£o..." 
                          rows="2" class="w-full p-3 border border-gray-300 rounded-lg form-control question-description"></textarea>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Pergunta *</label>
                <input type="text" placeholder="Digite a pergunta..." class="w-full p-3 border border-gray-300 rounded-lg form-control question-input">
                <div class="validation-error question-error"></div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Op√ß√µes de Resposta *</label>
                <div class="space-y-2 options-container">
                    <div class="option-item">
                        <input type="radio" name="correct-answer" class="text-blue-600 correct-option-radio">
                        <input type="text" placeholder="Op√ß√£o 1" class="flex-1 p-2 border border-gray-300 rounded option-input">
                        <button type="button" class="remove-option text-red-500 hover:text-red-700 interactive-card p-1" aria-label="Remover op√ß√£o">√ó</button>
                    </div>
                </div>
                <div class="validation-error options-error"></div>
                <button type="button" class="mt-2 text-blue-600 text-sm font-medium interactive-card flex items-center gap-1 add-option-btn">
                    <img src="{% static 'imagem/add_35dp_2682EA_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Adicionar" class="w-4 h-4">
                    Adicionar Op√ß√£o
                </button>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">XP da Quest√£o</label>
                <input type="number" min="5" max="50" value="10" class="w-24 p-2 border border-gray-300 rounded xp-input">
            </div>
        </div>
    </div>
</template>

<!-- Template para C√≥digo - SEM numera√ß√£o -->
<template id="code-template">
    <div class="question-item" data-type="code">
        <div class="flex items-start justify-between mb-4">
            <div class="flex items-center gap-3">
                <div class="drag-handle">
                    <img src="{% static 'imagem/drag_handle_35dp_64748b_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Arrastar" class="w-5 h-5">
                </div>
                <h4 class="font-semibold text-blue-700">Exerc√≠cio de Programa√ß√£o</h4>
            </div>

            <div class="flex items-center gap-2">
                <!-- Bot√£o de Dicas -->
                <div class="hints-section">
                    <button type="button" class="add-hint-btn bg-blue-100 text-blue-700 px-3 py-2 rounded-lg font-medium hover:bg-blue-200 transition interactive-card flex items-center gap-2 text-sm">
                        <img src="{% static 'imagem/lightbulb_35dp_2682EA_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Dicas" class="w-4 h-4">
                        Dicas
                        <span class="hint-counter bg-blue-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">0</span>
                    </button>
                </div>
                
                <button type="button" onclick="removeQuestion(this)" class="text-red-500 hover:text-red-700 interactive-card p-2 rounded-lg hover:bg-red-50 transition" aria-label="Remover quest√£o">
                    <img src="{% static 'imagem/delete_35dp_ef4444_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Remover" class="w-5 h-5">
                </button>
            </div>
        </div>
        
        <!-- Container de Dicas -->
        <div class="hints-container bg-blue-50 p-4 rounded-lg mb-4 hidden">
            <div class="flex justify-between items-center mb-3">
                <label class="font-medium text-blue-800 flex items-center gap-2">
                    <img src="{% static 'imagem/lightbulb_35dp_2682EA_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Dicas" class="w-4 h-4">
                    Dicas para o aluno (m√°x. 3)
                </label>
                <button type="button" class="add-hint bg-blue-600 text-white text-sm px-3 py-1 rounded hover:bg-blue-700 transition flex items-center gap-1">
                    <img src="{% static 'imagem/add_35dp_FFFFFF_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Adicionar" class="w-3 h-3">
                    Adicionar
                </button>
            </div>
            <div class="hints-list space-y-2"></div>
        </div>
        
        <div class="space-y-4">
            <!-- Descri√ß√£o da Quest√£o -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Descri√ß√£o/Contexto do Exerc√≠cio
                    <span class="text-gray-500 text-xs font-normal">(opcional)</span>
                </label>
                <textarea placeholder="Forne√ßa um contexto ou descri√ß√£o para este exerc√≠cio..." 
                          rows="2" class="w-full p-3 border border-gray-300 rounded-lg form-control question-description"></textarea>
            </div>
            
            <!-- Instru√ß√£o do Exerc√≠cio -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Instru√ß√£o do Exerc√≠cio *
                    <span class="text-gray-500 text-xs font-normal">(o que o aluno deve fazer)</span>
                </label>
                <textarea placeholder="Ex: Escreva um programa que imprima 'Hello World'" rows="3" class="w-full p-3 border border-gray-300 rounded-lg question-input"></textarea>
                <div class="validation-error question-error"></div>
            </div>
            
            <!-- C√≥digo Inicial (Opcional) - SEM numera√ß√£o -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    C√≥digo Inicial
                    <span class="text-gray-500 text-xs font-normal">(opcional - aparece para o aluno)</span>
                </label>
                <div class="code-editor-container">
                    <div class="code-editor-wrapper">
                        <textarea 
                            placeholder="# C√≥digo que o aluno vai ver inicialmente&#10;# Exemplo:&#10;print(&quot;Hello&quot;)&#10;&#10;for i in range(5):&#10;    print(i)" 
                            rows="6" 
                            class="code-textarea starter-code"
                            onkeydown="handleTabKey(this, event)"
                        ></textarea>
                    </div>
                </div>
            </div>
            
            <!-- Sa√≠da Esperada - SEM numera√ß√£o -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Sa√≠da Esperada *
                    <span class="text-gray-500 text-xs font-normal">(o que deve aparecer quando o c√≥digo rodar)</span>
                </label>
                <div class="code-editor-container">
                    <div class="code-editor-wrapper">
                        <textarea 
                            placeholder="Ex: Hello World&#10;0&#10;1&#10;2&#10;3&#10;4" 
                            rows="6" 
                            class="code-textarea expected-output"
                            onkeydown="handleTabKey(this, event)"
                        ></textarea>
                    </div>
                </div>
                <div class="validation-error output-error"></div>
            </div>
            
            <!-- Preview Simples -->
            <div class="bg-blue-50 p-4 rounded-lg">
                <h5 class="font-medium text-blue-800 mb-3">Como o aluno ver√°:</h5>
                <div class="bg-white p-4 rounded border border-blue-200">
                    <div class="mb-3">
                        <strong class="text-gray-700">Exerc√≠cio:</strong>
                        <p class="text-gray-600 mt-1 instruction-preview">Escreva um programa que imprima 'Hello World'</p>
                    </div>
                    <div class="mb-3">
                        <strong class="text-gray-700">Seu c√≥digo:</strong>
                        <div class="code-preview-container">
                            <div class="code-preview-wrapper">
                                <div class="code-preview-content">
                                    print("Hello")
                                </div>
                            </div>
                        </div>
                    </div>
                    <button class="bg-green-600 text-white px-4 py-2 mt-4 rounded hover:bg-green-700 transition run-button" 
                            onclick="simulateCodeExecution(this)">
                        ‚ñ∂ Executar C√≥digo
                    </button>
                    
                    <div class="output-preview mt-3 p-3 bg-gray-900 text-green-400 font-mono text-sm rounded hidden">
                        <div class="output-content">Hello</div>
                    </div>
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">XP da Quest√£o</label>
                <input type="number" min="10" max="100" value="30" class="w-24 p-2 border border-gray-300 rounded xp-input">
            </div>
        </div>
    </div>
</template>

<!-- Template para Completar Lacunas - ATUALIZADO COM DESCRI√á√ÉO -->
<!-- Template para Completar Lacunas - SEM numera√ß√£o -->
<template id="fill-blank-template">
    <div class="question-item" data-type="fill-blank">
        <div class="flex items-start justify-between mb-4">
            <div class="flex items-center gap-3">
                <div class="drag-handle">
                    <img src="{% static 'imagem/drag_handle_35dp_64748b_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Arrastar" class="w-5 h-5">
                </div>
                <h4 class="font-semibold text-blue-700">Completar Lacunas</h4>
            </div>

            <div class="flex items-center gap-2">
                <!-- Bot√£o de Dicas -->
                <div class="hints-section">
                    <button type="button" class="add-hint-btn bg-blue-100 text-blue-700 px-3 py-2 rounded-lg font-medium hover:bg-blue-200 transition interactive-card flex items-center gap-2 text-sm">
                        <img src="{% static 'imagem/lightbulb_35dp_2682EA_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Dicas" class="w-4 h-4">
                        Dicas
                        <span class="hint-counter bg-blue-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">0</span>
                    </button>
                </div>
                
                <button type="button" onclick="removeQuestion(this)" class="text-red-500 hover:text-red-700 interactive-card p-2 rounded-lg hover:bg-red-50 transition" aria-label="Remover quest√£o">
                    <img src="{% static 'imagem/delete_35dp_ef4444_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Remover" class="w-5 h-5">
                </button>
            </div>
        </div>
        
        <!-- Container de Dicas -->
        <div class="hints-container bg-blue-50 p-4 rounded-lg mb-4 hidden">
            <div class="flex justify-between items-center mb-3">
                <label class="font-medium text-blue-800 flex items-center gap-2">
                    <img src="{% static 'imagem/lightbulb_35dp_2682EA_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Dicas" class="w-4 h-4">
                    Dicas para o aluno (m√°x. 3)
                </label>
                <button type="button" class="add-hint bg-blue-600 text-white text-sm px-3 py-1 rounded hover:bg-blue-700 transition flex items-center gap-1">
                    <img src="{% static 'imagem/add_35dp_FFFFFF_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Adicionar" class="w-3 h-3">
                    Adicionar
                </button>
            </div>
            <div class="hints-list space-y-2"></div>
        </div>
        
        <div class="space-y-4">
            <!-- Descri√ß√£o da Quest√£o -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Descri√ß√£o/Contexto da Quest√£o
                    <span class="text-gray-500 text-xs font-normal">(opcional)</span>
                </label>
                <textarea placeholder="Forne√ßa um contexto ou descri√ß√£o para esta quest√£o..." 
                          rows="2" class="w-full p-3 border border-gray-300 rounded-lg form-control question-description"></textarea>
            </div>
            
            <!-- Texto com Lacunas - SEM numera√ß√£o -->
            <div>
                <div class="flex justify-between items-center mb-2">
                    <label class="block text-sm font-medium text-gray-700">
                        Texto com Lacunas *
                    </label>
                    <button type="button" onclick="addBlankToText(this)" class="text-blue-600 text-sm font-medium interactive-card flex items-center gap-1">
                        <img src="{% static 'imagem/add_35dp_2682EA_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Adicionar" class="w-4 h-4">
                        Adicionar Lacuna
                    </button>
                </div>
                
                <!-- Container do editor SEM numera√ß√£o -->
                <div class="code-editor-container">
                    <div class="code-editor-wrapper">
                        <textarea 
                            placeholder="Digite o texto aqui. Use o bot√£o 'Adicionar Lacuna' para criar as lacunas.&#10;&#10;Exemplo para c√≥digo:&#10;if idade >= 18:&#10;    print(&quot;Maior de idade&quot;)&#10;else:&#10;    print(&quot;Menor de idade&quot;)" 
                            rows="8" 
                            class="code-textarea question-input fill-blank-textarea large-textarea"
                            onkeydown="handleTabKey(this, event)"
                        ></textarea>
                    </div>
                </div>
                
                <div class="text-xs text-gray-500 mt-1">
                    üí° Clique em "Adicionar Lacuna" para inserir uma lacuna onde estiver o cursor
                </div>
                <div class="validation-error question-error"></div>
            </div>
            
            <!-- Respostas Corretas -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Respostas Corretas *
                    <span class="text-gray-500 text-xs font-normal">(uma para cada lacuna, na ordem)</span>
                </label>
                <div class="space-y-2 answers-container">
                    <div class="flex items-center gap-2">
                        <span class="text-sm font-medium text-gray-600 w-6">1.</span>
                        <input type="text" placeholder="Resposta para a primeira lacuna" class="flex-1 p-2 border border-gray-300 rounded answer-input">
                        <button type="button" onclick="removeAnswer(this)" class="text-red-500 hover:text-red-700 interactive-card p-1" aria-label="Remover resposta">√ó</button>
                    </div>
                </div>
                <div class="validation-error answers-error"></div>
            </div>
            
            <!-- Preview - Como o aluno ver√° - SEM numera√ß√£o -->
            <div class="bg-blue-50 p-4 rounded-lg">
                <h5 class="font-medium text-blue-800 mb-3">Como o aluno ver√°:</h5>
                <div class="bg-white p-4 rounded border border-blue-200">
                    <div class="code-preview-container">
                        <div class="code-preview-wrapper">
                            <div class="code-preview-content text-preview large-preview">
                                Para imprimir algo em Python, usamos a fun√ß√£o <span class="blank-preview">_____</span>("texto")
                            </div>
                        </div>
                    </div>
                    <div class="word-bank-container mt-3">
                        <!-- Banco de palavras ser√° gerado aqui -->
                    </div>
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">XP da Quest√£o</label>
                <input type="number" min="5" max="30" value="15" class="w-24 p-2 border border-gray-300 rounded xp-input">
            </div>
        </div>
    </div>
</template>

{% endblock %}

{% block extra_js %}
<script>
// ========== CONFIGURA√á√ïES DJANGO ==========
const DJANGO_URLS = {
    getModulos: "{% url 'get_modulos_ajax' 0 %}".replace('/0/', '/'),
    criarCapitulo: "{% url 'criar_capitulo_ajax' %}",
    criarModulo: "{% url 'criar_modulo_ajax' %}",
    criarConteudo: "{% url 'criar_conteudo' %}"
};

// ========== ESTADO GLOBAL ==========
let currentStep = 1;
let questions = [];
let autoSaveEnabled = true;
let autoSaveInterval;
let selectedChapterId = '';
let selectedChapterName = '';
let topicCounter = 1;
let questionCounter = 0;

// ========== INICIALIZA√á√ÉO ==========
document.addEventListener('DOMContentLoaded', function() {
    console.log('Inicializando Criar Conte√∫do...');
    updateProgressBar();
    setupAutoSave();
    setupDragAndDrop();
    initializeSelects();
    setupEventListeners();
    loadExistingChapters();
    
    // Inicializar editor do primeiro t√≥pico
    const firstTopic = document.querySelector('.topic-item');
    if (firstTopic) {
        initializeEditor(firstTopic);
    }
});

// ========== CONFIGURA√á√ÉO DE EVENTOS ==========
function setupEventListeners() {
    // Cap√≠tulo
    const chapterSelect = document.getElementById('chapter-select');
    if (chapterSelect) {
        chapterSelect.addEventListener('change', function() {
            console.log('Cap√≠tulo selecionado:', this.value);
            if (this.value === 'new') {
                openChapterModal();
            } else {
                selectedChapterId = this.value;
                selectedChapterName = this.options[this.selectedIndex].text;
                updateModuleSelect(this.value);
            }
        });
    }


    // Event listener para o formul√°rio
    const contentForm = document.getElementById('content-form');
    if (contentForm) {
        contentForm.addEventListener('submit', function(e) {
            console.log("Formul√°rio sendo enviado...");
            prepareFormData();
        });
    }


    // XP te√≥rico - atualizar revis√£o quando mudar
    const theoryXp = document.getElementById('theory-xp');
    if (theoryXp) {
        theoryXp.addEventListener('input', function() {
            if (currentStep === 4) {
                updateReview();
            }
        });
    }
    // M√≥dulo
    const moduleSelect = document.getElementById('module-select');
    if (moduleSelect) {
        moduleSelect.addEventListener('change', function() {
            if (this.value === 'new') {
                openModuleModal();
            }
        });
    }

    // Formul√°rios de modais
    const newChapterForm = document.getElementById('new-chapter-form');
    if (newChapterForm) {
        newChapterForm.addEventListener('submit', function(e) {
            e.preventDefault();
            createNewChapter();
        });
    }

    const newModuleForm = document.getElementById('new-module-form');
    if (newModuleForm) {
        newModuleForm.addEventListener('submit', function(e) {
            e.preventDefault();
            createNewModule();
        });
    }

    // Bot√£o adicionar t√≥pico
    const addTopicBtn = document.getElementById('add-topic-btn');
    if (addTopicBtn) {
        addTopicBtn.addEventListener('click', addTopic);
    }

    // Confirma√ß√£o de revis√£o - ATUALIZADO
    const confirmReview = document.getElementById('confirm-review');
    if (confirmReview) {
        confirmReview.addEventListener('change', function() {
            updateValidationChecklist();
        });
    }

    // Event delegation para elementos din√¢micos
    document.addEventListener('click', function(e) {
        // Remover t√≥pico
        if (e.target.closest('.remove-topic')) {
            const btn = e.target.closest('.remove-topic');
            removeTopic(btn);
        }
        
        // Adicionar op√ß√£o em m√∫ltipla escolha - CORRE√á√ÉO
        if (e.target.closest('.add-option-btn')) {
            const btn = e.target.closest('.add-option-btn');
            addOption(btn);
            e.preventDefault();
            e.stopPropagation();
        }
        
        // Remover op√ß√£o
        if (e.target.closest('.remove-option')) {
            const btn = e.target.closest('.remove-option');
            removeOption(btn);
            e.preventDefault();
            e.stopPropagation();
        }
        
        // Radio button de op√ß√£o correta
        if (e.target.closest('.correct-option-radio')) {
            const radio = e.target.closest('.correct-option-radio');
            highlightCorrectOption(radio);
        }
        
        // Dicas - CORRE√á√ÉO COMPLETA
        if (e.target.closest('.add-hint-btn')) {
            const btn = e.target.closest('.add-hint-btn');
            toggleHintsContainer(btn);
            e.preventDefault();
            e.stopPropagation();
        }
        
        if (e.target.closest('.add-hint')) {
            const btn = e.target.closest('.add-hint');
            addHint(btn);
            e.preventDefault();
            e.stopPropagation();
        }
        
        if (e.target.closest('.remove-hint')) {
            const btn = e.target.closest('.remove-hint');
            removeHint(btn);
            e.preventDefault();
            e.stopPropagation();
        }
        
        
        // Remover quest√£o
        if (e.target.closest('button') && e.target.closest('button').onclick && 
            e.target.closest('button').onclick.toString().includes('removeQuestion')) {
            const btn = e.target.closest('button');
            removeQuestion(btn);
            e.preventDefault();
            e.stopPropagation();
        }
        
        // Remover resposta de completar lacunas
        if (e.target.closest('.remove-answer')) {
            const btn = e.target.closest('.remove-answer');
            removeAnswer(btn);
            e.preventDefault();
            e.stopPropagation();
        }
    });

    // Inputs em tempo real para preview
    document.addEventListener('input', function(e) {
        // Preview de c√≥digo
        if (e.target.classList.contains('question-input') || 
            e.target.classList.contains('starter-code') || 
            e.target.classList.contains('expected-output')) {
            
            const questionEl = e.target.closest('.question-item');
            if (questionEl && questionEl.dataset.type === 'code') {
                updateCodePreview(questionEl);
            }
        }
        
        // Preview de completar lacunas
        if (e.target.classList.contains('fill-blank-textarea')) {
            const questionEl = e.target.closest('.question-item');
            if (questionEl && questionEl.dataset.type === 'fill-blank') {
                updateFillBlankPreview(questionEl);
                updateAnswerInputs(questionEl);
            }
        }
        
        // Validar dicas em tempo real
        if (e.target.classList.contains('hint-input')) {
            validateQuestionHints(e.target.closest('.question-item'));
        }
        
        // Atualizar revis√£o quando no passo 4
        if (currentStep === 4) {
            updateReview();
        }
    });
}

// ========== FUN√á√ïES DJANGO ==========
function getCSRFToken() {
    const token = document.querySelector('[name=csrfmiddlewaretoken]');
    return token ? token.value : '';
}

async function loadExistingChapters() {
    console.log('Cap√≠tulos carregados via template Django');
}

async function updateModuleSelect(chapterId) {
    const moduleSelect = document.getElementById('module-select');
    if (!moduleSelect) return;

    // Limpar m√≥dulos existentes
    moduleSelect.innerHTML = '<option value="" selected disabled>Carregando m√≥dulos...</option>';
    moduleSelect.disabled = true;

    if (chapterId && chapterId !== 'new') {
        try {
            const response = await fetch(DJANGO_URLS.getModulos + chapterId + '/');
            const modulos = await response.json();
            
            moduleSelect.innerHTML = '<option value="" selected disabled>Selecione um m√≥dulo</option>';
            
            modulos.forEach(modulo => {
                const option = new Option(modulo.titulo, modulo.id);
                moduleSelect.add(option);
            });
            
            // Adicionar op√ß√£o de criar novo m√≥dulo
            const newOption = new Option('+ Criar Novo M√≥dulo', 'new');
            moduleSelect.add(newOption);
            
            moduleSelect.disabled = false;
        } catch (error) {
            console.error('Erro ao carregar m√≥dulos:', error);
            moduleSelect.innerHTML = '<option value="" selected disabled>Erro ao carregar m√≥dulos</option>';
        }
    } else {
        moduleSelect.innerHTML = '<option value="" selected disabled>Selecione um cap√≠tulo primeiro</option>';
    }
}

async function createNewChapter() {
    const titleInput = document.getElementById('new-chapter-title');
    const descriptionInput = document.getElementById('new-chapter-description');
    const difficultyInput = document.getElementById('new-chapter-difficulty');
    
    if (!titleInput || !descriptionInput || !difficultyInput) {
        console.error('Elementos do modal de cap√≠tulo n√£o encontrados');
        return;
    }
    
    const title = titleInput.value.trim();
    const description = descriptionInput.value.trim();
    const difficulty = difficultyInput.value;
    
    // Limpar erros anteriores
    clearError('new-chapter-title-error');
    clearError('new-chapter-difficulty-error');
    titleInput.classList.remove('error');
    difficultyInput.classList.remove('error');
    
    // Valida√ß√µes espec√≠ficas do modal
    let isValid = true;
    
    if (!title) {
        showError('new-chapter-title-error', 'Digite um t√≠tulo para o cap√≠tulo');
        titleInput.classList.add('error');
        isValid = false;
    }

    if (!difficulty) {
        showError('new-chapter-difficulty-error', 'Selecione o n√≠vel de dificuldade');
        difficultyInput.classList.add('error');
        isValid = false;
    }
    
    if (!isValid) {
        console.log('Valida√ß√£o do modal de cap√≠tulo falhou');
        return;
    }
    
    try {
        console.log('Enviando dados do cap√≠tulo:', { titulo: title, descricao: description, dificuldade: difficulty });
        
        const response = await fetch(DJANGO_URLS.criarCapitulo, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({ 
                titulo: title, 
                descricao: description,
                dificuldade: difficulty
            })
        });
        
        if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status}`);
        }
        
        const resultado = await response.json();
        console.log('Resposta do servidor:', resultado);
        
        if (resultado.success) {
            // Adicionar o novo cap√≠tulo ao select
            const chapterSelect = document.getElementById('chapter-select');
            
            // Remover op√ß√£o de "Carregando..." se existir
            const loadingOption = chapterSelect.querySelector('option[value=""]');
            if (loadingOption && loadingOption.disabled) {
                loadingOption.remove();
            }
            
            // Adicionar a nova op√ß√£o
            const newOption = new Option(resultado.capitulo.titulo, resultado.capitulo.id);
            chapterSelect.add(newOption);
            
            // Selecionar o novo cap√≠tulo
            chapterSelect.value = resultado.capitulo.id;
            
            // Atualizar vari√°veis globais
            selectedChapterId = resultado.capitulo.id;
            selectedChapterName = resultado.capitulo.titulo;
            
            // Fechar modal e limpar formul√°rio
            closeChapterModal();
            
            // Atualizar m√≥dulos para o novo cap√≠tulo
            await updateModuleSelect(resultado.capitulo.id);
            
            showSaveIndicator('Cap√≠tulo criado com sucesso!');
            
            console.log('Cap√≠tulo criado com ID:', resultado.capitulo.id);
            
        } else {
            throw new Error(resultado.error || 'Erro desconhecido ao criar cap√≠tulo');
        }
    } catch (error) {
        console.error('Erro ao criar cap√≠tulo:', error);
        alert('Erro ao criar cap√≠tulo: ' + error.message);
    }
}



async function createNewModule() {
    const titleInput = document.getElementById('new-module-title');
    const descriptionInput = document.getElementById('new-module-description');
    
    if (!titleInput || !descriptionInput) return;
    
    const title = titleInput.value.trim();
    const description = descriptionInput.value.trim();
    
    if (!title) {
        showError('new-module-title-error', 'Digite um t√≠tulo para o m√≥dulo');
        titleInput.classList.add('error');
        return;
    }
    
    if (!selectedChapterId) {
        alert('Selecione um cap√≠tulo primeiro.');
        return;
    }
    
    try {
        const response = await fetch(DJANGO_URLS.criarModulo, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                capitulo_id: selectedChapterId,
                titulo: title,
                descricao: description
            })
        });
        
        const resultado = await response.json();
        
        if (resultado.success) {
            const moduleSelect = document.getElementById('module-select');
            const newOption = new Option(resultado.modulo.titulo, resultado.modulo.id);
            moduleSelect.add(newOption);
            
            if (moduleSelect.querySelector('option[value=""]')) {
                moduleSelect.querySelector('option[value=""]').selected = false;
            }
            moduleSelect.value = resultado.modulo.id;
            
            closeModuleModal();
            showSaveIndicator('M√≥dulo criado com sucesso!');
        } else {
            alert('Erro ao criar m√≥dulo: ' + resultado.error);
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao criar m√≥dulo.');
    }
}

// ========== NAVEGA√á√ÉO E PASSOS ==========
function goToStep(step) {
    // Esconder todos os passos
    document.querySelectorAll('[id^="step-"]').forEach(el => {
        el.classList.add('hidden');
    });
    
    // Atualizar indicadores
    document.querySelectorAll('.step').forEach(el => {
        el.classList.remove('active', 'completed');
    });
    
    // Mostrar passo atual
    const currentStepEl = document.getElementById(`step-${step}`);
    if (currentStepEl) {
        currentStepEl.classList.remove('hidden');
    }
    
    // Atualizar indicadores visuais
    for (let i = 1; i <= 4; i++) {
        const stepElement = document.querySelector(`.step[data-step="${i}"]`);
        if (stepElement) {
            if (i === step) {
                stepElement.classList.add('active');
            } else if (i < step) {
                stepElement.classList.add('completed');
            }
        }
    }
    
    currentStep = step;
    updateProgressBar();
    
    // A√ß√µes espec√≠ficas por passo
    if (step === 4) {
        updateReview();
    }
    
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function nextStep() {
    if (currentStep < 4) {
        goToStep(currentStep + 1);
    }
}

function prevStep(step) {
    if (currentStep > 1) {
        goToStep(currentStep - 1);
    }
}

// ========== VALIDA√á√ÉO DE PASSOS ==========
function validateStep1() {
    let isValid = true;
    clearErrors();
    
    const chapterSelect = document.getElementById('chapter-select');
    const moduleSelect = document.getElementById('module-select');
    const lessonTitle = document.getElementById('lesson-title');
    
    console.log("Validando passo 1:");
    console.log("Cap√≠tulo:", chapterSelect.value);
    console.log("M√≥dulo:", moduleSelect.value);
    console.log("T√≠tulo aula:", lessonTitle.value);
    
    // Validar cap√≠tulo - N√ÉO validar se estiver no meio da cria√ß√£o
    if (!chapterSelect.value || chapterSelect.value === '') {
        showError('chapter-error', 'Selecione um cap√≠tulo');
        chapterSelect.classList.add('error');
        isValid = false;
    } else if (chapterSelect.value === 'new') {
        // Se ainda est√° criando, considerar como inv√°lido
        showError('chapter-error', 'Finalize a cria√ß√£o do cap√≠tulo primeiro');
        chapterSelect.classList.add('error');
        isValid = false;
    }
    
    // Resto do c√≥digo permanece igual...
    // Validar m√≥dulo
    if (!moduleSelect.value || moduleSelect.value === '') {
        showError('module-error', 'Selecione um m√≥dulo');
        moduleSelect.classList.add('error');
        isValid = false;
    } else if (moduleSelect.value === 'new') {
        showError('module-error', 'Crie um novo m√≥dulo primeiro');
        moduleSelect.classList.add('error');
        isValid = false;
    }
    
    // Validar t√≠tulo da aula (OBRIGAT√ìRIO)
    if (!lessonTitle.value.trim()) {
        showError('lesson-title-error', 'Digite o t√≠tulo da aula');
        lessonTitle.classList.add('error');
        isValid = false;
    }
    
    if (isValid) {
        console.log("Passo 1 v√°lido, indo para passo 2");
        goToStep(2);
    } else {
        console.log("Erros no passo 1");
        scrollToFirstError();
    }
    
    return isValid;
}

function validateStep2() {
    let isValid = true;
    clearErrors();
    
    // Usar o campo correto para tempo te√≥rico
    const estimatedTimeTheory = document.getElementById('estimated-time-theory');
    
    console.log("Validando passo 2:");
    console.log("Tempo te√≥rico estimado:", estimatedTimeTheory.value);
    
    // Validar tempo te√≥rico estimado
    if (!estimatedTimeTheory.value || estimatedTimeTheory.value < 1 || estimatedTimeTheory.value > 120) {
        showError('time-theory-error', 'Tempo estimado deve ser entre 1 e 120 minutos');
        estimatedTimeTheory.classList.add('error');
        isValid = false;
    }
    
    // Validar que h√° conte√∫do nos t√≥picos
    const topicItems = document.querySelectorAll('.topic-item');
    let hasContent = false;
    let emptyTitles = [];
    
    topicItems.forEach((topic, index) => {
        const editor = topic.querySelector('.topic-editor');
        const titleInput = topic.querySelector('.topic-title');
        const content = editor ? editor.innerHTML : '';
        
        // Validar t√≠tulo do t√≥pico
        if (!titleInput.value.trim()) {
            titleInput.style.border = '2px solid #ef4444';
            emptyTitles.push(index + 1);
            isValid = false;
        } else {
            titleInput.style.border = '';
        }
        
        // Validar conte√∫do - verificar se tem conte√∫do real (n√£o apenas HTML vazio)
        const hasRealContent = content && 
                              content !== 'Comece a escrever o conte√∫do deste t√≥pico aqui...' && 
                              content.replace(/<[^>]*>/g, '').trim().length > 0;
        
        if (hasRealContent) {
            hasContent = true;
        }
    });
    
    if (emptyTitles.length > 0) {
        showError('theory-content-error', `Preencha os t√≠tulos dos t√≥picos: ${emptyTitles.join(', ')}`);
        isValid = false;
    }
    
    if (!hasContent) {
        showError('theory-content-error', 'Adicione conte√∫do em pelo menos um t√≥pico');
        isValid = false;
    }
    
    if (isValid) {
        console.log("Passo 2 v√°lido, indo para passo 3");
        goToStep(3);
    } else {
        console.log("Erros no passo 2");
        scrollToFirstError();
    }
    
    return isValid;
}

// Fun√ß√£o para debug - ver conte√∫do dos t√≥picos
function debugTopicContent() {
    const topicItems = document.querySelectorAll('.topic-item');
    console.log("=== DEBUG T√ìPICOS ===");
    
    topicItems.forEach((topic, index) => {
        const titulo = topic.querySelector('.topic-title').value;
        const editor = topic.querySelector('.topic-editor');
        const conteudo = editor ? editor.innerHTML : '';
        
        console.log(`T√≥pico ${index + 1}: "${titulo}"`);
        console.log(`Conte√∫do (${conteudo.length} chars):`, conteudo.substring(0, 200));
        console.log('---');
    });
}

// Chame debugTopicContent() no console para verificar os dados

function validateStep3() {
    let isValid = true;
    clearErrors();
    
    const practiceTitle = document.getElementById('titulo-pratica');
    const timePractice = document.getElementById('estimated-time-practice'); // NOVO
    const questionItems = document.querySelectorAll('#questions-list .question-item');
    
    console.log("Validando passo 3:");
    console.log("T√≠tulo pr√°tica:", practiceTitle.value);
    console.log("Tempo pr√°tico:", timePractice.value); // NOVO
    console.log("Total quest√µes:", questionItems.length);
    
    // Validar t√≠tulo da pr√°tica
    if (!practiceTitle.value.trim()) {
        showError('practice-title-error', 'Digite o t√≠tulo da lista de exerc√≠cios');
        practiceTitle.classList.add('error');
        isValid = false;
    }
    
    // NOVO: Validar tempo pr√°tico
    if (!timePractice.value || timePractice.value < 1 || timePractice.value > 120) {
        showError('time-practice-error', 'Tempo pr√°tico deve ser entre 1 e 120 minutos');
        timePractice.classList.add('error');
        isValid = false;
    }
    
    // Validar que h√° pelo menos uma quest√£o
    if (questionItems.length === 0) {
        alert('Adicione pelo menos um exerc√≠cio pr√°tico antes de continuar.');
        isValid = false;
        return false;
    }
    
    // Resto do c√≥digo permanece igual...
    // Validar cada quest√£o individualmente
    let allValid = true;
    let firstInvalidQuestion = null;
    
    questionItems.forEach((questionEl, index) => {
        const type = questionEl.dataset.type;
        let questionValid = true;
        
        clearQuestionErrors(questionEl);
        
        // Validar quest√£o b√°sica
        if (type === 'multiple-choice') {
            questionValid = validateMultipleChoice(questionEl);
        } else if (type === 'code') {
            questionValid = validateCodeQuestion(questionEl);
        } else if (type === 'fill-blank') {
            questionValid = validateFillBlank(questionEl);
        }
        
        // Validar dicas (3 dicas obrigat√≥rias)
        if (!validateQuestionHints(questionEl)) {
            questionValid = false;
            showQuestionError(questionEl, 'hints-error', '√â obrigat√≥rio preencher exatamente 3 dicas para cada quest√£o');
        }
        
        if (!questionValid) {
            allValid = false;
            if (!firstInvalidQuestion) {
                firstInvalidQuestion = questionEl;
            }
        }
    });
    
    if (!allValid) {
        if (firstInvalidQuestion) {
            firstInvalidQuestion.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center' 
            });
            
            // Destacar quest√£o com erro
            firstInvalidQuestion.style.border = '2px solid #ef4444';
            firstInvalidQuestion.style.borderRadius = '8px';
            setTimeout(() => {
                firstInvalidQuestion.style.border = '';
            }, 3000);
        }
        
        alert('Corrija os erros nas quest√µes antes de continuar. Lembre-se: s√£o obrigat√≥rias 3 dicas preenchidas para cada quest√£o.');
        return false;
    }
    
    if (isValid) {
        console.log("Passo 3 v√°lido, indo para passo 4");
        goToStep(4);
        updateReview();
    } else {
        console.log("Erros no passo 3");
        scrollToFirstError();
    }
    
    return isValid;
}

// ========== FUN√á√ïES DE VALIDA√á√ÉO ESPEC√çFICAS ==========
function validateMultipleChoice(questionEl) {
    let isValid = true;
    const questionInput = questionEl.querySelector('.question-input');
    const options = questionEl.querySelectorAll('.option-input');
    const hasCorrectOption = questionEl.querySelector('.correct-option-radio:checked');
    
    if (!questionInput.value.trim()) {
        showQuestionError(questionEl, 'question-error', 'Digite a pergunta');
        isValid = false;
    }
    
    if (options.length < 2) {
        showQuestionError(questionEl, 'options-error', 'Adicione pelo menos 2 op√ß√µes');
        isValid = false;
    } else {
        let emptyOptions = false;
        options.forEach(option => {
            if (!option.value.trim()) {
                option.classList.add('error');
                emptyOptions = true;
            }
        });
        
        if (emptyOptions) {
            showQuestionError(questionEl, 'options-error', 'Preencha todas as op√ß√µes');
            isValid = false;
        }
    }
    
    if (!hasCorrectOption) {
        showQuestionError(questionEl, 'options-error', 'Selecione a op√ß√£o correta');
        isValid = false;
    }
    
    return isValid;
}

function validateCodeQuestion(questionEl) {
    let isValid = true;
    const questionInput = questionEl.querySelector('.question-input');
    const expectedOutput = questionEl.querySelector('.expected-output');
    
    if (!questionInput.value.trim()) {
        showQuestionError(questionEl, 'question-error', 'Digite as instru√ß√µes do exerc√≠cio');
        isValid = false;
    }
    
    if (!expectedOutput.value.trim()) {
        showQuestionError(questionEl, 'output-error', 'Digite a sa√≠da esperada');
        isValid = false;
    }
    
    return isValid;
}

function validateFillBlank(questionEl) {
    let isValid = true;
    const questionInput = questionEl.querySelector('.question-input');
    const answerInputs = questionEl.querySelectorAll('.answer-input');
    
    if (!questionInput.value.trim()) {
        showQuestionError(questionEl, 'question-error', 'Digite o texto com lacunas');
        isValid = false;
    } else {
        const blankCount = (questionInput.value.match(/\[_____\]/g) || []).length;
        if (blankCount === 0) {
            showQuestionError(questionEl, 'question-error', 'Adicione pelo menos uma lacuna');
            isValid = false;
        }
    }
    
    let emptyAnswers = false;
    answerInputs.forEach(input => {
        if (!input.value.trim()) {
            input.classList.add('error');
            emptyAnswers = true;
        }
    });
    
    if (emptyAnswers) {
        showQuestionError(questionEl, 'answers-error', 'Preencha todas as respostas');
        isValid = false;
    }
    
    return isValid;
}

// ========== GERENCIAMENTO DE T√ìPICOS ==========
function addTopic() {
    const topicsContainer = document.getElementById('topics-container');
    const template = document.getElementById('topic-template');
    
    if (!topicsContainer || !template) return;
    
    const newTopic = template.content.cloneNode(true);
    const topicElement = newTopic.querySelector('.topic-item');
    
    // Atualizar √≠ndice do t√≥pico
    topicCounter++;
    topicElement.setAttribute('data-topic-index', topicCounter);
    
    // Configurar eventos do novo t√≥pico
    const removeBtn = topicElement.querySelector('.remove-topic');
    const titleInput = topicElement.querySelector('.topic-title');
    
    // Configurar eventos
    removeBtn.addEventListener('click', function() {
        removeTopic(this);
    });
    
    // Inicializar editor
    initializeEditor(topicElement);
    
    // Adicionar ao container
    topicsContainer.appendChild(newTopic);
    
    // Focar no t√≠tulo do novo t√≥pico
    setTimeout(() => {
        titleInput.focus();
    }, 100);
    
    showSaveIndicator('Novo t√≥pico adicionado');
}

function removeTopic(button) {
    const topicElement = button.closest('.topic-item');
    const topicsContainer = document.getElementById('topics-container');
    const topicCount = topicsContainer.querySelectorAll('.topic-item').length;
    
    if (!topicElement || !topicsContainer) return;
    
    // N√£o permitir remover se s√≥ tiver um t√≥pico
    if (topicCount <= 1) {
        alert('√â necess√°rio ter pelo menos um t√≥pico.');
        return;
    }
    
    topicElement.remove();
    showSaveIndicator('T√≥pico removido');
}

function initializeEditor(topicElement) {
    const editor = topicElement.querySelector('.topic-editor');
    const toolbar = topicElement.querySelector('.editor-toolbar');
    
    if (!editor || !toolbar) return;
    
    // Configurar Tab no editor
    editor.addEventListener('keydown', function(e) {
        if (e.key === 'Tab') {
            e.preventDefault();
            insertSpacesInEditor(this, 4);
        }
    });
    
    // Configurar eventos da barra de ferramentas
    const formatSelect = toolbar.querySelector('.format-block');
    const boldBtn = toolbar.querySelector('[data-command="bold"]');
    const italicBtn = toolbar.querySelector('[data-command="italic"]');
    const underlineBtn = toolbar.querySelector('[data-command="underline"]');
    const bulletListBtn = toolbar.querySelector('[data-command="insertUnorderedList"]');
    const numberListBtn = toolbar.querySelector('[data-command="insertOrderedList"]');
    
    // Evento de formata√ß√£o de bloco
    if (formatSelect) {
        formatSelect.addEventListener('change', function() {
            document.execCommand('formatBlock', false, this.value);
            editor.focus();
        });
    }
    
    // Eventos dos bot√µes de formata√ß√£o
    if (boldBtn) {
        boldBtn.addEventListener('click', function() {
            document.execCommand('bold', false, null);
            editor.focus();
        });
    }
    
    if (italicBtn) {
        italicBtn.addEventListener('click', function() {
            document.execCommand('italic', false, null);
            editor.focus();
        });
    }
    
    if (underlineBtn) {
        underlineBtn.addEventListener('click', function() {
            document.execCommand('underline', false, null);
            editor.focus();
        });
    }
    
    if (bulletListBtn) {
        bulletListBtn.addEventListener('click', function() {
            document.execCommand('insertUnorderedList', false, null);
            editor.focus();
        });
    }
    
    if (numberListBtn) {
        numberListBtn.addEventListener('click', function() {
            document.execCommand('insertOrderedList', false, null);
            editor.focus();
        });
    }
    
    // Evento para atualizar contador de palavras
    editor.addEventListener('input', function() {
        updateWordCount(topicElement);
    });
    
    // Inicializar contador de palavras
    updateWordCount(topicElement);
}

// Fun√ß√£o para inserir espa√ßos no editor
function insertSpacesInEditor(editor, spacesCount) {
    const selection = window.getSelection();
    if (selection.rangeCount === 0) return;
    
    const range = selection.getRangeAt(0);
    const spaces = ' '.repeat(spacesCount);
    const textNode = document.createTextNode(spaces);
    
    range.insertNode(textNode);
    range.setStartAfter(textNode);
    range.setEndAfter(textNode);
    selection.removeAllRanges();
    selection.addRange(range);
    
    // Disparar evento de input
    const inputEvent = new Event('input', { bubbles: true });
    editor.dispatchEvent(inputEvent);
}

function updateWordCount(topicElement) {
    const editor = topicElement.querySelector('.topic-editor');
    const wordCount = topicElement.querySelector('.word-count-display');
    
    if (!editor || !wordCount) return;
    
    const text = editor.textContent || '';
    const words = text.trim() ? text.trim().split(/\s+/).length : 0;
    if (wordCount) {
        wordCount.textContent = `${words} palavras`;
    }
}

// ========== GERENCIAMENTO DE QUEST√ïES ==========
function addQuestion(type) {
    const template = document.getElementById(`${type}-template`);
    const questionsList = document.getElementById('questions-list');
    
    if (!template || !questionsList) return;
    
    // Remover estado vazio
    const emptyState = questionsList.querySelector('.empty-state');
    if (emptyState) {
        emptyState.remove();
    }
    
    const questionEl = template.content.cloneNode(true);
    questionsList.appendChild(questionEl);
    
    const newQuestion = questionsList.lastElementChild;
    questionCounter++;
    
    // Dar um ID √∫nico para a quest√£o
    newQuestion.id = `question-${questionCounter}`;
    
    // Inicializa√ß√£o espec√≠fica por tipo
    if (type === 'multiple-choice') {
        initializeMultipleChoiceQuestion(newQuestion);
    } else if (type === 'code') {
        initializeCodeQuestion(newQuestion);
    } else if (type === 'fill-blank') {
        initializeFillBlankQuestion(newQuestion);
    }
    
    // Inicializar dicas
    initializeQuestionHints(newQuestion);
    
    updateQuestionCount();
    validateQuestionHints(newQuestion);
    
    showSaveIndicator(`Quest√£o de ${getQuestionTypeName(type)} adicionada`);
    
    // Scroll para a nova quest√£o
    setTimeout(() => {
        newQuestion.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 100);
}

function removeQuestion(button) {
    const questionEl = button.closest('.question-item');
    const questionsList = document.getElementById('questions-list');
    
    if (!questionEl || !questionsList) return;
    
    questionEl.remove();
    updateQuestionCount();
    
    // Mostrar estado vazio se necess√°rio
    if (questionsList.querySelectorAll('.question-item').length === 0) {
        showEmptyState();
    }
    
    showSaveIndicator('Quest√£o removida');
}

function updateQuestionCount() {
    const questionCount = document.querySelectorAll('#questions-list .question-item').length;
    const questionCounter = document.getElementById('question-count');
    if (questionCounter) {
        questionCounter.textContent = questionCount;
    }
}

function showEmptyState() {
    const questionsList = document.getElementById('questions-list');
    if (!questionsList) return;
    
    questionsList.innerHTML = `
        <div class="empty-state">
            <img src="{% static 'imagem/note_stack_100dp_64748b_FILL0_wght400_GRAD0_opsz48.png' %}" alt="Sem exerc√≠cios" class="w-16 h-16 mx-auto">
            <p class="text-gray-500">Nenhum exerc√≠cio adicionado ainda</p>
            <p class="text-sm text-gray-400">Clique em um dos tipos acima para come√ßar</p>
        </div>
    `;
}

function getQuestionTypeName(type) {
    const names = {
        'multiple-choice': 'M√∫ltipla Escolha',
        'code': 'Programa√ß√£o',
        'fill-blank': 'Completar Lacunas'
    };
    return names[type] || 'Exerc√≠cio';
}

// ========== QUEST√ïES DE M√öLTIPLA ESCOLHA ==========
function initializeMultipleChoiceQuestion(questionEl) {
    if (!questionEl.id) {
        questionEl.id = 'question-' + Date.now();
    }
    
    // Configurar radio buttons
    const radioInputs = questionEl.querySelectorAll('.correct-option-radio');
    radioInputs.forEach(radio => {
        radio.name = `correct-answer-${questionEl.id}`;
        if (radio.checked) {
            highlightCorrectOption(radio);
        }
    });
    
    // Configurar bot√£o de adicionar op√ß√£o - CORRE√á√ÉO: remover event listeners antigos
    const addOptionBtn = questionEl.querySelector('.add-option-btn');
    if (addOptionBtn) {
        // Substituir o bot√£o para remover event listeners antigos
        const newBtn = addOptionBtn.cloneNode(true);
        addOptionBtn.parentNode.replaceChild(newBtn, addOptionBtn);
        
        // Adicionar novo event listener
        newBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            addOption(this);
        });
    }
    
    // Configurar bot√µes de remover op√ß√£o
    const removeOptionBtns = questionEl.querySelectorAll('.remove-option');
    removeOptionBtns.forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            removeOption(this);
        });
    });
}

function addOption(button) {
    console.log("Adicionando op√ß√£o...");
    const questionEl = button.closest('.question-item');
    const optionsContainer = questionEl.querySelector('.options-container');
    
    if (!optionsContainer) {
        console.error('Container de op√ß√µes n√£o encontrado');
        return;
    }
    
    const questionId = questionEl.id || 'question-' + Date.now();
    const optionCount = optionsContainer.children.length + 1;
    
    const optionEl = document.createElement('div');
    optionEl.className = 'option-item';
    optionEl.innerHTML = `
        <input type="radio" name="correct-answer-${questionId}" class="text-blue-600 correct-option-radio">
        <input type="text" placeholder="Op√ß√£o ${optionCount}" class="flex-1 p-2 border border-gray-300 rounded option-input">
        <button type="button" class="remove-option text-red-500 hover:text-red-700 interactive-card p-1" aria-label="Remover op√ß√£o">√ó</button>
    `;
    
    optionsContainer.appendChild(optionEl);
    
    // Configurar eventos para a nova op√ß√£o
    const radioInput = optionEl.querySelector('.correct-option-radio');
    const textInput = optionEl.querySelector('.option-input');
    const removeBtn = optionEl.querySelector('.remove-option');
    
    // Evento para destacar op√ß√£o correta quando selecionada
    radioInput.addEventListener('change', function() {
        highlightCorrectOption(this);
    });
    
    // Evento para remover op√ß√£o
    removeBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        removeOption(this);
    });
    
    // Evento para valida√ß√£o em tempo real
    textInput.addEventListener('input', function() {
        this.classList.remove('error');
        const errorEl = questionEl.querySelector('.options-error');
        if (errorEl) errorEl.textContent = '';
    });
    
    // Focar no novo input
    textInput.focus();
}

function removeOption(button) {
    const optionEl = button.closest('.option-item');
    const questionEl = button.closest('.question-item');
    const optionsContainer = questionEl.querySelector('.options-container');
    
    if (!optionEl || !optionsContainer) return;
    
    // N√£o permitir remover se s√≥ tiver uma op√ß√£o
    if (optionsContainer.children.length <= 1) {
        alert('√â necess√°rio ter pelo menos uma op√ß√£o.');
        return;
    }
    
    optionEl.remove();
}

function highlightCorrectOption(radioInput) {
    const optionEl = radioInput.closest('.option-item');
    const questionEl = radioInput.closest('.question-item');
    
    if (!optionEl || !questionEl) return;
    
    // Remover destaque de todas as op√ß√µes
    const allOptions = questionEl.querySelectorAll('.option-item');
    allOptions.forEach(option => {
        option.classList.remove('correct-option');
    });
    
    // Destacar op√ß√£o selecionada
    if (radioInput.checked) {
        optionEl.classList.add('correct-option');
    }
}

// ========== GERENCIAMENTO DE DICAS ==========
function toggleHintsContainer(button) {
    const questionEl = button.closest('.question-item');
    const hintsContainer = questionEl.querySelector('.hints-container');
    
    if (!hintsContainer) {
        console.error('Container de dicas n√£o encontrado');
        return;
    }
    
    // Alternar visibilidade
    hintsContainer.classList.toggle('hidden');
    hintsContainer.classList.toggle('expanded');
    
    // Atualizar √≠cone do bot√£o
    const icon = button.querySelector('img');
    if (hintsContainer.classList.contains('hidden')) {
        icon.src = "{% static 'imagem/lightbulb_35dp_2682EA_FILL0_wght400_GRAD0_opsz40.png' %}";
        icon.alt = "Dicas fechadas";
    } else {
        icon.src = "{% static 'imagem/lightbulb_35dp_10B981_FILL0_wght400_GRAD0_opsz40.png' %}";
        icon.alt = "Dicas abertas";
    }
}

function addHint(button) {
    const questionEl = button.closest('.question-item');
    const hintsList = questionEl.querySelector('.hints-list');
    const count = hintsList.querySelectorAll('.hint-item').length;

    if (count >= 3) {
        alert('Voc√™ s√≥ pode adicionar at√© 3 dicas por quest√£o.');
        return;
    }

    const hint = document.createElement('div');
    hint.className = 'hint-item';
    hint.innerHTML = `
        <input type="text" placeholder="Dica ${count + 1} (obrigat√≥rio)" class="hint-input w-full">
        <button type="button" class="remove-hint text-red-500 hover:text-red-700 p-1 rounded transition-colors">
            <img src="{% static 'imagem/delete_35dp_ef4444_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Remover" class="w-4 h-4">
        </button>
    `;
    hintsList.appendChild(hint);
    
    // Configurar evento de input para a nova dica
    const hintInput = hint.querySelector('.hint-input');
    hintInput.addEventListener('input', function() {
        validateQuestionHints(questionEl);
    });
    
    // Configurar evento de remover dica
    const removeBtn = hint.querySelector('.remove-hint');
    removeBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        removeHint(this);
    });
    
    updateHintCounter(questionEl);
    validateQuestionHints(questionEl);
    hintInput.focus();
}

function removeHint(button) {
    const hintItem = button.closest('.hint-item');
    const questionEl = hintItem.closest('.question-item');
    
    if (!hintItem || !questionEl) return;
    
    hintItem.remove();
    updateHintCounter(questionEl);
    validateQuestionHints(questionEl);
}

function updateHintCounter(questionEl) {
    const hintsList = questionEl.querySelector('.hints-list');
    const counter = questionEl.querySelector('.hint-counter');
    const hintItems = hintsList.querySelectorAll('.hint-item');
    const filledHints = Array.from(hintItems).filter(item => {
        const input = item.querySelector('.hint-input');
        return input && input.value.trim() !== '';
    });
    const count = filledHints.length;
    
    if (counter) {
        counter.textContent = count;
        
        // Atualizar cores baseado no n√∫mero de dicas
        counter.classList.remove('bg-blue-500', 'bg-orange-500', 'bg-red-500', 'bg-green-500');
        
        if (count === 0) {
            counter.classList.add('bg-blue-500');
        } else if (count < 3) {
            counter.classList.add('bg-orange-500');
        } else {
            counter.classList.add('bg-green-500');
        }
    }
}

function validateQuestionHints(questionEl) {
    const hintsList = questionEl.querySelector('.hints-list');
    const hintItems = hintsList.querySelectorAll('.hint-item');
    const filledHints = Array.from(hintItems).filter(item => {
        const input = item.querySelector('.hint-input');
        return input && input.value.trim() !== '';
    });
    
    const isValid = filledHints.length === 3;
    
    // Atualizar apar√™ncia do bot√£o de dicas baseado na valida√ß√£o
    const hintBtn = questionEl.querySelector('.add-hint-btn');
    const hintCounter = questionEl.querySelector('.hint-counter');
    
    if (hintBtn && hintCounter) {
        if (isValid) {
            hintBtn.classList.remove('bg-blue-100', 'text-blue-700');
            hintBtn.classList.add('bg-green-100', 'text-green-700');
            hintCounter.classList.remove('bg-blue-500', 'bg-orange-500');
            hintCounter.classList.add('bg-green-500');
        } else {
            hintBtn.classList.remove('bg-green-100', 'text-green-700');
            hintBtn.classList.add('bg-blue-100', 'text-blue-700');
            hintCounter.classList.remove('bg-green-500');
            
            if (filledHints.length === 0) {
                hintCounter.classList.add('bg-blue-500');
            } else {
                hintCounter.classList.add('bg-orange-500');
            }
        }
        
        // Atualizar contador com n√∫mero real
        hintCounter.textContent = filledHints.length;
    }
    
    return isValid;
}

function validateAllQuestionsHints() {
    const questionItems = document.querySelectorAll('#questions-list .question-item');
    let allValid = true;
    
    console.log("Validando dicas de", questionItems.length, "quest√µes");
    
    questionItems.forEach((questionEl, index) => {
        const isValid = validateQuestionHints(questionEl);
        if (!isValid) {
            allValid = false;
            console.log(`Quest√£o ${index + 1} tem dicas inv√°lidas`);
        }
    });
    
    console.log("Todas as dicas v√°lidas:", allValid);
    return allValid;
}

function initializeQuestionHints(questionEl) {
    // Garantir que o container de dicas comece fechado
    const hintsContainer = questionEl.querySelector('.hints-container');
    if (hintsContainer) {
        hintsContainer.classList.add('hidden');
        hintsContainer.classList.remove('expanded');
    }
    
    // Configurar bot√£o de adicionar dica
    const addHintBtn = questionEl.querySelector('.add-hint');
    if (addHintBtn) {
        addHintBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            addHint(this);
        });
    }
    
    // Configurar eventos dos inputs de dica existentes
    const hintInputs = questionEl.querySelectorAll('.hint-input');
    hintInputs.forEach(input => {
        input.addEventListener('input', function() {
            validateQuestionHints(questionEl);
        });
    });
    
    // Validar dicas inicialmente
    validateQuestionHints(questionEl);
}

// ========== QUEST√ïES DE C√ìDIGO ==========
function initializeCodeQuestion(questionEl) {
    // Configurar eventos para atualizar preview em tempo real
    const questionInput = questionEl.querySelector('.question-input');
    const starterCode = questionEl.querySelector('.starter-code');
    const expectedOutput = questionEl.querySelector('.expected-output');
    
    if (questionInput) {
        questionInput.addEventListener('input', function() {
            updateCodePreview(questionEl);
        });
    }
    
    if (starterCode) {
        starterCode.addEventListener('input', function() {
            updateCodePreview(questionEl);
        });
    }
    
    if (expectedOutput) {
        expectedOutput.addEventListener('input', function() {
            updateCodePreview(questionEl);
        });
    }
    
    // Configurar placeholder espec√≠fico para c√≥digo
    if (starterCode) {
        starterCode.placeholder = `# Digite o c√≥digo inicial aqui\n# Exemplo:\nprint("Hello")\n\nfor i in range(5):\n    print(i)`;
    }
    
    if (expectedOutput) {
        expectedOutput.placeholder = `# Digite a sa√≠da esperada\n# Exemplo:\nHello\n0\n1\n2\n3\n4`;
    }
    
    // Inicializar preview
    updateCodePreview(questionEl);
}

function updateCodePreview(questionEl) {
    const instruction = questionEl.querySelector('.question-input')?.value || 'Digite as instru√ß√µes do exerc√≠cio...';
    const starterCode = questionEl.querySelector('.starter-code')?.value || '# C√≥digo inicial aparecer√° aqui';
    const expectedOutput = questionEl.querySelector('.expected-output')?.value || '# Sa√≠da esperada aparecer√° aqui';
    
    // Atualizar instru√ß√£o
    const instructionPreview = questionEl.querySelector('.instruction-preview');
    if (instructionPreview) {
        instructionPreview.textContent = instruction;
    }
    
    // Atualizar c√≥digo inicial com formata√ß√£o
    const codePreview = questionEl.querySelector('.code-preview');
    if (codePreview) {
        // Formatar o c√≥digo para preservar espa√ßos e quebras de linha
        const formattedCode = starterCode
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;')
            .replace(/\n/g, '<br>')
            .replace(/ /g, '&nbsp;')
            .replace(/\t/g, '&nbsp;&nbsp;&nbsp;&nbsp;');
        
        codePreview.innerHTML = formattedCode;
    }
    
    // Atualizar sa√≠da esperada
    const outputPreview = questionEl.querySelector('.output-content');
    if (outputPreview) {
        const formattedOutput = expectedOutput
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/\n/g, '<br>')
            .replace(/ /g, '&nbsp;')
            .replace(/\t/g, '&nbsp;&nbsp;&nbsp;&nbsp;');
        
        outputPreview.innerHTML = formattedOutput;
    }
    
    // Mostrar/ocultar container de output baseado no conte√∫do
    const outputContainer = questionEl.querySelector('.output-preview');
    if (outputContainer) {
        if (expectedOutput.trim()) {
            outputContainer.classList.remove('hidden');
        } else {
            outputContainer.classList.add('hidden');
        }
    }
}

// Simular execu√ß√£o de c√≥digo (para demonstra√ß√£o)
function simulateCodeExecution(button) {
    const questionEl = button.closest('.question-item');
    const outputContainer = questionEl.querySelector('.output-preview');
    const runButton = questionEl.querySelector('.run-button');
    
    if (!outputContainer || !runButton) return;
    
    // Mostrar loading
    runButton.innerHTML = `
        <div class="flex items-center gap-2">
            <div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
            <span>Executando...</span>
        </div>
    `;
    runButton.disabled = true;
    
    // Simular tempo de execu√ß√£o
    setTimeout(() => {
        outputContainer.classList.remove('hidden');
        
        // Restaurar bot√£o
        runButton.innerHTML = '‚ñ∂ Executar C√≥digo';
        runButton.disabled = false;
        
        showSaveIndicator('C√≥digo executado com sucesso!');
    }, 1500);
}

// ========== QUEST√ïES DE COMPLETAR LACUNAS ==========
function initializeFillBlankQuestion(questionEl) {
    // Configurar evento no textarea para atualizar em tempo real
    const textarea = questionEl.querySelector('.fill-blank-textarea');
    if (textarea) {
        textarea.addEventListener('input', function() {
            updateFillBlankPreview(questionEl);
            updateAnswerInputs(questionEl);
        });
        
        // Configurar placeholder espec√≠fico para c√≥digo
        textarea.placeholder = `Digite o texto aqui. Use o bot√£o 'Adicionar Lacuna' para criar as lacunas.

Exemplo para c√≥digo:
if idade >= 18:
    print("Maior de idade")
else:
    print("Menor de idade")`;
    }
    
    // Aplicar estilo para preservar espa√ßos e quebras de linha
    const preview = questionEl.querySelector('.text-preview');
    if (preview) {
        preview.style.whiteSpace = 'pre-wrap';
        preview.style.fontFamily = 'monospace';
        preview.style.lineHeight = '1.5';
    }
    
    // Inicializar preview
    updateFillBlankPreview(questionEl);
    updateAnswerInputs(questionEl);
}

function addBlankToText(button) {
    const questionEl = button.closest('.question-item');
    const textarea = questionEl.querySelector('.fill-blank-textarea');
    
    if (!textarea) {
        console.error('Textarea n√£o encontrado');
        return;
    }
    
    const startPos = textarea.selectionStart;
    const endPos = textarea.selectionEnd;
    const currentValue = textarea.value;
    
    // Inserir [_____] na posi√ß√£o do cursor
    const newValue = currentValue.substring(0, startPos) + 
                    '[_____]' + 
                    currentValue.substring(endPos);
    
    textarea.value = newValue;
    
    // Reposicionar o cursor ap√≥s a lacuna inserida
    const newCursorPos = startPos + 7; // 7 = comprimento de '[_____]'
    textarea.setSelectionRange(newCursorPos, newCursorPos);
    textarea.focus();
    
    // Atualizar preview e inputs de resposta
    updateFillBlankPreview(questionEl);
    updateAnswerInputs(questionEl);
    
    showSaveIndicator('Lacuna adicionada');
}

function updateFillBlankPreview(questionEl) {
    const textarea = questionEl.querySelector('.fill-blank-textarea');
    const previewContainer = questionEl.querySelector('.code-preview-content');
    
    if (!textarea || !previewContainer) return;
    
    let text = textarea.value;
    
    // Se estiver vazio, mostrar placeholder
    if (!text.trim()) {
        previewContainer.innerHTML = '<span class="text-gray-400">Digite o texto com lacunas...</span>';
        return;
    }
    
    // Processar o texto para HTML - CORRE√á√ÉO APLICADA
    text = text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;')
        .replace(/\n/g, '<br>')
        .replace(/ /g, '&nbsp;')
        .replace(/\t/g, '&nbsp;&nbsp;&nbsp;&nbsp;');
    
    // CORRE√á√ÉO: Substituir [_____] por spans estilizados - regex mais robusta
    text = text.replace(/\[_{5,}\]/g, '<span class="blank-preview" style="display: inline-block; min-width: 80px; border-bottom: 2px dashed #f59e0b; margin: 0 4px; padding: 2px 4px; background: #fef3c7; border-radius: 4px;">_____</span>');
    
    previewContainer.innerHTML = text;
}

function updateAnswerInputs(questionEl) {
    const textarea = questionEl.querySelector('.fill-blank-textarea');
    const answersContainer = questionEl.querySelector('.answers-container');
    
    if (!textarea || !answersContainer) return;
    
    // CORRE√á√ÉO: Contar quantas lacunas existem no texto
    const blankCount = (textarea.value.match(/\[_{5,}\]/g) || []).length;
    
    console.log(`Encontradas ${blankCount} lacunas no texto`);
    
    // Limpar container de respostas
    answersContainer.innerHTML = '';
    
    // Criar inputs para cada lacuna
    for (let i = 0; i < blankCount; i++) {
        const answerEl = document.createElement('div');
        answerEl.className = 'flex items-center gap-2 mb-2';
        answerEl.innerHTML = `
            <span class="text-sm font-medium text-gray-600 w-6">${i + 1}.</span>
            <input type="text" 
                   placeholder="Resposta para a lacuna ${i + 1}" 
                   class="flex-1 p-2 border border-gray-300 rounded answer-input"
                   oninput="validateFillBlankAnswer(this)">
            <button type="button" 
                    onclick="removeAnswer(this)" 
                    class="remove-answer text-red-500 hover:text-red-700 interactive-card p-1 rounded hover:bg-red-50 transition" 
                    aria-label="Remover resposta">√ó</button>
        `;
        answersContainer.appendChild(answerEl);
    }
    
    // CORRE√á√ÉO: Se n√£o h√° lacunas, mostrar mensagem
    if (blankCount === 0) {
        answersContainer.innerHTML = `
            <div class="text-center text-gray-500 py-4">
                <p>Adicione lacunas no texto acima para ver as respostas aqui</p>
            </div>
        `;
    }
    
    // Atualizar banco de palavras
    updateWordBank(questionEl);
}

function updateWordBank(questionEl) {
    const wordBankContainer = questionEl.querySelector('.word-bank-container');
    const answers = questionEl.querySelectorAll('.answer-input');
    
    if (!wordBankContainer) return;
    
    let wordBankHTML = '';
    const filledAnswers = Array.from(answers).filter(answer => answer.value.trim());
    
    if (filledAnswers.length > 0) {
        wordBankHTML = `
            <div class="mt-4">
                <strong class="text-sm text-gray-700 block mb-2">Banco de Palavras (como o aluno ver√°):</strong>
                <div class="word-bank">
                    ${filledAnswers.map(answer => 
                        `<div class="word-option">${answer.value}</div>`
                    ).join('')}
                </div>
            </div>
        `;
    }
    
    wordBankContainer.innerHTML = wordBankHTML;
}

function removeAnswer(button) {
    const answerEl = button.closest('.flex.items-center');
    const questionEl = button.closest('.question-item');
    
    if (!answerEl || !questionEl) return;
    
    answerEl.remove();
    updateWordBank(questionEl);
    showSaveIndicator('Resposta removida');
}

// ========== COLETA DE DADOS ==========
function collectTopicContent() {
    const topicItems = document.querySelectorAll('.topic-item');
    const topicosData = [];
    
    topicItems.forEach((topic, index) => {
        const titulo = topic.querySelector('.topic-title').value || `T√≥pico ${index + 1}`;
        const editor = topic.querySelector('.topic-editor');
        const conteudo = editor ? editor.innerHTML : '';
        
        console.log(`T√≥pico ${index + 1}:`, {
            titulo: titulo,
            conteudo_length: conteudo.length,
            conteudo_preview: conteudo.substring(0, 100)
        });
        
        topicosData.push({
            titulo: titulo,
            conteudo: conteudo,
            ordem: index + 1
        });
    });
    
    // Atualizar o campo hidden com os dados dos t√≥picos
    document.getElementById('topicos-json').value = JSON.stringify(topicosData);
    
    console.log("Dados dos t√≥picos coletados:", topicosData);
    return topicosData;
}


// Adicione esta fun√ß√£o para ser chamada antes do envio do formul√°rio
function prepareFormData() {
    console.log("=== PREPARANDO DADOS DO FORMUL√ÅRIO ===");
    
    // Coletar dados dos t√≥picos
    collectTopicContent();
    
    // Coletar dados das quest√µes
    const questionsData = collectQuestionsData();
    document.getElementById('questoes-json').value = JSON.stringify(questionsData);
    
    // Coletar XP te√≥rico
    const theoryXp = document.getElementById('theory-xp');
    if (theoryXp) {
        // Adicionar campo hidden para XP te√≥rico
        let theoryXpField = document.getElementById('theory-xp-hidden');
        if (!theoryXpField) {
            theoryXpField = document.createElement('input');
            theoryXpField.type = 'hidden';
            theoryXpField.id = 'theory-xp-hidden';
            theoryXpField.name = 'theory_xp';
            document.getElementById('content-form').appendChild(theoryXpField);
        }
        theoryXpField.value = theoryXp.value;
    }
    
    console.log("Dados preparados para envio:");
    console.log("T√≥picos:", document.getElementById('topicos-json').value.length, "caracteres");
    console.log("Quest√µes:", document.getElementById('questoes-json').value.length, "caracteres");
    console.log("XP Te√≥rico:", theoryXp ? theoryXp.value : '0');
    
    return true;
}

function collectQuestionsData() {
    const questions = [];
    const questionItems = document.querySelectorAll('#questions-list .question-item');
    
    console.log("Coletando dados de", questionItems.length, "quest√µes");
    
    questionItems.forEach((questionEl, index) => {
        const type = questionEl.dataset.type;
        const questionData = {
            type: type,
            ordem: index + 1,
            dicas: [],
            xp: parseInt(questionEl.querySelector('.xp-input')?.value) || 10,
            descricao: questionEl.querySelector('.question-description')?.value || ''
        };
        
        // Coletar dicas
        const hintInputs = questionEl.querySelectorAll('.hint-input');
        hintInputs.forEach(input => {
            if (input.value.trim()) {
                questionData.dicas.push(input.value.trim());
            }
        });
        
        // Coletar dados espec√≠ficos do tipo
        if (type === 'multiple-choice') {
            questionData.pergunta = questionEl.querySelector('.question-input').value;
            questionData.opcoes = [];
            
            questionEl.querySelectorAll('.option-item').forEach((opcaoEl, idx) => {
                const texto = opcaoEl.querySelector('.option-input').value;
                const correta = opcaoEl.querySelector('.correct-option-radio').checked;
                
                if (texto.trim()) {
                    questionData.opcoes.push({
                        texto: texto,
                        correta: correta
                    });
                }
            });
        }
        else if (type === 'code') {
            questionData.instrucao = questionEl.querySelector('.question-input').value;
            questionData.codigo_inicial = questionEl.querySelector('.starter-code').value;
            questionData.saida_esperada = questionEl.querySelector('.expected-output').value;
        }
        else if (type === 'fill-blank') {
            questionData.texto = questionEl.querySelector('.question-input').value;
            questionData.respostas = [];
            
            questionEl.querySelectorAll('.answer-input').forEach(input => {
                if (input.value.trim()) {
                    questionData.respostas.push(input.value.trim());
                }
            });
            
            // Contar lacunas
            const blankCount = (questionData.texto.match(/\[_____\]/g) || []).length;
            questionData.total_lacunas = blankCount;
        }
        
        questions.push(questionData);
        console.log(`Quest√£o ${index + 1} (${type}):`, questionData);
    });
    
    return questions;
}

// ========== FUN√á√ÉO PARA CALCULAR TEMPO TOTAL ==========
function updateTotalTime() {
    const timeTheory = document.getElementById('estimated-time-theory');
    const timePractice = document.getElementById('estimated-time-practice');
    
    if (timeTheory && timePractice) {
        const theoryValue = parseInt(timeTheory.value) || 0;
        const practiceValue = parseInt(timePractice.value) || 0;
        const total = theoryValue + practiceValue;
        
        // Atualizar revis√£o se estiver no passo 4
        if (currentStep === 4) {
            updateReview();
        }
    }
}

function collectFormData() {
    console.log("=== COLETANDO DADOS DO FORMUL√ÅRIO ===");
    
    // Coletar dados b√°sicos do passo 1
    const chapterSelect = document.getElementById('chapter-select');
    const moduleSelect = document.getElementById('module-select');
    const lessonTitle = document.getElementById('lesson-title');
    
    // Coletar dados do passo 2
    const tituloTeoria = document.getElementById('titulo-teoria');
    const descricaoBreve = document.getElementById('descricao-breve');
    const estimatedTime = document.getElementById('estimated-time');
    const difficultyLevel = document.getElementById('difficulty-level');
    
    // Coletar dados do passo 3
    const tituloPratica = document.getElementById('titulo-pratica');
    const conteudoPratico = document.getElementById('conteudo-pratico');
    
    // Coletar conte√∫do dos t√≥picos (passo 2)
    const conteudoTeorico = collectTopicContent();
    
    // Coletar quest√µes pr√°ticas (passo 3)
    const questionsData = collectQuestionsData();
    
    console.log("Dados coletados:");
    console.log("T√≠tulo pr√°tica:", tituloPratica.value);
    console.log("Descri√ß√£o pr√°tica:", conteudoPratico.value);
    console.log("Total quest√µes:", questionsData.length);
    
    // Criar FormData para envio
    const formData = new FormData();
    
    // Dados do passo 1
    formData.append('capitulo_id', chapterSelect.value);
    formData.append('modulo_id', moduleSelect.value);
    formData.append('titulo_aula', lessonTitle.value);
    
    // Dados do passo 2
    formData.append('titulo_teoria', tituloTeoria.value);
    formData.append('descricao_breve', descricaoBreve.value);
    formData.append('conteudo_teorico', conteudoTeorico);
    formData.append('tempo_estimado', estimatedTime.value);
    formData.append('dificuldade', difficultyLevel.value);
    
    // Dados do passo 3
    formData.append('titulo_pratica', tituloPratica.value);
    formData.append('conteudo_pratico', conteudoPratico.value);
    formData.append('questoes_json', JSON.stringify(questionsData));
    
    // Debug final
    console.log("Dados completos para envio:");
    for (let [key, value] of formData.entries()) {
        if (key === 'conteudo_teorico') {
            console.log(`${key}:`, value.length, "caracteres");
        } else if (key === 'questoes_json') {
            console.log(`${key}:`, JSON.parse(value).length, "quest√µes");
        } else {
            console.log(`${key}:`, value);
        }
    }
    
    return formData;
}

// ========== REVIS√ÉO E PUBLICA√á√ÉO ==========
function updateReview() {
    console.log("=== ATUALIZANDO REVIS√ÉO ===");
    updateReviewSummary();
    updateReviewTopics();
    updateReviewQuestions();
    updateValidationChecklist();
}

function updateReviewSummary() {
    console.log("Atualizando resumo da revis√£o...");
    
    const chapterSelect = document.getElementById('chapter-select');
    const moduleSelect = document.getElementById('module-select');
    const lessonTitle = document.getElementById('lesson-title');
    const timeTheory = document.getElementById('estimated-time-theory'); // CORRIGIDO
    const timePractice = document.getElementById('estimated-time-practice');
    const theoryXp = document.getElementById('theory-xp');
    
    console.log("Elementos encontrados:", {
        chapterSelect: !!chapterSelect,
        moduleSelect: !!moduleSelect,
        lessonTitle: !!lessonTitle,
        timeTheory: !!timeTheory,
        timePractice: !!timePractice,
        theoryXp: !!theoryXp
    });

    // Atualizar informa√ß√µes b√°sicas
    if (chapterSelect && chapterSelect.selectedIndex >= 0) {
        const chapterText = chapterSelect.options[chapterSelect.selectedIndex].text;
        setReviewText('review-chapter', chapterText);
        console.log("Cap√≠tulo:", chapterText);
    } else {
        setReviewText('review-chapter', 'N√£o selecionado');
    }
    
    if (moduleSelect && moduleSelect.selectedIndex >= 0) {
        const moduleText = moduleSelect.options[moduleSelect.selectedIndex].text;
        setReviewText('review-module', moduleText);
        console.log("M√≥dulo:", moduleText);
    } else {
        setReviewText('review-module', 'N√£o selecionado');
    }
    
    setReviewText('review-lesson-title', lessonTitle.value || 'N√£o definido');
    console.log("T√≠tulo aula:", lessonTitle.value);

    // Atualizar tempos - CORRIGIDO
    const theoryTime = parseInt(timeTheory?.value) || 0;
    const practiceTime = parseInt(timePractice?.value) || 0;
    const totalTime = theoryTime + practiceTime;
    
    console.log("Tempos:", { theoryTime, practiceTime, totalTime });
    
    setReviewText('review-time-theory', theoryTime > 0 ? `${theoryTime} minutos` : 'N√£o definido');
    setReviewText('review-time-practice', practiceTime > 0 ? `${practiceTime} minutos` : 'N√£o definido');
    setReviewText('review-total-time', totalTime > 0 ? `${totalTime} minutos` : 'N√£o definido');

    // Calcular XP - CORRIGIDO
    const theoryXpValue = theoryXp ? parseInt(theoryXp.value) || 0 : 0;
    const practiceXpValue = calculateTotalPracticeXp();
    const totalXp = theoryXpValue + practiceXpValue;
    
    console.log("XP calculado:", { theoryXpValue, practiceXpValue, totalXp });
    
    setReviewText('review-theory-xp', `${theoryXpValue} XP`);
    setReviewText('review-practice-xp', `${practiceXpValue} XP`);
    setReviewText('review-total-xp', `${totalXp} XP`);

    // Atualizar badge de quest√µes
    const questionCount = document.querySelectorAll('#questions-list .question-item').length;
    const questionsBadge = document.getElementById('review-questions-badge');
    if (questionsBadge) {
        questionsBadge.textContent = `${questionCount} quest√£o${questionCount !== 1 ? 'es' : ''}`;
    }
    
    console.log("Resumo atualizado com sucesso");
}

// Nova fun√ß√£o para calcular o XP total das quest√µes pr√°ticas
function calculateTotalPracticeXp() {
    const questionItems = document.querySelectorAll('#questions-list .question-item');
    let totalXp = 0;
    
    questionItems.forEach(questionEl => {
        const xpInput = questionEl.querySelector('.xp-input');
        if (xpInput && xpInput.value) {
            totalXp += parseInt(xpInput.value) || 0;
        }
    });
    
    console.log("XP pr√°tico total calculado:", totalXp);
    return totalXp;
}


// ========== FUN√á√ÉO PARA CALCULAR TEMPO TOTAL ==========
function updateTotalTime() {
    const timeTheory = document.getElementById('estimated-time');
    const timePractice = document.getElementById('estimated-time-practice');
    
    if (timeTheory && timePractice) {
        const theoryValue = parseInt(timeTheory.value) || 0;
        const practiceValue = parseInt(timePractice.value) || 0;
        const total = theoryValue + practiceValue;
        
        // Atualizar revis√£o se estiver no passo 4
        if (currentStep === 4) {
            updateReview();
        }
    }
}

function updateReviewTopics() {
    console.log("Atualizando revis√£o de t√≥picos...");
    const topicsContainer = document.getElementById('review-topics');
    const topicItems = document.querySelectorAll('.topic-item');
    
    if (!topicsContainer) {
        console.error("Container de t√≥picos n√£o encontrado!");
        return;
    }
    
    if (topicItems.length === 0) {
        topicsContainer.innerHTML = `
            <div class="text-center text-gray-500 py-4">
                <img src="{% static 'imagem/note_stack_100dp_64748b_FILL0_wght400_GRAD0_opsz48.png' %}" alt="Sem t√≥picos" class="w-12 h-12 mx-auto mb-2 opacity-50">
                <p>Nenhum t√≥pico adicionado</p>
            </div>
        `;
        return;
    }
    
    let topicsHTML = '';
    topicItems.forEach((topic, index) => {
        const titleInput = topic.querySelector('.topic-title');
        const editor = topic.querySelector('.topic-editor');
        
        const title = titleInput ? (titleInput.value || `T√≥pico ${index + 1}`) : `T√≥pico ${index + 1}`;
        const content = editor ? editor.innerText : 'Sem conte√∫do';
        const preview = content.length > 100 ? content.substring(0, 100) + '...' : content;
        
        topicsHTML += `
            <div class="border border-gray-200 rounded-lg p-4 mb-3">
                <div class="flex items-center justify-between mb-2">
                    <h4 class="font-semibold text-gray-800">${title}</h4>
                    <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">T√≥pico ${index + 1}</span>
                </div>
                <p class="text-gray-600 text-sm">${preview || 'Sem conte√∫do'}</p>
            </div>
        `;
    });
    
    topicsContainer.innerHTML = topicsHTML;
    console.log("T√≥picos atualizados:", topicItems.length);
}

function updateReviewQuestions() {
    console.log("Atualizando revis√£o de quest√µes...");
    const questionsContainer = document.getElementById('review-questions');
    const questionItems = document.querySelectorAll('#questions-list .question-item');
    
    if (!questionsContainer) {
        console.error("Container de quest√µes n√£o encontrado!");
        return;
    }
    
    if (questionItems.length === 0) {
        questionsContainer.innerHTML = `
            <div class="text-center text-gray-500 py-4">
                <img src="{% static 'imagem/quiz_100dp_64748b_FILL0_wght400_GRAD0_opsz48.png' %}" alt="Sem quest√µes" class="w-12 h-12 mx-auto mb-2 opacity-50">
                <p>Nenhum exerc√≠cio adicionado</p>
            </div>
        `;
        return;
    }
    
    let questionsHTML = '';
    questionItems.forEach((question, index) => {
        const type = question.dataset.type;
        const typeNames = {
            'multiple-choice': 'M√∫ltipla Escolha',
            'code': 'Programa√ß√£o',
            'fill-blank': 'Completar Lacunas'
        };
        
        // Verificar dicas
        const hintsList = question.querySelector('.hints-list');
        const hintInputs = hintsList ? hintsList.querySelectorAll('.hint-input') : [];
        const filledHints = Array.from(hintInputs).filter(input => input.value.trim() !== '');
        const hintsStatus = filledHints.length === 3 ? 
            '<span class="text-green-600 text-sm">‚úì 3 dicas preenchidas</span>' : 
            `<span class="text-red-600 text-sm">‚úó ${filledHints.length}/3 dicas preenchidas</span>`;
        
        let questionContent = '';
        
        if (type === 'multiple-choice') {
            const questionInput = question.querySelector('.question-input');
            const questionText = questionInput ? questionInput.value : 'Pergunta n√£o definida';
            const options = question.querySelectorAll('.option-input');
            let optionsHTML = '';
            
            options.forEach((option, optIndex) => {
                const optionItem = option.closest('.option-item');
                const isCorrect = optionItem ? optionItem.classList.contains('correct-option') : false;
                const optionText = option.value || 'Op√ß√£o n√£o definida';
                optionsHTML += `
                    <div class="flex items-center gap-2 ${isCorrect ? 'text-green-600 font-semibold' : 'text-gray-600'}">
                        <span class="w-4">${optIndex + 1}.</span>
                        <span>${optionText}</span>
                        ${isCorrect ? '<span class="text-xs">‚úì Correta</span>' : ''}
                    </div>
                `;
            });
            
            questionContent = `
                <p class="mb-2"><strong>Pergunta:</strong> ${questionText}</p>
                <div class="ml-4 space-y-1 mt-2">
                    <strong class="text-sm">Op√ß√µes:</strong>
                    ${optionsHTML}
                </div>
                <div class="mt-2">${hintsStatus}</div>
            `;
        } 
        else if (type === 'code') {
            const questionInput = question.querySelector('.question-input');
            const starterCode = question.querySelector('.starter-code');
            const expectedOutput = question.querySelector('.expected-output');
            
            const instruction = questionInput ? questionInput.value : 'Instru√ß√£o n√£o definida';
            const starterCodeValue = starterCode ? starterCode.value : '';
            const expectedOutputValue = expectedOutput ? expectedOutput.value : '';
            
            questionContent = `
                <p><strong>Instru√ß√£o:</strong> ${instruction}</p>
                ${starterCodeValue ? `
                <div class="mt-2">
                    <strong class="text-sm">C√≥digo Inicial:</strong>
                    <div class="bg-gray-100 p-3 rounded font-mono text-sm mt-1 whitespace-pre">${starterCodeValue}</div>
                </div>
                ` : ''}
                ${expectedOutputValue ? `
                <div class="mt-2">
                    <strong class="text-sm">Sa√≠da Esperada:</strong>
                    <div class="bg-gray-800 text-green-400 p-3 rounded font-mono text-sm mt-1 whitespace-pre">${expectedOutputValue}</div>
                </div>
                ` : ''}
                <div class="mt-2">${hintsStatus}</div>
            `;
        } 
        else if (type === 'fill-blank') {
            const questionInput = question.querySelector('.question-input');
            const answers = question.querySelectorAll('.answer-input');
            
            const questionText = questionInput ? questionInput.value : 'Texto n√£o definido';
            
            let answersHTML = '';
            answers.forEach((answer, ansIndex) => {
                if (answer.value.trim()) {
                    answersHTML += `
                        <div class="flex items-center gap-2 text-green-600">
                            <span class="text-sm font-medium w-6">${ansIndex + 1}.</span>
                            <span>${answer.value}</span>
                        </div>
                    `;
                }
            });
            
            // Processar texto para mostrar lacunas
            const displayText = questionText.replace(/\[_____\]/g, '<span class="blank-preview">_____</span>');
            
            questionContent = `
                <p class="mb-2"><strong>Texto com Lacunas:</strong></p>
                <div class="bg-gray-50 p-3 rounded border border-gray-200 mb-3">
                    <div class="text-gray-700 leading-relaxed whitespace-pre-wrap">${displayText}</div>
                </div>
                ${answersHTML ? `
                <div class="mt-2">
                    <strong class="text-sm">Respostas Corretas:</strong>
                    <div class="ml-4 space-y-1 mt-1">${answersHTML}</div>
                </div>
                ` : '<p class="text-red-500 text-sm">‚úó Respostas n√£o definidas</p>'}
                <div class="mt-2">${hintsStatus}</div>
            `;
        }
        
        const xpInput = question.querySelector('.xp-input');
        const xpValue = xpInput ? (xpInput.value || '10') : '10';
        
        questionsHTML += `
            <div class="border border-gray-200 rounded-lg p-4 mb-4">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-3">
                        <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-medium">
                            ${typeNames[type] || 'Exerc√≠cio'}
                        </span>
                        <span class="text-gray-500 text-sm">Quest√£o ${index + 1}</span>
                    </div>
                    <span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs">
                        ${xpValue} XP
                    </span>
                </div>
                ${questionContent}
            </div>
        `;
    });
    
    questionsContainer.innerHTML = questionsHTML;
    console.log("Quest√µes atualizadas:", questionItems.length);
}

// ========== CHECKLIST DE VALIDA√á√ÉO CORRIGIDO ==========
function updateValidationChecklist() {
    console.log("=== ATUALIZANDO CHECKLIST ===");
    
    const checkTitle = document.getElementById('check-title');
    const checkTopics = document.getElementById('check-topics');
    const checkQuestions = document.getElementById('check-questions');
    const checkTimeTheory = document.getElementById('check-time-theory');
    const checkTimePractice = document.getElementById('check-time-practice');
    const checkHints = document.getElementById('check-hints');
    const publishButton = document.getElementById('publish-button');
    const confirmReview = document.getElementById('confirm-review');

    console.log("Elementos do checklist:", {
        checkTitle: !!checkTitle,
        checkTopics: !!checkTopics,
        checkQuestions: !!checkQuestions,
        checkTimeTheory: !!checkTimeTheory,
        checkTimePractice: !!checkTimePractice,
        checkHints: !!checkHints,
        publishButton: !!publishButton,
        confirmReview: !!confirmReview
    });

    // 1. Validar t√≠tulo da aula
    const lessonTitle = document.getElementById('lesson-title');
    const hasTitle = lessonTitle && lessonTitle.value.trim().length > 0;
    updateCheckItem(checkTitle, hasTitle);
    console.log("T√≠tulo da aula v√°lido:", hasTitle);

    // 2. Validar t√≥picos com conte√∫do
    const topicItems = document.querySelectorAll('.topic-item');
    let hasTopicsContent = false;
    let topicsWithContent = 0;
    
    topicItems.forEach(topic => {
        const editor = topic.querySelector('.topic-editor');
        const content = editor ? editor.innerText.trim() : '';
        const hasRealContent = content && 
                              content !== 'Comece a escrever o conte√∫do deste t√≥pico aqui...' && 
                              content.length > 0;
        
        if (hasRealContent) {
            hasTopicsContent = true;
            topicsWithContent++;
        }
    });
    
    updateCheckItem(checkTopics, hasTopicsContent);
    console.log("T√≥picos com conte√∫do:", topicsWithContent, "de", topicItems.length);

    // 3. Validar quest√µes
    const hasQuestions = document.querySelectorAll('#questions-list .question-item').length > 0;
    updateCheckItem(checkQuestions, hasQuestions);
    console.log("Tem quest√µes:", hasQuestions);

    // 4. Validar tempo te√≥rico - CORRIGIDO (agora usa estimated-time-theory)
    const timeTheory = document.getElementById('estimated-time-theory');
    const hasTimeTheory = timeTheory && timeTheory.value && 
                         parseInt(timeTheory.value) >= 1 && 
                         parseInt(timeTheory.value) <= 120;
    updateCheckItem(checkTimeTheory, hasTimeTheory);
    console.log("Tempo te√≥rico v√°lido:", hasTimeTheory, "valor:", timeTheory?.value);

    // 5. Validar tempo pr√°tico - CORRIGIDO (agora usa estimated-time-practice)
    const timePractice = document.getElementById('estimated-time-practice');
    const hasTimePractice = timePractice && timePractice.value && 
                           parseInt(timePractice.value) >= 1 && 
                           parseInt(timePractice.value) <= 120;
    updateCheckItem(checkTimePractice, hasTimePractice);
    console.log("Tempo pr√°tico v√°lido:", hasTimePractice, "valor:", timePractice?.value);

    // 6. Validar dicas - todas as quest√µes t√™m 3 dicas preenchidas
    const questionItems = document.querySelectorAll('#questions-list .question-item');
    let allHintsValid = true;
    let questionsWithValidHints = 0;
    
    if (hasQuestions) {
        questionItems.forEach(questionEl => {
            const hintsValid = validateQuestionHints(questionEl);
            if (hintsValid) {
                questionsWithValidHints++;
            } else {
                allHintsValid = false;
            }
        });
    } else {
        allHintsValid = false;
    }
    
    updateCheckItem(checkHints, allHintsValid);
    console.log("Dicas v√°lidas:", questionsWithValidHints, "de", questionItems.length);

    // Atualizar bot√£o de publica√ß√£o
    if (publishButton && confirmReview) {
        const allValid = hasTitle && hasTopicsContent && hasQuestions && 
                        hasTimeTheory && hasTimePractice && allHintsValid;
        
        publishButton.disabled = !allValid || !confirmReview.checked;
        
        console.log("Todos v√°lidos:", allValid);
        console.log("Confirmado:", confirmReview.checked);
        console.log("Bot√£o habilitado:", !publishButton.disabled);
        
        if (publishButton.disabled) {
            console.log("Motivos do bloqueio:");
            if (!hasTitle) console.log("- T√≠tulo da aula n√£o preenchido");
            if (!hasTopicsContent) console.log("- T√≥picos sem conte√∫do");
            if (!hasQuestions) console.log("- Nenhuma quest√£o adicionada");
            if (!hasTimeTheory) console.log("- Tempo te√≥rico inv√°lido");
            if (!hasTimePractice) console.log("- Tempo pr√°tico inv√°lido");
            if (!allHintsValid) console.log("- Dicas incompletas");
            if (!confirmReview.checked) console.log("- Confirma√ß√£o n√£o marcada");
        }
    }
}

// ========== FUN√á√ÉO AUXILIAR PARA ATUALIZAR OS CHECK ITEMS ==========
function updateCheckItem(element, isValid) {
    if (!element) return;
    
    if (isValid) {
        element.innerHTML = '‚úì';
        element.className = 'w-5 h-5 rounded-full bg-green-500 text-white flex items-center justify-center text-xs';
    } else {
        element.innerHTML = '';
        element.className = 'w-5 h-5 rounded-full border-2 border-gray-300';
    }
}
function setReviewText(elementId, text) {
    const element = document.getElementById(elementId);
    if (element) {
        element.textContent = text;
        console.log(`Set ${elementId}: ${text}`);
    } else {
        console.error(`Elemento n√£o encontrado: ${elementId}`);
    }
}

function updateCheckItem(element, isValid) {
    if (!element) return;
    
    if (isValid) {
        element.innerHTML = '‚úì';
        element.className = 'w-5 h-5 rounded-full bg-green-500 text-white flex items-center justify-center text-xs';
    } else {
        element.innerHTML = '';
        element.className = 'w-5 h-5 rounded-full border-2 border-gray-300';
    }
}

function publishContent() {
    console.log("=== INICIANDO PUBLICA√á√ÉO ===");
    
    // Primeiro validar o formul√°rio
    if (!validateFinalForm()) {
        const errorMessage = 'Por favor, complete todos os requisitos antes de publicar. Verifique:\n' +
                           '- T√≠tulo da aula preenchido\n' +
                           '- Pelo menos um t√≥pico com conte√∫do\n' + 
                           '- Pelo menos um exerc√≠cio pr√°tico\n' +
                           '- Tempos te√≥rico e pr√°tico definidos\n' +
                           '- 3 dicas preenchidas em cada quest√£o\n' +
                           '- Confirma√ß√£o de revis√£o marcada';
        alert(errorMessage);
        return;
    }
    
    // Preparar dados
    console.log("Preparando dados para envio...");
    prepareFormData();
    
    // Mostrar loading
    const publishButton = document.getElementById('publish-button');
    if (publishButton) {
        publishButton.innerHTML = `
            <div class="flex items-center gap-2">
                <div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                <span>Publicando...</span>
            </div>
        `;
        publishButton.disabled = true;
    }
    
    console.log("Enviando formul√°rio...");
    
    // For√ßar o envio do formul√°rio
    setTimeout(() => {
        const form = document.getElementById('content-form');
        if (form) {
            console.log("Formul√°rio encontrado, enviando...");
            form.submit();
        } else {
            console.error("Formul√°rio n√£o encontrado!");
            alert("Erro: formul√°rio n√£o encontrado");
            
            // Restaurar bot√£o em caso de erro
            if (publishButton) {
                publishButton.innerHTML = `
                    <img src="{% static 'imagem/publish_35dp_FFFFFF_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Publicar" class="w-5 h-5">
                    Publicar Conte√∫do
                `;
                publishButton.disabled = false;
            }
        }
    }, 500);
}

function validateFinalForm() {
    console.log("=== VALIDA√á√ÉO FINAL ===");
    
    const hasTitle = document.getElementById('lesson-title').value.trim().length > 0;
    const hasQuestions = document.querySelectorAll('#questions-list .question-item').length > 0;
    const hasTimeTheory = document.getElementById('estimated-time-theory').value && 
                         parseInt(document.getElementById('estimated-time-theory').value) > 0;
    const hasTimePractice = document.getElementById('estimated-time-practice').value && 
                           parseInt(document.getElementById('estimated-time-practice').value) > 0;
    const isConfirmed = document.getElementById('confirm-review').checked;
    const hasChapter = document.getElementById('chapter-select').value && 
                      document.getElementById('chapter-select').value !== '';
    const hasModule = document.getElementById('module-select').value && 
                     document.getElementById('module-select').value !== '';
    
    // Validar dicas
    const allHintsValid = validateAllQuestionsHints();
    
    // Validar t√≥picos
    const topicItems = document.querySelectorAll('.topic-item');
    let hasTopicsContent = false;
    topicItems.forEach(topic => {
        const editor = topic.querySelector('.topic-editor');
        const content = editor ? editor.innerText.trim() : '';
        const hasRealContent = content && 
                              content !== 'Comece a escrever o conte√∫do deste t√≥pico aqui...' && 
                              content.length > 0;
        if (hasRealContent) {
            hasTopicsContent = true;
        }
    });
    
    console.log("Resultado da valida√ß√£o:", {
        hasTitle,
        hasTopicsContent,
        hasQuestions,
        hasTimeTheory,
        hasTimePractice,
        isConfirmed,
        hasChapter,
        hasModule,
        allHintsValid,
        todosValidos: hasTitle && hasTopicsContent && hasQuestions && hasTimeTheory && 
                     hasTimePractice && isConfirmed && hasChapter && hasModule && allHintsValid
    });
    
    return hasTitle && 
           hasTopicsContent && 
           hasQuestions && 
           hasTimeTheory && 
           hasTimePractice && 
           isConfirmed && 
           hasChapter && 
           hasModule && 
           allHintsValid;
}

// ========== MODAIS ==========
function openChapterModal() {
    const modal = document.getElementById('chapter-modal');
    if (modal) {
        modal.classList.add('active');
        const titleInput = document.getElementById('new-chapter-title');
        if (titleInput) titleInput.focus();
    }
}

function closeChapterModal() {
    const modal = document.getElementById('chapter-modal');
    if (modal) {
        modal.classList.remove('active');
        const form = document.getElementById('new-chapter-form');
        if (form) {
            form.reset();
            // Limpar erros visuais
            const titleInput = document.getElementById('new-chapter-title');
            const difficultyInput = document.getElementById('new-chapter-difficulty');
            if (titleInput) titleInput.classList.remove('error');
            if (difficultyInput) difficultyInput.classList.remove('error');
        }
        clearError('new-chapter-title-error');
        clearError('new-chapter-difficulty-error');
    }
}

function openModuleModal() {
    if (!selectedChapterId) {
        alert('Selecione um cap√≠tulo primeiro antes de criar um m√≥dulo.');
        const moduleSelect = document.getElementById('module-select');
        if (moduleSelect) moduleSelect.value = '';
        return;
    }
    
    const modal = document.getElementById('module-modal');
    if (modal) {
        const chapterName = document.getElementById('selected-chapter-name');
        if (chapterName) chapterName.textContent = selectedChapterName;
        
        modal.classList.add('active');
        const titleInput = document.getElementById('new-module-title');
        if (titleInput) titleInput.focus();
    }
}

function closeModuleModal() {
    const modal = document.getElementById('module-modal');
    if (modal) {
        modal.classList.remove('active');
        const form = document.getElementById('new-module-form');
        if (form) form.reset();
        clearError('new-module-title-error');
        clearError('new-module-title');
    }
}

// ========== FUN√á√ïES UTILIT√ÅRIAS ==========
function initializeSelects() {
    const chapterSelect = document.getElementById('chapter-select');
    const moduleSelect = document.getElementById('module-select');
    
    if (chapterSelect && chapterSelect.options[0]) {
        chapterSelect.options[0].selected = true;
        chapterSelect.options[0].disabled = true;
    }
    
    if (moduleSelect && moduleSelect.options[0]) {
        moduleSelect.options[0].selected = true;
        moduleSelect.options[0].disabled = true;
    }
}

function setupDragAndDrop() {
    console.log('Drag and drop inicializado');
}

function setupAutoSave() {
    if (autoSaveInterval) {
        clearInterval(autoSaveInterval);
    }
    
    if (autoSaveEnabled) {
        autoSaveInterval = setInterval(function() {
            showSaveIndicator('Altera√ß√µes salvas automaticamente');
        }, 30000);
    }
}

function updateProgressBar() {
    const progressFill = document.getElementById('progress-fill');
    if (progressFill) {
        const width = (currentStep / 4) * 100;
        progressFill.style.width = `${width}%`;
    }
}

function showSaveIndicator(message) {
    const saveIndicator = document.getElementById('save-indicator');
    if (saveIndicator) {
        saveIndicator.innerHTML = `
            <img src="{% static 'imagem/check_circle_35dp_FFFFFF_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Salvo" class="w-5 h-5">
            <span>${message}</span>
        `;
        saveIndicator.style.display = 'flex';
        
        setTimeout(function() {
            saveIndicator.style.display = 'none';
        }, 3000);
    }
}

function setReviewText(elementId, text) {
    const element = document.getElementById(elementId);
    if (element) {
        element.textContent = text;
    }
}

// ========== GERENCIAMENTO DE ERROS ==========
function clearErrors() {
    document.querySelectorAll('.validation-error').forEach(el => {
        el.textContent = '';
    });
    document.querySelectorAll('.error').forEach(el => {
        el.classList.remove('error');
    });
}

function clearError(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
        element.textContent = '';
    }
}

function showError(elementId, message) {
    const element = document.getElementById(elementId);
    if (element) {
        element.textContent = message;
    }
}

function clearQuestionErrors(questionEl, specificError = null) {
    if (specificError) {
        const errorEl = questionEl.querySelector(`.${specificError}`);
        if (errorEl) errorEl.textContent = '';
    } else {
        questionEl.querySelectorAll('.validation-error').forEach(el => {
            el.textContent = '';
        });
    }
    
    questionEl.querySelectorAll('.error').forEach(el => {
        el.classList.remove('error');
    });
}

function showQuestionError(questionEl, errorClass, message) {
    const errorEl = questionEl.querySelector(`.${errorClass}`);
    if (errorEl) {
        errorEl.textContent = message;
    }
}

function highlightQuestionError(questionEl) {
    questionEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
    questionEl.style.border = '2px solid #ef4444';
    questionEl.style.borderRadius = '8px';
    setTimeout(() => {
        questionEl.style.border = '';
    }, 3000);
}

function scrollToFirstError() {
    const firstError = document.querySelector('.error');
    if (firstError) {
        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
}


// ========== FUN√á√ïES PARA TAB (mantenha apenas estas) ==========

// Fun√ß√£o para lidar com a tecla Tab em textareas
function handleTabKey(textarea, event) {
    if (event.key === 'Tab') {
        event.preventDefault();
        insertSpacesInTextarea(textarea, 4);
    }
}

// Fun√ß√£o para inserir espa√ßos em textareas
function insertSpacesInTextarea(textarea, spacesCount) {
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const spaces = ' '.repeat(spacesCount);
    
    // Inserir os espa√ßos na posi√ß√£o do cursor
    textarea.value = textarea.value.substring(0, start) + 
                     spaces + 
                     textarea.value.substring(end);
    
    // Reposicionar o cursor
    textarea.selectionStart = textarea.selectionEnd = start + spacesCount;
    textarea.focus();
}

// ========== ATUALIZAR A INICIALIZA√á√ÉO ==========
function initializeFillBlankQuestion(questionEl) {
    const textarea = questionEl.querySelector('.fill-blank-textarea');
    
    if (textarea) {
        // Configurar eventos
        textarea.addEventListener('keydown', function(e) {
            if (e.key === 'Tab') {
                e.preventDefault();
                insertSpacesInTextarea(this, 4);
            }
        });
        
        // CORRE√á√ÉO: Atualizar preview em tempo real
        textarea.addEventListener('input', function() {
            updateFillBlankPreview(questionEl);
            updateAnswerInputs(questionEl);
        });
        
        // Configurar placeholder com exemplo melhorado
        textarea.placeholder = `Digite o texto aqui e use o bot√£o "Adicionar Lacuna" para criar lacunas.

Exemplo:
Para imprimir algo em Python, usamos a fun√ß√£o [_____]("texto").

if idade >= 18:
    print("Maior de idade")
else:
    [_____]("Menor de idade")`;
    }
    
    // CORRE√á√ÉO: Inicializar preview imediatamente
    setTimeout(() => {
        updateFillBlankPreview(questionEl);
        updateAnswerInputs(questionEl);
    }, 100);
}

// CORRE√á√ÉO: Adicionar CSS inline para garantir que as lacunas sejam vis√≠veis
function addBlankStyles() {
    const style = document.createElement('style');
    style.textContent = `
        .blank-preview {
            display: inline-block !important;
            min-width: 80px !important;
            text-align: center !important;
            font-weight: 500 !important;
            background: #fef3c7 !important;
            border: 2px dashed #f59e0b !important;
            border-radius: 6px !important;
            padding: 2px 8px !important;
            margin: 0 2px !important;
            color: #92400e !important;
        }
        
        .word-bank {
            min-height: 60px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 8px;
            margin: 12px 0;
        }

        .word-option {
            background: #dbeafe !important;
            border: 2px solid #3b82f6 !important;
            border-radius: 8px !important;
            padding: 8px 12px !important;
            text-align: center !important;
            cursor: grab !important;
            transition: all 0.2s ease !important;
            user-select: none !important;
            font-weight: 500 !important;
            color: #1e40af !important;
        }

        .word-option:hover {
            background: #3b82f6 !important;
            color: white !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3) !important;
        }
    `;
    document.head.appendChild(style);
}

// CORRE√á√ÉO: Chamar a fun√ß√£o para adicionar estilos quando a p√°gina carregar
document.addEventListener('DOMContentLoaded', function() {
    addBlankStyles();
});

// ========== QUEST√ïES DE C√ìDIGO ==========
function initializeCodeQuestion(questionEl) {
    console.log('Inicializando quest√£o de c√≥digo...');
    
    // Configurar eventos para atualizar preview em tempo real
    const questionInput = questionEl.querySelector('.question-input');
    const starterCode = questionEl.querySelector('.starter-code');
    const expectedOutput = questionEl.querySelector('.expected-output');
    
    // Configurar Tab para campos de c√≥digo
    if (starterCode) {
        starterCode.addEventListener('keydown', function(e) {
            if (e.key === 'Tab') {
                e.preventDefault();
                insertSpacesInTextarea(this, 4);
            }
        });
        
        starterCode.addEventListener('input', function() {
            console.log('Starter code alterado');
            updateCodePreview(questionEl);
        });
    }
    
    if (expectedOutput) {
        expectedOutput.addEventListener('keydown', function(e) {
            if (e.key === 'Tab') {
                e.preventDefault();
                insertSpacesInTextarea(this, 4);
            }
        });
        
        expectedOutput.addEventListener('input', function() {
            console.log('Expected output alterado');
            updateCodePreview(questionEl);
        });
    }
    
    if (questionInput) {
        questionInput.addEventListener('input', function() {
            console.log('Instru√ß√£o alterada');
            updateCodePreview(questionEl);
        });
    }
    
    // Configurar placeholder espec√≠fico para c√≥digo
    if (starterCode) {
        starterCode.placeholder = `# Digite o c√≥digo inicial aqui\n# Exemplo:\nprint("Hello")\n\nfor i in range(5):\n    print(i)`;
    }
    
    if (expectedOutput) {
        expectedOutput.placeholder = `# Digite a sa√≠da esperada\n# Exemplo:\nHello\n0\n1\n2\n3\n4`;
    }
    
    // Inicializar preview imediatamente
    setTimeout(() => {
        updateCodePreview(questionEl);
    }, 100);
}

function updateCodePreview(questionEl) {
    console.log('Atualizando preview de c√≥digo...');
    
    const questionInput = questionEl.querySelector('.question-input');
    const starterCode = questionEl.querySelector('.starter-code');
    const expectedOutput = questionEl.querySelector('.expected-output');
    
    const instruction = questionInput ? questionInput.value : 'Digite as instru√ß√µes do exerc√≠cio...';
    const starterCodeValue = starterCode ? starterCode.value : '# C√≥digo inicial aparecer√° aqui';
    const expectedOutputValue = expectedOutput ? expectedOutput.value : '# Sa√≠da esperada aparecer√° aqui';
    
    console.log('Instru√ß√£o:', instruction);
    console.log('Starter code:', starterCodeValue.substring(0, 50) + '...');
    console.log('Expected output:', expectedOutputValue.substring(0, 50) + '...');
    
    // Atualizar instru√ß√£o
    const instructionPreview = questionEl.querySelector('.instruction-preview');
    if (instructionPreview) {
        instructionPreview.textContent = instruction;
    }
    
    // Atualizar c√≥digo inicial
    const codePreview = questionEl.querySelector('.code-preview-content');
    if (codePreview) {
        // Formatar o c√≥digo para preservar espa√ßos e quebras de linha
        let formattedCode = starterCodeValue;
        
        // Se estiver vazio, mostrar placeholder
        if (!formattedCode.trim()) {
            formattedCode = '# C√≥digo inicial aparecer√° aqui';
        }
        
        // Aplicar formata√ß√£o b√°sica para HTML
        formattedCode = formattedCode
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;')
            .replace(/\n/g, '<br>')
            .replace(/ /g, '&nbsp;')
            .replace(/\t/g, '&nbsp;&nbsp;&nbsp;&nbsp;');
        
        codePreview.innerHTML = formattedCode;
        console.log('C√≥digo preview atualizado');
    }
    
    // Atualizar sa√≠da esperada
    const outputContent = questionEl.querySelector('.output-content');
    if (outputContent) {
        let formattedOutput = expectedOutputValue;
        
        // Se estiver vazio, mostrar placeholder
        if (!formattedOutput.trim()) {
            formattedOutput = '# Sa√≠da esperada aparecer√° aqui';
        }
        
        formattedOutput = formattedOutput
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/\n/g, '<br>')
            .replace(/ /g, '&nbsp;')
            .replace(/\t/g, '&nbsp;&nbsp;&nbsp;&nbsp;');
        
        outputContent.innerHTML = formattedOutput;
        console.log('Output preview atualizado');
    }
    
    // Mostrar/ocultar container de output baseado no conte√∫do
    const outputContainer = questionEl.querySelector('.output-preview');
    if (outputContainer) {
        if (expectedOutputValue && expectedOutputValue.trim() && expectedOutputValue !== '# Sa√≠da esperada aparecer√° aqui') {
            outputContainer.classList.remove('hidden');
        } else {
            outputContainer.classList.add('hidden');
        }
    }
}

// Simular execu√ß√£o de c√≥digo (para demonstra√ß√£o)
function simulateCodeExecution(button) {
    const questionEl = button.closest('.question-item');
    const outputContainer = questionEl.querySelector('.output-preview');
    const runButton = questionEl.querySelector('.run-button');
    const starterCode = questionEl.querySelector('.starter-code');
    const expectedOutput = questionEl.querySelector('.expected-output');
    
    if (!outputContainer || !runButton) return;
    
    // Mostrar loading
    runButton.innerHTML = `
        <div class="flex items-center gap-2">
            <div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
            <span>Executando...</span>
        </div>
    `;
    runButton.disabled = true;
    
    // Simular tempo de execu√ß√£o
    setTimeout(() => {
        outputContainer.classList.remove('hidden');
        
        // Se houver c√≥digo, simular execu√ß√£o
        const outputContent = questionEl.querySelector('.output-content');
        if (outputContent && starterCode && starterCode.value.trim()) {
            // Simular sa√≠da baseada no c√≥digo (exemplo simples)
            let simulatedOutput = '';
            const code = starterCode.value;
            
            if (code.includes('print(')) {
                // Extrair textos dos prints (simula√ß√£o b√°sica)
                const printMatches = code.match(/print\(["']([^"']*)["']\)/g);
                if (printMatches) {
                    printMatches.forEach(match => {
                        const textMatch = match.match(/print\(["']([^"']*)["']\)/);
                        if (textMatch && textMatch[1]) {
                            simulatedOutput += textMatch[1] + '\n';
                        }
                    });
                }
                
                // Simular loops b√°sicos
                if (code.includes('for') && code.includes('range')) {
                    const rangeMatch = code.match(/range\((\d+)\)/);
                    if (rangeMatch && rangeMatch[1]) {
                        const count = parseInt(rangeMatch[1]);
                        for (let i = 0; i < count; i++) {
                            simulatedOutput += i + '\n';
                        }
                    }
                }
            }
            
            if (!simulatedOutput.trim()) {
                simulatedOutput = '# Executando c√≥digo...\n# (Esta √© uma simula√ß√£o)';
            }
            
            outputContent.innerHTML = simulatedOutput
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\n/g, '<br>')
                .replace(/ /g, '&nbsp;')
                .replace(/\t/g, '&nbsp;&nbsp;&nbsp;&nbsp;');
        }
        
        // Restaurar bot√£o
        runButton.innerHTML = '‚ñ∂ Executar C√≥digo';
        runButton.disabled = false;
        
        showSaveIndicator('C√≥digo executado com sucesso!');
    }, 1500);
}

// ========== ATUALIZAR A FUN√á√ÉO DE PREVIEW ==========
function updateFillBlankPreview(questionEl) {
    const textarea = questionEl.querySelector('.fill-blank-textarea');
    const previewContainer = questionEl.querySelector('.code-preview-content');
    
    if (!textarea || !previewContainer) return;
    
    let text = textarea.value;
    
    // Processar o texto para HTML
    text = text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;')
        .replace(/\n/g, '<br>')
        .replace(/ /g, '&nbsp;')
        .replace(/\t/g, '&nbsp;&nbsp;&nbsp;&nbsp;');
    
    // Substituir lacunas
    text = text.replace(/\[_____\]/g, '<span class="blank-preview">&nbsp;_____&nbsp;</span>');
    
    previewContainer.innerHTML = text;
}

// REMOVA todas as fun√ß√µes relacionadas √† numera√ß√£o de linhas:
// - updateLineNumbers()
// - updateLineNumbersForElement()
// - syncScroll()
// - updatePreviewLineNumbers()

// ========== ATUALIZAR A INICIALIZA√á√ÉO ==========
function initializeFillBlankQuestion(questionEl) {
    const textarea = questionEl.querySelector('.fill-blank-textarea');
    
    if (textarea) {
        // Inicializar numera√ß√£o de linhas
        updateLineNumbers(textarea);
        
        // Configurar eventos
        textarea.addEventListener('keydown', function(e) {
            if (e.key === 'Tab') {
                e.preventDefault();
                insertSpacesInTextarea(this, 4);
                updateLineNumbers(this);
            }
        });
        
        textarea.addEventListener('input', function() {
            updateLineNumbers(this);
        });
        
        textarea.addEventListener('scroll', function() {
            syncScroll(this);
        });
        
        // Configurar placeholder com exemplo
        textarea.placeholder = `Digite o texto aqui. Use o bot√£o 'Adicionar Lacuna' para criar as lacunas.

Exemplo para c√≥digo:
if idade >= 18:
    print("Maior de idade")
else:
    print("Menor de idade")`;
    }
    
    // Configurar scroll do preview
    const previewContent = questionEl.querySelector('.code-preview-content');
    if (previewContent) {
        previewContent.addEventListener('scroll', function() {
            const previewLineNumbers = questionEl.querySelector('.preview-line-numbers');
            if (previewLineNumbers) {
                previewLineNumbers.scrollTop = this.scrollTop;
            }
        });
    }
    
    updateFillBlankPreview(questionEl);
    updateAnswerInputs(questionEl);
}

// ========== ATUALIZAR A FUN√á√ÉO DE ADICIONAR LACUNA ==========
function addBlankToText(button) {
    console.log('Adicionar lacuna chamado');
    
    const questionEl = button.closest('.question-item');
    const textarea = questionEl.querySelector('.fill-blank-textarea');
    
    if (!textarea) {
        console.error('Textarea n√£o encontrado');
        return;
    }
    
    // CORRE√á√ÉO: Garantir que o textarea est√° focado
    textarea.focus();
    
    setTimeout(() => {
        const startPos = textarea.selectionStart;
        const endPos = textarea.selectionEnd;
        const currentValue = textarea.value;
        
        // CORRE√á√ÉO: Inserir a lacuna na posi√ß√£o do cursor
        const newValue = currentValue.substring(0, startPos) + '[_____]' + currentValue.substring(endPos);
        textarea.value = newValue;
        
        // CORRE√á√ÉO: Reposicionar cursor ap√≥s a lacuna
        const newCursorPos = startPos + 7; // Comprimento de '[_____]'
        textarea.setSelectionRange(newCursorPos, newCursorPos);
        
        // CORRE√á√ÉO: Atualizar preview e respostas
        updateFillBlankPreview(questionEl);
        updateAnswerInputs(questionEl);
        
        // Disparar evento de input para for√ßar atualiza√ß√£o
        const inputEvent = new Event('input', { bubbles: true });
        textarea.dispatchEvent(inputEvent);
        
        showSaveIndicator('Lacuna adicionada');
        console.log('Lacuna adicionada com sucesso');
    }, 10);
}

// ========== ATUALIZAR A INICIALIZA√á√ÉO DE QUEST√ïES DE C√ìDIGO ==========
function initializeCodeQuestion(questionEl) {
    // Configurar eventos para atualizar preview em tempo real
    const questionInput = questionEl.querySelector('.question-input');
    const starterCode = questionEl.querySelector('.starter-code');
    const expectedOutput = questionEl.querySelector('.expected-output');
    
    // Configurar Tab para campos de c√≥digo
    if (starterCode) {
        starterCode.addEventListener('keydown', function(e) {
            if (e.key === 'Tab') {
                e.preventDefault();
                insertSpacesInTextarea(this, 4);
            }
        });
    }
    
    if (expectedOutput) {
        expectedOutput.addEventListener('keydown', function(e) {
            if (e.key === 'Tab') {
                e.preventDefault();
                insertSpacesInTextarea(this, 4);
            }
        });
    }
    
    if (questionInput) {
        questionInput.addEventListener('input', function() {
            updateCodePreview(questionEl);
        });
    }
    
    if (starterCode) {
        starterCode.addEventListener('input', function() {
            updateCodePreview(questionEl);
        });
    }
    
    if (expectedOutput) {
        expectedOutput.addEventListener('input', function() {
            updateCodePreview(questionEl);
        });
    }
    
    // Configurar placeholder espec√≠fico para c√≥digo
    if (starterCode) {
        starterCode.placeholder = `# Digite o c√≥digo inicial aqui\n# Exemplo:\nprint("Hello")\n\nfor i in range(5):\n    print(i)`;
    }
    
    if (expectedOutput) {
        expectedOutput.placeholder = `# Digite a sa√≠da esperada\n# Exemplo:\nHello\n0\n1\n2\n3\n4`;
    }
    
    // Inicializar preview
    updateCodePreview(questionEl);
}

console.log('JavaScript do Criar Conte√∫do carregado com sucesso!');
</script>
{% endblock %}


