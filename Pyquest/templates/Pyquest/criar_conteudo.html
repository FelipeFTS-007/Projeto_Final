{% extends "base.html" %}
{% load static %}

{% block title %}Criar Conte√∫do - PyQuest{% endblock %}

{% block extra_css %}
<style>
    .card-hover {
        transition: all 0.3s ease;
    }
    
    .card-hover:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.4);
    }
    
    .module-card {
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .module-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: linear-gradient(90deg, #3B82F6 0%, #1E40AF 100%);
    }
    
    .floating-element {
        animation: float 6s ease-in-out infinite;
    }
    
    @keyframes float {
        0% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
        100% { transform: translateY(0px); }
    }
    
    .interactive-card {
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .interactive-card:hover {
        transform: translateY(-3px) scale(1.02);
        box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.3);
    }
    
    .fade-in {
        animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .form-section {
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .form-section-header {
        background: linear-gradient(135deg, #3B82F6 0%, #1E40AF 100%);
        color: white;
        padding: 1rem 1.5rem;
        margin: -1.5rem -1.5rem 1.5rem -1.5rem;
        border-radius: 12px 12px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .question-item {
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }
    
    .question-item:hover {
        border-color: #3B82F6;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
    }
    
    .drag-handle {
        cursor: move;
        color: #64748b;
        transition: color 0.3s ease;
    }
    
    .drag-handle:hover {
        color: #3B82F6;
    }
    
    .option-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }
    
    .correct-option {
        background-color: #f0f9ff;
        border-left: 4px solid #3B82F6;
    }
    
    .empty-state {
        text-align: center;
        padding: 3rem 2rem;
        color: #64748b;
    }
    
    .empty-state img {
        opacity: 0.5;
        margin-bottom: 1rem;
    }
    
    .step-indicator {
        display: flex;
        justify-content: center;
        margin-bottom: 2rem;
    }
    
    .step {
        display: flex;
        align-items: center;
        color: #64748b;
        font-weight: 500;
    }
    
    .step.active {
        color: #3B82F6;
        font-weight: 600;
    }
    
    .step-number {
        width: 2rem;
        height: 2rem;
        border-radius: 50%;
        background: #e2e8f0;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 0.5rem;
        font-weight: 600;
    }
    
    .step.active .step-number {
        background: #3B82F6;
        color: white;
    }
    
    .step-connector {
        width: 4rem;
        height: 2px;
        background: #e2e8f0;
        margin: 0 1rem;
    }
    
    .step.active ~ .step-connector {
        background: #3B82F6;
    }
    
    .content-preview {
        background: #f8fafc;
        border: 2px dashed #cbd5e1;
        border-radius: 8px;
        padding: 1.5rem;
        min-height: 200px;
    }
    
    .question-preview {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 30px;
    }
    
    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    
    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #cbd5e1;
        transition: .4s;
        border-radius: 34px;
    }
    
    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 22px;
        width: 22px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }
    
    input:checked + .toggle-slider {
        background-color: #3B82F6;
    }
    
    input:checked + .toggle-slider:before {
        transform: translateX(30px);
    }
    
    /* Novos estilos adicionados */
    .step.completed {
        color: #10B981;
    }
    
    .step.completed .step-number {
        background: #10B981;
        color: white;
    }
    
    .question-item.dragging {
        opacity: 0.5;
        transform: rotate(5deg);
    }
    
    .question-item.drag-over {
        border: 2px dashed #3B82F6;
    }
    
    .validation-error {
        color: #EF4444;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }
    
    .form-control.error {
        border-color: #EF4444;
    }
    
    .progress-bar {
        height: 6px;
        background: #E5E7EB;
        border-radius: 3px;
        margin: 1rem 0;
        overflow: hidden;
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #3B82F6 0%, #1E40AF 100%);
        width: 25%;
        transition: width 0.5s ease;
    }
    
    .save-indicator {
        position: fixed;
        top: 1rem;
        right: 1rem;
        background: #10B981;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        display: none;
        align-items: center;
        gap: 0.5rem;
        z-index: 1000;
    }
    
    .question-counter {
        background: #3B82F6;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.875rem;
        font-weight: 600;
    }
    
    .auto-save-toggle {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        color: #64748B;
    }

    /* Estilos para o Modal */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }
    
    .modal-overlay.active {
        opacity: 1;
        visibility: visible;
    }
    
    .modal-content {
        background: white;
        border-radius: 12px;
        padding: 0;
        width: 90%;
        max-width: 500px;
        transform: translateY(-20px);
        transition: transform 0.3s ease;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    .modal-overlay.active .modal-content {
        transform: translateY(0);
    }
    
    .modal-header {
        background: linear-gradient(135deg, #3B82F6 0%, #1E40AF 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 12px 12px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .modal-header h3 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
    }
    
    .modal-close {
        background: none;
        border: none;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background-color 0.3s ease;
    }
    
    .modal-close:hover {
        background: rgba(255, 255, 255, 0.2);
    }
    
    .modal-body {
        padding: 1.5rem;
    }
    
    .modal-footer {
        padding: 1rem 1.5rem 1.5rem;
        display: flex;
        gap: 0.75rem;
        justify-content: flex-end;
        border-top: 1px solid #e2e8f0;
    }

    /* Novos estilos para o editor estilo Google Docs */
    .editor-container {
        border: 1px solid #dadce0;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .editor-toolbar {
        background: #f8f9fa;
        border-bottom: 1px solid #dadce0;
        padding: 8px 12px;
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        align-items: center;
    }
    
    .toolbar-group {
        display: flex;
        align-items: center;
        gap: 2px;
        padding: 0 8px;
        border-right: 1px solid #e0e0e0;
    }
    
    .toolbar-group:last-child {
        border-right: none;
    }
    
    .toolbar-button {
        background: transparent;
        border: none;
        border-radius: 4px;
        padding: 6px 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #5f6368;
        transition: all 0.2s ease;
        min-width: 32px;
        height: 32px;
    }
    
    .toolbar-button:hover {
        background: #f1f3f4;
        color: #1a73e8;
    }
    
    .toolbar-button.active {
        background: #e8f0fe;
        color: #1a73e8;
    }
    
    .toolbar-select {
        border: 1px solid #dadce0;
        border-radius: 4px;
        padding: 4px 8px;
        background: white;
        color: #3c4043;
        font-size: 13px;
        cursor: pointer;
        height: 32px;
    }
    
    .toolbar-select:focus {
        outline: none;
        border-color: #1a73e8;
    }
    
    .editor-content {
        background: white;
        min-height: 400px;
        padding: 20px;
        line-height: 1.6;
        font-family: 'Arial', sans-serif;
        font-size: 14px;
        color: #202124;
        outline: none;
        overflow-y: auto;
        max-height: 600px;
    }
    
    .editor-content:focus {
        outline: none;
    }
    
    .editor-content h1, .editor-content h2, .editor-content h3 {
        margin: 12px 0;
        color: #202124;
        font-weight: 400;
    }
    
    .editor-content h1 {
        font-size: 24px;
    }
    
    .editor-content h2 {
        font-size: 20px;
    }
    
    .editor-content h3 {
        font-size: 16px;
    }
    
    .editor-content p {
        margin: 8px 0;
    }
    
    .editor-content ul, .editor-content ol {
        margin: 8px 0;
        padding-left: 24px;
    }
    
    .editor-content blockquote {
        border-left: 4px solid #dadce0;
        margin: 12px 0;
        padding-left: 16px;
        color: #5f6368;
        font-style: italic;
    }
    
    .editor-content code {
        background: #f1f3f4;
        padding: 2px 4px;
        border-radius: 3px;
        font-family: 'Courier New', monospace;
        font-size: 13px;
    }
    
    .editor-content pre {
        background: #f8f9fa;
        border: 1px solid #dadce0;
        border-radius: 4px;
        padding: 12px;
        margin: 12px 0;
        overflow-x: auto;
        font-family: 'Courier New', monospace;
        font-size: 13px;
        line-height: 1.4;
    }
    
    .color-picker {
        position: relative;
        display: inline-block;
    }
    
    .color-options {
        position: absolute;
        top: 100%;
        left: 0;
        background: white;
        border: 1px solid #dadce0;
        border-radius: 4px;
        padding: 8px;
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        gap: 4px;
        z-index: 1000;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        display: none;
    }
    
    .color-option {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        cursor: pointer;
        border: 1px solid #e0e0e0;
    }
    
    .color-option:hover {
        transform: scale(1.1);
    }
    
    .toolbar-divider {
        width: 1px;
        height: 20px;
        background: #e0e0e0;
        margin: 0 8px;
    }
    
    .word-count {
        color: #5f6368;
        font-size: 12px;
        margin-left: auto;
        padding: 0 8px;
    }
    
    /* Estilo para texto selecionado */
    .editor-content ::selection {
        background: #c2e7ff;
    }
    
    /* Estilos para imagens no editor */
    .editor-content img {
        max-width: 100%;
        height: auto;
        border-radius: 4px;
        margin: 8px 0;
    }
    
    /* Estilo para links */
    .editor-content a {
        color: #1a73e8;
        text-decoration: underline;
    }
    
    /* Estilo para tabelas */
    .editor-content table {
        border-collapse: collapse;
        width: 100%;
        margin: 12px 0;
    }
    
    .editor-content table, .editor-content th, .editor-content td {
        border: 1px solid #dadce0;
    }
    
    .editor-content th, .editor-content td {
        padding: 8px 12px;
        text-align: left;
    }
    
    .editor-content th {
        background: #f8f9fa;
        font-weight: 500;
    }

    .option-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
    padding: 0.5rem;
    border-radius: 4px;
    transition: background-color 0.2s ease;
}

.option-item:hover {
    background-color: #f8fafc;
}

.option-input {
    flex: 1;
    padding: 0.5rem;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    color: #374151; /* Cor preta padr√£o */
    background-color: white;
}

.option-input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.correct-option {
    background-color: #f0f9ff !important;
    border-left: 4px solid #3b82f6;
    padding-left: 8px;
}

/* Remover qualquer estilo vermelho indesejado */
.option-input.error {
    border-color: #ef4444;
    color: #374151; /* Manter cor preta mesmo quando h√° erro */
}


/* Estilos para o Editor de C√≥digo */
/* Estilos m√≠nimos para a quest√£o de c√≥digo */
.code-preview {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 4px;
    min-height: 40px;
    white-space: pre-wrap;
    font-family: 'Courier New', monospace;
}

.output-preview {
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 4px;
    min-height: 40px;
    font-family: 'Courier New', monospace;
}

.run-button {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    transition: all 0.3s ease;
}

.run-button:hover:not(:disabled) {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
    transform: translateY(-1px);
}

.run-button:disabled {
    opacity: 0.7;
    cursor: not-allowed;
}

.instruction-preview {
    color: #4b5563;
    line-height: 1.5;
}


/* Estilos consolidados para Completar Lacunas */
.blank-preview {
    display: inline-block;
    min-width: 80px;
    text-align: center;
    font-weight: 500;
    background: #fef3c7;
    border: 2px dashed #f59e0b;
    border-radius: 6px;
    padding: 2px 8px;
    margin: 0 2px;
    transition: all 0.2s ease;
}

.blank-filled {
    background: #d1fae5;
    border: 2px solid #10b981;
    color: #065f46;
    font-weight: 600;
}

.word-bank {
    min-height: 60px;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 8px;
    margin: 12px 0;
}

.word-option {
    background: #dbeafe;
    border: 2px solid #3b82f6;
    border-radius: 8px;
    padding: 8px 12px;
    text-align: center;
    cursor: grab;
    transition: all 0.2s ease;
    user-select: none;
    font-weight: 500;
}

.word-option:hover {
    background: #3b82f6;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
}

.word-option:active {
    cursor: grabbing;
    transform: scale(0.95);
}

.fill-blank-textarea {
    font-family: 'Arial', sans-serif;
    line-height: 1.6;
    min-height: 120px;
}




</style>
{% endblock %}

{% block content %}
<div class="space-y-8 fade-in">
    <!-- Cabe√ßalho -->
    <div class="bg-gradient-to-r from-blue-600 to-blue-800 rounded-2xl p-8 text-white">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold mb-2">Criar Conte√∫do</h1>
                <p class="text-blue-100 text-lg">Desenvolva materiais de aprendizado interativos para seus alunos</p>
            </div>
            <img src="{% static 'imagem/edit_note_100dp_FFFFFF_FILL0_wght400_GRAD0_opsz48.png' %}" alt="Criar Conte√∫do" class="w-16 h-16 floating-element">
        </div>
        
        <!-- Barra de Progresso -->
        <div class="mt-4">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div class="flex justify-between text-blue-200 text-sm">
                <span>Estrutura</span>
                <span>Conte√∫do Te√≥rico</span>
                <span>Exerc√≠cios Pr√°ticos</span>
                <span>Revis√£o</span>
            </div>
        </div>
    </div>

    <!-- Indicador de Passos -->
    <div class="step-indicator">
        <div class="step active" data-step="1">
            <div class="step-number">1</div>
            <span>Estrutura</span>
        </div>
        <div class="step-connector"></div>
        <div class="step" data-step="2">
            <div class="step-number">2</div>
            <span>Conte√∫do Te√≥rico</span>
        </div>
        <div class="step-connector"></div>
        <div class="step" data-step="3">
            <div class="step-number">3</div>
            <span>Exerc√≠cios Pr√°ticos</span>
        </div>
        <div class="step-connector"></div>
        <div class="step" data-step="4">
            <div class="step-number">4</div>
            <span>Revis√£o</span>
        </div>
    </div>

    <!-- Form Principal -->
    <form id="content-form" class="space-y-6">
        <!-- PASSO 1: ESTRUTURA DO CONTE√öDO -->
        <div id="step-1" class="form-section">
            <div class="form-section-header">
                <h2 class="text-xl font-bold">üìö Estrutura do Conte√∫do</h2>
                <span class="text-blue-200">Passo 1 de 4</span>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Cap√≠tulo -->
                <div>
                    <label for="chapter-select" class="block text-sm font-medium text-gray-700 mb-2">Cap√≠tulo</label>
                    <select id="chapter-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 form-control">
                        <option value="" selected disabled>Selecionar Cap√≠tulo</option>
                        <option value="chapter-1">Introdu√ß√£o ao Python</option>
                        <option value="chapter-2">Fundamentos da Programa√ß√£o</option>
                        <option value="chapter-3">Estruturas de Controle</option>
                        <option value="new">+ Criar Novo Cap√≠tulo</option>
                    </select>
                    <div class="validation-error" id="chapter-error"></div>
                </div>
                
                <!-- M√≥dulo -->
                <div>
                    <label for="module-select" class="block text-sm font-medium text-gray-700 mb-2">M√≥dulo</label>
                    <select id="module-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 form-control" disabled>
                        <option value="" selected disabled>Selecione um cap√≠tulo primeiro</option>
                    </select>
                    <div class="validation-error" id="module-error"></div>
                </div>
                
                <!-- Tarefa -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tarefa</label>
                    <div class="space-y-3">
                        <input type="text" placeholder="T√≠tulo da Tarefa" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 form-control">
                        <div class="flex items-center gap-4">
                            <label class="flex items-center gap-2">
                                <input type="checkbox" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" id="theory-checkbox" checked>
                                <span class="text-sm text-gray-700">Conte√∫do Te√≥rico</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" id="exercises-checkbox" checked>
                                <span class="text-sm text-gray-700">Exerc√≠cios Pr√°ticos</span>
                            </label>
                        </div>
                    </div>
                    <div class="validation-error" id="task-error"></div>
                </div>
            </div>
            
            <div class="mt-6 flex justify-end">
                <button type="button" onclick="validateStep1()" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition interactive-card">
                    Pr√≥ximo ‚Üí Conte√∫do Te√≥rico
                </button>
            </div>
        </div>

        <!-- PASSO 2: CONTE√öDO TE√ìRICO -->
<div id="step-2" class="form-section hidden">
    <div class="form-section-header">
        <h2 class="text-xl font-bold">üìñ Conte√∫do Te√≥rico</h2>
        <span class="text-blue-200">Passo 2 de 4</span>
    </div>
    
    <div class="space-y-4">
        <div>
            <label for="lesson-title" class="block text-sm font-medium text-gray-700 mb-2">T√≠tulo da Aula Te√≥rica</label>
            <input type="text" id="lesson-title" placeholder="Ex: Introdu√ß√£o ao Python" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 form-control">
            <div class="validation-error" id="lesson-title-error"></div>
        </div>
        
        <div>
            <div class="flex justify-between items-center mb-4">
                <label class="block text-sm font-medium text-gray-700">Conte√∫do da Aula</label>
                <button type="button" id="add-topic-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition interactive-card flex items-center gap-2">
                    <img src="{% static 'imagem/add_35dp_FFFFFF_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Adicionar" class="w-4 h-4">
                    Adicionar T√≥pico
                </button>
            </div>
            
            <!-- Container de T√≥picos -->
            <div id="topics-container" class="space-y-4">
                <!-- T√≥pico padr√£o (inicial) -->
                <div class="topic-item border border-gray-300 rounded-lg overflow-hidden">
                    <div class="topic-header bg-gray-50 p-4 border-b border-gray-300 flex justify-between items-center">
                        <div class="flex items-center gap-3 flex-1">
                            <div class="drag-handle cursor-move">
                                <img src="{% static 'imagem/drag_handle_35dp_64748b_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Arrastar" class="w-5 h-5">
                            </div>
                            <input type="text" class="topic-title bg-transparent border-none text-lg font-semibold focus:outline-none focus:ring-2 focus:ring-blue-500 rounded px-2 py-1" 
                                   value="Introdu√ß√£o" placeholder="Nome do t√≥pico">
                        </div>
                        <button type="button" class="remove-topic text-red-500 hover:text-red-700 interactive-card" aria-label="Remover t√≥pico">
                            <img src="{% static 'imagem/delete_35dp_ef4444_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Remover" class="w-5 h-5">
                        </button>
                    </div>
                    <div class="topic-content p-4">
                        <!-- Editor estilo Google Docs -->
                        <div class="editor-container">
                            <!-- Barra de Ferramentas -->
                            <div class="editor-toolbar">
                                <!-- Grupo de Formata√ß√£o de Texto -->
                                <div class="toolbar-group">
                                    <select class="toolbar-select format-block">
                                        <option value="p">Texto normal</option>
                                        <option value="h1">T√≠tulo 1</option>
                                        <option value="h2">T√≠tulo 2</option>
                                        <option value="h3">T√≠tulo 3</option>
                                        <option value="blockquote">Cita√ß√£o</option>
                                        <option value="pre">Bloco de c√≥digo</option>
                                    </select>
                                </div>
                                
                                <div class="toolbar-divider"></div>
                                
                                <!-- Grupo de Fonte -->
                                <div class="toolbar-group">
                                    <select class="toolbar-select font-family">
                                        <option value="Arial, sans-serif">Arial</option>
                                        <option value="'Times New Roman', serif">Times New Roman</option>
                                        <option value="'Courier New', monospace">Courier New</option>
                                        <option value="Georgia, serif">Georgia</option>
                                        <option value="Verdana, sans-serif">Verdana</option>
                                    </select>
                                    
                                    <select class="toolbar-select font-size">
                                        <option value="1">8px</option>
                                        <option value="2">10px</option>
                                        <option value="3">12px</option>
                                        <option value="4" selected>14px</option>
                                        <option value="5">18px</option>
                                        <option value="6">24px</option>
                                        <option value="7">36px</option>
                                    </select>
                                </div>
                                
                                <div class="toolbar-divider"></div>
                                
                                <!-- Grupo de Estilo de Texto -->
                                <div class="toolbar-group">
                                    <button type="button" class="toolbar-button" data-command="bold" title="Negrito (Ctrl+B)">
                                        <strong>B</strong>
                                    </button>
                                    <button type="button" class="toolbar-button" data-command="italic" title="It√°lico (Ctrl+I)">
                                        <em>I</em>
                                    </button>
                                    <button type="button" class="toolbar-button" data-command="underline" title="Sublinhado (Ctrl+U)">
                                        <u>U</u>
                                    </button>
                                    <button type="button" class="toolbar-button" data-command="strikeThrough" title="Tachado">
                                        <s>S</s>
                                    </button>
                                </div>
                                
                                <div class="toolbar-divider"></div>
                                
                                <!-- Grupo de Cores -->
                                <div class="toolbar-group">
                                    <div class="color-picker">
                                        <button type="button" class="toolbar-button text-color-button" title="Cor do texto">
                                            <span style="color: #202124;">A</span>
                                        </button>
                                        <div class="color-options text-color-options">
                                            <div class="color-option" style="background-color: #202124;" data-color="#202124"></div>
                                            <div class="color-option" style="background-color: #5f6368;" data-color="#5f6368"></div>
                                            <div class="color-option" style="background-color: #ea4335;" data-color="#ea4335"></div>
                                            <div class="color-option" style="background-color: #fbbc04;" data-color="#fbbc04"></div>
                                            <div class="color-option" style="background-color: #34a853;" data-color="#34a853"></div>
                                            <div class="color-option" style="background-color: #4285f4;" data-color="#4285f4"></div>
                                            <div class="color-option" style="background-color: #1a73e8;" data-color="#1a73e8"></div>
                                            <div class="color-option" style="background-color: #8e24aa;" data-color="#8e24aa"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="color-picker">
                                        <button type="button" class="toolbar-button highlight-color-button" title="Cor de destaque">
                                            <span style="background-color: #fbbc04; padding: 2px 4px; border-radius: 2px;">A</span>
                                        </button>
                                        <div class="color-options highlight-color-options">
                                            <div class="color-option" style="background-color: #fbbc04;" data-color="#fbbc04"></div>
                                            <div class="color-option" style="background-color: #c2e7ff;" data-color="#c2e7ff"></div>
                                            <div class="color-option" style="background-color: #aecbfa;" data-color="#aecbfa"></div>
                                            <div class="color-option" style="background-color: #fdcfe8;" data-color="#fdcfe8"></div>
                                            <div class="color-option" style="background-color: #e6c9a8;" data-color="#e6c9a8"></div>
                                            <div class="color-option" style="background-color: #a8dab5;" data-color="#a8dab5"></div>
                                            <div class="color-option" style="background-color: #fff475;" data-color="#fff475"></div>
                                            <div class="color-option" style="background-color: #ffffff; border: 1px solid #dadce0;" data-color="transparent"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="toolbar-divider"></div>
                                
                                <!-- Grupo de Alinhamento -->
                                <div class="toolbar-group">
                                    <button type="button" class="toolbar-button" data-command="justifyLeft" title="Alinhar √† esquerda">
                                        <img src="{% static 'imagem/format_align_left_35dp_5f6368_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Alinhar √† esquerda" class="w-4 h-4">
                                    </button>
                                    <button type="button" class="toolbar-button" data-command="justifyCenter" title="Centralizar">
                                        <img src="{% static 'imagem/format_align_center_35dp_5f6368_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Centralizar" class="w-4 h-4">
                                    </button>
                                    <button type="button" class="toolbar-button" data-command="justifyRight" title="Alinhar √† direita">
                                        <img src="{% static 'imagem/format_align_right_35dp_5f6368_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Alinhar √† direita" class="w-4 h-4">
                                    </button>
                                    <button type="button" class="toolbar-button" data-command="justifyFull" title="Justificar">
                                        <img src="{% static 'imagem/format_align_justify_35dp_5f6368_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Justificar" class="w-4 h-4">
                                    </button>
                                </div>
                                
                                <div class="toolbar-divider"></div>
                                
                                <!-- Grupo de Listas -->
                                <div class="toolbar-group">
                                    <button type="button" class="toolbar-button" data-command="insertUnorderedList" title="Lista com marcadores">
                                        <img src="{% static 'imagem/format_list_bulleted_35dp_5f6368_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Lista com marcadores" class="w-4 h-4">
                                    </button>
                                    <button type="button" class="toolbar-button" data-command="insertOrderedList" title="Lista numerada">
                                        <img src="{% static 'imagem/format_list_numbered_35dp_5f6368_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Lista numerada" class="w-4 h-4">
                                    </button>
                                    <button type="button" class="toolbar-button" data-command="outdent" title="Diminuir recuo">
                                        <img src="{% static 'imagem/format_indent_decrease_35dp_5f6368_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Diminuir recuo" class="w-4 h-4">
                                    </button>
                                    <button type="button" class="toolbar-button" data-command="indent" title="Aumentar recuo">
                                        <img src="{% static 'imagem/format_indent_increase_35dp_5f6368_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Aumentar recuo" class="w-4 h-4">
                                    </button>
                                </div>
                                
                                <div class="toolbar-divider"></div>
                                
                                <!-- Grupo de Inser√ß√£o -->
                                <div class="toolbar-group">
                                    <button type="button" class="toolbar-button insert-link" title="Inserir link">
                                        <img src="{% static 'imagem/link_35dp_5f6368_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Inserir link" class="w-4 h-4">
                                    </button>
                                    <button type="button" class="toolbar-button insert-image" title="Inserir imagem">
                                        <img src="{% static 'imagem/image_35dp_5f6368_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Inserir imagem" class="w-4 h-4">
                                    </button>
                                    <button type="button" class="toolbar-button insert-table" title="Inserir tabela">
                                        <img src="{% static 'imagem/table_chart_35dp_5f6368_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Inserir tabela" class="w-4 h-4">
                                    </button>
                                    <button type="button" class="toolbar-button insert-code" title="Inserir c√≥digo">
                                        <img src="{% static 'imagem/code_35dp_5f6368_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Inserir c√≥digo" class="w-4 h-4">
                                    </button>
                                </div>
                                
                                <!-- Contador de palavras -->
                                <div class="word-count">
                                    <span class="word-count-display">0 palavras</span>
                                </div>
                            </div>
                            
                            <!-- √Årea de Conte√∫do Edit√°vel -->
                            <div class="editor-content topic-editor" contenteditable="true" placeholder="Comece a escrever o conte√∫do deste t√≥pico aqui...">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="validation-error" id="theory-content-error"></div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label for="estimated-time" class="block text-sm font-medium text-gray-700 mb-2">Tempo Estimado (minutos)</label>
                <input type="number" id="estimated-time" min="1" max="120" placeholder="Ex: 45" class="w-full p-3 border border-gray-300 rounded-lg form-control">
                <div class="validation-error" id="time-error"></div>
            </div>
            <div>
                <label for="difficulty-level" class="block text-sm font-medium text-gray-700 mb-2">N√≠vel de Dificuldade</label>
                <select id="difficulty-level" class="w-full p-3 border border-gray-300 rounded-lg form-control">
                    <option value="beginner">Iniciante</option>
                    <option value="intermediate">Intermedi√°rio</option>
                    <option value="advanced">Avan√ßado</option>
                </select>
            </div>
        </div>
    </div>
    
    <div class="mt-6 flex justify-between">
        <button type="button" onclick="prevStep(1)" class="bg-gray-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-600 transition interactive-card">
            ‚Üê Voltar
        </button>
        <button type="button" onclick="validateStep2()" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition interactive-card">
            Pr√≥ximo ‚Üí Exerc√≠cios Pr√°ticos
        </button>
    </div>
</div>

        <!-- PASSO 3: EXERC√çCIOS PR√ÅTICOS -->
        <div id="step-3" class="form-section hidden">
            <div class="form-section-header">
                <div class="flex items-center gap-3">
                    <h2 class="text-xl font-bold">üíª Exerc√≠cios Pr√°ticos</h2>
                    <span class="question-counter" id="question-count">0</span>
                </div>
                <span class="text-blue-200">Passo 3 de 4</span>
            </div>
            
            <div class="space-y-6">
                <!-- Seletor de Tipo de Exerc√≠cio -->
                <div class="bg-blue-50 p-4 rounded-lg">
                    <label class="block text-sm font-medium text-gray-700 mb-3">Adicionar Novo Exerc√≠cio</label>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <button type="button" onclick="addQuestion('multiple-choice')" class="p-4 bg-white border-2 border-blue-200 rounded-lg text-center hover:border-blue-400 transition interactive-card">
                            <img src="{% static 'imagem/quiz_35dp_2682EA_FILL0_wght400_GRAD0_opsz40.png' %}" alt="M√∫ltipla Escolha" class="w-8 h-8 mx-auto mb-2">
                            <span class="font-semibold text-blue-700">M√∫ltipla Escolha</span>
                        </button>
                        
                        <button type="button" onclick="addQuestion('code')" class="p-4 bg-white border-2 border-blue-200 rounded-lg text-center hover:border-blue-400 transition interactive-card">
                            <img src="{% static 'imagem/code_35dp_2682EA_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Escrever C√≥digo" class="w-8 h-8 mx-auto mb-2">
                            <span class="font-semibold text-blue-700">Escrever C√≥digo</span>
                        </button>
                        
                        <button type="button" onclick="addQuestion('fill-blank')" class="p-4 bg-white border-2 border-blue-200 rounded-lg text-center hover:border-blue-400 transition interactive-card">
                            <img src="{% static 'imagem/edit_35dp_2682EA_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Completar Lacunas" class="w-8 h-8 mx-auto mb-2">
                            <span class="font-semibold text-blue-700">Completar Lacunas</span>
                        </button>
                    </div>
                </div>
                
                <!-- Lista de Exerc√≠cios -->
                <div id="questions-list" class="space-y-4">
                    <div class="empty-state">
                        <img src="{% static 'imagem/note_stack_100dp_64748b_FILL0_wght400_GRAD0_opsz48.png' %}" alt="Sem exerc√≠cios" class="w-16 h-16 mx-auto">
                        <p class="text-gray-500">Nenhum exerc√≠cio adicionado ainda</p>
                        <p class="text-sm text-gray-400">Clique em um dos tipos acima para come√ßar</p>
                    </div>
                </div>
            </div>
            
            <div class="mt-6 flex justify-between">
                <button type="button" onclick="prevStep(2)" class="bg-gray-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-600 transition interactive-card">
                    ‚Üê Voltar
                </button>
                <button type="button" onclick="validateStep3()" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition interactive-card">
                    Pr√≥ximo ‚Üí Revis√£o
                </button>
            </div>
        </div>

        <!-- PASSO 4: REVIS√ÉO E PUBLICA√á√ÉO -->
        <div id="step-4" class="form-section hidden">
            <div class="form-section-header">
                <h2 class="text-xl font-bold">üëÅÔ∏è Revis√£o Final</h2>
                <span class="text-blue-200">Passo 4 de 4</span>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Preview do Conte√∫do -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Pr√©-visualiza√ß√£o do Conte√∫do</h3>
                    <div class="content-preview">
                        <div id="content-preview-area">
                            <p class="text-gray-500 text-center py-8">O preview do conte√∫do aparecer√° aqui</p>
                        </div>
                    </div>
                </div>
                
                <!-- Configura√ß√µes Finais -->
                <div class="space-y-6">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Configura√ß√µes de Publica√ß√£o</h3>
                        
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <span class="text-gray-700">Publicar Imediatamente</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="publish-immediately">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <span class="text-gray-700">Permitir Coment√°rios</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="allow-comments" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <span class="text-gray-700">Ativar Progresso do Aluno</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="track-progress" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            
                            <div>
                                <label for="task-xp" class="block text-sm font-medium text-gray-700 mb-2">XP da Tarefa</label>
                                <input type="number" id="task-xp" min="0" max="1000" value="100" class="w-full p-3 border border-gray-300 rounded-lg form-control">
                            </div>
                            
                            <div class="auto-save-toggle">
                                <input type="checkbox" id="auto-save" checked>
                                <label for="auto-save">Salvamento autom√°tico</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <div class="flex items-start gap-3">
                            <img src="{% static 'imagem/info_35dp_92400e_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Informa√ß√£o" class="w-5 h-5 mt-0.5">
                            <div>
                                <h4 class="font-semibold text-yellow-800">Antes de Publicar</h4>
                                <p class="text-yellow-700 text-sm mt-1">Revise todo o conte√∫do, exerc√≠cios e configura√ß√µes. Ap√≥s a publica√ß√£o, o conte√∫do ficar√° dispon√≠vel para todos os alunos.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-6 flex justify-between">
                <button type="button" onclick="prevStep(3)" class="bg-gray-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-600 transition interactive-card">
                    ‚Üê Voltar
                </button>
                <button type="submit" class="bg-green-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-green-700 transition interactive-card flex items-center gap-2">
                    <img src="{% static 'imagem/publish_35dp_FFFFFF_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Publicar" class="w-5 h-5">
                    Publicar Conte√∫do
                </button>
            </div>
        </div>
    </form>
</div>


<!-- Modal para Criar Novo Cap√≠tulo -->
<div class="modal-overlay" id="chapter-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Criar Novo Cap√≠tulo</h3>
            <button type="button" class="modal-close" onclick="closeChapterModal()">√ó</button>
        </div>
        
        <form id="new-chapter-form">
            <div class="modal-body space-y-4">
                <div>
                    <label for="new-chapter-title" class="block text-sm font-medium text-gray-700 mb-2">
                        T√≠tulo do Cap√≠tulo *
                    </label>
                    <input type="text" id="new-chapter-title" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 form-control"
                           placeholder="Ex: Introdu√ß√£o ao Python"
                           required>
                    <div class="validation-error" id="new-chapter-title-error"></div>
                </div>
                
                <div>
                    <label for="new-chapter-description" class="block text-sm font-medium text-gray-700 mb-2">
                        Descri√ß√£o do Cap√≠tulo
                    </label>
                    <textarea id="new-chapter-description" rows="4"
                              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 form-control"
                              placeholder="Descreva o objetivo e conte√∫do deste cap√≠tulo..."></textarea>
                </div>
                
                <div class="bg-blue-50 p-4 rounded-lg">
                    <div class="flex items-start gap-3">
                        <img src="{% static 'imagem/info_35dp_2682EA_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Informa√ß√£o" class="w-5 h-5 mt-0.5">
                        <div>
                            <h4 class="font-semibold text-blue-800 text-sm">Sobre Cap√≠tulos</h4>
                            <p class="text-blue-700 text-xs mt-1">Cap√≠tulos organizam o conte√∫do em grandes temas. Cada cap√≠tulo pode conter m√∫ltiplos m√≥dulos com aulas espec√≠ficas.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" onclick="closeChapterModal()" class="px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 transition interactive-card">
                    Cancelar
                </button>
                <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition interactive-card flex items-center gap-2">
                    <img src="{% static 'imagem/add_35dp_FFFFFF_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Adicionar" class="w-4 h-4">
                    Criar Cap√≠tulo
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal para Criar Novo M√≥dulo -->
<div class="modal-overlay" id="module-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Criar Novo M√≥dulo</h3>
            <button type="button" class="modal-close" onclick="closeModuleModal()">√ó</button>
        </div>
        
        <form id="new-module-form">
            <div class="modal-body space-y-4">
                <!-- Mostrar o cap√≠tulo selecionado (apenas informativo) -->
                <div class="bg-blue-50 p-3 rounded-lg">
                    <div class="flex items-center gap-2 text-blue-700">
                        <img src="{% static 'imagem/folder_35dp_2682EA_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Cap√≠tulo" class="w-4 h-4">
                        <span class="text-sm font-medium">Cap√≠tulo:</span>
                        <span id="selected-chapter-name" class="text-sm">-</span>
                    </div>
                </div>
                
                <div>
                    <label for="new-module-title" class="block text-sm font-medium text-gray-700 mb-2">
                        T√≠tulo do M√≥dulo *
                    </label>
                    <input type="text" id="new-module-title" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 form-control"
                           placeholder="Ex: Vari√°veis e Tipos de Dados"
                           required>
                    <div class="validation-error" id="new-module-title-error"></div>
                </div>
                
                <div>
                    <label for="new-module-description" class="block text-sm font-medium text-gray-700 mb-2">
                        Descri√ß√£o do M√≥dulo
                    </label>
                    <textarea id="new-module-description" rows="4"
                              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 form-control"
                              placeholder="Descreva o objetivo e conte√∫do deste m√≥dulo..."></textarea>
                </div>
                
                <div class="bg-blue-50 p-4 rounded-lg">
                    <div class="flex items-start gap-3">
                        <img src="{% static 'imagem/info_35dp_2682EA_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Informa√ß√£o" class="w-5 h-5 mt-0.5">
                        <div>
                            <h4 class="font-semibold text-blue-800 text-sm">Sobre M√≥dulos</h4>
                            <p class="text-blue-700 text-xs mt-1">M√≥dulos organizam o conte√∫do dentro de um cap√≠tulo. Cada m√≥dulo cont√©m aulas e exerc√≠cios espec√≠ficos sobre um t√≥pico.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" onclick="closeModuleModal()" class="px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 transition interactive-card">
                    Cancelar
                </button>
                <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition interactive-card flex items-center gap-2">
                    <img src="{% static 'imagem/add_35dp_FFFFFF_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Adicionar" class="w-4 h-4">
                    Criar M√≥dulo
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Indicador de salvamento -->
<div class="save-indicator" id="save-indicator">
    <img src="{% static 'imagem/check_circle_35dp_FFFFFF_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Salvo" class="w-5 h-5">
    <span>Altera√ß√µes salvas</span>
</div>


<!-- Template para novos t√≥picos -->
<template id="topic-template">
    <div class="topic-item border border-gray-300 rounded-lg overflow-hidden">
        <div class="topic-header bg-gray-50 p-4 border-b border-gray-300 flex justify-between items-center">
            <div class="flex items-center gap-3 flex-1">
                <div class="drag-handle cursor-move">
                    <img src="{% static 'imagem/drag_handle_35dp_64748b_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Arrastar" class="w-5 h-5">
                </div>
                <input type="text" class="topic-title bg-transparent border-none text-lg font-semibold focus:outline-none focus:ring-2 focus:ring-blue-500 rounded px-2 py-1" 
                       placeholder="Nome do t√≥pico">
            </div>
            <button type="button" class="remove-topic text-red-500 hover:text-red-700 interactive-card" aria-label="Remover t√≥pico">
                <img src="{% static 'imagem/delete_35dp_ef4444_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Remover" class="w-5 h-5">
            </button>
        </div>
        <div class="topic-content p-4">
            <!-- Editor estilo Google Docs -->
            <div class="editor-container">
                <!-- Barra de Ferramentas -->
                <div class="editor-toolbar">
                    <!-- Grupo de Formata√ß√£o de Texto -->
                    <div class="toolbar-group">
                        <select class="toolbar-select format-block">
                            <option value="p">Texto normal</option>
                            <option value="h1">T√≠tulo 1</option>
                            <option value="h2">T√≠tulo 2</option>
                            <option value="h3">T√≠tulo 3</option>
                            <option value="blockquote">Cita√ß√£o</option>
                            <option value="pre">Bloco de c√≥digo</option>
                        </select>
                    </div>
                    
                    <div class="toolbar-divider"></div>
                    
                    <!-- Grupo de Fonte -->
                    <div class="toolbar-group">
                        <select class="toolbar-select font-family">
                            <option value="Arial, sans-serif">Arial</option>
                            <option value="'Times New Roman', serif">Times New Roman</option>
                            <option value="'Courier New', monospace">Courier New</option>
                            <option value="Georgia, serif">Georgia</option>
                            <option value="Verdana, sans-serif">Verdana</option>
                        </select>
                        
                        <select class="toolbar-select font-size">
                            <option value="1">8px</option>
                            <option value="2">10px</option>
                            <option value="3">12px</option>
                            <option value="4" selected>14px</option>
                            <option value="5">18px</option>
                            <option value="6">24px</option>
                            <option value="7">36px</option>
                        </select>
                    </div>
                    
                    <div class="toolbar-divider"></div>
                    
                    <!-- Grupo de Estilo de Texto -->
                    <div class="toolbar-group">
                        <button type="button" class="toolbar-button" data-command="bold" title="Negrito (Ctrl+B)">
                            <strong>B</strong>
                        </button>
                        <button type="button" class="toolbar-button" data-command="italic" title="It√°lico (Ctrl+I)">
                            <em>I</em>
                        </button>
                        <button type="button" class="toolbar-button" data-command="underline" title="Sublinhado (Ctrl+U)">
                            <u>U</u>
                        </button>
                        <button type="button" class="toolbar-button" data-command="strikeThrough" title="Tachado">
                            <s>S</s>
                        </button>
                    </div>
                    
                    <div class="toolbar-divider"></div>
                    
                    <!-- Grupo de Cores -->
                    <div class="toolbar-group">
                        <div class="color-picker">
                            <button type="button" class="toolbar-button text-color-button" title="Cor do texto">
                                <span style="color: #202124;">A</span>
                            </button>
                            <div class="color-options text-color-options">
                                <div class="color-option" style="background-color: #202124;" data-color="#202124"></div>
                                <div class="color-option" style="background-color: #5f6368;" data-color="#5f6368"></div>
                                <div class="color-option" style="background-color: #ea4335;" data-color="#ea4335"></div>
                                <div class="color-option" style="background-color: #fbbc04;" data-color="#fbbc04"></div>
                                <div class="color-option" style="background-color: #34a853;" data-color="#34a853"></div>
                                <div class="color-option" style="background-color: #4285f4;" data-color="#4285f4"></div>
                                <div class="color-option" style="background-color: #1a73e8;" data-color="#1a73e8"></div>
                                <div class="color-option" style="background-color: #8e24aa;" data-color="#8e24aa"></div>
                            </div>
                        </div>
                        
                        <div class="color-picker">
                            <button type="button" class="toolbar-button highlight-color-button" title="Cor de destaque">
                                <span style="background-color: #fbbc04; padding: 2px 4px; border-radius: 2px;">A</span>
                            </button>
                            <div class="color-options highlight-color-options">
                                <div class="color-option" style="background-color: #fbbc04;" data-color="#fbbc04"></div>
                                <div class="color-option" style="background-color: #c2e7ff;" data-color="#c2e7ff"></div>
                                <div class="color-option" style="background-color: #aecbfa;" data-color="#aecbfa"></div>
                                <div class="color-option" style="background-color: #fdcfe8;" data-color="#fdcfe8"></div>
                                <div class="color-option" style="background-color: #e6c9a8;" data-color="#e6c9a8"></div>
                                <div class="color-option" style="background-color: #a8dab5;" data-color="#a8dab5"></div>
                                <div class="color-option" style="background-color: #fff475;" data-color="#fff475"></div>
                                <div class="color-option" style="background-color: #ffffff; border: 1px solid #dadce0;" data-color="transparent"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="toolbar-divider"></div>
                    
                    <!-- Grupo de Alinhamento -->
                    <div class="toolbar-group">
                        <button type="button" class="toolbar-button" data-command="justifyLeft" title="Alinhar √† esquerda">
                            <img src="{% static 'imagem/format_align_left_35dp_5f6368_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Alinhar √† esquerda" class="w-4 h-4">
                        </button>
                        <button type="button" class="toolbar-button" data-command="justifyCenter" title="Centralizar">
                            <img src="{% static 'imagem/format_align_center_35dp_5f6368_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Centralizar" class="w-4 h-4">
                        </button>
                        <button type="button" class="toolbar-button" data-command="justifyRight" title="Alinhar √† direita">
                            <img src="{% static 'imagem/format_align_right_35dp_5f6368_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Alinhar √† direita" class="w-4 h-4">
                        </button>
                        <button type="button" class="toolbar-button" data-command="justifyFull" title="Justificar">
                            <img src="{% static 'imagem/format_align_justify_35dp_5f6368_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Justificar" class="w-4 h-4">
                        </button>
                    </div>
                    
                    <div class="toolbar-divider"></div>
                    
                    <!-- Grupo de Listas -->
                    <div class="toolbar-group">
                        <button type="button" class="toolbar-button" data-command="insertUnorderedList" title="Lista com marcadores">
                            <img src="{% static 'imagem/format_list_bulleted_35dp_5f6368_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Lista com marcadores" class="w-4 h-4">
                        </button>
                        <button type="button" class="toolbar-button" data-command="insertOrderedList" title="Lista numerada">
                            <img src="{% static 'imagem/format_list_numbered_35dp_5f6368_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Lista numerada" class="w-4 h-4">
                        </button>
                        <button type="button" class="toolbar-button" data-command="outdent" title="Diminuir recuo">
                            <img src="{% static 'imagem/format_indent_decrease_35dp_5f6368_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Diminuir recuo" class="w-4 h-4">
                        </button>
                        <button type="button" class="toolbar-button" data-command="indent" title="Aumentar recuo">
                            <img src="{% static 'imagem/format_indent_increase_35dp_5f6368_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Aumentar recuo" class="w-4 h-4">
                        </button>
                    </div>
                    
                    <div class="toolbar-divider"></div>
                    
                    <!-- Grupo de Inser√ß√£o -->
                    <div class="toolbar-group">
                        <button type="button" class="toolbar-button insert-link" title="Inserir link">
                            <img src="{% static 'imagem/link_35dp_5f6368_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Inserir link" class="w-4 h-4">
                        </button>
                        <button type="button" class="toolbar-button insert-image" title="Inserir imagem">
                            <img src="{% static 'imagem/image_35dp_5f6368_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Inserir imagem" class="w-4 h-4">
                        </button>
                        <button type="button" class="toolbar-button insert-table" title="Inserir tabela">
                            <img src="{% static 'imagem/table_chart_35dp_5f6368_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Inserir tabela" class="w-4 h-4">
                        </button>
                        <button type="button" class="toolbar-button insert-code" title="Inserir c√≥digo">
                            <img src="{% static 'imagem/code_35dp_5f6368_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Inserir c√≥digo" class="w-4 h-4">
                        </button>
                    </div>
                    
                    <!-- Contador de palavras -->
                    <div class="word-count">
                        <span class="word-count-display">0 palavras</span>
                    </div>
                </div>
                
                <!-- √Årea de Conte√∫do Edit√°vel -->
                <div class="editor-content topic-editor" contenteditable="true" placeholder="Comece a escrever o conte√∫do deste t√≥pico aqui...">
                </div>
            </div>
        </div>
    </div>
</template>

<!-- Templates para os tipos de quest√µes -->
<template id="multiple-choice-template">
    <div class="question-item" data-type="multiple-choice">
        <div class="flex items-start justify-between mb-4">
            <div class="flex items-center gap-3">
                <div class="drag-handle">
                    <img src="{% static 'imagem/drag_handle_35dp_64748b_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Arrastar" class="w-5 h-5">
                </div>
                <h4 class="font-semibold text-blue-700">M√∫ltipla Escolha</h4>
            </div>
            <button type="button" onclick="removeQuestion(this)" class="text-red-500 hover:text-red-700 interactive-card" aria-label="Remover quest√£o">
                <img src="{% static 'imagem/delete_35dp_ef4444_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Remover" class="w-5 h-5">
            </button>
        </div>
        
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Pergunta</label>
                <input type="text" placeholder="Digite a pergunta..." class="w-full p-3 border border-gray-300 rounded-lg form-control question-input">
                <div class="validation-error question-error"></div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Op√ß√µes de Resposta</label>
                <div class="space-y-2 options-container">
                        <div class="option-item">
                            <input type="radio" name="correct-answer" class="text-blue-600 correct-option-radio">
                            <input type="text" placeholder="Op√ß√£o 1" class="flex-1 p-2 border border-gray-300 rounded option-input">
                            <button type="button" class="remove-option text-red-500 hover:text-red-700 interactive-card p-1" aria-label="Remover op√ß√£o">√ó</button>
                        </div>
                    </div>
                <div class="validation-error options-error"></div>
                <button type="button" class="mt-2 text-blue-600 text-sm font-medium interactive-card flex items-center gap-1 add-option-btn">
                    <img src="{% static 'imagem/add_35dp_2682EA_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Adicionar" class="w-4 h-4">
                    Adicionar Op√ß√£o
                </button>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">XP da Quest√£o</label>
                <input type="number" min="5" max="50" value="10" class="w-24 p-2 border border-gray-300 rounded xp-input">
            </div>
        </div>
    </div>
</template>

<template id="code-template">
    <div class="question-item" data-type="code">
        <div class="flex items-start justify-between mb-4">
            <div class="flex items-center gap-3">
                <div class="drag-handle">
                    <img src="{% static 'imagem/drag_handle_35dp_64748b_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Arrastar" class="w-5 h-5">
                </div>
                <h4 class="font-semibold text-blue-700">Exerc√≠cio de Programa√ß√£o</h4>
            </div>
            <button type="button" onclick="removeQuestion(this)" class="text-red-500 hover:text-red-700 interactive-card" aria-label="Remover quest√£o">
                <img src="{% static 'imagem/delete_35dp_ef4444_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Remover" class="w-5 h-5">
            </button>
        </div>
        
        <div class="space-y-4">
            <!-- Instru√ß√£o do Exerc√≠cio -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Instru√ß√£o do Exerc√≠cio
                    <span class="text-gray-500 text-xs font-normal">(o que o aluno deve fazer)</span>
                </label>
                <textarea placeholder="Ex: Escreva um programa que imprima 'Hello World'" rows="3" class="w-full p-3 border border-gray-300 rounded-lg question-input"></textarea>
                <div class="validation-error question-error"></div>
            </div>
            
            <!-- C√≥digo Inicial (Opcional) -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    C√≥digo Inicial
                    <span class="text-gray-500 text-xs font-normal">(opcional - aparece para o aluno)</span>
                </label>
                <textarea placeholder="# C√≥digo que o aluno vai ver inicialmente&#10;# Exemplo:&#10;print(&quot;Hello&quot;)" rows="4" class="w-full p-3 border border-gray-300 rounded-lg font-mono text-sm starter-code"></textarea>
            </div>
            
            <!-- Sa√≠da Esperada -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Sa√≠da Esperada
                    <span class="text-gray-500 text-xs font-normal">(o que deve aparecer quando o c√≥digo rodar)</span>
                </label>
                <textarea placeholder="Ex: Hello World" rows="3" class="w-full p-3 border border-gray-300 rounded-lg font-mono text-sm expected-output"></textarea>
                <div class="validation-error output-error"></div>
            </div>
            
            <!-- Preview Simples -->
            <div class="bg-blue-50 p-4 rounded-lg">
                <h5 class="font-medium text-blue-800 mb-3">Como o aluno ver√°:</h5>
                <div class="bg-white p-4 rounded border border-blue-200">
                    <div class="mb-3">
                        <strong class="text-gray-700">Exerc√≠cio:</strong>
                        <p class="text-gray-600 mt-1 instruction-preview">Escreva um programa que imprima 'Hello World'</p>
                    </div>
                    <div class="mb-3">
                        <strong class="text-gray-700">Seu c√≥digo:</strong>
                        <div class="bg-gray-100 p-3 rounded font-mono text-sm mt-1 code-preview">
                            print("Hello")
                        </div>
                        <button class="bg-green-600 text-white px-4 py-2 mt-4 rounded hover:bg-green-700 transition run-button">
                        ‚ñ∂ Executar C√≥digo
                    </button>
                    </div>
                    
                    <div class="output-preview mt-3 p-3 bg-gray-900 text-green-400 font-mono text-sm rounded hidden">
                        <div class="output-content">Hello</div>
                    </div>
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">XP da Quest√£o</label>
                <input type="number" min="10" max="100" value="30" class="w-24 p-2 border border-gray-300 rounded xp-input">
            </div>
        </div>
    </div>
</template>

<template id="fill-blank-template">
    <div class="question-item" data-type="fill-blank">
        <div class="flex items-start justify-between mb-4">
            <div class="flex items-center gap-3">
                <div class="drag-handle">
                    <img src="{% static 'imagem/drag_handle_35dp_64748b_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Arrastar" class="w-5 h-5">
                </div>
                <h4 class="font-semibold text-blue-700">Completar Lacunas</h4>
            </div>
            <button type="button" onclick="removeQuestion(this)" class="text-red-500 hover:text-red-700 interactive-card" aria-label="Remover quest√£o">
                <img src="{% static 'imagem/delete_35dp_ef4444_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Remover" class="w-5 h-5">
            </button>
        </div>
        
        <div class="space-y-4">
            <!-- Texto com Lacunas -->
            <div>
                <div class="flex justify-between items-center mb-2">
                    <label class="block text-sm font-medium text-gray-700">
                        Texto com Lacunas
                    </label>
                    <button type="button" onclick="addBlankToText(this)" class="text-blue-600 text-sm font-medium interactive-card flex items-center gap-1">
                        <img src="{% static 'imagem/add_35dp_2682EA_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Adicionar" class="w-4 h-4">
                        Adicionar Lacuna
                    </button>
                </div>
                <textarea placeholder="Digite o texto aqui. Use o bot√£o 'Adicionar Lacuna' para criar as lacunas." rows="4" class="w-full p-3 border border-gray-300 rounded-lg question-input fill-blank-textarea"></textarea>
                <div class="text-xs text-gray-500 mt-1">
                    üí° Clique em "Adicionar Lacuna" para inserir uma lacuna onde estiver o cursor
                </div>
                <div class="validation-error question-error"></div>
            </div>
            
            <!-- Respostas Corretas -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Respostas Corretas
                    <span class="text-gray-500 text-xs font-normal">(uma para cada lacuna, na ordem)</span>
                </label>
                <div class="space-y-2 answers-container">
                    <div class="flex items-center gap-2">
                        <span class="text-sm font-medium text-gray-600 w-6">1.</span>
                        <input type="text" placeholder="Resposta para a primeira lacuna" class="flex-1 p-2 border border-gray-300 rounded answer-input">
                        <button type="button" onclick="removeAnswer(this)" class="text-red-500 hover:text-red-700 interactive-card p-1" aria-label="Remover resposta">√ó</button>
                    </div>
                </div>
                <div class="validation-error answers-error"></div>
            </div>
            
            <!-- Preview - Como o aluno ver√° -->
            <div class="bg-blue-50 p-4 rounded-lg">
                <h5 class="font-medium text-blue-800 mb-3">Como o aluno ver√°:</h5>
                <div class="bg-white p-4 rounded border border-blue-200">
                    <div class="text-preview mb-4 text-gray-700 leading-relaxed">
                        Para imprimir algo em Python, usamos a fun√ß√£o <span class="blank-preview">_____</span>("texto")
                    </div>
                    <div class="word-bank grid grid-cols-3 gap-2 mb-3">
                        <!-- As op√ß√µes ser√£o geradas automaticamente -->
                    </div>
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">XP da Quest√£o</label>
                <input type="number" min="5" max="30" value="15" class="w-24 p-2 border border-gray-300 rounded xp-input">
            </div>
        </div>
    </div>
</template>

{% endblock %}

{% block extra_js %}
<script>
    // Estado global da aplica√ß√£o
    let currentStep = 1;
    let questions = [];
    let autoSaveEnabled = true;
    let autoSaveInterval;
    let selectedChapterId = '';
    let selectedChapterName = '';
    
    // Inicializa√ß√£o
    document.addEventListener('DOMContentLoaded', function() {
        updateProgressBar();
        setupAutoSave();
        setupDragAndDrop();
        
        // Configurar seletor de cap√≠tulo
        const chapterSelect = document.getElementById('chapter-select');
        chapterSelect.addEventListener('change', function() {
            if (this.value === 'new') {
                openChapterModal();
            } else {
                selectedChapterId = this.value;
                selectedChapterName = this.options[this.selectedIndex].text;
                updateModuleSelect(this.value);
            }
        });
        
        // Configurar formul√°rio de novo cap√≠tulo
        document.getElementById('new-chapter-form').addEventListener('submit', function(e) {
            e.preventDefault();
            createNewChapter();
        });
        
        // Configurar seletor de m√≥dulo
        const moduleSelect = document.getElementById('module-select');
        moduleSelect.addEventListener('change', function() {
            if (this.value === 'new') {
                openModuleModal();
            }
        });
        
        // Configurar formul√°rio de novo m√≥dulo
        document.getElementById('new-module-form').addEventListener('submit', function(e) {
            e.preventDefault();
            createNewModule();
        });
        
        // Configurar auto-save
        const autoSaveToggle = document.getElementById('auto-save');
        autoSaveToggle.addEventListener('change', function() {
            autoSaveEnabled = this.checked;
            if (autoSaveEnabled) {
                setupAutoSave();
            } else {
                clearInterval(autoSaveInterval);
            }
        });

        // Inicializar selects com estado correto
        initializeSelects();

        // Inicializar o editor
        initializeEditor();
    });

    function initializeEditor() {
        const editor = document.getElementById('theory-content');
        const toolbar = document.getElementById('editor-toolbar');
        
        // Configurar atalhos de teclado
        editor.addEventListener('keydown', function(e) {
            // Ctrl+B para negrito
            if (e.ctrlKey && e.key === 'b') {
                e.preventDefault();
                document.execCommand('bold');
                updateToolbarState();
            }
            
            // Ctrl+I para it√°lico
            if (e.ctrlKey && e.key === 'i') {
                e.preventDefault();
                document.execCommand('italic');
                updateToolbarState();
            }
            
            // Ctrl+U para sublinhado
            if (e.ctrlKey && e.key === 'u') {
                e.preventDefault();
                document.execCommand('underline');
                updateToolbarState();
            }
        });
        
        // Atualizar contador de palavras
        editor.addEventListener('input', updateWordCount);
        
        // Configurar bot√µes da barra de ferramentas
        toolbar.addEventListener('click', function(e) {
            const button = e.target.closest('.toolbar-button');
            if (button) {
                e.preventDefault();
                const command = button.dataset.command;
                
                if (command) {
                    document.execCommand(command, false, null);
                    updateToolbarState();
                }
            }
        });
        
        // Configurar seletores
        document.getElementById('format-block').addEventListener('change', function() {
            document.execCommand('formatBlock', false, this.value);
        });
        
        document.getElementById('font-family').addEventListener('change', function() {
            document.execCommand('fontName', false, this.value);
        });
        
        document.getElementById('font-size').addEventListener('change', function() {
            document.execCommand('fontSize', false, this.value);
        });
        
        // Configurar seletores de cor
        setupColorPicker('text-color-button', 'text-color-options', 'foreColor');
        setupColorPicker('highlight-color-button', 'highlight-color-options', 'hiliteColor');
        
        // Configurar bot√µes de inser√ß√£o
        document.getElementById('insert-link').addEventListener('click', insertLink);
        document.getElementById('insert-image').addEventListener('click', insertImage);
        document.getElementById('insert-table').addEventListener('click', insertTable);
        document.getElementById('insert-code').addEventListener('click', insertCodeBlock);
        
        // Atualizar estado da barra de ferramentas quando o editor ganha foco
        editor.addEventListener('focus', updateToolbarState);
        editor.addEventListener('mouseup', updateToolbarState);
        editor.addEventListener('keyup', updateToolbarState);
        
        // Inicializar contador de palavras
        updateWordCount();
    }
    
    function setupColorPicker(buttonId, optionsId, command) {
        const button = document.getElementById(buttonId);
        const options = document.getElementById(optionsId);
        
        button.addEventListener('click', function() {
            options.style.display = options.style.display === 'grid' ? 'none' : 'grid';
        });
        
        options.addEventListener('click', function(e) {
            const colorOption = e.target.closest('.color-option');
            if (colorOption) {
                const color = colorOption.dataset.color;
                document.execCommand(command, false, color);
                options.style.display = 'none';
                
                // Atualizar √≠cone do bot√£o
                if (command === 'foreColor') {
                    button.innerHTML = `<span style="color: ${color};">A</span>`;
                } else {
                    button.innerHTML = `<span style="background-color: ${color}; padding: 2px 4px; border-radius: 2px;">A</span>`;
                }
            }
        });
        
        // Fechar se clicar fora
        document.addEventListener('click', function(e) {
            if (!button.contains(e.target) && !options.contains(e.target)) {
                options.style.display = 'none';
            }
        });
    }
    
    function updateToolbarState() {
        // Atualizar estado dos bot√µes de estilo
        const commands = ['bold', 'italic', 'underline', 'strikeThrough'];
        commands.forEach(command => {
            const button = document.querySelector(`[data-command="${command}"]`);
            if (button) {
                if (document.queryCommandState(command)) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            }
        });
        
        // Atualizar estado dos bot√µes de alinhamento
        const alignCommands = ['justifyLeft', 'justifyCenter', 'justifyRight', 'justifyFull'];
        alignCommands.forEach(command => {
            const button = document.querySelector(`[data-command="${command}"]`);
            if (button) {
                if (document.queryCommandState(command)) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            }
        });
    }
    
    function updateWordCount() {
        const editor = document.getElementById('theory-content');
        const text = editor.innerText || '';
        const words = text.trim() ? text.trim().split(/\s+/).length : 0;
        document.getElementById('word-count').textContent = `${words} palavras`;
    }
    
    function insertLink() {
        const url = prompt('URL do link:');
        if (url) {
            const text = prompt('Texto do link:', url);
            document.execCommand('createLink', false, url);
            
            // Aplicar estilo aos links
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                const link = range.startContainer.parentElement.closest('a');
                if (link) {
                    link.style.color = '#1a73e8';
                    link.style.textDecoration = 'underline';
                }
            }
        }
    }
    
    function insertImage() {
        const url = prompt('URL da imagem:');
        if (url) {
            document.execCommand('insertImage', false, url);
            
            // Aplicar estilo √†s imagens
            const images = document.getElementById('theory-content').getElementsByTagName('img');
            const lastImage = images[images.length - 1];
            if (lastImage) {
                lastImage.style.maxWidth = '100%';
                lastImage.style.height = 'auto';
                lastImage.style.borderRadius = '4px';
                lastImage.style.margin = '8px 0';
            }
        }
    }
    
    function insertTable() {
        const rows = parseInt(prompt('N√∫mero de linhas:', '3')) || 3;
        const cols = parseInt(prompt('N√∫mero de colunas:', '3')) || 3;
        
        let tableHTML = '<table>';
        
        // Cabe√ßalho
        tableHTML += '<thead><tr>';
        for (let i = 0; i < cols; i++) {
            tableHTML += `<th>Coluna ${i + 1}</th>`;
        }
        tableHTML += '</tr></thead>';
        
        // Corpo
        tableHTML += '<tbody>';
        for (let i = 0; i < rows - 1; i++) {
            tableHTML += '<tr>';
            for (let j = 0; j < cols; j++) {
                tableHTML += `<td>Conte√∫do ${i + 1}.${j + 1}</td>`;
            }
            tableHTML += '</tr>';
        }
        tableHTML += '</tbody></table>';
        
        document.execCommand('insertHTML', false, tableHTML);
    }
    
    function insertCodeBlock() {
        const language = prompt('Linguagem de programa√ß√£o (opcional):', 'python');
        const code = prompt('C√≥digo:');
        
        if (code) {
            const codeBlock = `<pre><code class="language-${language || 'text'}">${code}</code></pre>`;
            document.execCommand('insertHTML', false, codeBlock);
        }
    }
    
    // Fun√ß√£o para obter o conte√∫do HTML do editor
    function getEditorContent() {
        return document.getElementById('theory-content').innerHTML;
    }
    
    // Fun√ß√£o para definir o conte√∫do HTML do editor
    function setEditorContent(html) {
        document.getElementById('theory-content').innerHTML = html;
        updateWordCount();
    }
    
    function validateStep2() {
    let isValid = true;
    
    // Limpar erros anteriores
    document.getElementById('lesson-title-error').textContent = '';
    document.getElementById('theory-content-error').textContent = '';
    document.getElementById('time-error').textContent = '';
    
    // Validar t√≠tulo da aula
    const lessonTitle = document.getElementById('lesson-title').value.trim();
    if (!lessonTitle) {
        document.getElementById('lesson-title-error').textContent = 'Por favor, insira um t√≠tulo para a aula te√≥rica.';
        document.getElementById('lesson-title').classList.add('error');
        isValid = false;
    } else {
        document.getElementById('lesson-title').classList.remove('error');
    }
    
    // Validar que pelo menos um t√≥pico tem conte√∫do
    const topics = document.querySelectorAll('.topic-item');
    let hasContent = false;
    let hasValidTitles = true;
    
    topics.forEach((topic, index) => {
        const editor = topic.querySelector('.topic-editor');
        const titleInput = topic.querySelector('.topic-title');
        const title = titleInput.value.trim();
        
        // Validar nome do t√≥pico
        if (!title) {
            titleInput.style.border = '2px solid #ef4444';
            titleInput.placeholder = 'Nome do t√≥pico √© obrigat√≥rio';
            hasValidTitles = false;
            isValid = false;
        } else {
            titleInput.style.border = '';
        }
        
        // Validar conte√∫do do t√≥pico
        if (editor) {
            const content = editor.innerText.trim();
            const htmlContent = editor.innerHTML.trim();
            
            // Considerar que tem conte√∫do se n√£o estiver vazio ou com apenas placeholder
            if (content && content !== 'Comece a escrever o conte√∫do deste t√≥pico aqui...' && htmlContent !== '<br>') {
                hasContent = true;
            }
        }
    });
    
    if (!hasContent) {
        document.getElementById('theory-content-error').textContent = 'Por favor, adicione conte√∫do em pelo menos um t√≥pico.';
        isValid = false;
    }
    
    if (!hasValidTitles) {
        document.getElementById('theory-content-error').textContent = 'Por favor, preencha o nome de todos os t√≥picos.';
        isValid = false;
    }
    
    // Validar tempo estimado
    const estimatedTime = document.getElementById('estimated-time').value;
    if (!estimatedTime || estimatedTime < 1 || estimatedTime > 120) {
        document.getElementById('time-error').textContent = 'Por favor, insira um tempo estimado v√°lido (1-120 minutos).';
        document.getElementById('estimated-time').classList.add('error');
        isValid = false;
    } else {
        document.getElementById('estimated-time').classList.remove('error');
    }
    
    if (isValid) {
        // Se tudo estiver v√°lido, ir para o pr√≥ximo passo
        goToStep(3);
    } else {
        // Scroll para o primeiro erro
        const firstError = document.querySelector('.error');
        if (firstError) {
            firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }
    
    return isValid;
}


    // Inicializar selects com op√ß√£o "Selecionar" destacada
    function initializeSelects() {
        const chapterSelect = document.getElementById('chapter-select');
        const moduleSelect = document.getElementById('module-select');
        
        // Garantir que a primeira op√ß√£o (Selecionar) esteja selecionada e desabilitada
        if (chapterSelect.options[0]) {
            chapterSelect.options[0].selected = true;
            chapterSelect.options[0].disabled = true;
        }
        
        if (moduleSelect.options[0]) {
            moduleSelect.options[0].selected = true;
            moduleSelect.options[0].disabled = true;
        }
    }

    // Fun√ß√µes do Modal de Cap√≠tulo
    function openChapterModal() {
        const modal = document.getElementById('chapter-modal');
        modal.classList.add('active');
        document.getElementById('new-chapter-title').focus();
    }

    function closeChapterModal() {
        const modal = document.getElementById('chapter-modal');
        modal.classList.remove('active');
        
        // Resetar formul√°rio
        document.getElementById('new-chapter-form').reset();
        document.getElementById('new-chapter-title-error').textContent = '';
        document.getElementById('new-chapter-title').classList.remove('error');
        
        // N√£o resetar o select aqui - manter a sele√ß√£o atual
    }

    function createNewChapter() {
        const title = document.getElementById('new-chapter-title').value.trim();
        const description = document.getElementById('new-chapter-description').value.trim();
        
        // Validar
        if (!title) {
            document.getElementById('new-chapter-title-error').textContent = 'Digite um t√≠tulo para o cap√≠tulo';
            document.getElementById('new-chapter-title').classList.add('error');
            return;
        }
        
        // Simular cria√ß√£o do cap√≠tulo
        const newChapterId = 'chapter-' + Date.now();
        const newChapterName = title;
        
        // Adicionar ao select e selecionar automaticamente
        const chapterSelect = document.getElementById('chapter-select');
        const newOption = new Option(newChapterName, newChapterId);
        chapterSelect.add(newOption);
        
        // Remover sele√ß√£o da op√ß√£o "Selecionar" e selecionar o novo cap√≠tulo
        chapterSelect.querySelector('option[value=""]').selected = false;
        chapterSelect.value = newChapterId;
        
        // Atualizar vari√°veis do cap√≠tulo selecionado
        selectedChapterId = newChapterId;
        selectedChapterName = newChapterName;
        
        // Fechar modal e atualizar m√≥dulos
        closeChapterModal();
        updateModuleSelect(newChapterId);
        
        // Mostrar mensagem de sucesso
        showSaveIndicator('Cap√≠tulo criado e selecionado com sucesso!');
    }

    // Fun√ß√µes do Modal de M√≥dulo
    function openModuleModal() {
        // Verificar se h√° um cap√≠tulo selecionado
        if (!selectedChapterId) {
            alert('Selecione um cap√≠tulo primeiro antes de criar um m√≥dulo.');
            document.getElementById('module-select').value = '';
            return;
        }
        
        const modal = document.getElementById('module-modal');
        
        // Atualizar o nome do cap√≠tulo no modal
        document.getElementById('selected-chapter-name').textContent = selectedChapterName;
        
        modal.classList.add('active');
        document.getElementById('new-module-title').focus();
    }

    function closeModuleModal() {
        const modal = document.getElementById('module-modal');
        modal.classList.remove('active');
        
        // Resetar formul√°rio
        document.getElementById('new-module-form').reset();
        document.getElementById('new-module-title-error').textContent = '';
        document.getElementById('new-module-title').classList.remove('error');
        
        // N√£o resetar o select aqui - manter a sele√ß√£o atual
    }

    function createNewModule() {
        const title = document.getElementById('new-module-title').value.trim();
        const description = document.getElementById('new-module-description').value.trim();
        
        // Validar
        if (!title) {
            document.getElementById('new-module-title-error').textContent = 'Digite um t√≠tulo para o m√≥dulo';
            document.getElementById('new-module-title').classList.add('error');
            return;
        }
        
        // Simular cria√ß√£o do m√≥dulo
        const newModuleId = 'module-' + Date.now();
        const newModuleName = title;
        
        // Adicionar ao select e selecionar automaticamente
        const moduleSelect = document.getElementById('module-select');
        const newOption = new Option(newModuleName, newModuleId);
        moduleSelect.add(newOption);
        
        // Remover sele√ß√£o da op√ß√£o "Selecionar" e selecionar o novo m√≥dulo
        if (moduleSelect.querySelector('option[value=""]')) {
            moduleSelect.querySelector('option[value=""]').selected = false;
        }
        moduleSelect.value = newModuleId;
        
        // Fechar modal
        closeModuleModal();
        
        // Mostrar mensagem de sucesso
        showSaveIndicator(`M√≥dulo "${title}" criado e selecionado no cap√≠tulo "${selectedChapterName}"!`);
    }

    // Atualizar seletor de m√≥dulos
    function updateModuleSelect(chapterId) {
        const moduleSelect = document.getElementById('module-select');
        
        // Limpar m√≥dulos existentes (mantendo a op√ß√£o "Selecionar")
        const selectOption = moduleSelect.querySelector('option[value=""]');
        moduleSelect.innerHTML = '';
        if (selectOption) {
            moduleSelect.appendChild(selectOption);
            selectOption.selected = true;
            selectOption.disabled = true;
        }
        
        // Adicionar op√ß√£o de criar novo m√≥dulo
        const newModuleOption = new Option('+ Criar Novo M√≥dulo', 'new');
        moduleSelect.add(newModuleOption);
        
        // Simular carregamento de m√≥dulos espec√≠ficos do cap√≠tulo
        if (chapterId) {
            moduleSelect.disabled = false;
            
            // Adicionar m√≥dulos de exemplo baseados no cap√≠tulo selecionado
            const sampleModules = getSampleModulesForChapter(chapterId);
            sampleModules.forEach(module => {
                const option = new Option(module.name, module.id);
                moduleSelect.add(option);
            });
        } else {
            moduleSelect.disabled = true;
            moduleSelect.innerHTML = '<option value="" selected disabled>Selecione um cap√≠tulo primeiro</option>';
        }
    }

    // Fun√ß√£o auxiliar para obter m√≥dulos de exemplo baseados no cap√≠tulo
    function getSampleModulesForChapter(chapterId) {
        // Se o cap√≠tulo for novo (come√ßa com 'chapter-' seguido de timestamp), n√£o retorna m√≥dulos
        if (chapterId.startsWith('chapter-') && /^chapter-\d+$/.test(chapterId)) {
            return []; // Retorna array vazio para cap√≠tulos novos
        }
        
        // Simula m√≥dulos diferentes para cap√≠tulos existentes
        const modulesByChapter = {
            'chapter-1': [
                { id: 'module-1-1', name: 'Introdu√ß√£o ao Python' },
                { id: 'module-1-2', name: 'Configura√ß√£o do Ambiente' }
            ],
            'chapter-2': [
                { id: 'module-2-1', name: 'Vari√°veis e Tipos de Dados' },
                { id: 'module-2-2', name: 'Operadores' }
            ],
            'chapter-3': [
                { id: 'module-3-1', name: 'Estruturas Condicionais' },
                { id: 'module-3-2', name: 'Estruturas de Repeti√ß√£o' }
            ]
        };
        
        return modulesByChapter[chapterId] || [];
    }

    function showSaveIndicator(message) {
        const saveIndicator = document.getElementById('save-indicator');
        saveIndicator.innerHTML = `
            <img src="{% static 'imagem/check_circle_35dp_FFFFFF_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Salvo" class="w-5 h-5">
            <span>${message}</span>
        `;
        saveIndicator.style.display = 'flex';
        
        setTimeout(function() {
            saveIndicator.style.display = 'none';
        }, 3000);
    }
    // Navega√ß√£o entre passos
    function goToStep(step) {
    console.log('Indo para o passo:', step); // Para debug
    
    // Esconder todos os passos
    document.querySelectorAll('[id^="step-"]').forEach(el => {
        el.classList.add('hidden');
    });
    
    // Atualizar indicadores de passo
    document.querySelectorAll('.step').forEach(el => {
        el.classList.remove('active', 'completed');
    });
    
    // Mostrar passo atual
    const currentStepEl = document.getElementById(`step-${step}`);
    if (currentStepEl) {
        currentStepEl.classList.remove('hidden');
    }
    
    // Atualizar indicadores visuais
    for (let i = 1; i <= 4; i++) {
        const stepElement = document.querySelector(`.step[data-step="${i}"]`);
        if (stepElement) {
            if (i === step) {
                stepElement.classList.add('active');
            } else if (i < step) {
                stepElement.classList.add('completed');
            }
        }
    }
    
    currentStep = step;
    updateProgressBar();
    
    // Scroll para o topo do passo
    window.scrollTo({ top: 0, behavior: 'smooth' });
}
    
    function nextStep() {
        if (currentStep < 4) {
            goToStep(currentStep + 1);
        }
    }
    
    function prevStep(fromStep) {
        if (currentStep > 1) {
            goToStep(currentStep - 1);
        }
    }
    
    // Valida√ß√£o de passos
    function validateStep1() {
        let isValid = true;
        
        // Validar cap√≠tulo
        const chapterSelect = document.getElementById('chapter-select');
        if (!chapterSelect.value) {
            document.getElementById('chapter-error').textContent = 'Selecione um cap√≠tulo';
            chapterSelect.classList.add('error');
            isValid = false;
        } else {
            document.getElementById('chapter-error').textContent = '';
            chapterSelect.classList.remove('error');
        }
        
        // Validar m√≥dulo
        const moduleSelect = document.getElementById('module-select');
        if (!moduleSelect.value) {
            document.getElementById('module-error').textContent = 'Selecione um m√≥dulo';
            moduleSelect.classList.add('error');
            isValid = false;
        } else {
            document.getElementById('module-error').textContent = '';
            moduleSelect.classList.remove('error');
        }
        
        if (isValid) {
            nextStep();
        }
    }
    
    function validateStep2() {
    let isValid = true;
    
    // Limpar erros anteriores
    document.getElementById('lesson-title-error').textContent = '';
    document.getElementById('theory-content-error').textContent = '';
    document.getElementById('time-error').textContent = '';
    
    // Validar t√≠tulo da aula
    const lessonTitle = document.getElementById('lesson-title').value.trim();
    if (!lessonTitle) {
        document.getElementById('lesson-title-error').textContent = 'Por favor, insira um t√≠tulo para a aula te√≥rica.';
        document.getElementById('lesson-title').classList.add('error');
        isValid = false;
    } else {
        document.getElementById('lesson-title').classList.remove('error');
    }
    
    // Validar que pelo menos um t√≥pico tem conte√∫do
    const topics = document.querySelectorAll('.topic-item');
    let hasContent = false;
    let hasValidTitles = true;
    
    topics.forEach((topic, index) => {
        const editor = topic.querySelector('.topic-editor');
        const titleInput = topic.querySelector('.topic-title');
        const title = titleInput.value.trim();
        
        // Validar nome do t√≥pico
        if (!title) {
            titleInput.style.border = '2px solid #ef4444';
            titleInput.placeholder = 'Nome do t√≥pico √© obrigat√≥rio';
            hasValidTitles = false;
            isValid = false;
        } else {
            titleInput.style.border = '';
        }
        
        // Validar conte√∫do do t√≥pico
        if (editor) {
            const content = editor.innerText.trim();
            const htmlContent = editor.innerHTML.trim();
            
            // Considerar que tem conte√∫do se n√£o estiver vazio ou com apenas placeholder
            if (content && content !== 'Comece a escrever o conte√∫do deste t√≥pico aqui...' && htmlContent !== '<br>') {
                hasContent = true;
            }
        }
    });
    
    if (!hasContent) {
        document.getElementById('theory-content-error').textContent = 'Por favor, adicione conte√∫do em pelo menos um t√≥pico.';
        isValid = false;
    }
    
    if (!hasValidTitles) {
        document.getElementById('theory-content-error').textContent = 'Por favor, preencha o nome de todos os t√≥picos.';
        isValid = false;
    }
    
    // Validar tempo estimado
    const estimatedTime = document.getElementById('estimated-time').value;
    if (!estimatedTime || estimatedTime < 1 || estimatedTime > 120) {
        document.getElementById('time-error').textContent = 'Por favor, insira um tempo estimado v√°lido (1-120 minutos).';
        document.getElementById('estimated-time').classList.add('error');
        isValid = false;
    } else {
        document.getElementById('estimated-time').classList.remove('error');
    }
    
    if (isValid) {
        // Se tudo estiver v√°lido, ir para o pr√≥ximo passo
        goToStep(3);
    } else {
        // Scroll para o primeiro erro
        const firstError = document.querySelector('.error') || document.querySelector('[style*="border: 2px solid #ef4444"]');
        if (firstError) {
            firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }
    
    return isValid;
}
    
    function validateStep3() {
    // Verificar se h√° pelo menos uma quest√£o (usando a contagem correta)
    const questionItems = document.querySelectorAll('#questions-list .question-item');
    const hasQuestions = questionItems.length > 0;
    
    if (!hasQuestions) {
        alert('Adicione pelo menos um exerc√≠cio pr√°tico antes de continuar.');
        return false;
    }
    
    // Validar cada quest√£o individualmente
    let allValid = true;
    let firstInvalidQuestion = null;
    
    questionItems.forEach((questionEl, index) => {
        const type = questionEl.dataset.type;
        let isValid = true;
        
        // Limpar erros anteriores
        const errorElements = questionEl.querySelectorAll('.validation-error');
        errorElements.forEach(el => el.textContent = '');
        
        const inputElements = questionEl.querySelectorAll('.form-control, .question-input, .option-input');
        inputElements.forEach(el => el.classList.remove('error'));
        
        if (type === 'multiple-choice') {
            const questionInput = questionEl.querySelector('.question-input');
            const options = questionEl.querySelectorAll('.option-input');
            const hasCorrectOption = questionEl.querySelector('.correct-option-radio:checked');
            
            // Validar pergunta
            if (!questionInput || !questionInput.value.trim()) {
                const errorEl = questionEl.querySelector('.question-error');
                if (errorEl) errorEl.textContent = 'Digite a pergunta';
                if (questionInput) questionInput.classList.add('error');
                isValid = false;
            }
            
            // Validar op√ß√µes (pelo menos 2)
            if (options.length < 2) {
                const errorEl = questionEl.querySelector('.options-error');
                if (errorEl) errorEl.textContent = 'Adicione pelo menos 2 op√ß√µes';
                isValid = false;
            } else {
                // Validar que cada op√ß√£o tem conte√∫do
                let emptyOptions = false;
                options.forEach(option => {
                    if (!option.value.trim()) {
                        emptyOptions = true;
                        option.classList.add('error');
                    }
                });
                
                if (emptyOptions) {
                    const errorEl = questionEl.querySelector('.options-error');
                    if (errorEl) errorEl.textContent = 'Preencha todas as op√ß√µes';
                    isValid = false;
                }
            }
            
            // Validar op√ß√£o correta selecionada
            if (!hasCorrectOption) {
                const errorEl = questionEl.querySelector('.options-error');
                if (errorEl) errorEl.textContent = 'Selecione a op√ß√£o correta';
                isValid = false;
            }
        }
        else if (type === 'code') {
            const questionInput = questionEl.querySelector('.question-input');
            const expectedOutput = questionEl.querySelector('.expected-output');
            
            // Validar instru√ß√£o
            if (!questionInput || !questionInput.value.trim()) {
                const errorEl = questionEl.querySelector('.question-error');
                if (errorEl) errorEl.textContent = 'Digite as instru√ß√µes do exerc√≠cio';
                if (questionInput) questionInput.classList.add('error');
                isValid = false;
            }
            
            // Validar sa√≠da esperada
            if (!expectedOutput || !expectedOutput.value.trim()) {
                const errorEl = questionEl.querySelector('.output-error');
                if (errorEl) errorEl.textContent = 'Digite a sa√≠da esperada';
                if (expectedOutput) expectedOutput.classList.add('error');
                isValid = false;
            }
        }
        else if (type === 'fill-blank') {
            const questionInput = questionEl.querySelector('.question-input');
            const answerInputs = questionEl.querySelectorAll('.answer-input');
            
            // Validar texto com lacunas
            if (!questionInput || !questionInput.value.trim()) {
                const errorEl = questionEl.querySelector('.question-error');
                if (errorEl) errorEl.textContent = 'Digite o texto com lacunas';
                if (questionInput) questionInput.classList.add('error');
                isValid = false;
            } else {
                // Validar que h√° lacunas no texto
                const blankCount = (questionInput.value.match(/\[_____\]/g) || []).length;
                if (blankCount === 0) {
                    const errorEl = questionEl.querySelector('.question-error');
                    if (errorEl) errorEl.textContent = 'Adicione pelo menos uma lacuna usando o bot√£o "Adicionar Lacuna"';
                    isValid = false;
                }
            }
            
            // Validar respostas
            let emptyAnswers = false;
            answerInputs.forEach(input => {
                if (!input.value.trim()) {
                    emptyAnswers = true;
                    input.classList.add('error');
                }
            });
            
            if (emptyAnswers) {
                const errorEl = questionEl.querySelector('.answers-error');
                if (errorEl) errorEl.textContent = 'Preencha todas as respostas';
                isValid = false;
            }
        }
        
        if (!isValid) {
            allValid = false;
            if (!firstInvalidQuestion) {
                firstInvalidQuestion = questionEl;
            }
        }
    });
    
    if (!allValid) {
        // Scroll para a primeira quest√£o com erro
        if (firstInvalidQuestion) {
            firstInvalidQuestion.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center' 
            });
            
            // Adicionar destaque visual
            firstInvalidQuestion.style.border = '2px solid #ef4444';
            firstInvalidQuestion.style.borderRadius = '8px';
            setTimeout(() => {
                firstInvalidQuestion.style.border = '';
            }, 3000);
        }
        
        alert('Corrija os erros nas quest√µes antes de continuar.');
        return false;
    }
    
    // Se tudo estiver v√°lido, ir para o pr√≥ximo passo
    goToStep(4);
    updatePreview();
    return true;
}

// Fun√ß√£o corrigida para adicionar op√ß√£o
function addOption(button) {
    const questionEl = button.closest('.question-item');
    const optionsContainer = questionEl.querySelector('.options-container');
    
    if (!optionsContainer) {
        console.error('Container de op√ß√µes n√£o encontrado');
        return;
    }
    
    const questionId = questionEl.id || 'question-' + Date.now();
    const optionCount = optionsContainer.children.length + 1;
    
    const optionEl = document.createElement('div');
    optionEl.className = 'option-item';
    optionEl.innerHTML = `
        <input type="radio" name="correct-answer-${questionId}" class="text-blue-600 correct-option-radio">
        <input type="text" placeholder="Op√ß√£o ${optionCount}" class="flex-1 p-2 border border-gray-300 rounded option-input">
        <button type="button" class="remove-option text-red-500 hover:text-red-700 interactive-card p-1" aria-label="Remover op√ß√£o">√ó</button>
    `;
    
    optionsContainer.appendChild(optionEl);
    
    // Configurar eventos para a nova op√ß√£o
    const radioInput = optionEl.querySelector('.correct-option-radio');
    const textInput = optionEl.querySelector('.option-input');
    const removeBtn = optionEl.querySelector('.remove-option');
    
    // Evento para destacar op√ß√£o correta quando selecionada
    radioInput.addEventListener('change', function() {
        highlightCorrectOption(this);
    });
    
    // Evento para remover op√ß√£o
    removeBtn.addEventListener('click', function() {
        removeOption(this);
    });
    
    // Evento para valida√ß√£o em tempo real
    textInput.addEventListener('input', function() {
        this.classList.remove('error');
        const errorEl = questionEl.querySelector('.options-error');
        if (errorEl) errorEl.textContent = '';
    });
    
    // Focar no novo input
    textInput.focus();
}

// Fun√ß√£o para remover op√ß√£o
function removeOption(button) {
    const optionEl = button.closest('.option-item');
    const questionEl = button.closest('.question-item');
    const optionsContainer = questionEl.querySelector('.options-container');
    
    if (!optionEl || !optionsContainer) return;
    
    // N√£o permitir remover se s√≥ tiver uma op√ß√£o
    if (optionsContainer.children.length <= 1) {
        alert('√â necess√°rio ter pelo menos uma op√ß√£o.');
        return;
    }
    
    optionEl.remove();
}

// Fun√ß√£o para destacar op√ß√£o correta
function highlightCorrectOption(radioInput) {
    const optionEl = radioInput.closest('.option-item');
    const questionEl = radioInput.closest('.question-item');
    
    if (!optionEl || !questionEl) return;
    
    // Remover destaque de todas as op√ß√µes
    const allOptions = questionEl.querySelectorAll('.option-item');
    allOptions.forEach(option => {
        option.classList.remove('correct-option');
    });
    
    // Destacar op√ß√£o selecionada
    if (radioInput.checked) {
        optionEl.classList.add('correct-option');
    }
}

// Configurar event delegation para todos os bot√µes de adicionar op√ß√£o
document.addEventListener('click', function(e) {
    // Verificar se o clique foi em um bot√£o de adicionar op√ß√£o
    if (e.target.closest('.add-option-btn')) {
        e.preventDefault();
        const button = e.target.closest('.add-option-btn');
        addOption(button);
    }
    
    // Verificar se o clique foi em um bot√£o de remover op√ß√£o
    if (e.target.closest('.remove-option')) {
        e.preventDefault();
        const button = e.target.closest('.remove-option');
        removeOption(button);
    }
    
    // Verificar se o clique foi em um radio button de op√ß√£o correta
    if (e.target.closest('.correct-option-radio')) {
        const radio = e.target.closest('.correct-option-radio');
        highlightCorrectOption(radio);
    }
});

// Fun√ß√£o corrigida para inicializar quest√µes de m√∫ltipla escolha
function initializeMultipleChoiceQuestion(questionEl) {
    // Garantir que a quest√£o tenha um ID √∫nico
    if (!questionEl.id) {
        questionEl.id = 'question-' + Date.now();
    }
    
    // Configurar radio buttons existentes
    const radioInputs = questionEl.querySelectorAll('.correct-option-radio');
    radioInputs.forEach(radio => {
        radio.name = `correct-answer-${questionEl.id}`;
        
        // Aplicar destaque inicial se j√° estiver selecionado
        if (radio.checked) {
            highlightCorrectOption(radio);
        }
    });
    
    // Remover qualquer event listener antigo do bot√£o de adicionar
    const addOptionBtn = questionEl.querySelector('.add-option-btn');
    if (addOptionBtn) {
        // Substituir o bot√£o para remover event listeners antigos
        const newBtn = addOptionBtn.cloneNode(true);
        addOptionBtn.parentNode.replaceChild(newBtn, addOptionBtn);
    }
}

// Atualizar a fun√ß√£o addQuestion para garantir inicializa√ß√£o correta
function addQuestion(type) {
    const template = document.getElementById(`${type}-template`);
    if (!template) {
        console.error(`Template n√£o encontrado: ${type}-template`);
        return;
    }
    
    const questionsList = document.getElementById('questions-list');
    
    // Remover estado vazio se existir
    const emptyState = questionsList.querySelector('.empty-state');
    if (emptyState) {
        emptyState.remove();
    }
    
    // Clonar o template
    const questionEl = template.content.cloneNode(true);
    
    // Adicionar √† lista
    questionsList.appendChild(questionEl);
    
    // Inicializar os eventos para a nova quest√£o
    const newQuestion = questionsList.lastElementChild;
    
    // ‚úÖ ADICIONAR ESTAS LINHAS - Inicializa√ß√£o espec√≠fica por tipo
    if (type === 'multiple-choice') {
        initializeMultipleChoiceQuestion(newQuestion);
    } else if (type === 'code') {
        initializeCodeQuestion(newQuestion); // ‚Üê ESTA LINHA √â NOVA
    } else if (type === 'fill-blank') {
        initializeFillBlankQuestion(newQuestion);
    }
    
    updateQuestionCount();
    
    // Mostrar feedback
    showSaveIndicator(`Quest√£o de ${getQuestionTypeName(type)} adicionada`);
}
    const questionId = 'question-' + Date.now();
    const addOptionBtn = questionEl.querySelector('button[onclick*="addOption"]');
    const removeOptionBtns = questionEl.querySelectorAll('button[onclick*="removeOption"]');
    
    // Atualizar o name dos radio buttons existentes
    const radioInputs = questionEl.querySelectorAll('.correct-option-radio');
    radioInputs.forEach(radio => {
        radio.name = `correct-answer-${questionId}`;
        radio.addEventListener('change', function() {
            highlightCorrectOption(this);
        });
    });
    
    if (addOptionBtn) {
        addOptionBtn.onclick = function() { 
            addOption(this, questionId); 
        };
    }
    
    removeOptionBtns.forEach(btn => {
        btn.onclick = function() { removeOption(this); };
    });


// Fun√ß√£o corrigida para inicializar quest√£o de c√≥digo
function initializeCodeQuestion(questionEl) {
    // Atualizar preview quando os campos mudarem
    const instructionInput = questionEl.querySelector('.question-input');
    const starterCodeInput = questionEl.querySelector('.starter-code');
    const expectedOutputInput = questionEl.querySelector('.expected-output');
    
    // Fun√ß√£o para atualizar todo o preview
    function updateCodePreview() {
        const instructionPreview = questionEl.querySelector('.instruction-preview');
        const codePreview = questionEl.querySelector('.code-preview');
        
        if (instructionPreview) {
            instructionPreview.textContent = instructionInput.value || 'Escreva um programa que imprima "Hello World"';
        }
        
        if (codePreview) {
            codePreview.textContent = starterCodeInput.value || '# Seu c√≥digo aqui Exemplo:\nprint("Hello World")';
        }
    }
    
    // Configurar eventos de input
    instructionInput.addEventListener('input', updateCodePreview);
    starterCodeInput.addEventListener('input', updateCodePreview);
    expectedOutputInput.addEventListener('input', updateCodePreview);
    
    // Configurar bot√£o de executar no preview
    const runButton = questionEl.querySelector('.run-button');
    const outputPreview = questionEl.querySelector('.output-preview');
    const outputContent = questionEl.querySelector('.output-content');
    
    if (runButton && outputPreview && outputContent) {
        runButton.addEventListener('click', function() {
            // Simular execu√ß√£o do c√≥digo
            runButton.textContent = 'Executando...';
            runButton.disabled = true;
            
            setTimeout(() => {
                runButton.textContent = '‚ñ∂ Executar C√≥digo';
                runButton.disabled = false;
                outputPreview.classList.remove('hidden');
                
                // Mostrar resultado baseado no c√≥digo inicial e sa√≠da esperada
                const code = starterCodeInput.value;
                const expectedOutput = expectedOutputInput.value;
                
                if (code.includes('print(')) {
                    // Extrair texto do print (simula√ß√£o b√°sica)
                    const match = code.match(/print\(["']([^"']+)["']\)/);
                    if (match) {
                        outputContent.textContent = match[1];
                    } else {
                        outputContent.textContent = 'Hello World';
                    }
                } else if (expectedOutput) {
                    outputContent.textContent = expectedOutput;
                } else {
                    outputContent.textContent = 'C√≥digo executado com sucesso!';
                }
            }, 1000);
        });
    }
    
    // Inicializar preview imediatamente
    updateCodePreview();
}

// Atualizar preview do editor
function updateCodePreview(questionEl) {
    const language = questionEl.querySelector('.code-language').value;
    const starterCode = questionEl.querySelector('.starter-code').value;
    const preview = questionEl.querySelector('.code-content');
    
    if (!preview) return;
    
    let highlightedCode = highlightSyntax(starterCode || 'print("Digite seu c√≥digo aqui")', language);
    preview.innerHTML = highlightedCode;
    
    // Atualizar n√∫meros de linha
    updateLineNumbers(questionEl);
}

function removeQuestion(button) {
    const questionEl = button.closest('.question-item');
    const questionsList = document.getElementById('questions-list');
    
    if (!questionEl || !questionsList) {
        console.error('Elemento da quest√£o n√£o encontrado');
        return;
    }
    
    // Remover a quest√£o
    questionEl.remove();
    
    // Atualizar contador
    updateQuestionCount();
    
    // Mostrar estado vazio se n√£o houver mais quest√µes
    const remainingQuestions = questionsList.querySelectorAll('.question-item');
    if (remainingQuestions.length === 0) {
        showEmptyState();
    }
    
    showSaveIndicator('Quest√£o removida');
}


// Realce de sintaxe b√°sico
function highlightSyntax(code, language) {
    let highlighted = code;
    
    if (language === 'python') {
        // Palavras-chave do Python
        const pythonKeywords = ['def', 'class', 'if', 'else', 'elif', 'for', 'while', 'return', 'import', 'from', 'as', 'try', 'except', 'finally', 'with', 'lambda', 'print', 'input'];
        pythonKeywords.forEach(keyword => {
            const regex = new RegExp(`\\b${keyword}\\b`, 'g');
            highlighted = highlighted.replace(regex, `<span class="keyword">${keyword}</span>`);
        });
        
        // Strings
        highlighted = highlighted.replace(/(["'])(?:(?=(\\?))\2.)*?\1/g, '<span class="string">$&</span>');
        
        // Coment√°rios
        highlighted = highlighted.replace(/#.*$/gm, '<span class="comment">$&</span>');
        
        // N√∫meros
        highlighted = highlighted.replace(/\b\d+\b/g, '<span class="number">$&</span>');
    }
    
    // Converter quebras de linha em divs
    const lines = highlighted.split('\n');
    const formattedLines = lines.map(line => {
        if (line.trim() === '') {
            return '<div class="code-line">&nbsp;</div>';
        }
        return `<div class="code-line">${line}</div>`;
    });
    
    return formattedLines.join('');
}

// Atualizar n√∫meros de linha
function updateLineNumbers(questionEl) {
    const codeContent = questionEl.querySelector('.code-content');
    const lineNumbers = questionEl.querySelector('.line-numbers');
    
    if (!codeContent || !lineNumbers) return;
    
    const lineCount = codeContent.querySelectorAll('.code-line').length;
    let numbersHTML = '';
    
    for (let i = 1; i <= Math.max(lineCount, 10); i++) {
        numbersHTML += `${i}<br>`;
    }
    
    lineNumbers.innerHTML = numbersHTML;
}

// Executar c√≥digo no preview (simulado)
function runCodePreview(questionEl) {
    const runButton = questionEl.querySelector('.run-button');
    const outputArea = questionEl.querySelector('.output-area');
    const outputContent = questionEl.querySelector('.output-content');
    const starterCode = questionEl.querySelector('.starter-code').value;
    
    if (!outputArea || !outputContent) return;
    
    // Mostrar que est√° executando
    runButton.classList.add('running');
    runButton.textContent = 'Executando...';
    outputArea.classList.remove('hidden');
    outputContent.innerHTML = '<div class="output-warning">Executando c√≥digo...</div>';
    
    // Simular execu√ß√£o (em um ambiente real, isso seria uma chamada API)
    setTimeout(() => {
        runButton.classList.remove('running');
        runButton.textContent = '‚ñ∂ Executar';
        
        // Simular diferentes sa√≠das baseadas no c√≥digo
        if (starterCode.includes('print(') && starterCode.includes('"')) {
            const match = starterCode.match(/print\(["']([^"']+)["']\)/);
            if (match) {
                outputContent.innerHTML = `<div class="output-success">${match[1]}</div>`;
            } else {
                outputContent.innerHTML = '<div class="output-success">Hello World</div>';
            }
        } else if (starterCode.includes('error') || starterCode.includes('Error')) {
            outputContent.innerHTML = '<div class="output-error">Erro: C√≥digo cont√©m erro</div>';
        } else {
            outputContent.innerHTML = '<div class="output-success">C√≥digo executado com sucesso!</div>';
        }
    }, 1500);
}

// A√ß√µes da toolbar
function handleToolbarAction(questionEl, action) {
    const textarea = questionEl.querySelector('.starter-code');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end);
    
    switch(action) {
        case 'indent':
            const indentedText = selectedText.split('\n').map(line => '    ' + line).join('\n');
            textarea.value = textarea.value.substring(0, start) + indentedText + textarea.value.substring(end);
            break;
            
        case 'comment':
            const commentedText = selectedText.split('\n').map(line => '# ' + line).join('\n');
            textarea.value = textarea.value.substring(0, start) + commentedText + textarea.value.substring(end);
            break;
    }
    
    textarea.focus();
    updateCodePreview(questionEl);
}

// Atualizar tema
function updateCodeTheme(questionEl) {
    const theme = questionEl.querySelector('.code-theme').value;
    const codeArea = questionEl.querySelector('.code-area');
    const editorHeader = questionEl.querySelector('.editor-header');
    
    if (!codeArea) return;
    
    // Remover classes de tema anteriores
    codeArea.classList.remove('theme-dark', 'theme-light', 'theme-monokai');
    editorHeader.classList.remove('theme-dark', 'theme-light', 'theme-monokai');
    
    // Aplicar novo tema
    codeArea.classList.add(`theme-${theme}`);
    editorHeader.classList.add(`theme-${theme}`);
}

// Fun√ß√µes para casos de teste
function addTestCase(button) {
    const testCasesContainer = button.previousElementSibling;
    const testCaseCount = testCasesContainer.children.length + 1;
    
    const testCaseEl = document.createElement('div');
    testCaseEl.className = 'test-case-item bg-gray-50 p-3 rounded border border-gray-200';
    testCaseEl.innerHTML = `
        <div class="flex items-center gap-3 mb-2">
            <input type="checkbox" class="test-case-active" checked>
            <span class="font-medium text-sm">Caso de Teste ${testCaseCount}</span>
            <button type="button" onclick="removeTestCase(this)" class="text-red-500 hover:text-red-700 ml-auto">√ó</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
                <label class="text-xs text-gray-600">Entrada</label>
                <textarea class="test-input w-full h-20 font-mono text-xs p-2 border border-gray-300 rounded" placeholder="Entrada para o programa"></textarea>
            </div>
            <div>
                <label class="text-xs text-gray-600">Sa√≠da Esperada</label>
                <textarea class="test-expected w-full h-20 font-mono text-xs p-2 border border-gray-300 rounded" placeholder="Sa√≠da esperada"></textarea>
            </div>
        </div>
    `;
    
    testCasesContainer.appendChild(testCaseEl);
    
    // Configurar evento para o novo bot√£o de remover
    const removeBtn = testCaseEl.querySelector('button[onclick*="removeTestCase"]');
    removeBtn.onclick = function() { removeTestCase(this); };
}

function removeTestCase(button) {
    const testCaseEl = button.closest('.test-case-item');
    const testCasesContainer = testCaseEl.parentNode;
    
    if (testCasesContainer.children.length > 1) {
        testCaseEl.remove();
    }
}

// Atualizar preview do c√≥digo inicial em tempo real
function updateStarterCodePreview(questionEl) {
    // Pequeno delay para performance
    clearTimeout(questionEl._updateTimeout);
    questionEl._updateTimeout = setTimeout(() => {
        updateCodePreview(questionEl);
    }, 300);
}

// Adicionar estilos para temas
const themeStyles = `
.theme-dark .code-area { background: #1a202c; color: #e2e8f0; }
.theme-dark .line-numbers { background: #2d3748; color: #718096; }
.theme-dark .editor-header { background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%); }

.theme-light .code-area { background: #f7fafc; color: #2d3748; }
.theme-light .line-numbers { background: #edf2f7; color: #a0aec0; }
.theme-light .editor-header { background: linear-gradient(135deg, #edf2f7 0%, #e2e8f0 100%); color: #2d3748; }

.theme-monokai .code-area { background: #272822; color: #f8f8f2; }
.theme-monokai .line-numbers { background: #373832; color: #90908a; }
.theme-monokai .editor-header { background: linear-gradient(135deg, #373832 0%, #474842 100%); }
`;

// Adicionar estilos de tema ao documento
const styleElement = document.createElement('style');
styleElement.textContent = themeStyles;
document.head.appendChild(styleElement);

// Fun√ß√£o unificada para inicializar quest√£o de completar lacunas
function initializeFillBlankQuestion(questionEl) {
    const questionInput = questionEl.querySelector('.question-input');
    const addBlankBtn = questionEl.querySelector('button[onclick*="addBlankToText"]');
    
    // Configurar bot√£o de adicionar lacuna
    if (addBlankBtn) {
        addBlankBtn.onclick = function() { addBlankToText(this); };
    }
    
    // Atualizar preview quando o texto mudar
    questionInput.addEventListener('input', function() {
        updateFillBlankPreview(questionEl);
        updateAnswerInputs(questionEl);
    });
    
    // Inicializar preview
    updateFillBlankPreview(questionEl);
}

// Fun√ß√£o unificada para adicionar lacuna
function addBlankToText(button) {
    const questionEl = button.closest('.question-item');
    const textarea = questionEl.querySelector('.question-input');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    
    // Inserir a lacuna no cursor - usar [_____] como padr√£o
    const blank = '[_____]';
    textarea.value = textarea.value.substring(0, start) + blank + textarea.value.substring(end);
    
    // Colocar o cursor ap√≥s a lacuna
    const newPosition = start + blank.length;
    textarea.focus();
    textarea.setSelectionRange(newPosition, newPosition);
    
    // Atualizar preview
    updateFillBlankPreview(questionEl);
    updateAnswerInputs(questionEl);
}

// Fun√ß√£o unificada para atualizar preview
function updateFillBlankPreview(questionEl) {
    const questionInput = questionEl.querySelector('.question-input');
    const textPreview = questionEl.querySelector('.text-preview');
    const wordBank = questionEl.querySelector('.word-bank');
    
    if (!textPreview || !wordBank) return;
    
    let text = questionInput.value || 'Digite o texto e use o bot√£o para adicionar lacunas';
    
    // Contar quantas lacunas existem
    const blankCount = (text.match(/\[_____\]/g) || []).length;
    
    // ‚úÖ PRESERVAR QUEBRAS DE LINHA - substituir \n por <br>
    const formattedText = text
        .replace(/\n/g, '<br>')  // Manter quebras de linha
        .replace(/\[_____\]/g, '<span class="blank-preview" data-blank="true">_____</span>');
    
    textPreview.innerHTML = formattedText;
    
    // ‚úÖ REMOVER o banco de palavras (quadros azuis)
    wordBank.innerHTML = '';
    wordBank.style.display = 'none'; // Esconder completamente
    
    // Configurar arrastar e soltar (se ainda quiser funcionalidade de drag)
    setupBlankDragAndDrop(questionEl);
}

// Fun√ß√£o unificada para atualizar banco de palavras
function updateWordBank(questionEl, blankCount) {
    const wordBank = questionEl.querySelector('.word-bank');
    const answersContainer = questionEl.querySelector('.answers-container');
    
    if (!wordBank) return;
    
    // Limpar banco de palavras
    wordBank.innerHTML = '';
    
    // Obter respostas corretas
    const correctAnswers = [];
    const answerInputs = answersContainer.querySelectorAll('.answer-input');
    answerInputs.forEach(input => {
        if (input.value.trim()) {
            correctAnswers.push(input.value.trim());
        }
    });
    
    // Adicionar respostas corretas ao banco
    correctAnswers.forEach((answer, index) => {
        if (index < blankCount) {
            const wordOption = document.createElement('div');
            wordOption.className = 'word-option';
            wordOption.textContent = answer;
            wordOption.draggable = true;
            wordOption.dataset.answer = answer;
            wordOption.dataset.index = index;
            wordBank.appendChild(wordOption);
        }
    });
    
    // Adicionar distra√ß√µes se necess√°rio
    addDistractionWords(wordBank, correctAnswers, blankCount);
}


// Fun√ß√£o unificada para arrastar e soltar
function setupBlankDragAndDrop(questionEl) {
    const wordOptions = questionEl.querySelectorAll('.word-option');
    const blanks = questionEl.querySelectorAll('.blank-preview');
    
    wordOptions.forEach(option => {
        option.addEventListener('dragstart', handleDragStart);
        option.addEventListener('dragend', handleDragEnd);
    });
    
    blanks.forEach(blank => {
        blank.addEventListener('dragover', handleDragOver);
        blank.addEventListener('dragleave', handleDragLeave);
        blank.addEventListener('drop', handleDrop);
    });
}

// Handlers de drag and drop
function handleDragStart(e) {
    e.dataTransfer.setData('text/plain', this.textContent);
    this.style.opacity = '0.4';
}

function handleDragEnd() {
    this.style.opacity = '1';
}

function handleDragOver(e) {
    e.preventDefault();
    this.style.background = '#fef3c7';
    this.style.border = '2px solid #3b82f6';
}

function handleDragLeave() {
    this.style.background = '#fef3c7';
    this.style.border = '2px dashed #f59e0b';
}

function handleDrop(e) {
    e.preventDefault();
    const word = e.dataTransfer.getData('text/plain');
    this.textContent = word;
    this.classList.remove('blank-preview');
    this.classList.add('blank-filled');
    this.dataset.filled = 'true';
    this.dataset.answer = word;
    
    // Verificar automaticamente se est√° correto
    setTimeout(() => checkSingleBlank(this.closest('.question-item'), this), 500);
}

// Fun√ß√£o unificada para atualizar inputs de resposta
function updateAnswerInputs(questionEl) {
    const questionInput = questionEl.querySelector('.question-input');
    const answersContainer = questionEl.querySelector('.answers-container');
    
    if (!questionInput || !answersContainer) return;
    
    const text = questionInput.value;
    const blankCount = (text.match(/\[_____\]/g) || []).length;
    const currentAnswerCount = answersContainer.children.length;
    
    // Adicionar ou remover inputs conforme necess√°rio
    if (blankCount > currentAnswerCount) {
        for (let i = currentAnswerCount; i < blankCount; i++) {
            addAnswerInput(questionEl);
        }
    } else if (blankCount < currentAnswerCount) {
        for (let i = currentAnswerCount; i > blankCount; i--) {
            const lastAnswer = answersContainer.lastElementChild;
            if (lastAnswer) lastAnswer.remove();
        }
    }
    
    // Atualizar n√∫meros dos labels
    updateAnswerLabels(answersContainer);
}

// Fun√ß√£o unificada para adicionar input de resposta
function addAnswerInput(questionEl) {
    const answersContainer = questionEl.querySelector('.answers-container');
    const answerCount = answersContainer.children.length + 1;
    
    const answerEl = document.createElement('div');
    answerEl.className = 'flex items-center gap-2';
    answerEl.innerHTML = `
        <span class="text-sm font-medium text-gray-600 w-6">${answerCount}.</span>
        <input type="text" placeholder="Resposta para a lacuna ${answerCount}" class="flex-1 p-2 border border-gray-300 rounded answer-input">
        <button type="button" class="remove-answer text-red-500 hover:text-red-700 interactive-card p-1">√ó</button>
    `;
    
    answersContainer.appendChild(answerEl);
    
    // Configurar eventos
    const newInput = answerEl.querySelector('.answer-input');
    const removeBtn = answerEl.querySelector('.remove-answer');
    
    newInput.addEventListener('input', function() {
        this.classList.remove('error');
        updateFillBlankPreview(questionEl);
    });
    
    removeBtn.addEventListener('click', function() {
        removeAnswerInput(this);
    });
}

// Fun√ß√£o unificada para remover input de resposta
function removeAnswerInput(button) {
    const answerEl = button.closest('.flex.items-center');
    const answersContainer = answerEl.parentNode;
    const questionEl = button.closest('.question-item');
    
    if (answersContainer.children.length > 1) {
        answerEl.remove();
        updateAnswerLabels(answersContainer);
        updateFillBlankPreview(questionEl);
    }
}

// Fun√ß√£o auxiliar para atualizar labels
function updateAnswerLabels(answersContainer) {
    const answerLabels = answersContainer.querySelectorAll('span');
    answerLabels.forEach((label, index) => {
        label.textContent = `${index + 1}.`;
    });
}

// Fun√ß√£o para verificar lacuna individual
function checkSingleBlank(questionEl, blank) {
    const answersContainer = questionEl.querySelector('.answers-container');
    const answerInputs = answersContainer.querySelectorAll('.answer-input');
    const blanks = questionEl.querySelectorAll('[data-blank="true"]');
    
    const blankIndex = Array.from(blanks).indexOf(blank);
    const correctAnswer = answerInputs[blankIndex] ? answerInputs[blankIndex].value.trim() : '';
    const userAnswer = blank.dataset.answer;
    
    if (userAnswer === correctAnswer) {
        // Resposta correta
        blank.style.background = '#d1fae5';
        blank.style.borderColor = '#10b981';
        blank.style.color = '#065f46';
    } else {
        // Resposta incorreta - resetar ap√≥s 2 segundos
        blank.style.background = '#fee2e2';
        blank.style.borderColor = '#ef4444';
        blank.style.color = '#991b1b';
        
        setTimeout(() => {
            resetBlank(blank);
        }, 2000);
    }
}

// Fun√ß√£o para resetar lacuna
function resetBlank(blank) {
    blank.textContent = '_____';
    blank.classList.remove('blank-filled');
    blank.classList.add('blank-preview');
    blank.removeAttribute('data-filled');
    blank.removeAttribute('data-answer');
    blank.removeAttribute('style');
}
    
    // Formata√ß√£o de texto
    function formatText(type) {
        const textarea = document.getElementById('theory-content');
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const selectedText = textarea.value.substring(start, end);
        
        let formattedText = '';
        switch(type) {
            case 'bold':
                formattedText = `**${selectedText}**`;
                break;
            case 'italic':
                formattedText = `_${selectedText}_`;
                break;
            case 'code':
                formattedText = `\`${selectedText}\``;
                break;
        }
        
        textarea.value = textarea.value.substring(0, start) + formattedText + textarea.value.substring(end);
        textarea.focus();
        textarea.setSelectionRange(start + formattedText.length, start + formattedText.length);
    }
    
    function insertImage() {
        const url = prompt('URL da imagem:');
        if (url) {
            const textarea = document.getElementById('theory-content');
            const start = textarea.selectionStart;
            const markdown = `![Imagem](${url})`;
            
            textarea.value = textarea.value.substring(0, start) + markdown + textarea.value.substring(start);
            textarea.focus();
        }
    }
    
    function insertLink() {
        const url = prompt('URL do link:');
        const text = prompt('Texto do link:', 'link');
        if (url && text) {
            const textarea = document.getElementById('theory-content');
            const start = textarea.selectionStart;
            const markdown = `[${text}](${url})`;
            
            textarea.value = textarea.value.substring(0, start) + markdown + textarea.value.substring(start);
            textarea.focus();
        }
    }
    
    // Drag and Drop
    function setupDragAndDrop() {
        const questionsList = document.getElementById('questions-list');
        
        questionsList.addEventListener('dragover', function(e) {
            e.preventDefault();
            const afterElement = getDragAfterElement(questionsList, e.clientY);
            const draggable = document.querySelector('.dragging');
            if (draggable) {
                if (afterElement == null) {
                    questionsList.appendChild(draggable);
                } else {
                    questionsList.insertBefore(draggable, afterElement);
                }
            }
        });
    }
    
    function setupQuestionDrag(questionEl) {
        const dragHandle = questionEl.querySelector('.drag-handle');
        
        dragHandle.setAttribute('draggable', true);
        
        dragHandle.addEventListener('dragstart', function() {
            questionEl.classList.add('dragging');
        });
        
        dragHandle.addEventListener('dragend', function() {
            questionEl.classList.remove('dragging');
        });
    }
    
    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.question-item:not(.dragging)')];
        
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }
    
    // Atualizar preview
    function updatePreview() {
        const previewArea = document.getElementById('content-preview-area');
        const lessonTitle = document.getElementById('lesson-title').value;
        const theoryContent = document.getElementById('theory-content').value;
        
        let previewHTML = `
            <div class="space-y-4">
                <h3 class="text-xl font-bold text-blue-700">${lessonTitle || 'T√≠tulo da Aula'}</h3>
                <div class="prose max-w-none">
                    ${theoryContent ? theoryContent.replace(/\n/g, '<br>') : '<p class="text-gray-500">Conte√∫do te√≥rico da aula</p>'}
                </div>
        `;
        
        // Adicionar preview das quest√µes
        const questions = document.querySelectorAll('.question-item');
        if (questions.length > 0) {
            previewHTML += `<div class="mt-6 pt-4 border-t border-gray-200">
                <h4 class="text-lg font-semibold mb-4">Exerc√≠cios Pr√°ticos</h4>
                <div class="space-y-4">`;
            
            questions.forEach((question, index) => {
                const type = question.dataset.type;
                previewHTML += `<div class="question-preview">
                    <h5 class="font-medium mb-2">Quest√£o ${index + 1}: ${getQuestionTypeName(type)}</h5>`;
                
                if (type === 'multiple-choice') {
                    const questionText = question.querySelector('.question-input').value;
                    previewHTML += `<p class="mb-3">${questionText || 'Pergunta de m√∫ltipla escolha'}</p>
                    <div class="space-y-2">`;
                    
                    const options = question.querySelectorAll('.option-input');
                    options.forEach(option => {
                        previewHTML += `<div class="flex items-center gap-2">
                            <input type="radio" disabled>
                            <span>${option.value || 'Op√ß√£o'}</span>
                        </div>`;
                    });
                    
                    previewHTML += `</div>`;
                } else if (type === 'code') {
                    const instructions = question.querySelector('.question-input').value;
                    previewHTML += `<p class="mb-3">${instructions || 'Instru√ß√µes para escrever c√≥digo'}</p>
                    <div class="bg-gray-100 p-3 rounded font-mono text-sm">
                        // √Årea para escrever c√≥digo
                    </div>`;
                } else if (type === 'fill-blank') {
                    const text = question.querySelector('.question-input').value;
                    previewHTML += `<p class="mb-3">${text ? text.replace(/\[lacuna\]/g, '______') : 'Texto com lacunas para completar'}</p>`;
                }
                
                previewHTML += `</div>`;
            });
            
            previewHTML += `</div></div>`;
        }
        
        previewHTML += `</div>`;
        previewArea.innerHTML = previewHTML;
    }
    
    function getQuestionTypeName(type) {
        const names = {
            'multiple-choice': 'M√∫ltipla Escolha',
            'code': 'Escrever C√≥digo',
            'fill-blank': 'Completar Lacunas'
        };
        return names[type] || 'Exerc√≠cio';
    }
    
    
    
    // Atualizar barra de progresso
    function updateProgressBar() {
        const progressFill = document.getElementById('progress-fill');
        const width = (currentStep / 4) * 100;
        progressFill.style.width = `${width}%`;
    }
    
    // Auto-save
    function setupAutoSave() {
        if (autoSaveInterval) {
            clearInterval(autoSaveInterval);
        }
        
        if (autoSaveEnabled) {
            autoSaveInterval = setInterval(function() {
                // Simular salvamento
                const saveIndicator = document.getElementById('save-indicator');
                saveIndicator.style.display = 'flex';
                
                setTimeout(function() {
                    saveIndicator.style.display = 'none';
                }, 2000);
            }, 30000); // Salvar a cada 30 segundos
        }
    }
    
    // Envio do formul√°rio
    document.getElementById('content-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Validar todos os passos
        if (!validateFinalForm()) {
            alert('Por favor, corrija os erros antes de publicar.');
            return;
        }
        
        // Simular envio
        alert('Conte√∫do publicado com sucesso!');
        // Aqui voc√™ adicionaria o c√≥digo para enviar o formul√°rio
    });
    
    function validateFinalForm() {
        // Validar todos os campos necess√°rios
        let isValid = true;
        
        // Validar estrutura
        if (!document.getElementById('chapter-select').value) {
            isValid = false;
        }
        
        // Validar conte√∫do te√≥rico
        if (!document.getElementById('lesson-title').value.trim()) {
            isValid = false;
        }
        
        // Validar exerc√≠cios
        if (document.querySelectorAll('.question-item').length === 0) {
            isValid = false;
        }
        
        return isValid;
    }


    // Fun√ß√µes para gerenciar t√≥picos
function addTopic() {
    const template = document.getElementById('topic-template');
    const topicEl = template.content.cloneNode(true);
    const topicsContainer = document.getElementById('topics-container');
    
    topicsContainer.appendChild(topicEl);
    
    // Inicializar o editor para o novo t√≥pico
    const newTopic = topicsContainer.lastElementChild;
    initializeTopicEditor(newTopic);
    
    // Configurar eventos para o novo t√≥pico
    setupTopicEvents(newTopic);
    
    // Focar no t√≠tulo do novo t√≥pico
    const titleInput = newTopic.querySelector('.topic-title');
    titleInput.focus();
    
    showSaveIndicator('Novo t√≥pico adicionado');
}

function removeTopic(button) {
    const topicEl = button.closest('.topic-item');
    const topicsContainer = document.getElementById('topics-container');
    
    // N√£o permitir remover o √∫ltimo t√≥pico
    if (topicsContainer.children.length <= 1) {
        alert('√â necess√°rio ter pelo menos um t√≥pico.');
        return;
    }
    
    topicEl.remove();
    showSaveIndicator('T√≥pico removido');
}

function initializeTopicEditor(topicEl) {
    const editor = topicEl.querySelector('.topic-editor');
    const toolbar = topicEl.querySelector('.editor-toolbar');
    
    // Configurar atalhos de teclado
    editor.addEventListener('keydown', function(e) {
        // Ctrl+B para negrito
        if (e.ctrlKey && e.key === 'b') {
            e.preventDefault();
            document.execCommand('bold');
            updateTopicToolbarState(topicEl);
        }
        
        // Ctrl+I para it√°lico
        if (e.ctrlKey && e.key === 'i') {
            e.preventDefault();
            document.execCommand('italic');
            updateTopicToolbarState(topicEl);
        }
        
        // Ctrl+U para sublinhado
        if (e.ctrlKey && e.key === 'u') {
            e.preventDefault();
            document.execCommand('underline');
            updateTopicToolbarState(topicEl);
        }
    });
    
    // Atualizar contador de palavras
    editor.addEventListener('input', function() {
        updateTopicWordCount(topicEl);
    });
    
    // Configurar bot√µes da barra de ferramentas
    toolbar.addEventListener('click', function(e) {
        const button = e.target.closest('.toolbar-button');
        if (button) {
            e.preventDefault();
            const command = button.dataset.command;
            
            if (command) {
                document.execCommand(command, false, null);
                updateTopicToolbarState(topicEl);
            }
        }
    });
    
    // Configurar seletores
    const formatBlock = topicEl.querySelector('.format-block');
    if (formatBlock) {
        formatBlock.addEventListener('change', function() {
            document.execCommand('formatBlock', false, this.value);
        });
    }
    
    const fontFamily = topicEl.querySelector('.font-family');
    if (fontFamily) {
        fontFamily.addEventListener('change', function() {
            document.execCommand('fontName', false, this.value);
        });
    }
    
    const fontSize = topicEl.querySelector('.font-size');
    if (fontSize) {
        fontSize.addEventListener('change', function() {
            document.execCommand('fontSize', false, this.value);
        });
    }
    
    // Configurar seletores de cor
    setupTopicColorPicker(topicEl, 'text-color-button', 'text-color-options', 'foreColor');
    setupTopicColorPicker(topicEl, 'highlight-color-button', 'highlight-color-options', 'hiliteColor');
    
    // Configurar bot√µes de inser√ß√£o
    const insertLink = topicEl.querySelector('.insert-link');
    if (insertLink) {
        insertLink.addEventListener('click', function() {
            insertTopicLink(topicEl);
        });
    }
    
    const insertImage = topicEl.querySelector('.insert-image');
    if (insertImage) {
        insertImage.addEventListener('click', function() {
            insertTopicImage(topicEl);
        });
    }
    
    const insertTable = topicEl.querySelector('.insert-table');
    if (insertTable) {
        insertTable.addEventListener('click', function() {
            insertTopicTable(topicEl);
        });
    }
    
    const insertCode = topicEl.querySelector('.insert-code');
    if (insertCode) {
        insertCode.addEventListener('click', function() {
            insertTopicCodeBlock(topicEl);
        });
    }
    
    // Atualizar estado da barra de ferramentas quando o editor ganha foco
    editor.addEventListener('focus', function() {
        updateTopicToolbarState(topicEl);
    });
    editor.addEventListener('mouseup', function() {
        updateTopicToolbarState(topicEl);
    });
    editor.addEventListener('keyup', function() {
        updateTopicToolbarState(topicEl);
    });
    
    // Inicializar contador de palavras
    updateTopicWordCount(topicEl);
}

function setupTopicEvents(topicEl) {
    // Configurar bot√£o de remover t√≥pico
    const removeBtn = topicEl.querySelector('.remove-topic');
    if (removeBtn) {
        removeBtn.addEventListener('click', function() {
            removeTopic(this);
        });
    }
    
    // Configurar drag handle
    const dragHandle = topicEl.querySelector('.drag-handle');
    if (dragHandle) {
        setupTopicDrag(topicEl);
    }
}

function setupTopicColorPicker(topicEl, buttonId, optionsId, command) {
    const button = topicEl.querySelector(`.${buttonId}`);
    const options = topicEl.querySelector(`.${optionsId}`);
    
    if (!button || !options) return;
    
    button.addEventListener('click', function() {
        options.style.display = options.style.display === 'grid' ? 'none' : 'grid';
    });
    
    options.addEventListener('click', function(e) {
        const colorOption = e.target.closest('.color-option');
        if (colorOption) {
            const color = colorOption.dataset.color;
            document.execCommand(command, false, color);
            options.style.display = 'none';
            
            // Atualizar √≠cone do bot√£o
            if (command === 'foreColor') {
                button.innerHTML = `<span style="color: ${color};">A</span>`;
            } else {
                button.innerHTML = `<span style="background-color: ${color}; padding: 2px 4px; border-radius: 2px;">A</span>`;
            }
        }
    });
    
    // Fechar se clicar fora
    document.addEventListener('click', function(e) {
        if (!button.contains(e.target) && !options.contains(e.target)) {
            options.style.display = 'none';
        }
    });
}

function updateTopicToolbarState(topicEl) {
    const toolbar = topicEl.querySelector('.editor-toolbar');
    if (!toolbar) return;
    
    // Atualizar estado dos bot√µes de estilo
    const commands = ['bold', 'italic', 'underline', 'strikeThrough'];
    commands.forEach(command => {
        const button = toolbar.querySelector(`[data-command="${command}"]`);
        if (button) {
            if (document.queryCommandState(command)) {
                button.classList.add('active');
            } else {
                button.classList.remove('active');
            }
        }
    });
    
    // Atualizar estado dos bot√µes de alinhamento
    const alignCommands = ['justifyLeft', 'justifyCenter', 'justifyRight', 'justifyFull'];
    alignCommands.forEach(command => {
        const button = toolbar.querySelector(`[data-command="${command}"]`);
        if (button) {
            if (document.queryCommandState(command)) {
                button.classList.add('active');
            } else {
                button.classList.remove('active');
            }
        }
    });
}

function updateTopicWordCount(topicEl) {
    const editor = topicEl.querySelector('.topic-editor');
    const wordCountDisplay = topicEl.querySelector('.word-count-display');
    
    if (!editor || !wordCountDisplay) return;
    
    const text = editor.innerText || '';
    const words = text.trim() ? text.trim().split(/\s+/).length : 0;
    wordCountDisplay.textContent = `${words} palavras`;
}

function insertTopicLink(topicEl) {
    const url = prompt('Digite a URL do link:');
    if (url) {
        const text = prompt('Digite o texto do link (opcional):', url);
        document.execCommand('createLink', false, url);
    }
}

function insertTopicImage(topicEl) {
    const url = prompt('Digite a URL da imagem:');
    if (url) {
        document.execCommand('insertImage', false, url);
    }
}

function insertTopicTable(topicEl) {
    const rows = parseInt(prompt('N√∫mero de linhas:', '3'));
    const cols = parseInt(prompt('N√∫mero de colunas:', '3'));
    
    if (rows > 0 && cols > 0) {
        const table = document.createElement('table');
        table.style.borderCollapse = 'collapse';
        table.style.width = '100%';
        
        for (let i = 0; i < rows; i++) {
            const tr = document.createElement('tr');
            for (let j = 0; j < cols; j++) {
                const td = document.createElement('td');
                td.style.border = '1px solid #ccc';
                td.style.padding = '8px';
                td.innerHTML = '&nbsp;';
                tr.appendChild(td);
            }
            table.appendChild(tr);
        }
        
        document.execCommand('insertHTML', false, table.outerHTML);
    }
}

function insertTopicCodeBlock(topicEl) {
    const code = prompt('Cole seu c√≥digo aqui:');
    if (code) {
        const pre = document.createElement('pre');
        pre.style.backgroundColor = '#f5f5f5';
        pre.style.padding = '10px';
        pre.style.borderRadius = '4px';
        pre.style.overflow = 'auto';
        pre.textContent = code;
        
        document.execCommand('insertHTML', false, pre.outerHTML);
    }
}

function setupTopicDrag(topicEl) {
    // Implementa√ß√£o b√°sica de drag & drop para reordenar t√≥picos
    const dragHandle = topicEl.querySelector('.drag-handle');
    let isDragging = false;
    let dragStartY = 0;
    let originalY = 0;
    
    dragHandle.addEventListener('mousedown', function(e) {
        isDragging = true;
        dragStartY = e.clientY;
        originalY = topicEl.offsetTop;
        topicEl.style.opacity = '0.7';
        topicEl.style.zIndex = '1000';
        document.body.style.cursor = 'grabbing';
        
        e.preventDefault();
    });
    
    document.addEventListener('mousemove', function(e) {
        if (!isDragging) return;
        
        const deltaY = e.clientY - dragStartY;
        topicEl.style.position = 'relative';
        topicEl.style.top = `${deltaY}px`;
        
        // Implementar l√≥gica de reordena√ß√£o aqui
        // (seria necess√°rio calcular a posi√ß√£o relativa aos outros t√≥picos)
    });
    
    document.addEventListener('mouseup', function() {
        if (!isDragging) return;
        
        isDragging = false;
        topicEl.style.opacity = '';
        topicEl.style.zIndex = '';
        topicEl.style.position = '';
        topicEl.style.top = '';
        document.body.style.cursor = '';
        
        showSaveIndicator('T√≥pico reorganizado');
    });
}

// Inicializar todos os t√≥picos existentes
function initializeAllTopics() {
    const topics = document.querySelectorAll('.topic-item');
    topics.forEach(topic => {
        initializeTopicEditor(topic);
        setupTopicEvents(topic);
    });
}

// Event listener para adicionar t√≥picos
document.addEventListener('DOMContentLoaded', function() {
    const addTopicBtn = document.getElementById('add-topic-btn');
    if (addTopicBtn) {
        addTopicBtn.addEventListener('click', addTopic);
    }
    
    // Inicializar t√≥picos existentes
    initializeAllTopics();


// Tamb√©m adicionar event delegation para os campos de c√≥digo
document.addEventListener('input', function(e) {
    // Se for um campo de quest√£o de c√≥digo, atualizar o preview
    if (e.target.classList.contains('question-input') || 
        e.target.classList.contains('starter-code') || 
        e.target.classList.contains('expected-output')) {
        
        const questionEl = e.target.closest('.question-item');
        if (questionEl && questionEl.dataset.type === 'code') {
            // Encontrar e atualizar os elementos de preview
            const instructionPreview = questionEl.querySelector('.instruction-preview');
            const codePreview = questionEl.querySelector('.code-preview');
            
            if (e.target.classList.contains('question-input') && instructionPreview) {
                instructionPreview.textContent = e.target.value || 'Escreva um programa que imprima "Hello World"';
            }
            
            if (e.target.classList.contains('starter-code') && codePreview) {
                codePreview.textContent = e.target.value || '# Seu c√≥digo aqui\nprint("Hello World")';
            }
        }
    }
});

});
</script>
{% endblock %}