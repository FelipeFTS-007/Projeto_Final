{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - PyQuest{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    /* Vari√°veis de cores para consist√™ncia com conte√∫do */
    :root {
        --primary-blue: #3B82F6;
        --primary-dark-blue: #1E40AF;
        --light-blue: #EFF6FF;
        --text-blue: #1E40AF;
        --light-bg: #F8FAFC;
        --success-green: #10B981;
        --warning-orange: #F59E0B;
        --danger-red: #EF4444;
        --purple: #8B5CF6;
    }
    
    .fade-in {
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.7s ease, transform 0.7s ease;
    }
    
    /* Cards de estat√≠sticas modernizados */
    .stat-card {
        background: white;
        border-radius: 1.5rem;
        padding: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        position: relative;
        overflow: hidden;
        border: 2px solid transparent;
    }
    
    .stat-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 20px 25px -5px rgba(59, 130, 246, 0.2), 0 10px 10px -5px rgba(59, 130, 246, 0.1);
    }
    
    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--card-color-1, #3B82F6), var(--card-color-2, #1E40AF));
    }
    
    .stat-card-completed {
        --card-color-1: #10B981;
        --card-color-2: #059669;
    }
    
    .stat-card-progress {
        --card-color-1: #F59E0B;
        --card-color-2: #D97706;
    }
    
    .stat-card-locked {
        --card-color-1: #6B7280;
        --card-color-2: #4B5563;
    }
    
    .stat-card-overall {
        --card-color-1: #8B5CF6;
        --card-color-2: #7C3AED;
    }
    
    .stat-card-streak {
        --card-color-1: #EF4444;
        --card-color-2: #DC2626;
    }
    
    .stat-card-vida {
        --card-color-1: #3B82F6;
        --card-color-2: #1E40AF;
    }
    
    .stat-icon {
        width: 3rem;
        height: 3rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.75rem;
        background: var(--light-blue);
    }
    
    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-blue);
        margin-bottom: 0.25rem;
    }
    
    .stat-label {
        font-size: 0.875rem;
        color: #64748B;
        font-weight: 500;
        margin-bottom: 0.5rem;
    }
    
    .stat-subtext {
        font-size: 0.75rem;
        color: #94A3B8;
    }
    
    
    /* Gr√°ficos modernizados - MELHORIAS APLICADAS */
    .chart-container {
        position: relative;
        height: 440px;
        background: white;
        border-radius: 1.5rem;
        padding: 1.5rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
        border: 1px solid #E2E8F0;
        background: linear-gradient(145deg, #ffffff, #f8fafc);
    }
    
    .chart-container:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.15), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        border-color: #CBD5E1;
    }
    
    .chart-container h2 {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1F2937;
        margin-bottom: 1.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid #F3F4F6;
    }
    
    /* Calend√°rio Mini Compacto - Atualizado */
    .mini-calendar {
        background: white;
        border-radius: 1.5rem;
        padding: 1.5rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        border: 1px solid #E2E8F0;
        height: 440px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        transition: all 0.3s ease;
        background: linear-gradient(145deg, #ffffff, #f8fafc);
    }
    
    .mini-calendar:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.15), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        border-color: #CBD5E1;
    }
    
    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding: 0 0.5rem;
    }
    
    .calendar-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #1f2937;
    }
    
    .calendar-nav-btn {
        background: #f3f4f6;
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        color: #4b5563;
        font-size: 0.8rem;
    }
    
    .calendar-nav-btn:hover {
        background: #e5e7eb;
        color: #374151;
        transform: scale(1.05);
    }
    
    .calendar-weekdays {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 2px;
        margin-bottom: 8px;
    }
    
    .weekday {
        text-align: center;
        font-size: 0.75rem;
        font-weight: 500;
        color: #6b7280;
        padding: 4px 0;
    }
    
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
        flex: 1;
        grid-template-rows: repeat(6, 1fr);
        min-height: 0;
    }
    
    .calendar-day {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        font-weight: 500;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        border: 2px solid transparent;
        min-height: 0;
        height: auto;
    }
    
    .calendar-day::before {
        content: '';
        display: block;
        padding-top: 100%;
    }
    
    .calendar-day span {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }
    
    .calendar-day:hover {
        transform: scale(1.1);
        z-index: 10;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    
    .day-other-month {
        color: #d1d5db;
        background: #f9fafb;
    }
    
    .day-today {
        border-color: #ef4444;
        background: #fef2f2;
        color: #dc2626;
        font-weight: 600;
    }
    
    /* Cores de atividade - quadrado todo pintado */
    .activity-none { 
        background-color: #f8fafc; 
        border-color: #e2e8f0;
    }
    .activity-low { 
        background-color: #dbeafe; 
        border-color: #93c5fd;
    }
    .activity-medium { 
        background-color: #93c5fd; 
        border-color: #60a5fa;
    }
    .activity-high { 
        background-color: #3b82f6; 
        border-color: #2563eb;
        color: white;
    }
    .activity-very-high { 
        background-color: #1e40af; 
        border-color: #1e3a8a;
        color: white;
    }
    
    .calendar-stats {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #f3f4f6;
        font-size: 0.8rem;
        color: #6b7280;
    }
    
    .stat-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    
    /* Legenda compacta */
    .calendar-legend {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin-top: 0.75rem;
        flex-wrap: wrap;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 0.7rem;
        color: #6b7280;
    }
    
    .legend-color {
        width: 12px;
        height: 12px;
        border-radius: 2px;
        border: 1px solid;
    }
    
    /* Bot√µes de per√≠odo modernizados */
    .time-btn {
        position: relative;
        z-index: 10;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
        outline: none;
        background: white;
        border: 1px solid #CBD5E1;
        border-radius: 0.75rem;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        color: #64748B;
        font-weight: 500;
    }
    
    .time-btn:hover {
        border-color: var(--primary-blue);
        color: var(--primary-blue);
        transform: translateY(-2px);
        box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.2);
    }
    
    .time-btn.active {
        background: var(--primary-blue);
        color: white;
        border-color: var(--primary-blue);
        box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.4);
    }
    
    /* Barra de progresso para m√≥dulos */
    .progress-bar-modules {
        height: 0.5rem;
        background: #E2E8F0;
        border-radius: 9999px;
        overflow: hidden;
        position: relative;
        margin-top: 0.5rem;
    }
    
    .progress-fill-modules {
        height: 100%;
        border-radius: 9999px;
        background: linear-gradient(90deg, var(--primary-blue) 0%, var(--primary-dark-blue) 100%);
        transition: width 1s ease-in-out;
        position: relative;
        overflow: hidden;
    }
    
    /* Header modernizado */
    .dashboard-header {
        background: linear-gradient(135deg, #3B82F6 0%, #1E40AF 100%);
        border-radius: 1.5rem;
        padding: 2rem;
        margin-bottom: 2rem;
        position: relative;
        overflow: hidden;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    .dashboard-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Ccircle cx='30' cy='30' r='2'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    }
    
    .header-content {
        position: relative;
        z-index: 2;
    }
    
    .dashboard-title {
        font-size: 2rem;
        font-weight: 800;
        color: white;
        margin-bottom: 0.5rem;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .dashboard-subtitle {
        font-size: 1.125rem;
        color: rgba(255, 255, 255, 0.9);
        margin-bottom: 0;
        font-weight: 400;
    }
    
    /* Anima√ß√µes */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    .stat-card, .chart-container, .mini-calendar {
        animation: fadeIn 0.5s ease forwards;
        opacity: 0;
    }
    
    .stat-card:nth-child(1) { animation-delay: 0.1s; }
    .stat-card:nth-child(2) { animation-delay: 0.2s; }
    .stat-card:nth-child(3) { animation-delay: 0.3s; }
    .stat-card:nth-child(4) { animation-delay: 0.4s; }
    .stat-card:nth-child(5) { animation-delay: 0.5s; }
    .stat-card:nth-child(6) { animation-delay: 0.6s; }
    
    /* Ajustes espec√≠ficos para o gr√°fico de conquistas */
    .chart-container:nth-child(1) .chart-container-inner {
        height: 180px; /* Altura maior para caber todas as barras */
    }
    
    /* Aumentar o espa√ßamento inferior do t√≠tulo */
    .chart-container h2 {
        margin-bottom: 1.5rem;
    }
    
    /* Ajustar a legenda para n√£o sobrepor */
    #conquistas-legenda {
        margin-top: 1rem;
        max-height: 120px;
        overflow-y: auto;
    }
    .chart-container-inner {
        height: 300px; /* Ou o valor que preferir */
        position: relative;
    }
    
    /* MELHORIAS PARA GR√ÅFICOS - NOVAS REGRAS */
    
    /* T√≠tulos dos gr√°ficos mais destacados */
    .chart-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1F2937;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid #F3F4F6;
    }
    
    .chart-title i {
        margin-right: 0.75rem;
        font-size: 1.5rem;
        background: linear-gradient(135deg, #3B82F6, #1E40AF);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    /* Controles de per√≠odo mais destacados */
    .time-controls {
        display: flex;
        gap: 0.5rem;
        background: #F8FAFC;
        padding: 0.25rem;
        border-radius: 0.75rem;
        border: 1px solid #E2E8F0;
    }
    
    /* Dropdown de ranking mais destacado */
    .ranking-dropdown {
        position: relative;
    }
    
    .ranking-dropdown-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: white;
        border: 1px solid #E2E8F0;
        border-radius: 0.75rem;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        color: #64748B;
        font-weight: 500;
        transition: all 0.2s ease;
        cursor: pointer;
    }
    
    .ranking-dropdown-btn:hover {
        border-color: #3B82F6;
        color: #3B82F6;
    }
    
    .ranking-dropdown-menu {
        position: absolute;
        top: 100%;
        right: 0;
        margin-top: 0.5rem;
        background: white;
        border-radius: 0.75rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        border: 1px solid #E2E8F0;
        min-width: 120px;
        z-index: 20;
        overflow: hidden;
    }
    
    .ranking-option {
        display: block;
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
        color: #64748B;
        transition: all 0.2s ease;
        border-bottom: 1px solid #F1F5F9;
    }
    
    .ranking-option:last-child {
        border-bottom: none;
    }
    
    .ranking-option:hover {
        background: #F8FAFC;
        color: #3B82F6;
    }
    
    /* Estilos para os gr√°ficos do Chart.js - MAIS DESTAQUE */
    .chartjs-render-monitor {
        filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.05));
    }
    
    /* Responsividade */
    @media (max-width: 768px) {
        .dashboard-header {
            padding: 1.5rem;
        }
        
        .dashboard-title {
            font-size: 1.75rem;
        }
        
        .dashboard-subtitle {
            font-size: 1rem;
        }
        
        .stat-number {
            font-size: 1.75rem;
        }
        
        .calendar-day {
            font-size: 0.7rem;
        }
        
        .chart-container, .mini-calendar {
            height: 400px;
        }
    }
    
    @media (max-width: 640px) {
        .dashboard-title {
            font-size: 1.5rem;
        }
        
        .stat-card {
            padding: 1.25rem;
        }
        
        .calendar-day {
            font-size: 0.65rem;
        }
        
        .chart-container, .mini-calendar {
            height: 350px;
            padding: 1rem;
        }
    }


/* CORRE√á√ÉO: Container de informa√ß√µes do ranking */
.flex.justify-between.items-center.mt-4.text-sm.text-gray-600.bg-gray-50.p-3.rounded-lg {
    margin-top: auto; /* Empurra para baixo */
    margin-bottom: 0;
    flex-shrink: 0; /* Evita que diminua */
    min-height: fit-content;
}
</style>
{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Cabe√ßalho modernizado -->
    <div class="dashboard-header">
        <div class="header-content">
            <h1 class="dashboard-title">Dashboard</h1>
            <p class="dashboard-subtitle">Bem-vindo de volta, {{ request.user.first_name|default:request.user.username }}! üëã Veja seu progresso e continue evoluindo.</p>
            <div class="text-sm text-white/80 mt-2">
                Atualizado em <span id="current-time">{{ current_time }}</span>
            </div>
        </div>
    </div>

<!-- Cards de Resumo Atualizados -->
<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
    <!-- Tempo de Estudo TOTAL (Teoria + Pr√°tica) -->
    <div class="stat-card stat-card-vida fade-in">
        <div class="stat-icon">
            <i class="fas fa-clock text-blue-600 text-xl"></i>
        </div>
        <h3 class="stat-label">Tempo de Estudo</h3>
        <p class="stat-number" id="tempo-estudo">{{ perfil.tempo_estudo_formatado }}</p>
        <div class="stat-subtext" id="tempo-hoje">
            Hoje
        </div>
    </div>
    
    <!-- XP Total -->
    <div class="stat-card stat-card-overall fade-in">
        <div class="stat-icon">
            <i class="fas fa-star text-purple-600 text-xl"></i>
        </div>
        <h3 class="stat-label">XP Total</h3>
        <p class="stat-number" id="xp-total">{{ perfil.xp|default:0 }}</p>
        <div class="stat-subtext" id="xp-hoje">+{{ perfil.xp_hoje|default:0 }} hoje</div>
    </div>

    <!-- M√≥dulos -->
    <div class="stat-card stat-card-progress fade-in">
        <div class="stat-icon">
            <i class="fas fa-cubes text-orange-500 text-xl"></i>
        </div>
        <h3 class="stat-label">M√≥dulos</h3>
        <p class="stat-number" id="modulos-concluidos">{{ modulos_concluidos|default:0 }}/{{ total_modulos|default:0 }}</p>
        <div class="progress-bar-modules">
            <div class="progress-fill-modules" id="progresso-modulos" style="width: 0%"></div>
        </div>
    </div>
    
    <!-- Sequ√™ncia -->
    <div class="stat-card stat-card-streak fade-in">
        <div class="stat-icon">
            <i class="fas fa-fire text-red-500 text-xl"></i>
        </div>
        <h3 class="stat-label">Sequ√™ncia</h3>
        <p class="stat-number" id="sequencia-atual">{{ perfil.sequencia|default:0 }} Dias</p>
        <div class="stat-subtext" id="meta-sequencia">Meta: 7 dias</div>
    </div>
    
    <!-- Tempo para Pr√≥xima Vida (CORRIGIDO) -->
    <div class="stat-card stat-card-vida fade-in">
        <div class="stat-icon">
            <i class="fas fa-heart text-blue-600 text-xl"></i>
        </div>
        <h3 class="stat-label">Pr√≥xima Vida</h3>
        <p class="stat-number" id="tempo-proxima-vida">
            {% if perfil.vidas >= perfil.max_vidas %}
                Completas
            {% else %}
                {{ perfil.tempo_para_proxima_vida }}min
            {% endif %}
        </p>
        <!-- ‚úÖ CORRE√á√ÉO: REMOVER TEXTO DAS VIDAS EM BAIXO -->
    </div>
    
    <!-- Recorde de Sequ√™ncia -->
    <div class="stat-card stat-card-completed fade-in">
        <div class="stat-icon">
            <i class="fas fa-trophy text-green-600 text-xl"></i>
        </div>
        <h3 class="stat-label">Recorde</h3>
        <p class="stat-number" id="recorde-sequencia">{{ perfil.sequencia_maxima|default:0 }} Dias</p>
        <div class="stat-subtext">Melhor sequ√™ncia</div>
    </div>
</div>

    <!-- Primeira Linha de Gr√°ficos -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Gr√°fico de Evolu√ß√£o de XP -->
        <div class="chart-container fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="chart-title">
                    <i class="fas fa-chart-line"></i> Evolu√ß√£o do XP
                </h2>
                <div class="time-controls">
                    <button class="time-btn px-3 py-1.5 rounded-lg font-semibold text-sm transition-all duration-300" data-period="day">Dia</button>
                    <button class="time-btn px-3 py-1.5 rounded-lg font-semibold text-sm transition-all duration-300 active" data-period="week">Semana</button>
                    <button class="time-btn px-3 py-1.5 rounded-lg font-semibold text-sm transition-all duration-300" data-period="month">M√™s</button>
                </div>
            </div>
            <div class="chart-container-inner">
                <canvas id="xpChart"></canvas>
            </div>
        </div>
        
        <!-- Mini Calend√°rio Compacto -->
        <div class="mini-calendar fade-in">
            <div class="calendar-header">
                <button class="calendar-nav-btn" id="calendar-prev">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="calendar-title" id="calendar-month-year">Carregando...</div>
                <button class="calendar-nav-btn" id="calendar-next">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            
            <div class="calendar-weekdays">
                <div class="weekday">D</div>
                <div class="weekday">S</div>
                <div class="weekday">T</div>
                <div class="weekday">Q</div>
                <div class="weekday">Q</div>
                <div class="weekday">S</div>
                <div class="weekday">S</div>
            </div>
            
            <div class="calendar-grid" id="calendar-days">
                <!-- Dias ser√£o preenchidos via JavaScript -->
            </div>
            
            <!-- Legenda Compacta -->
            <div class="calendar-legend">
                <div class="legend-item">
                    <div class="legend-color activity-none border-gray-300"></div>
                    <span>Nenhum</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color activity-low border-blue-300"></div>
                    <span>Leve</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color activity-medium border-blue-400"></div>
                    <span>M√©dio</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color activity-high border-blue-600"></div>
                    <span>Alto</span>
                </div>
            </div>
            
            <div class="calendar-stats">
                <div class="stat-item">
                    <span>Dias ativos:</span>
                    <span class="font-semibold text-blue-600" id="stats-active-days">0</span>
                </div>
                <div class="stat-item">
                    <span>Sequ√™ncia:</span>
                    <span class="font-semibold text-green-600" id="stats-current-streak">0 dias</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Segunda Linha de Gr√°ficos -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Gr√°fico de Conquistas por Categoria -->
        <div class="chart-container fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="chart-title">
                    <i class="fas fa-trophy"></i> Conquistas por Categoria
                </h2>
                <div class="flex items-center text-sm text-gray-600 bg-blue-50 px-3 py-1.5 rounded-lg">
                    <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                    <span class="text-xs font-medium">Progresso nas categorias</span>
                </div>
            </div>
            <div class="chart-container-inner">
                <canvas id="conquistasChart"></canvas>
            </div>
            <div class="mt-4 grid grid-cols-2 md:grid-cols-3 gap-2 text-xs" id="conquistas-legenda">
                <!-- Legenda ser√° preenchida via JavaScript -->
            </div>
        </div>
        
        <!-- Ranking Chart -->
        <div class="chart-container fade-in">
            <div class="flex justify-between items-center mb-0">
                <h2 class="chart-title">
                    <i class="fas fa-chart-bar"></i> Evolu√ß√£o no Ranking
                </h2>
                <div class="ranking-dropdown">
                    <button id="rankingDropdownBtn" class="ranking-dropdown-btn">
                        Semana
                        <i class="fas fa-chevron-down text-xs"></i>
                    </button>
                    <div id="rankingDropdownMenu" class="ranking-dropdown-menu hidden">
                        <a href="#" class="ranking-option" data-period="day">Dia</a>
                        <a href="#" class="ranking-option" data-period="week">Semana</a>
                        <a href="#" class="ranking-option" data-period="month">M√™s</a>
                    </div>
                </div>
            </div>
            <div class="chart-container-inner">
                <canvas id="rankingChart"></canvas>
            </div>
            <div class="flex justify-between items-center mt-0 text-sm text-gray-600 bg-gray-50 p-3 rounded-lg">
                <span>Posi√ß√£o atual: <strong id="posicao-atual" class="text-blue-600">#{{ posicao_ranking|default:0 }}</strong></span>
                <span class="flex items-center" id="variacao-ranking">
                    <i class="fas fa-minus mr-1 text-gray-500"></i> <span class="text-gray-500">Sem varia√ß√£o</span>
                </span>
            </div>
        </div>
    </div>
    
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="fixed inset-0 bg-white/80 flex items-center justify-center z-50 transition-opacity duration-300">
    <div class="text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
        <p class="text-gray-600">Carregando dashboard...</p>
    </div>


    
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Vari√°veis globais
let charts = {};
let currentCalendarDate = new Date();

// üî• SISTEMA MAIS RIGOROSO - CRIT√âRIOS DIFICULTADOS
const CRITERIOS_ATIVIDADE = {
    1: { // Leve - MUITO MAIS DIF√çCIL
        min_xp: 25,       // Era 10, agora 25
        min_atividades: 2, // Era 1, agora 2
        min_tempo: 5,     // 15 minutos m√≠nimos
        cor: '#dbeafe',
        nome: 'Leve'
    },
    2: { // Moderado - MUITO MAIS DIF√çCIL
        min_xp: 60,       // Era 30, agora 60
        min_atividades: 4, // Era 3, agora 4
        min_tempo: 15,     // 30 minutos m√≠nimos
        cor: '#93c5fd',
        nome: 'Moderado'
    },
    3: { // Intenso - MUITO MAIS DIF√çCIL
        min_xp: 220,      // Era 60, agora 120
        min_atividades: 6, // Era 5, agora 6
        min_tempo: 20,     // 1 hora m√≠nima
        cor: '#3b82f6',
        nome: 'Intenso'
    },
    4: { // Muito Intenso - MUITO MAIS DIF√çCIL
        min_xp: 400,      
        min_atividades: 8, // Era 8, agora 8 (mantido mas mais raro)
        min_tempo: 45,    // 45 minnutos de minimo
        cor: '#1e40af',
        nome: 'Muito Intenso'
    }
};

document.addEventListener('DOMContentLoaded', async () => {
    console.log('üöÄ Inicializando Dashboard...');
    
    const loadingOverlay = document.getElementById('loadingOverlay');
    
    try {
        // Inicializar dados b√°sicos
        await inicializarDadosBasicos();
        
        // Inicializar gr√°ficos
        await inicializarGraficos();
        
        // Inicializar calend√°rio
        await inicializarCalendario();
        
        // Configurar bot√µes
        configurarBotoesPeriodo();
        configurarControlesCalendario();
        
        // Animar entrada dos elementos
        animarEntrada();
        
        console.log('‚úÖ Dashboard inicializado com sucesso!');
        
    } catch (error) {
        console.error('‚ùå Erro ao carregar dashboard:', error);
        mostrarNotificacao('Erro ao carregar dados do dashboard', 'error');
    } finally {
        setTimeout(() => {
            loadingOverlay.style.opacity = '0';
            setTimeout(() => loadingOverlay.remove(), 300);
        }, 500);
    }
});

// Fun√ß√µes de API
async function fetchAPI(url) {
    try {
        console.log('üì° Fetching URL:', url);
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        console.log('‚úÖ Dados recebidos de', url, data);
        return data;
    } catch (error) {
        console.error('‚ùå Erro na requisi√ß√£o API:', error);
        
        // FALLBACK para diferentes APIs
        if (url.includes('/calendar/')) {
            return getFallbackCalendarData();
        }
        
        if (url.includes('/xp/')) {
            const period = url.includes('period=day') ? 'day' : 
                          url.includes('period=month') ? 'month' : 'week';
            
            if (period === 'day') {
                return {
                    labels: ['00h', '04h', '08h', '12h', '16h', '20h'],
                    data: [50, 120, 80, 200, 150, 100],
                    period: period
                };
            } else if (period === 'month') {
                return {
                    labels: ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4'],
                    data: [1500, 1800, 1600, 2000],
                    period: period
                };
            } else {
                return {
                    labels: ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b', 'Dom'],
                    data: [200, 450, 300, 600, 350, 500, 400],
                    period: 'week'
                };
            }
        }
        
        if (url.includes('/conquistas-categorias/')) {
            return {
                categorias: ['Progresso', 'Habilidade', 'Precis√£o', 'Dom√≠nio', 'Especial'],
                percentuais: [75, 60, 45, 30, 20],
                detalhes: [
                    { categoria: 'Progresso', conquistas_desbloqueadas: 6, total_conquistas: 8, percentual: 75 },
                    { categoria: 'Habilidade', conquistas_desbloqueadas: 3, total_conquistas: 5, percentual: 60 },
                    { categoria: 'Precis√£o', conquistas_desbloqueadas: 2, total_conquistas: 4, percentual: 45 },
                    { categoria: 'Dom√≠nio', conquistas_desbloqueadas: 1, total_conquistas: 3, percentual: 30 },
                    { categoria: 'Especial', conquistas_desbloqueadas: 1, total_conquistas: 5, percentual: 20 }
                ]
            };
        }
        
        return getFallbackData(url);
    }
}

// üî• CALEND√ÅRIO MUITO MAIS RIGOROSO
function getFallbackCalendarData() {
    const year = currentCalendarDate.getFullYear();
    const month = currentCalendarDate.getMonth();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const data = [];
    
    const hoje = new Date();
    const monthStart = new Date(year, month, 1);
    
    for (let day = 1; day <= daysInMonth; day++) {
        const currentDate = new Date(year, month, day);
        const isPast = currentDate < hoje;
        const isToday = currentDate.toDateString() === hoje.toDateString();
        
        let hasActivity = false;
        let activityLevel = 0;
        let activityCount = 0;
        let xp = 0;
        let tempoEstudo = 0;

        if (isPast) {
            // üî• SISTEMA MUITO MAIS RIGOROSO: Menos dias com atividade
            hasActivity = Math.random() > 0.75; // Apenas 25% de chance (era 40%)
            
            if (hasActivity) {
                // üî• Gerar dados mais realistas mas MUITO mais dif√≠ceis
                activityCount = Math.floor(Math.random() * 12) + 1; // 1-12 atividades
                xp = Math.floor(Math.random() * 250) + 10; // 10-259 XP
                tempoEstudo = Math.floor(Math.random() * 180) + 10; // 10-189 minutos
                
                // üî• N√çVEIS MUITO MAIS DIF√çCEIS DE ATINGIR
                if (xp >= CRITERIOS_ATIVIDADE[4].min_xp && 
                    activityCount >= CRITERIOS_ATIVIDADE[4].min_atividades &&
                    tempoEstudo >= CRITERIOS_ATIVIDADE[4].min_tempo) {
                    activityLevel = 4; // Muito intenso
                } else if (xp >= CRITERIOS_ATIVIDADE[3].min_xp && 
                          activityCount >= CRITERIOS_ATIVIDADE[3].min_atividades &&
                          tempoEstudo >= CRITERIOS_ATIVIDADE[3].min_tempo) {
                    activityLevel = 3; // Intenso
                } else if (xp >= CRITERIOS_ATIVIDADE[2].min_xp && 
                          activityCount >= CRITERIOS_ATIVIDADE[2].min_atividades &&
                          tempoEstudo >= CRITERIOS_ATIVIDADE[2].min_tempo) {
                    activityLevel = 2; // Moderado
                } else if (xp >= CRITERIOS_ATIVIDADE[1].min_xp && 
                          activityCount >= CRITERIOS_ATIVIDADE[1].min_atividades &&
                          tempoEstudo >= CRITERIOS_ATIVIDADE[1].min_tempo) {
                    activityLevel = 1; // Leve
                } else {
                    // üî• Se n√£o atingiu o m√≠nimo para n√≠vel 1, n√£o conta como atividade
                    hasActivity = false;
                    activityLevel = 0;
                    activityCount = 0;
                    xp = 0;
                    tempoEstudo = 0;
                }
            }
        } else if (isToday) {
            // Hoje tamb√©m mais rigoroso
            hasActivity = Math.random() > 0.6; // 40% de chance (era 60%)
            if (hasActivity) {
                activityCount = Math.floor(Math.random() * 6) + 1;
                xp = Math.floor(Math.random() * 80) + 15;
                tempoEstudo = Math.floor(Math.random() * 60) + 15;
                
                // Aplicar crit√©rios rigorosos tamb√©m para hoje
                if (xp >= CRITERIOS_ATIVIDADE[2].min_xp && activityCount >= CRITERIOS_ATIVIDADE[2].min_atividades) {
                    activityLevel = 2;
                } else if (xp >= CRITERIOS_ATIVIDADE[1].min_xp && activityCount >= CRITERIOS_ATIVIDADE[1].min_atividades) {
                    activityLevel = 1;
                } else {
                    hasActivity = false;
                    activityLevel = 0;
                }
            }
        }
        
        data.push({
            date: `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`,
            activity_level: activityLevel,
            activity_count: activityCount,
            xp: xp,
            tempo_estudo: tempoEstudo,
            is_today: isToday,
            has_activity: hasActivity
        });
    }
    
    // Calcular estat√≠sticas
    const dias_ativos = data.filter(d => d.activity_level > 0).length;
    const total_atividades = data.reduce((sum, d) => sum + d.activity_count, 0);
    const total_xp = data.reduce((sum, d) => sum + d.xp, 0);
    const total_tempo = data.reduce((sum, d) => sum + d.tempo_estudo, 0);
    
    console.log('üî• CALEND√ÅRIO RIGOROSO - Dias ativos:', dias_ativos, 'de', daysInMonth, 
                'Total XP:', total_xp, 'Total tempo:', Math.round(total_tempo/60) + 'h');
    
    return {
        year: year,
        month: month,
        data: data,
        stats: {
            dias_ativos: dias_ativos,
            total_atividades: total_atividades,
            total_xp: total_xp,
            total_tempo_minutos: total_tempo,
            current_streak: calcularSequenciaFallback(data),
            percentual_mes: Math.round((dias_ativos / daysInMonth) * 100)
        }
    };
}

function calcularSequenciaFallback(data) {
    const hoje = new Date().toISOString().split('T')[0];
    let streak = 0;
    
    // Encontrar dados de hoje
    const todayData = data.find(d => d.date === hoje);
    if (todayData && todayData.activity_level > 0) {
        streak++;
        
        // Verificar dias anteriores consecutivos
        let currentDate = new Date(hoje);
        for (let i = 1; i <= 30; i++) {
            currentDate.setDate(currentDate.getDate() - 1);
            const dateStr = currentDate.toISOString().split('T')[0];
            const dayData = data.find(d => d.date === dateStr);
            
            if (dayData && dayData.activity_level > 0) {
                streak++;
            } else {
                break;
            }
        }
    }
    
    return streak;
}

function getFallbackData(url) {
    console.log('üîÑ Usando dados de fallback para:', url);
    
    if (url.includes('/basico/')) {
        return {
            tempo_estudo: '45:30',
            xp_total: 1250,
            xp_hoje: 85,
            modulos_concluidos: 3,
            total_modulos: 12,
            sequencia_atual: 5,
            precisao: 89,
            acertos_seguidos: 8,
            recorde_sequencia: 12
        };
    }
    
    if (url.includes('/categorias/')) {
        return {
            labels: ['Python', 'Django', 'Banco Dados', 'Frontend', 'APIs'],
            data: [75, 60, 45, 30, 20],
            cores: ['#1e40af', '#2563eb', '#3b82f6', '#60a5fa', '#93c5fd']
        };
    }
    
    if (url.includes('/ranking/')) {
        return {
            labels: ['2 dias atr√°s', 'Ontem', 'Hoje'],
            data: [45, 43, 42],
            posicao_atual: 42,
            variacao: 3,
            period: 'week'
        };
    }
    
    return {};
}

async function inicializarDadosBasicos() {
    try {
        const data = await fetchAPI('/api/dashboard/basico/');
        
        // ‚úÖ CORRE√á√ÉO: Usar tempo total formatado do perfil
        document.getElementById('tempo-estudo').textContent = data.tempo_estudo;
        document.getElementById('xp-total').textContent = data.xp_total.toLocaleString();
        document.getElementById('xp-hoje').textContent = `+${data.xp_hoje} hoje`;
        document.getElementById('modulos-concluidos').textContent = `${data.modulos_concluidos}/${data.total_modulos}`;
        document.getElementById('sequencia-atual').textContent = `${data.sequencia_atual} Dias`;
        
        // ‚úÖ CORRE√á√ÉO: Mostrar APENAS "Hoje" sem tempo estimado
        const tempoHojeElement = document.getElementById('tempo-hoje');
        if (tempoHojeElement) {
            // Verificar se h√° atividade hoje (XP ganho > 0)
            if (data.xp_hoje > 0) {
                tempoHojeElement.textContent = 'Hoje';
            } else {
                tempoHojeElement.textContent = 'Total acumulado';
            }
        }
        
        // Usar o campo correto para o recorde de sequ√™ncia
        const recordeSequencia = data.recorde_sequencia || data.recorde_acertos || 0;
        document.getElementById('recorde-sequencia').textContent = `${recordeSequencia} Dias`;
        
        console.log('üìä Dados b√°sicos carregados:', {
            tempo_estudo: data.tempo_estudo,
            xp_hoje: data.xp_hoje,
            sequencia_atual: data.sequencia_atual,
            recorde_sequencia: recordeSequencia
        });
        
        // Animar barras de progresso
        setTimeout(() => {
            document.getElementById('progresso-modulos').style.width = `${(data.modulos_concluidos / data.total_modulos) * 100}%`;
        }, 500);
        
    } catch (error) {
        console.error('Erro ao carregar dados b√°sicos:', error);
    }
}

async function inicializarGraficos() {
    await Promise.all([
        inicializarGraficoXP(),
        inicializarGraficoConquistas(),
        inicializarGraficoRanking()
    ]);
}

// Gr√°fico de Linha - Evolu√ß√£o do XP
async function inicializarGraficoXP() {
    try {
        const data = await fetchAPI('/api/dashboard/xp/?period=week');
        
        const ctx = document.getElementById('xpChart').getContext('2d');
        charts.xp = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'XP ganho',
                    data: data.data,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#3b82f6',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { 
                        beginAtZero: true,
                        grid: { color: 'rgba(0, 0, 0, 0.05)' },
                        ticks: { color: '#6b7280' }
                    },
                    x: { 
                        grid: { display: false },
                        ticks: { color: '#6b7280' }
                    }
                }
            }
        });
        
        console.log('‚úÖ Gr√°fico de XP inicializado (Semana)');
    } catch (error) {
        console.error('‚ùå Erro ao inicializar gr√°fico XP:', error);
    }
}

// Gr√°fico de Conquistas por Categoria
async function inicializarGraficoConquistas() {
    try {
        const data = await fetchAPI('/api/dashboard/conquistas-categorias/');
        
        const ctx = document.getElementById('conquistasChart').getContext('2d');
        charts.conquistas = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.categorias,
                datasets: [{
                    label: 'Conclus√£o (%)',
                    data: data.percentuais,
                    backgroundColor: [
                        'rgba(59, 130, 246, 0.8)',
                        'rgba(16, 185, 129, 0.8)',
                        'rgba(245, 158, 11, 0.8)',
                        'rgba(239, 68, 68, 0.8)',
                        'rgba(139, 92, 246, 0.8)',
                        'rgba(14, 165, 233, 0.8)'
                    ],
                    borderColor: [
                        '#3b82f6',
                        '#10b981',
                        '#f59e0b',
                        '#ef4444',
                        '#8b5cf6',
                        '#0ea5e9'
                    ],
                    borderWidth: 2,
                    borderRadius: 6,
                    borderSkipped: false,
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const detalhes = data.detalhes[context.dataIndex];
                                return [
                                    `Progresso: ${context.parsed.x}%`,
                                    `Conquistas: ${detalhes.conquistas_desbloqueadas}/${detalhes.total_conquistas}`
                                ];
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        max: 100,
                        grid: { color: 'rgba(0, 0, 0, 0.05)' },
                        ticks: { 
                            color: '#6b7280',
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    },
                    y: {
                        grid: { display: false },
                        ticks: { color: '#6b7280' }
                    }
                }
            }
        });
        
        // Atualizar legenda
        atualizarLegendaConquistas(data.detalhes);
        
        console.log('‚úÖ Gr√°fico de conquistas inicializado');
    } catch (error) {
        console.error('‚ùå Erro ao inicializar gr√°fico de conquistas:', error);
    }
}

function atualizarLegendaConquistas(detalhes) {
    const container = document.getElementById('conquistas-legenda');
    container.innerHTML = '';
    
    detalhes.forEach((categoria, index) => {
        const cores = [
            'bg-blue-500', 'bg-green-500', 'bg-yellow-500', 
            'bg-red-500', 'bg-purple-500', 'bg-cyan-500'
        ];
        
        const item = document.createElement('div');
        item.className = 'flex items-center space-x-2 p-2 bg-gray-50 rounded-lg';
        item.innerHTML = `
            <div class="w-3 h-3 rounded-full ${cores[index]}"></div>
            <div class="flex-1 min-w-0">
                <div class="font-semibold text-gray-800 text-xs truncate">${categoria.categoria}</div>
                <div class="text-gray-600 text-xs">${categoria.conquistas_desbloqueadas}/${categoria.total_conquistas}</div>
            </div>
            <div class="font-bold text-gray-800 text-xs">${categoria.percentual}%</div>
        `;
        container.appendChild(item);
    });
}

// Gr√°fico de Ranking
async function inicializarGraficoRanking() {
    try {
        const data = await fetchAPI('/api/dashboard/ranking/?period=week');
        
        charts.ranking = new Chart(document.getElementById('rankingChart'), {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'Posi√ß√£o',
                    data: data.data,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#3b82f6',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { 
                        reverse: true,
                        grid: { color: 'rgba(0, 0, 0, 0.05)' },
                        ticks: { color: '#6b7280' }
                    },
                    x: { 
                        grid: { display: false },
                        ticks: { color: '#6b7280' }
                    }
                }
            }
        });
        
        // Atualizar informa√ß√µes de ranking
        document.getElementById('posicao-atual').textContent = `#${data.posicao_atual}`;
        atualizarVariacaoRanking(data.variacao);
        
        console.log('‚úÖ Gr√°fico de ranking inicializado');
    } catch (error) {
        console.error('‚ùå Erro ao inicializar gr√°fico ranking:', error);
    }
}

function atualizarVariacaoRanking(variacao) {
    const elemento = document.getElementById('variacao-ranking');
    
    if (variacao > 0) {
        elemento.innerHTML = `<i class="fas fa-arrow-up mr-1 text-green-500"></i> <span class="text-green-500">+${variacao}</span>`;
    } else if (variacao < 0) {
        elemento.innerHTML = `<i class="fas fa-arrow-down mr-1 text-red-500"></i> <span class="text-red-500">${variacao}</span>`;
    } else {
        elemento.innerHTML = `<i class="fas fa-minus mr-1 text-gray-500"></i> <span class="text-gray-500">Sem varia√ß√£o</span>`;
    }
}

// Calend√°rio Mini Compacto
async function inicializarCalendario() {
    try {
        await renderCalendario();
        console.log('‚úÖ Calend√°rio mini compacto inicializado');
    } catch (error) {
        console.error('‚ùå Erro ao inicializar calend√°rio:', error);
    }
}

async function renderCalendario() {
    const container = document.getElementById('calendar-days');
    const monthYearElement = document.getElementById('calendar-month-year');
    
    // Obter dados do calend√°rio
    const data = await fetchAPI(`/api/dashboard/calendar/?year=${currentCalendarDate.getFullYear()}&month=${currentCalendarDate.getMonth() + 1}`);
    
    // Atualizar t√≠tulo
    const monthNames = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 
                       'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
    monthYearElement.textContent = `${monthNames[currentCalendarDate.getMonth()]} ${currentCalendarDate.getFullYear()}`;
    
    // Limpar container
    container.innerHTML = '';
    
    // Obter primeiro dia do m√™s e √∫ltimo dia do m√™s
    const firstDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), 1);
    const lastDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 0);
    
    // Dias da semana (0 = Domingo, 1 = Segunda, ...)
    const firstDayIndex = firstDay.getDay();
    const daysInMonth = lastDay.getDate();
    
    // Dias do m√™s anterior
    const prevMonthLastDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), 0).getDate();
    
    // Gerar dias do m√™s anterior
    for (let i = firstDayIndex; i > 0; i--) {
        const day = prevMonthLastDay - i + 1;
        const dayElement = createDayElement(day, true, false, 0, null);
        container.appendChild(dayElement);
    }
    
    // Gerar dias do m√™s atual
    const today = new Date();
    const isCurrentMonth = today.getMonth() === currentCalendarDate.getMonth() && 
                          today.getFullYear() === currentCalendarDate.getFullYear();
    
    for (let i = 1; i <= daysInMonth; i++) {
        const isToday = isCurrentMonth && i === today.getDate();
        
        // Criar a data completa no formato YYYY-MM-DD
        const fullDate = `${currentCalendarDate.getFullYear()}-${String(currentCalendarDate.getMonth() + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
        
        // Encontrar dados para este dia
        const dayData = data.data.find(d => d.date === fullDate);
        
        const activityLevel = dayData ? dayData.activity_level : 0;
        
        const dayElement = createDayElement(i, false, isToday, activityLevel, fullDate);
        container.appendChild(dayElement);
    }
    
    // Calcular dias restantes para completar a grade (6 linhas)
    const totalCells = 42; // 6 linhas x 7 colunas
    const existingCells = firstDayIndex + daysInMonth;
    const remainingCells = totalCells - existingCells;
    
    // Gerar dias do pr√≥ximo m√™s
    for (let i = 1; i <= remainingCells; i++) {
        const dayElement = createDayElement(i, true, false, 0, null);
        container.appendChild(dayElement);
    }
    
    // Atualizar estat√≠sticas
    updateCalendarStats(data);
}

function createDayElement(dayNumber, isOtherMonth, isToday, activityLevel, fullDate) {
    const dayElement = document.createElement('div');
    
    // Classes base
    let classes = ['calendar-day'];
    
    if (isOtherMonth) {
        classes.push('day-other-month');
    }
    if (isToday) {
        classes.push('day-today');
    }
    
    // Adicionar classe de atividade (quadrado todo pintado)
    const activityClass = getActivityClass(activityLevel);
    classes.push(activityClass);
    
    dayElement.className = classes.join(' ');
    
    // USAR SPAN para o n√∫mero do dia
    const daySpan = document.createElement('span');
    daySpan.textContent = dayNumber;
    dayElement.appendChild(daySpan);
    
    // Adicionar tooltip e clique se houver atividade e n√£o for de outro m√™s
    if (activityLevel > 0 && !isOtherMonth && fullDate) {
        // Adicionar tooltip no hover
        dayElement.addEventListener('mouseenter', function(e) {
            showCalendarTooltip(e.target, dayNumber, activityLevel, fullDate);
        });
        
        dayElement.addEventListener('mouseleave', hideCalendarTooltip);
        
        // Adicionar clique para ver detalhes
        dayElement.addEventListener('click', async function() {
            await mostrarDetalhesDia(fullDate);
        });
        
        // Adicionar cursor pointer para indicar que √© clic√°vel
        dayElement.style.cursor = 'pointer';
    }
    
    return dayElement;
}

function getActivityClass(level) {
    if (level === 1) return 'activity-low';
    if (level === 2) return 'activity-medium';
    if (level === 3) return 'activity-high';
    if (level >= 4) return 'activity-very-high';
    return 'activity-none';
}

// üî• TOOLTIP COM CRIT√âRIOS RIGOROSOS
function showCalendarTooltip(element, dayNumber, activityLevel, dateStr) {
    // Remover tooltip existente
    hideCalendarTooltip();
    
    const tooltip = document.createElement('div');
    tooltip.className = 'calendar-tooltip fixed z-50 bg-white border border-gray-300 rounded-lg shadow-lg p-4 max-w-xs';
    tooltip.style.pointerEvents = 'none';
    
    const monthNames = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 
                       'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
    
    const criterios = CRITERIOS_ATIVIDADE[activityLevel];
    let activityText = 'Nenhuma atividade';
    let criteriaText = '';
    
    if (criterios) {
        activityText = `Atividade ${criterios.nome}`;
        criteriaText = `M√≠nimo: ${criterios.min_xp}+ XP ‚Ä¢ ${criterios.min_atividades}+ atividades ‚Ä¢ ${criterios.min_tempo}min`;
    }
    
    tooltip.innerHTML = `
        <div class="font-semibold text-gray-800 text-sm">${dayNumber} de ${monthNames[currentCalendarDate.getMonth()]}</div>
        <div class="text-gray-700 text-sm mt-1">${activityText}</div>
        <div class="text-xs text-gray-600 mt-2 font-medium">${criteriaText}</div>
        <div class="text-xs text-blue-600 mt-2 font-medium">Clique para ver detalhes</div>
    `;
    document.body.appendChild(tooltip);
    
    // Posicionar tooltip
    const rect = element.getBoundingClientRect();
    const tooltipRect = tooltip.getBoundingClientRect();
    
    let left = rect.left + rect.width / 2 - tooltipRect.width / 2;
    let top = rect.top - tooltipRect.height - 10;
    
    // Ajustar se sair da tela
    if (left < 10) left = 10;
    if (left + tooltipRect.width > window.innerWidth - 10) {
        left = window.innerWidth - tooltipRect.width - 10;
    }
    if (top < 10) {
        top = rect.bottom + 10;
    }
    
    tooltip.style.left = left + 'px';
    tooltip.style.top = top + 'px';
    tooltip.style.opacity = '1';
    
    element.tooltip = tooltip;
}

async function mostrarDetalhesDia(dateStr) {
    console.log('üìÖ Buscando detalhes para:', dateStr);
    
    try {
        const response = await fetch(`/api/calendar/activity-detail/?date=${dateStr}`);
        
        if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            console.log('‚úÖ Dados recebidos para:', data.date_display || data.date);
            criarModalDetalhesDia(data);
        } else {
            console.log('‚ÑπÔ∏è Nenhuma atividade detalhada para este dia');
            criarModalDetalhesDia({
                date: dateStr,
                date_display: formatarDataParaExibicao(dateStr),
                atividades: [],
                total_atividades: 0,
                total_xp: 0,
                tempo_estudo_formatado: '00:00'
            });
        }
    } catch (error) {
        console.error('‚ùå Erro ao buscar detalhes:', error);
        
        // Mostrar modal de erro
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-red-600">Erro</h3>
                    <button class="text-gray-500 hover:text-gray-700" onclick="this.closest('.fixed').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <p class="text-gray-600">N√£o foi poss√≠vel carregar os detalhes deste dia.</p>
                <div class="mt-4 flex justify-end">
                    <button class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600" onclick="this.closest('.fixed').remove()">
                        Fechar
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Fechar modal ao clicar fora
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                modal.remove();
            }
        });
    }
}

function formatarDataParaExibicao(dateStr) {
    const data = new Date(dateStr);
    return data.toLocaleDateString('pt-BR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
    });
}

function criarModalDetalhesDia(dados) {
    // Remover modal existente se houver
    const existingModal = document.querySelector('.modal-overlay');
    if (existingModal) {
        existingModal.remove();
    }
    
    let dataFormatada;
    if (dados.date_display) {
        dataFormatada = dados.date_display;
    } else {
        const dataObj = new Date(dados.date);
        dataFormatada = dataObj.toLocaleDateString('pt-BR', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
    }
    
    console.log('üìä Exibindo modal para:', dataFormatada);
    
    const modal = document.createElement('div');
    modal.className = 'modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4';
    modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
    modal.innerHTML = `
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-hidden">
            <div class="flex justify-between items-center p-6 border-b border-gray-200 bg-white">
                <h3 class="text-xl font-bold text-gray-800">Atividades do Dia</h3>
                <button class="close-modal text-gray-400 hover:text-gray-600 transition-colors p-2 rounded-full hover:bg-gray-100">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            
            <div class="p-6 bg-gray-50 border-b border-gray-200">
                <p class="text-gray-700 font-medium text-lg capitalize">${dataFormatada}</p>
            </div>
            
            <div class="p-6 max-h-64 overflow-y-auto">
                ${dados.atividades && dados.atividades.length > 0 ? 
                    dados.atividades.map(atividade => `
                        <div class="mb-4 last:mb-0 p-4 bg-white rounded-lg border border-gray-200 shadow-sm">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-800 text-sm">${atividade.titulo || 'Atividade'}</h4>
                                    <div class="text-xs text-gray-500 mt-1">
                                        <span class="inline-flex items-center">
                                            <i class="fas fa-clock mr-1"></i>
                                            ${atividade.hora || '--:--'}
                                        </span>
                                        ${atividade.aula ? ` ‚Ä¢ ${atividade.aula}` : ''}
                                    </div>
                                </div>
                                <div class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-bold ml-3">
                                    +${atividade.xp_ganho || 0} XP
                                </div>
                            </div>
                        </div>
                    `).join('') 
                    : 
                    '<div class="text-center py-8">' +
                    '<i class="fas fa-calendar-plus text-gray-300 text-5xl mb-4"></i>' +
                    '<p class="text-gray-500 font-medium text-lg">Nenhuma atividade</p>' +
                    '<p class="text-gray-400 text-sm mt-1">Este dia n√£o teve atividades registradas</p>' +
                    '</div>'
                }
            </div>
            
            <div class="p-6 bg-gray-50 border-t border-gray-200">
                <div class="grid grid-cols-3 gap-4 text-center">
                    <div class="bg-white p-3 rounded-lg border border-gray-200">
                        <div class="text-2xl font-bold text-blue-600">${dados.total_atividades || 0}</div>
                        <div class="text-xs text-gray-600 font-medium mt-1">Atividades</div>
                    </div>
                    <div class="bg-white p-3 rounded-lg border border-gray-200">
                        <div class="text-2xl font-bold text-green-600">+${dados.total_xp || 0}</div>
                        <div class="text-xs text-gray-600 font-medium mt-1">XP Total</div>
                    </div>
                    <div class="bg-white p-3 rounded-lg border border-gray-200">
                        <div class="text-lg font-bold text-purple-600">${dados.tempo_estudo_formatado || '00:00'}</div>
                        <div class="text-xs text-gray-600 font-medium mt-1">Tempo</div>
                    </div>
                </div>
            </div>
            
            <div class="p-6 bg-white border-t border-gray-200">
                <button class="close-modal w-full bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 transition-colors font-medium">
                    Fechar
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Adicionar event listeners para fechar o modal
    const closeModalHandler = function() {
        modal.remove();
    };
    
    const closeButtons = modal.querySelectorAll('.close-modal');
    closeButtons.forEach(button => {
        button.addEventListener('click', closeModalHandler);
    });
    
    // Fechar modal ao clicar no overlay
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeModalHandler();
        }
    });
    
    // Fechar modal com ESC
    const keyHandler = function(e) {
        if (e.key === 'Escape') {
            closeModalHandler();
            document.removeEventListener('keydown', keyHandler);
        }
    };
    
    document.addEventListener('keydown', keyHandler);
    
    // Limpar event listener quando modal for fechado
    modal.addEventListener('click', function handler() {
        document.removeEventListener('keydown', keyHandler);
    });
}

function hideCalendarTooltip() {
    const existingTooltip = document.querySelector('.calendar-tooltip');
    if (existingTooltip) {
        existingTooltip.remove();
    }
}

function updateCalendarStats(data) {
    document.getElementById('stats-active-days').textContent = data.stats.dias_ativos;
    
    // Calcular sequ√™ncia atual
    const currentStreak = calcularSequenciaAtual(data.data);
    document.getElementById('stats-current-streak').textContent = `${currentStreak} dias`;
}

function calcularSequenciaAtual(days) {
    const hoje = new Date().toISOString().split('T')[0];
    let streak = 0;
    let currentDate = new Date(hoje);
    
    for (let i = 0; i < 30; i++) {
        const dateStr = currentDate.toISOString().split('T')[0];
        const dayData = days.find(d => d.date === dateStr);
        
        if (dayData && dayData.activity_level > 0) {
            streak++;
        } else {
            break;
        }
        
        currentDate.setDate(currentDate.getDate() - 1);
    }
    
    return streak;
}

// FUN√á√ïES DE ATUALIZA√á√ÉO DOS GR√ÅFICOS
async function atualizarGraficoXP(period) {
    console.log('üîÑ Atualizando gr√°fico XP para:', period);
    try {
        const data = await fetchAPI(`/api/dashboard/xp/?period=${period}`);
        
        if (charts.xp) {
            charts.xp.data.labels = data.labels;
            charts.xp.data.datasets[0].data = data.data;
            charts.xp.update();
            console.log('‚úÖ Gr√°fico XP atualizado para:', period);
        }
    } catch (error) {
        console.error('‚ùå Erro ao atualizar gr√°fico XP:', error);
    }
}

async function atualizarGraficoRanking(period) {
    console.log('üîÑ Atualizando gr√°fico ranking para:', period);
    try {
        const data = await fetchAPI(`/api/dashboard/ranking/?period=${period}`);
        
        if (charts.ranking) {
            charts.ranking.data.labels = data.labels;
            charts.ranking.data.datasets[0].data = data.data;
            charts.ranking.update();
            
            document.getElementById('posicao-atual').textContent = `#${data.posicao_atual}`;
            atualizarVariacaoRanking(data.variacao);
            console.log('‚úÖ Gr√°fico ranking atualizado para:', period);
        }
    } catch (error) {
        console.error('‚ùå Erro ao atualizar gr√°fico ranking:', error);
    }
}

// FUN√á√ïES AUXILIARES
function animarEntrada() {
    const elements = document.querySelectorAll('.fade-in');
    elements.forEach((el, index) => {
        setTimeout(() => {
            el.style.opacity = '1';
            el.style.transform = 'translateY(0)';
        }, index * 100);
    });
}

function mostrarNotificacao(mensagem, tipo = 'info') {
    const notification = document.createElement('div');
    const bgColor = tipo === 'success' ? 'bg-green-500' : tipo === 'error' ? 'bg-red-500' : 'bg-blue-500';
    
    notification.className = `fixed top-4 right-4 ${bgColor} text-white p-4 rounded-lg shadow-lg z-50 transform transition-transform duration-300 translate-x-full`;
    notification.innerHTML = `
        <div class="flex items-center">
            <i class="fas fa-${tipo === 'success' ? 'check' : tipo === 'error' ? 'exclamation-triangle' : 'info'} mr-2"></i>
            <span>${mensagem}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.classList.remove('translate-x-full');
    }, 100);
    
    setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => notification.remove(), 300);
    }, 5000);
}

function atualizarTempoAtual() {
    const now = new Date();
    const timeString = now.toLocaleString('pt-BR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
    document.getElementById('current-time').textContent = timeString;
}

// SISTEMA DE BOT√ïES
function configurarBotoesPeriodo() {
    console.log('üîß Configurando bot√µes de per√≠odo...');
    
    // Bot√µes do gr√°fico de linha (Evolu√ß√£o do XP)
    document.querySelectorAll('.time-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const period = this.dataset.period;
            console.log('üéØ Bot√£o time-btn clicado:', period);
            
            // Remover classe active de todos os bot√µes do mesmo grupo
            this.parentElement.querySelectorAll('.time-btn').forEach(b => {
                b.classList.remove('active');
            });
            
            // Adicionar classe active ao bot√£o clicado
            this.classList.add('active');
            
            // Atualizar gr√°fico
            atualizarGraficoXP(period);
        });
    });
    
    // Dropdown do ranking
    const rankingBtn = document.getElementById('rankingDropdownBtn');
    const rankingMenu = document.getElementById('rankingDropdownMenu');
    
    if (rankingBtn) {
        rankingBtn.addEventListener('click', () => {
            rankingMenu.classList.toggle('hidden');
        });
        
        // Op√ß√µes do dropdown
        document.querySelectorAll('.ranking-option').forEach(option => {
            option.addEventListener('click', function(e) {
                e.preventDefault();
                const period = this.dataset.period;
                rankingBtn.innerHTML = `${this.textContent} <i class="fas fa-chevron-down ml-2 text-xs self-center"></i>`;
                rankingMenu.classList.add('hidden');
                atualizarGraficoRanking(period);
            });
        });
    }
    
    console.log('‚úÖ Sistema de bot√µes configurado');
}

// Configurar controles do calend√°rio
function configurarControlesCalendario() {
    // Bot√£o m√™s anterior
    document.getElementById('calendar-prev').addEventListener('click', () => {
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
        renderCalendario();
    });
    
    // Bot√£o pr√≥ximo m√™s
    document.getElementById('calendar-next').addEventListener('click', () => {
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
        renderCalendario();
    });
}

// Fechar dropdowns ao clicar fora
document.addEventListener('click', (e) => {
    if (!e.target.closest('#rankingDropdownBtn') && !e.target.closest('#rankingDropdownMenu')) {
        document.getElementById('rankingDropdownMenu')?.classList.add('hidden');
    }
});

// CORRE√á√ÉO FINAL: Fun√ß√£o para atualizar status das vidas
async function atualizarStatusVidas() {
    try {
        const data = await fetchAPI('/api/dashboard/basico/');
        
        // ‚úÖ ATUALIZAR APENAS O CARD DE VIDAS
        const elementoVidas = document.getElementById('tempo-proxima-vida');
        const elementoStatusVidas = document.getElementById('status-vidas');
        
        if (elementoVidas && elementoStatusVidas) {
            const vidasAtuais = data.vidas_restantes || 5;
            const maxVidas = data.max_vidas || 10;
            
            if (vidasAtuais >= maxVidas) {
                elementoVidas.textContent = 'Completas';
            } else {
                const tempoProximaVida = data.tempo_para_proxima_vida || 5;
                elementoVidas.textContent = `${tempoProximaVida}min`;
            }
            
            // ‚úÖ ATUALIZAR APENAS O ELEMENTO DE STATUS DE VIDAS
            elementoStatusVidas.textContent = `${vidasAtuais}/${maxVidas} vidas`;
        }
        
        // ‚úÖ MANTER O TEMPO DE HOJE SEM ALTERA√á√ÉO
        const tempoHojeElement = document.getElementById('tempo-hoje');
        if (tempoHojeElement && data.tempo_estudo_hoje) {
            tempoHojeElement.textContent = `Hoje: ${data.tempo_estudo_hoje}`;
        }
        
    } catch (error) {
        console.error('Erro ao atualizar status das vidas:', error);
    }
}

// Chamar a fun√ß√£o periodicamente (a cada minuto)
setInterval(atualizarStatusVidas, 60000);

// E tamb√©m chamar quando a p√°gina carregar
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(atualizarStatusVidas, 1000);
});

// Atualizar tempo a cada minuto
setInterval(atualizarTempoAtual, 60000);
atualizarTempoAtual();
</script>
{% endblock %}