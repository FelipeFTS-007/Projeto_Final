{% extends 'base.html' %}
{% load static %}

{% block title %}P√°gina Inicial{% endblock %}

{% block extra_css %}
<style>
    /* Seus estilos CSS existentes permanecem aqui */
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
    
    .card-hover {
      transition: all 0.3s ease;
    }
    
    .card-hover:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.15);
    }
    
    .progress-bar {
      overflow: hidden;
      position: relative;
    }
    
    .progress-bar::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: var(--progress);
      background: linear-gradient(90deg, #3B82F6 0%, #1E40AF 100%);
      border-radius: 9999px;
    }
    
    .xp-badge {
      background: linear-gradient(135deg, #3B82F6 0%, #1E40AF 100%);
    }
    
    .activity-item {
      transition: all 0.3s ease;
      border-left: 4px solid transparent;
    }
    
    .activity-item:hover {
      transform: translateY(-2px);
      border-left-color: #3B82F6;
    }

    .activity-item.active {
      transform: translateY(-2px);
      border-left-color: #3B82F6;
    }
    
    .pulse-animation {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    .floating-element {
      animation: float 6s ease-in-out infinite;
    }
    
    @keyframes float {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
      100% { transform: translateY(0px); }
    }

    .circular-chart {
      display: block;
      max-width: 100%;
      max-height: 100%;
    }
    
    .circle-bg {
      fill: none;
      stroke: #EFF6FF;
      stroke-width: 3.8;
    }
    
    .circle {
      fill: none;
      stroke-width: 2.8;
      stroke-linecap: round;
      stroke: #EF4444;
      animation: progress 1.5s ease-out forwards;
    }
    
    @keyframes progress {
      0% { stroke-dasharray: 0 100; }
    }
    
    .percentage {
      fill: #DC2626;
      font-size: 0.5em;
      text-anchor: middle;
      font-weight: bold;
    }
    
    /* Novos estilos adicionados */
    .card-blue {
      border-color: #3B82F6;
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    }
    
     .card-white {
      border-color: #3B82F6;
      background: linear-gradient(135deg, #ffff 0%, #ffffff 100%);
    }
    
    .card-red {
      border-color: #EF4444;
      background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
    }
    
    .card-purple {
      border-color: #8B5CF6;
      background: linear-gradient(135deg, #faf5ff 0%, #ede9fe 100%);
    }
    
    .card-green {
      border-color: #10B981;
      background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
    }
    
    .card-amber {
      border-color: #F59E0B;
      background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
    }
    
    .section-title {
      position: relative;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
    }
    
    .highlight-text {
      background: linear-gradient(90deg, #3B82F6 0%, #EF4444 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* Novo estilo para o timer */
    .timer-active {
      background: linear-gradient(135deg, #10B981 0%, #059669 100%) !important;
      color: white !important;
    }
</style>
{% endblock %}

{% block content %}
<section class="flex-1 bg-white rounded-2xl p-6 flex flex-col gap-6">
<!-- Boas-vindas com gradiente e anima√ß√£o -->
<div class="bg-gradient-to-r from-blue-600 to-blue-800 rounded-2xl p-6 flex justify-between items-center shadow-lg relative overflow-hidden">
  <div class="relative z-10">
    <h2 class="text-2xl font-bold text-white">Ol√°, {{ nome }}!</h2>
    <p class="text-blue-100 mt-1">Continue sua jornada de aprendizado Python. Voc√™ est√° indo bem!</p>
    <div class="flex items-center mt-4">
      <div class="bg-blue-800 text-blue-100 text-xs font-medium px-3 py-1 rounded-full">
        N√≠vel {{ nivel }}
      </div>
      <div class="bg-purple-700 text-purple-100 text-xs font-medium px-3 py-1 rounded-full ml-2">
        {{ xp }} XP
      </div>
    </div>
  </div>
  <img src="{% static 'imagem/rocket_launch_100dp_FFFFFF_FILL0_wght400_GRAD0_opsz48.png' %}" alt="Boas-vindas" class="w-16 h-16 relative z-10 floating-element">
  
  <!-- Elementos decorativos de fundo -->
  <div class="absolute top-0 left-0 w-full h-full overflow-hidden opacity-10">
    <div class="absolute -top-4 -left-4 w-24 h-24 rounded-full bg-white"></div>
    <div class="absolute top-10 right-20 w-16 h-16 rounded-full bg-white"></div>
    <div class="absolute bottom-5 left-20 w-12 h-12 rounded-full bg-white"></div>
  </div>
</div>

<!-- Cards de Estat√≠sticas com layout melhorado -->
<div class="stats-grid">
  <div class="activity-item p-5 rounded-2xl shadow-md card-hover border card-blue">
    <div class="flex justify-between items-start">
      <h3 class="text-lg font-semibold text-blue-700">Progresso Di√°rio</h3>
      <img src="{% static 'imagem/trending_up_35dp_2682EA_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Progresso" class="w-6 h-6">
    </div>
    <p class="mt-2 text-blue-600 font-bold text-2xl">{{ progresso }}%</p>
    <div class="w-full bg-blue-200 h-2.5 rounded-full mt-3 progress-bar" style="--progress: {{ progresso }}%;"></div>
    <p class="text-xs text-blue-500 mt-2">Meta: {{ meta }}% di√°rio</p>
  </div>
  
  <div class="activity-item p-5 rounded-2xl shadow-md card-hover border card-green">
    <div class="flex justify-between items-start">
      <h3 class="text-lg font-semibold text-green-700">Tempo de Estudo</h3>
      <img src="{% static 'imagem/schedule_35dp_10B981_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Tempo" class="w-6 h-6">
    </div>
    <div class="flex items-center mt-2 flex-grow">
      <img src="{% static 'imagem/local_cafe_100dp_10B981_FILL0_wght400_GRAD0_opsz48.png' %}" alt="" class="w-12 h-12">
      <p id="tempo-estudo-display" class="text-green-600 font-bold text-2xl ml-3">{{ tempo }}</p>
    </div>
    <p class="text-xs text-green-500 mt-2">Minutos</p>
  </div>
  
  <div class="p-5 activity-item rounded-2xl shadow-md card-hover border card-amber">
    <div class="flex justify-between items-start">
      <h3 class="text-lg font-semibold text-amber-700">Sequ√™ncia atual</h3>
      <img src="{% static 'imagem/calendar_month_35dp_F59E0B_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Sequ√™ncia" class="w-6 h-6">
    </div>
    <div class="flex items-center mt-2 flex-grow">
      <img src="{% static 'imagem/mode_heat_100dp_F59E0B_FILL0_wght400_GRAD0_opsz48.png' %}" alt="" class="w-12 h-12">
      <p class="text-amber-600 font-bold text-2xl ml-3">{{ perfil.sequencia }} Dias</p>
    </div>
    <p class="text-xs text-amber-500 mt-2">Mantenha a sequ√™ncia para ganhar b√¥nus!</p>
  </div>
</div>

<!-- Cards de Miss√µes e Conquistas com design aprimorado -->
<div class="stats-grid">
  <div class="activity-item p-5 rounded-2xl shadow-md card-hover border card-red">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-lg font-semibold text-red-700">Vidas</h3>
      <img src="{% static 'imagem/favorite_35dp_EF4444_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Vidas" class="w-6 h-6">
    </div>
    <div class="flex items-center">
      <div class="relative">
        <div class="w-16 h-16">
          <svg viewBox="0 0 36 36" class="circular-chart">
            <path class="circle"
              stroke-dasharray="{{ progresso_vidas }}, 100"
              d="M18 2.0845
                a 15.9155 15.9155 0 0 1 0 31.831
                a 15.9155 15.9155 0 0 1 0 -31.831"/>
            <text x="18" y="20.35" class="percentage">{{ vidas }}/{{ max_vidas }}</text>
          </svg>
        </div>
      </div>
      <p class="text-red-600 font-bold text-xl ml-4">{{ vidas }}</p>
    </div>
    <p class="text-xs text-red-500 mt-2">
    {% if perfil.vidas < 10 %}
      Regenera√ß√£o: {{ perfil.tempo_para_proxima_vida }} min
    {% else %}
      Vidas completas
    {% endif %}
    </p>
  </div>

  <div class="activity-item p-5 rounded-2xl shadow-md card-hover border card-purple">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-lg font-semibold text-purple-700">XP Total</h3>
      <img src="{% static 'imagem/chess_35dp_8B5CF6_FILL0_wght400_GRAD0_opsz40.png' %}" alt="XP" class="w-6 h-6">
    </div>
    <div class="flex items-center">
      <img src="{% static 'imagem/trophy_100dp_8B5CF6_FILL0_wght400_GRAD0_opsz48.png' %}" alt="trofeu" class="w-16 h-16">
      <p class="text-purple-600 font-bold text-2xl ml-4">{{ perfil.xp }}</p>
    </div>
    <p class="text-xs text-purple-500 mt-2">+{{ perfil.xp_hoje }} XP hoje</p>
  </div>
  
  <div class="activity-item p-5 rounded-2xl shadow-md card-hover border card-blue">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-lg font-semibold text-blue-700">Conquistas</h3>
      <img src="{% static 'imagem/military_tech_35dp_2682EA_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Conquistas" class="w-6 h-6">
    </div>
    <div class="flex items-center">
      <img src="{% static 'imagem/diamond_shine_100dp_2682EA_FILL0_wght400_GRAD0_opsz48.png' %}" alt="" class="w-16 h-16">
      <div class="ml-4">
        <p class="text-blue-600 font-bold text-2xl">{{ conquistas }}/{{ total_conquistas }}</p>
        <p class="text-xs text-blue-500">conquistas</p>
      </div>
    </div>
    <p class="text-xs text-blue-500 mt-2">3 conquistas pr√≥ximas</p>
  </div>
</div>

<!-- Bot√£o Continuar Estudando com sistema de timer -->
<div class="mt-6 flex justify-center">
  <button id="btn-iniciar-estudo" class="bg-gradient-to-r from-blue-600 to-blue-800 text-white px-8 py-4 rounded-2xl font-semibold text-l transition transform hover:scale-105 shadow-lg flex items-center pulse-animation">
    <span id="btn-text">Continuar Estudando</span>
    <img src="{% static 'imagem/arrow_forward_35dp_FFFFFF_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Seta" class="w-5 h-5 ml-2">
  </button>
  
  <div id="timer-display" class="hidden items-center ml-4">
    <div class="bg-green-100 text-green-800 px-4 py-2 rounded-lg font-mono text-lg">
      <span id="timer-minutes">00</span>:<span id="timer-seconds">00</span>
    </div>
    <button id="btn-parar-estudo" class="ml-2 bg-red-600 text-white px-4 py-2 rounded-lg font-semibold">
      Parar
    </button>
  </div>
</div>

</section>
{% endblock %}

{% block extra_js %}
<script>
class TimerEstudo {
    constructor() {
        this.tempoInicio = null;
        this.intervalo = null;
        this.tempoDecorrido = 0;
        this.estaRodando = false;
        
        this.btnIniciar = document.getElementById('btn-iniciar-estudo');
        this.btnParar = document.getElementById('btn-parar-estudo');
        this.timerDisplay = document.getElementById('timer-display');
        this.tempoEstudoDisplay = document.getElementById('tempo-estudo-display');
        
        this.inicializarEventos();
    }
    
    inicializarEventos() {
        this.btnIniciar.addEventListener('click', () => this.iniciarEstudo());
        this.btnParar.addEventListener('click', () => this.pararEstudo());
        
        // Salvar tempo quando a p√°gina for fechada/recarregada
        window.addEventListener('beforeunload', () => {
            if (this.estaRodando) {
                this.salvarTempoEstudo();
            }
        });
    }
    
    iniciarEstudo() {
        this.estaRodando = true;
        this.tempoInicio = new Date();
        
        this.btnIniciar.classList.add('hidden');
        this.timerDisplay.classList.remove('hidden');
        this.btnIniciar.classList.remove('pulse-animation');
        
        this.intervalo = setInterval(() => {
            this.atualizarTimer();
        }, 1000);
        
        console.log("‚è±Ô∏è Timer iniciado");
    }
    
    atualizarTimer() {
        const agora = new Date();
        const diferenca = Math.floor((agora - this.tempoInicio) / 1000);
        this.tempoDecorrido = diferenca;
        
        const minutos = Math.floor(diferenca / 60);
        const segundos = diferenca % 60;
        
        document.getElementById('timer-minutes').textContent = minutos.toString().padStart(2, '0');
        document.getElementById('timer-seconds').textContent = segundos.toString().padStart(2, '0');
    }
    
    async pararEstudo() {
        if (this.intervalo) {
            clearInterval(this.intervalo);
        }
        
        this.estaRodando = false;
        
        try {
            await this.salvarTempoEstudo();
            this.resetarTimer();
        } catch (error) {
            console.error('Erro ao salvar tempo:', error);
            this.resetarTimer();
        }
    }
    
    async salvarTempoEstudo() {
        if (this.tempoDecorrido > 0) {
            try {
                const response = await fetch('/salvar-tempo-estudo/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        tempo_segundos: this.tempoDecorrido,
                        tipo: 'estudo_geral'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log(`‚úÖ Tempo salvo: ${this.tempoDecorrido} segundos`);
                    
                    // Atualizar display do tempo total
                    if (this.tempoEstudoDisplay && data.tempo_total_formatado) {
                        this.tempoEstudoDisplay.textContent = data.tempo_total_formatado;
                    }
                    
                    // Mostrar notifica√ß√£o
                    this.mostrarNotificacao(`+${this.formatarTempo(this.tempoDecorrido)} de estudo registrado!`);
                    
                    return true;
                }
            } catch (error) {
                console.error('Erro ao salvar tempo:', error);
            }
        }
        return false;
    }
    
    resetarTimer() {
        this.tempoInicio = null;
        this.tempoDecorrido = 0;
        
        this.btnIniciar.classList.remove('hidden');
        this.timerDisplay.classList.add('hidden');
        this.btnIniciar.classList.add('pulse-animation');
        
        document.getElementById('timer-minutes').textContent = '00';
        document.getElementById('timer-seconds').textContent = '00';
        
        console.log("‚è±Ô∏è Timer resetado");
    }
    
    formatarTempo(segundos) {
        const minutos = Math.floor(segundos / 60);
        const segs = segundos % 60;
        
        if (minutos > 0) {
            return `${minutos}min ${segs}s`;
        } else {
            return `${segs}s`;
        }
    }
    
    mostrarNotificacao(mensagem) {
        // Criar notifica√ß√£o simples
        const notificacao = document.createElement('div');
        notificacao.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
        notificacao.textContent = mensagem;
        
        document.body.appendChild(notificacao);
        
        // Remover ap√≥s 3 segundos
        setTimeout(() => {
            document.body.removeChild(notificacao);
        }, 3000);
    }
}

// Inicializar o timer quando a p√°gina carregar
document.addEventListener('DOMContentLoaded', function() {
    window.timerEstudo = new TimerEstudo();
    
    // Atualizar tempo de estudo a cada 30 segundos (opcional)
    setInterval(() => {
        if (window.timerEstudo.estaRodando) {
            console.log("üîÑ Atualizando tempo em background...");
        }
    }, 30000);
});

// Fun√ß√£o para testar o salvamento de tempo (apenas para desenvolvimento)
async function testarSalvamentoTempo() {
    try {
        const response = await fetch('/testar-tempo/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                segundos: 120  // 2 minutos de teste
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`Tempo de teste salvo! Total: ${data.tempo_atual} segundos`);
            location.reload();
        }
    } catch (error) {
        console.error('Erro no teste:', error);
    }
}
</script>
{% endblock %}