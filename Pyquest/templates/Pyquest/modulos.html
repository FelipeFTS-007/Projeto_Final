{% extends 'base.html' %}
{% load static %}

{% block title %}Módulos - {{ capitulo.titulo|default:"Fundamentos do Python" }}{% endblock %}

{% block extra_css %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
    
    .card-hover {
      transition: all 0.3s ease;
    }
    
    .card-hover:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.4);
    }
    
    .progress-bar-container {
      overflow: hidden;
      position: relative;
    }
    
    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #3B82F6 0%, #1E40AF 100%);
      border-radius: 9999px;
      transition: width 1.5s ease-in-out;
      width: 0%;
    }
    
    .module-card {
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .module-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.4);
    }
    
    .module-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, #3B82F6 0%, #1E40AF 100%);
    }
    
    .floating-element {
      animation: float 6s ease-in-out infinite;
    }
    
    @keyframes float {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
      100% { transform: translateY(0px); }
    }
    
    .pulse-animation {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    .circular-chart {
      display: block;
      max-width: 100%;
      max-height: 100%;
    }
    
    .circle-bg {
      fill: none;
      stroke: #EFF6FF;
      stroke-width: 3.8;
    }
    
    .circle {
      fill: none;
      stroke-width: 2.8;
      stroke-linecap: round;
      stroke: #3B82F6;
      animation: progress 1.5s ease-out forwards;
    }
    
    @keyframes progress {
      0% { stroke-dasharray: 0 100; }
    }
    
    .percentage {
      fill: #1E40AF;
      font-size: 0.5em;
      text-anchor: middle;
      font-weight: bold;
    }

    /* Estilos para a descrição expansível dos módulos */
    .descricao-modulo-container {
      position: relative;
      margin-bottom: 1rem;
    }
    
    .descricao-modulo-resumida {
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      line-height: 1.4;
    }
    
    .descricao-modulo-completa {
      display: none;
      line-height: 1.4;
    }
    
    .descricao-modulo-expandir {
      color: #3B82F6;
      cursor: pointer;
      font-weight: 500;
      font-size: 0.8rem;
      display: inline-flex;
      align-items: center;
      margin-top: 8px;
      transition: color 0.2s ease;
    }
    
    .descricao-modulo-expandir:hover {
      color: #1E40AF;
      text-decoration: underline;
    }

    .stats-modulo {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border-radius: 12px;
      padding: 12px;
      margin-top: 12px;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Função para expandir/recolher a descrição dos módulos
    function toggleDescricaoModulo(button) {
        const container = button.closest('.descricao-modulo-container');
        const resumida = container.querySelector('.descricao-modulo-resumida');
        const completa = container.querySelector('.descricao-modulo-completa');
        
        if (resumida.style.display === 'none') {
            // Recolher
            resumida.style.display = '-webkit-box';
            completa.style.display = 'none';
            button.innerHTML = 'Mostrar Mais <img src="{% static "imagem/arrow_drop_down_16dp_2682EA_FILL0_wght400_GRAD0_opsz20.png" %}" alt="Expandir" class="w-4 h-4 ml-1">';
        } else {
            // Expandir
            resumida.style.display = 'none';
            completa.style.display = 'block';
            button.innerHTML = 'Mostrar Menos <img src="{% static "imagem/unfold_less_16dp_2682EA_FILL0_wght400_GRAD0_opsz20.png" %}" alt="Recolher" class="w-4 h-4 ml-1">';
        }
    }
    
    // Adicionar evento de clique a todos os botões de expandir dos módulos
    document.querySelectorAll('.descricao-modulo-expandir').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            toggleDescricaoModulo(this);
        });
    });
    
    // Verificar se a descrição dos módulos precisa ser truncada
    document.querySelectorAll('.descricao-modulo-container').forEach(container => {
        const textoCompleto = container.querySelector('.descricao-modulo-completa').textContent;
        
        // Se o texto tiver mais de 20 palavras, mostra o botão de expandir
        const palavras = textoCompleto.trim().split(/\s+/).length;
        if (palavras > 20) {
            container.querySelector('.descricao-modulo-expandir').style.display = 'inline-flex';
        }
    });
});
</script>
{% endblock %}

{% block content %}
<!-- BOTÃO VOLTAR FIXO NO TOPO -->
<div class="mb-6">
  <a href="{% url 'conteudo' %}" class="text-blue-600 font-semibold hover:text-blue-800 flex items-center gap-2 transition-colors">
    <img src="{% static 'imagem/arrow_back_35dp_2682EA_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Voltar" class="w-5 h-5">
    <span class="text-sm">Voltar aos capítulos</span>
  </a>
</div>

<!-- BANNER DO CAPÍTULO -->
<div class="bg-gradient-to-r from-blue-600 to-blue-800 text-white rounded-2xl p-6 mb-6 flex flex-col md:flex-row md:justify-between md:items-center gap-6 shadow-lg relative overflow-hidden">
  <div class="flex items-center gap-6 z-10">
    <img src="{% static 'imagem/rocket_launch_100dp_FFFFFF_FILL0_wght400_GRAD0_opsz48.png' %}" alt="Python" class="w-16 h-16 floating-element">
    <div>
      <h2 class="text-2xl font-bold">{{ capitulo.titulo|default:"Fundamentos do Python" }}</h2>
      <p class="text-sm text-blue-100">{{ capitulo.descricao|default:"Aprenda os Conceitos Básicos e essenciais da linguagem Python" }}</p>
    </div>
  </div>
  
  <!-- Elementos decorativos de fundo -->
  <div class="absolute top-0 left-0 w-full h-full overflow-hidden opacity-10">
    <div class="absolute -top-4 -left-4 w-24 h-24 rounded-full bg-white"></div>
    <div class="absolute top-10 right-20 w-16 h-16 rounded-full bg-white"></div>
    <div class="absolute bottom-5 left-20 w-12 h-12 rounded-full bg-white"></div>
  </div>
</div>

<!-- PROGRESSO DO CAPÍTULO DINÂMICO -->
<div class="bg-gradient-to-br from-white to-blue-50 border border-blue-100 rounded-2xl p-6 mb-6 shadow-md">
  <div class="flex justify-between items-center mb-4">
    <span class="font-bold text-blue-800">Progresso do Capítulo</span>
    <span class="font-bold text-blue-600">{{ progresso_capitulo }}%</span>
  </div>
  <div class="w-full bg-blue-200 rounded-full h-3 mb-2 progress-bar-container">
    <div class="progress-bar-fill" style="width: {{ progresso_capitulo }}%"></div>
  </div>
  <div class="text-xs text-blue-600 flex justify-between">
    <span>{{ modulos_concluidos_capitulo }} de {{ total_modulos_capitulo }} módulos concluídos</span>
    <span>{{ xp_total_capitulo }} XP Total</span>
  </div>
</div>

<!-- DICA DE ESTUDO -->
<div class="bg-gradient-to-r from-blue-100 to-blue-50 border-l-4 border-blue-500 text-blue-700 text-sm rounded-r-xl p-4 mb-6 shadow flex items-start">
  <img src="{% static 'imagem/lightbulb_2_100dp_2682EA_FILL0_wght400_GRAD0_opsz48.png' %}" alt="Dica" class="w-6 h-6 mr-3 flex-shrink-0">
  <div>
    <p class="font-semibold">Dica de Estudo</p>
    <p>Complete os módulos em ordem sequencial para um aprendizado mais eficiente. Cada módulo concluído desbloqueia novos conceitos!</p>
  </div>
</div>

<!-- CARDS DE MÓDULOS COM DADOS DINÂMICOS -->
<div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
  {% for mod_stat in modulos_com_stats %}
  <!-- Módulo {{ forloop.counter }} -->
  <div class="module-card bg-gradient-to-b from-white to-blue-50 border border-blue-200 rounded-2xl shadow-lg overflow-hidden h-full flex flex-col">
    <div class="w-full h-2 bg-blue-600"></div>
    <div class="p-6 flex-1 flex flex-col">
      <div class="flex items-center gap-4 mb-4">
        <div class="bg-blue-100 p-3 rounded-xl flex-shrink-0">
          <!-- Ícone dinâmico baseado no módulo -->
          {% if forloop.counter == 1 %}
          <img src="{% static 'imagem/python1.png' %}" alt="Introdução" class="w-10 h-10">
          {% elif forloop.counter == 2 %}
          <img src="{% static 'imagem/variaveis2.png' %}" alt="Variáveis" class="w-10 h-10">
          {% else %}
          <img src="{% static 'imagem/calculate_100dp_2682EA_FILL0_wght400_GRAD0_opsz48.png' %}" alt="Operadores" class="w-10 h-10">
          {% endif %}
        </div>
        <h3 class="font-bold text-blue-800 text-lg leading-tight">{{ mod_stat.modulo.titulo }}</h3>
      </div>
      
      <!-- Descrição com botão "Mostrar Mais" -->
      <div class="descricao-modulo-container flex-1">
        <p class="text-sm text-blue-700 mb-2 descricao-modulo-resumida">{{ mod_stat.modulo.descricao }}</p>
        <p class="text-sm text-blue-700 mb-2 descricao-modulo-completa">{{ mod_stat.modulo.descricao }}</p>
        <button class="descricao-modulo-expandir" style="display: none;">
          Mostrar Mais <img src="{% static 'imagem/arrow_drop_down_16dp_2682EA_FILL0_wght400_GRAD0_opsz20.png' %}" alt="Expandir" class="w-4 h-4 ml-1">
        </button>
      </div>

      <!-- Estatísticas do Módulo DINÂMICAS -->
      <div class="stats-modulo mt-auto">
        <!-- Barra de progresso dinâmica CORRIGIDA -->
        <div class="w-full bg-blue-200 h-2 rounded-full mb-3 progress-bar-container">
          <div class="progress-bar-fill" style="width: {{ mod_stat.progresso_percentual }}%"></div>
        </div>
        
        <div class="flex justify-between text-xs text-blue-700 mb-2">
          <span class="font-medium">
            {{ mod_stat.aulas_concluidas }}/{{ mod_stat.total_aulas }} lições
          </span>
          <span class="font-bold">
            {{ mod_stat.xp_total }} XP
          </span>
        </div>
        
        <!-- Status do módulo dinâmico -->
        <div class="flex justify-between items-center mt-2">
          <div class="text-xs text-blue-800 flex items-center font-semibold">
            {% if mod_stat.progresso_percentual == 100 %}
            <span class="mr-1">Concluído</span>
            <img src="{% static 'imagem/check_small_100dp_2682EA_FILL0_wght400_GRAD0_opsz48.png' %}" alt="Concluído" class="w-4 h-4">
            {% elif mod_stat.progresso_percentual > 0 %}
            <span class="mr-1">Em progresso</span>
            <img src="{% static 'imagem/hourglass_100dp_2682EA_FILL0_wght400_GRAD0_opsz48.png' %}" alt="Em progresso" class="w-4 h-4">
            {% else %}
            <span class="mr-1">Não iniciado</span>
            <img src="{% static 'imagem/play_circle_16dp_2682EA_FILL0_wght400_GRAD0_opsz20.png' %}" alt="Não iniciado" class="w-4 h-4">
            {% endif %}
          </div>
          
          <!-- Tempo estimado -->
          <span class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded-full font-medium">
            {% if mod_stat.tempo_total_modulo %}
              {{ mod_stat.tempo_total_modulo }}min
            {% else %}
              0min
            {% endif %}
          </span>
        </div>
      </div>
    </div>
  </div>
  {% empty %}
  <!-- Mensagem quando não há módulos -->
  <div class="col-span-3 text-center py-12">
    <img src="{% static 'imagem/code_blocks_100dp_2682EA_FILL0_wght400_GRAD0_opsz48.png' %}" alt="Sem módulos" class="w-24 h-24 mx-auto mb-4 opacity-50">
    <h3 class="text-xl font-bold text-blue-700 mb-2">Nenhum módulo disponível</h3>
    <p class="text-blue-600 mb-4">Este capítulo ainda não possui módulos configurados.</p>
    {% if user.groups.filter.name == 'professores' or user.is_staff %}
    <a href="{% url 'criar_conteudo' %}" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
      Criar Primeiro Módulo
    </a>
    {% endif %}
  </div>
  {% endfor %}
</div>

<!-- BOTÃO DE CONTINUAR ESTUDANDO -->
<div class="mt-8 flex justify-center">
  <a href="#" class="bg-gradient-to-r from-blue-600 to-blue-800 text-white px-8 py-3 rounded-2xl font-semibold text-lg hover:from-blue-700 hover:to-blue-900 transition transform hover:scale-105 shadow-lg flex items-center pulse-animation">
    Continuar Estudando
    <img src="{% static 'imagem/arrow_forward_35dp_FFFFFF_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Continuar" class="w-5 h-5 ml-2">
  </a>
</div>

<script>
   // Marcar o item de conteúdo como ativo
  document.addEventListener('DOMContentLoaded', function() {
    // Encontrar o link de conteúdo na sidebar
    const conteudoLink = document.getElementById('nav-conteudo');
    
    // Adicionar a classe ativa ao link de conteúdo
    if (conteudoLink) {
      conteudoLink.classList.add('bg-blue-500', 'text-white');
      
      // Atualizar o ícone para a versão branca
      const conteudoIcon = conteudoLink.querySelector('.nav-icon');
      if (conteudoIcon) {
        const whiteIcon = conteudoIcon.getAttribute('data-white');
        if (whiteIcon) {
          conteudoIcon.src = whiteIcon;
        }
      }
    }
  });
</script>
{% endblock %}