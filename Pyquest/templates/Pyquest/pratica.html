{% extends "base.html" %}
{% load static %}

{% block title %}Pr√°tica - {{ aula.titulo_pratica|default:aula.titulo_aula }}{% endblock %}

{% block extra_css %}
<style>
    /* ‚úÖ CORRE√á√ÉO DEFINITIVA - PRESERVA√á√ÉO TOTAL DE ESPA√áOS */
    .fill-blank-container {
        white-space: pre-wrap !important;
        word-wrap: break-word !important;
        font-family: inherit !important;
        line-height: 1.6 !important;
        background: transparent !important;
        border: none !important;
        padding: 15px !important;
        margin: 0 !important;
        display: block !important;
    }

    /* ‚úÖ LINHAS DE TEXTO COM FORMATA√á√ÉO EXATA */
    .text-line {
        margin: 4px 0;
        line-height: 1.6;
        min-height: 1.6em;
        white-space: pre;
        font-family: inherit;
        display: block;
    }

    .preserve-spaces {
        white-space: pre;
        display: inline;
        font-family: inherit;
    }

    .empty-line {
        height: 1.6em;
        margin: 4px 0;
        display: block;
    }

    /* ‚úÖ REMOVER ESTILOS PADR√ÉO QUE ATRAPALHAM */
    .fill-blank-container pre {
        background: transparent !important;
        border: none !important;
        padding: 0 !important;
        margin: 0 !important;
        font-family: inherit !important;
        white-space: pre-wrap !important;
    }

    /* ‚úÖ LACUNAS MAIS COMPACTAS */
    .blank-input {
        border-bottom: 2px solid #3B82F6;
        text-align: center;
        padding: 2px 4px !important;
        margin: 0 4px !important;
        background: transparent;
        outline: none;
        min-width: 80px !important;
        max-width: 120px !important;
        font-weight: 500;
        display: inline-block;
        vertical-align: baseline;
        font-family: inherit;
        font-size: 14px;
        border-radius: 3px;
        height: 24px !important;
        line-height: 1;
        transition: all 0.3s ease;
    }
    /* ‚úÖ ESTILOS MELHORADOS PARA LACUNAS */
    .blank-input {
        border-bottom: 2px solid #3B82F6;
        text-align: center;
        padding: 2px 4px !important;
        margin: 0 2px !important;
        background: transparent;
        outline: none;
        min-width: 70px !important;
        max-width: 100px !important;
        font-weight: 500;
        display: inline-block;
        vertical-align: middle;
        font-family: inherit;
        font-size: 14px;
        border-radius: 3px;
        height: 22px !important;
        line-height: 1;
        transition: all 0.3s ease;
    }

    .blank-input:focus {
        border-color: #1E40AF;
        background: #f0f9ff;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }

    .blank-input.filled {
        background: #f0f9ff !important;
        border-color: #10b981 !important;
        color: #047857 !important;
        font-weight: 600;
    }

    .blank-input.shake {
        border-color: #ef4444 !important;
        background: #fef2f2 !important;
    }

    /* Container de texto com lacunas */
    .fill-blank-container {
        white-space: pre-wrap;
        word-wrap: break-word;
        line-height: 1.6 !important;
        font-family: inherit;
        font-size: 15px;
        letter-spacing: normal;
        word-spacing: normal;
    }
    
    /* ‚úÖ SISTEMA DE VIDAS DISCRETO */
    .lives-container {
        display: flex;
        align-items: center;
        gap: 8px;
        background: #fef2f2;
        padding: 8px 12px;
        border-radius: 12px;
        border: 1px solid #fecaca;
    }
    
    .life-indicator {
        width: 24px;
        height: 24px;
        transition: all 0.3s ease;
    }
    
    .life-lost {
        animation: lifeLost 0.5s ease-in-out;
    }
    
    @keyframes lifeLost {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.3); opacity: 0.7; }
        100% { transform: scale(1); opacity: 1; }
    }

    /* MENSAGEM DE PERDA DE VIDA */
    .life-lost-message {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #ef4444;
        color: white;
        padding: 12px 16px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        z-index: 10000;
        display: flex;
        align-items: center;
        gap: 8px;
        animation: slideInRight 0.5s ease-out;
    }
    
    @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    .life-lost-message.fade-out {
        animation: slideOutRight 0.5s ease-in forwards;
    }
    
    @keyframes slideOutRight {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }

    /* ESTILOS OTIMIZADOS E FLUIDOS */
    .fade-in {
        animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .slide-in {
        animation: slideIn 0.4s ease-out;
    }
    
    @keyframes slideIn {
        from { opacity: 0; transform: translateX(30px); }
        to { opacity: 1; transform: translateX(0); }
    }
    
    .bounce-in {
        animation: bounceIn 0.6s ease-out;
    }
    
    @keyframes bounceIn {
        0% { transform: scale(0.3); opacity: 0; }
        50% { transform: scale(1.05); opacity: 1; }
        70% { transform: scale(0.95); }
        100% { transform: scale(1); opacity: 1; }
    }
    
    .shake {
        animation: shake 0.5s ease-in-out;
    }
    
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-8px); }
        75% { transform: translateX(8px); }
    }
    
    /* Sistema de dicas */
    .hint-container {
        display: none;
        background-color: #f0f9ff;
        border-left: 4px solid #3B82F6;
        padding: 1rem;
        margin-top: 1rem;
        border-radius: 0.5rem;
    }
    
    .hint-container.active {
        display: block;
    }
    
    .blank-filled {
        background: #f0f9ff;
        border-color: #3B82F6;
        color: #1E40AF;
        font-weight: 600;
    }
    
    .code-output {
        font-family: 'Courier New', monospace;
        font-size: 14px;
        line-height: 1.4;
        white-space: pre-wrap;
        background: #0f172a;
        color: #10b981;
        padding: 1rem;
        border-radius: 0.5rem;
        border: 1px solid #1e293b;
    }
    
    .option-button {
        transition: all 0.3s ease;
        border: 2px solid #e2e8f0;
    }
    
    .option-button:hover {
        border-color: #3B82F6;
        transform: translateY(-2px);
    }
    
    .option-button.selected {
        border-color: #3B82F6;
        background: #f0f9ff;
    }
    
    .feedback-message {
        padding: 1rem;
        border-radius: 0.5rem;
        margin: 1rem 0;
        font-weight: 600;
        text-align: center;
    }
    
    .feedback-correct {
        background-color: #f0f9ff;
        color: #1E40AF;
        border: 2px solid #3B82F6;
    }
    
    .feedback-incorrect {
        background-color: #fef2f2;
        color: #dc2626;
        border: 2px solid #fecaca;
    }
    
    /* Bot√£o voltar */
    .back-button {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background: white;
        border: 1px solid #CBD5E1;
        border-radius: 0.75rem;
        padding: 0.75rem 1.25rem;
        font-size: 0.875rem;
        font-weight: 500;
        color: #64748B;
        transition: all 0.3s ease;
        margin-bottom: 2rem;
    }
    
    .back-button:hover {
        border-color: var(--primary-blue);
        color: var(--primary-blue);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
    }
    
    /* Progresso da pr√°tica */
    .practice-progress {
        height: 6px;
        background: #e5e7eb;
        border-radius: 3px;
        overflow: hidden;
        margin: 1rem 0;
    }
    
    .practice-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #3B82F6, #1E40AF);
        transition: width 0.5s ease;
    }
    
    /* Indicador de quest√µes */
    .questions-indicator {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin: 1rem 0;
    }
    
    .question-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #e5e7eb;
        transition: all 0.3s ease;
    }
    
    .question-dot.answered {
        background: #10b981;
    }
    
    .question-dot.current {
        background: #3B82F6;
        transform: scale(1.2);
    }
    
    .question-dot.pending {
        background: #f59e0b;
    }
    
    /* EDITOR DE C√ìDIGO */
    .code-editor-container {
        position: relative;
        border: 1px solid #334155;
        border-radius: 0.5rem;
        overflow: hidden;
        margin: 1rem 0;
        background: #0f172a;
    }
    
    .editor-header {
        background: #1e293b;
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #334155;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .editor-title {
        color: #e2e8f0;
        font-size: 0.875rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .editor-actions {
        display: flex;
        gap: 0.5rem;
    }
    
    .editor-btn {
        background: #374151;
        border: 1px solid #4b5563;
        color: #e2e8f0;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .editor-btn:hover {
        background: #4b5563;
        border-color: #6b7280;
    }
    
    .editor-btn.primary {
        background: #3B82F6;
        border-color: #2563eb;
    }
    
    .editor-btn.primary:hover {
        background: #2563eb;
    }
    
    .editor-content {
        position: relative;
        display: flex;
        min-height: 300px;
    }
    
    .editor-line-numbers {
        background: #1e293b;
        color: #64748b;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        line-height: 1.5;
        padding: 1rem 0.5rem;
        text-align: right;
        border-right: 1px solid #334155;
        user-select: none;
        min-width: 50px;
        overflow: hidden;
    }
    
    .line-number {
        height: 21px;
        display: block;
    }
    
    .code-textarea {
        flex: 1;
        background: #0f172a;
        color: #e2e8f0;
        border: none;
        padding: 1rem;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        line-height: 1.5;
        resize: none;
        outline: none;
        tab-size: 4;
        white-space: pre;
        overflow-wrap: normal;
        overflow: auto;
    }
    
    .code-textarea:focus {
        box-shadow: none;
    }
    
    /* Terminal de sa√≠da */
    .terminal {
        background: #0f172a;
        border: 1px solid #334155;
        border-radius: 0.5rem;
        margin-top: 1rem;
        overflow: hidden;
    }
    
    .terminal-header {
        background: #1e293b;
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #334155;
        color: #e2e8f0;
        font-size: 0.875rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .terminal-content {
        padding: 1rem;
        color: #10b981;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        line-height: 1.4;
        white-space: pre-wrap;
        min-height: 60px;
        max-height: 300px;
        overflow-y: auto;
    }
    
    .terminal-content.error {
        color: #ef4444;
    }
    
    .question-container {
        display: none;
    }
    
    .question-container.active {
        display: block;
        animation: slideIn 0.4s ease-out;
    }

    /* Loading do Pyodide */
    .pyodide-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 1rem;
        color: #6b7280;
    }
    
    .spinner {
        border: 2px solid #f3f4f6;
        border-top: 2px solid #3b82f6;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        animation: spin 1s linear infinite;
    }

    /* ‚úÖ CONTAINER COM ESPA√áOS COMPACTOS */
    .fill-blank-container {
        white-space: pre-wrap;
        word-wrap: break-word;
        line-height: 1.4 !important;
        font-family: inherit;
        font-size: 14px;
        letter-spacing: -0.2px;
        word-spacing: -0.5px;
    }

    /* ‚úÖ ESPA√áOS ENTRE PAR√ÅGRAFOS MENORES */
    .fill-blank-container br {
        line-height: 0.8 !important;
        margin-bottom: 2px !important;
    }

    .blank-input:focus {
        border-color: #1E40AF;
        background: #f0f9ff;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }

    .blank-input.filled {
        background: #f0f9ff !important;
        border-color: #3B82F6 !important;
        color: #1E40AF !important;
    }

    /* ‚úÖ BOT√ÉO DE FINALIZAR REVIS√ÉO SEMPRE VIS√çVEL */
    .finalizar-revisao-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: linear-gradient(135deg, #8B5CF6, #7C3AED);
        color: white;
        border: none;
        border-radius: 50px;
        padding: 12px 24px;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        z-index: 1000;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
    }

    .finalizar-revisao-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(139, 92, 246, 0.4);
    }

    /* ‚úÖ MENSAGEM DE FEEDBACK NEUTRA */
    .feedback-neutral {
        background: #f0f9ff;
        color: #1E40AF;
        border: 2px solid #3B82F6;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* ‚úÖ CORRE√á√ÉO DEFINITIVA - PRESERVA√á√ÉO TOTAL DE ESPA√áOS */
    .fill-blank-container {
        white-space: pre-wrap !important;
        word-wrap: break-word !important;
        font-family: inherit !important;
        line-height: 1.4 !important;
        background: transparent !important;
        border: none !important;
        padding: 0 !important;
        margin: 0 !important;
        display: block !important;
    }

    /* ‚úÖ REMOVER ESTILOS PADR√ÉO DO PRE QUE ATRAPALHAM */
    .fill-blank-container pre {
        background: transparent !important;
        border: none !important;
        padding: 0 !important;
        margin: 0 !important;
        font-family: inherit !important;
        white-space: pre-wrap !important;
    }

    /* ‚úÖ GARANTIR FORMATA√á√ÉO EXATA */
    .text-line {
        margin: 2px 0;
        line-height: 1.4;
        min-height: 1.4em;
        white-space: pre;
        font-family: monospace;
    }

    .preserve-spaces {
        white-space: pre;
        display: inline;
    }

    .empty-line {
        height: 1.4em;
        margin: 2px 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6 fade-in">
    <!-- Topo: Bot√£o voltar + Cron√¥metro + VIDAS -->
    <div class="flex items-center justify-between border-b border-blue-100 pb-4">
        <!-- Bot√£o Voltar -->
        <a href="{% url 'tarefas' %}?modulo_id={{ aula.modulo.id }}" class="back-button">
            <img src="{% static 'imagem/arrow_back_20dp_64748B_FILL0_wght400_GRAD0_opsz20.png' %}" alt="Voltar" class="w-4 h-4">
            <span>Voltar as Tarefas</span>
        </a>

        <div class="flex items-center gap-4">
            <!-- Cron√¥metro -->
            <div class="flex items-center gap-3 bg-blue-100 text-blue-600 px-4 py-2 rounded-xl font-bold">
                <div class="relative w-8 h-8">
                    <svg class="progress-ring w-8 h-8" width="32" height="32">
                        <circle class="progress-ring__circle" stroke="#3B82F6" stroke-width="3" fill="transparent" r="14" cx="16" cy="16"
                            stroke-dasharray="88" stroke-dashoffset="52.8"></circle>
                    </svg>
                    <img src="{% static 'imagem/timer_100dp_2682EA_FILL0_wght400_GRAD0_opsz48.png' %}" alt="Tempo" class="w-4 h-4 absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2">
                </div>
                <span id="timer">00:00</span>
                <span class="text-xs">/ {{ aula.tempo_pratica }}:00</span>
            </div>
        </div>
    </div>

    <!-- Campos hidden para controle -->
    <input type="hidden" id="aula-id" value="{{ aula.id }}">
    <input type="hidden" id="pratica-concluida" value="{{ pratica_concluida|yesno:'true,false' }}">
    <input type="hidden" id="xp-revisao" value="5">

    <!-- Cabe√ßalho da Pr√°tica -->
    <div class="flex items-center justify-between">
        <div>
            <h2 class="text-2xl font-bold text-blue-600">{{ aula.titulo_pratica|default:aula.titulo_aula }}</h2>
            {% if pratica_concluida %}
            <div class="flex items-center gap-2 mt-2">
                <span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm font-semibold flex items-center gap-1">
                    Modo Revis√£o
                </span>
            </div>
            {% endif %}
        </div>
        
        <div class="flex gap-4">
            <div class="bg-blue-100 text-blue-600 px-3 py-1 rounded-xl text-sm font-bold flex items-center">
                <img src="{% static 'imagem/timer_100dp_2682EA_FILL0_wght400_GRAD0_opsz48.png' %}" alt="" class="h-5 w-5 mx-1"> {{ aula.tempo_pratica }} min
            </div>
            <div class="bg-blue-100 text-blue-600 px-3 py-1 rounded-xl text-sm font-bold flex items-center">
                +{{ aula.xp_pratica }} XP
            </div>
        </div>
    </div>

    <!-- Descri√ß√£o da Pr√°tica -->
    {% if aula.conteudo_pratico %}
    <div class="bg-gradient-to-br from-white to-blue-50 border border-blue-200 rounded-2xl p-6 shadow-lg">
        <h3 class="text-lg font-bold text-blue-600 mb-3 flex items-center gap-2">
            <img src="{% static 'imagem/description_35dp_2682EA_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Descri√ß√£o" class="w-5 h-5">
            Descri√ß√£o da Pr√°tica
        </h3>
        <p class="text-gray-700 leading-relaxed">
            {{ aula.conteudo_pratico }}
        </p>
    </div>
    {% endif %}

    <!-- Container Principal das Quest√µes -->
    <div id="questions-container" class="space-y-6">
        {% for questao in aula.questoes.all %}
        <div class="question-container {% if forloop.first %}active{% endif %}" data-question-id="{{ questao.id }}" data-question-type="{{ questao.tipo }}" data-question-number="{{ forloop.counter }}">
            <!-- Cabe√ßalho da Quest√£o -->
            <div class="bg-gradient-to-r from-blue-600 to-blue-800 text-white rounded-t-2xl p-6 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    {% if questao.tipo == 'multiple-choice' %}
                    <img src="{% static 'imagem/quiz_35dp_FFFFFF_FILL0_wght400_GRAD0_opsz40.png' %}" alt="M√∫ltipla Escolha" class="w-6 h-6">
                    {% elif questao.tipo == 'code' %}
                    <img src="{% static 'imagem/code_35dp_FFFFFF_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Programa√ß√£o" class="w-6 h-6">
                    {% elif questao.tipo == 'fill-blank' %}
                    <img src="{% static 'imagem/edit_35dp_FFFFFF_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Completar Lacunas" class="w-6 h-6">
                    {% endif %}
                    <div>
                        <h3 class="font-bold text-lg">Quest√£o {{ forloop.counter }}</h3>
                        <span class="text-sm text-blue-100">
                            {% if questao.tipo == 'multiple-choice' %}M√∫ltipla Escolha
                            {% elif questao.tipo == 'code' %}Programa√ß√£o
                            {% elif questao.tipo == 'fill-blank' %}Completar Lacunas
                            {% else %}{{ questao.tipo }}{% endif %}
                        </span>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <!-- Bot√£o de Dicas -->
                    <button class="hint-btn bg-blue-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-600 transition flex items-center gap-2"
                            data-question-id="{{ questao.id }}">
                        <img src="{% static 'imagem/lightbulb_35dp_FFFFFF_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Dicas" class="w-4 h-4">
                        Dicas
                        <span class="hint-counter bg-white text-blue-600 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold">{{ questao.dicas.count }}</span>
                    </button>
                    
                    <!-- XP da Quest√£o -->
                    <div class="bg-yellow-100 text-yellow-800 px-3 py-2 rounded-lg font-bold flex items-center gap-2">
                        +{{ questao.xp }} XP
                    </div>
                </div>
            </div>

            <!-- Conte√∫do da Quest√£o -->
            <div class="bg-white rounded-b-2xl p-6 border border-blue-200 border-t-0">
                {% if questao.descricao %}
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 rounded-r-lg">
                    <p class="text-blue-800 text-sm">{{ questao.descricao }}</p>
                </div>
                {% endif %}
                
                <!-- Container de Dicas -->
                <div class="hint-container mb-6" id="hints-{{ questao.id }}" style="display: none;">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-bold text-blue-800 flex items-center gap-2">
                            <img src="{% static 'imagem/lightbulb_35dp_2682EA_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Dicas" class="w-4 h-4">
                            Dicas Dispon√≠veis
                        </h4>
                        <span class="text-sm text-blue-600">{{ questao.dicas.count }} dica(s)</span>
                    </div>
                    
                    <div class="hints-list space-y-3">
                        {% for dica in questao.dicas.all %}
                        <div class="hint-step bg-blue-50 p-4 rounded-r-lg"
                            style="display: none;">
                            <div class="flex items-start gap-3">
                                <span class="bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold mt-1 flex-shrink-0">
                                    {{ forloop.counter }}
                                </span>
                                <div>
                                    <p class="text-blue-700">{{ dica.texto }}</p>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <p class="text-gray-500 text-center py-2">Nenhuma dica dispon√≠vel para esta quest√£o.</p>
                        {% endfor %}
                    </div>
                </div>

                <!-- Enunciado da Quest√£o -->
                <div class="mb-6">
                    <h4 class="font-bold text-gray-800 mb-3 text-lg">Enunciado:</h4>
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                        <p class="text-gray-700 whitespace-pre-wrap">{{ questao.enunciado }}</p>
                    </div>
                </div>

                <!-- Conte√∫do Espec√≠fico por Tipo -->
                {% if questao.tipo == 'multiple-choice' %}
                <!-- M√∫ltipla Escolha -->
                <div class="space-y-3">
                    <h4 class="font-bold text-gray-800 mb-3">Selecione a op√ß√£o correta:</h4>
                    <div class="grid gap-3">
                        {% for opcao in questao.opcoes.all %}
                        <button class="option-button bg-white border-2 border-gray-200 rounded-xl p-4 text-left hover:border-blue-400 transition-all"
                                data-option-id="{{ opcao.id }}" data-correct="{{ opcao.correta|yesno:'true,false' }}">
                            <div class="flex items-center gap-3">
                                <span class="bg-blue-100 text-blue-600 rounded-full w-8 h-8 flex items-center justify-center font-bold flex-shrink-0"
                                      data-index="{{ forloop.counter0 }}">
                                    {{ forloop.counter0|add:65|stringformat:"c" }}
                                </span>
                                <span class="text-gray-700">{{ opcao.texto }}</span>
                            </div>
                        </button>
                        {% empty %}
                        <p class="text-gray-500 text-center py-4">Nenhuma op√ß√£o dispon√≠vel.</p>
                        {% endfor %}
                    </div>
                </div>

                {% elif questao.tipo == 'code' %}
                <!-- EDITOR DE C√ìDIGO -->
                <div class="space-y-4">
                    <div id="saida-esperada-{{ questao.id }}" 
                         data-saida-esperada="{{ questao.saida_esperada|default:'' }}" 
                         style="display: none;">
                    </div>
                    
                    <div>
                        <h4 class="font-bold text-gray-800 mb-2">Escreva seu c√≥digo Python:</h4>
                        <div class="code-editor-container" id="editor-container-{{ questao.id }}">
                            <div class="editor-header">
                                <div class="editor-title">
                                    <img src="{% static 'imagem/code_35dp_FFFFFF_FILL0_wght400_GRAD0_opsz40.png' %}" alt="C√≥digo" class="w-4 h-4">
                                    main.py
                                </div>
                                <div class="editor-actions">
                                    <button class="editor-btn run-editor-code" data-question-id="{{ questao.id }}">
                                        <img src="{% static 'imagem/play_arrow_35dp_FFFFFF_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Executar" class="w-4 h-4">
                                        Executar
                                    </button>
                                    <button class="editor-btn primary check-editor-code" data-question-id="{{ questao.id }}">
                                        <img src="{% static 'imagem/check_circle_35dp_FFFFFF_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Verificar" class="w-4 h-4">
                                        Verificar
                                    </button>
                                </div>
                            </div>
                            <div class="editor-content">
                                <div class="editor-line-numbers" id="line-numbers-{{ questao.id }}">1</div>
                                <textarea class="code-textarea" id="code-input-{{ questao.id }}" 
                                          placeholder="Escreva seu c√≥digo Python aqui..." 
                                          spellcheck="false">{{ questao.codigo_inicial|default:"# Escreva seu c√≥digo aqui\n" }}</textarea>
                            </div>
                        </div>
                    </div>

                    <div class="terminal" id="terminal-{{ questao.id }}">
                        <div class="terminal-header">
                            <img src="{% static 'imagem/terminal_35dp_FFFFFF_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Terminal" class="w-4 h-4">
                            Sa√≠da do C√≥digo
                        </div>
                        <div class="terminal-content" id="code-output-{{ questao.id }}">
                            <div class="pyodide-loading">
                                <div class="spinner"></div>
                                <span>Carregando Python...</span>
                            </div>
                        </div>
                    </div>
                </div>

                {% elif questao.tipo == 'fill-blank' %}
                <!-- ‚úÖ CORRE√á√ÉO: Completar Lacunas - FORMATO EXATO DO BANCO -->
                <div class="space-y-4">
                    <h4 class="font-bold text-gray-800 mb-2">Complete as lacunas no texto abaixo:</h4>
                    
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-6">
                        <!-- ‚úÖ CORRE√á√ÉO CR√çTICA: DIV COM PRESERVA√á√ÉO PERFEITA -->
                        <div id="fill-blank-text-{{ questao.id }}" class="text-gray-700 fill-blank-container">
                            {{ questao.texto_com_lacunas|default:questao.enunciado }}
                        </div>
                    </div>

                    <div id="respostas-{{ questao.id }}" 
                        data-respostas='{{ questao.respostas_corretas|default:"[]" }}'
                        style="display: none;">
                    </div>

                    <button class="check-blank bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition flex items-center gap-2"
                            data-question-id="{{ questao.id }}">
                        Verificar Respostas
                    </button>
                </div>
                {% endif %}

                <!-- Feedback da Quest√£o -->
                <div id="feedback-{{ questao.id }}" class="feedback-message hidden mt-6"></div>
            </div>
        </div>
        {% empty %}
        <!-- Mensagem quando n√£o h√° quest√µes -->
        <div class="text-center py-12">
            <img src="{% static 'imagem/quiz_100dp_64748b_FILL0_wght400_GRAD0_opsz48.png' %}" alt="Sem quest√µes" class="w-24 h-24 mx-auto mb-4 opacity-50">
            <h3 class="text-xl font-bold text-gray-700 mb-2">Nenhum exerc√≠cio dispon√≠vel</h3>
            <p class="text-gray-500">Esta aula ainda n√£o possui exerc√≠cios pr√°ticos.</p>
            <a href="{% url 'tarefas' %}?modulo_id={{ aula.modulo.id }}" 
               class="inline-block mt-4 bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
                Voltar para Tarefas
            </a>
        </div>
        {% endfor %}
    </div>

    
    <!-- Tela de Resultados -->
    <div id="result-screen" class="hidden bg-gradient-to-br from-white to-green-50 rounded-2xl shadow-lg p-8 text-center space-y-6 border border-green-200">
        <div class="bg-gradient-to-r from-green-600 to-green-800 text-white rounded-t-2xl p-6 -m-8 mb-6">
            <h2 class="text-3xl font-bold flex items-center justify-center gap-3">
                <span>üéâ</span>
                Parab√©ns!
            </h2>
            <p class="mt-2 text-green-100">Voc√™ concluiu todos os exerc√≠cios!</p>
        </div>

        <!-- Resumo de Desempenho -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
            <div class="bg-white rounded-xl p-6 shadow-md">
                <div class="flex items-center justify-center gap-2 mb-3">
                    <img src="{% static 'imagem/auto_awesome_mosaic_35dp_10B981_FILL0_wght400_GRAD0_opsz40.png' %}" alt="XP" class="w-8 h-8">
                </div>
                <div class="text-2xl font-bold text-green-600 mb-2"><span id="final-xp">0</span> XP</div>
                <p class="text-sm text-gray-600">Total conquistado</p>
            </div>

            <div class="bg-white rounded-xl p-6 shadow-md">
                <div class="flex items-center justify-center gap-2 mb-3">
                    <img src="{% static 'imagem/timer_35dp_10B981_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Tempo" class="w-8 h-8">
                </div>
                <div class="text-2xl font-bold text-green-600 mb-2"><span id="final-time">00:00</span></div>
                <p class="text-sm text-gray-600">Tempo total</p>
            </div>

            <div class="bg-white rounded-xl p-6 shadow-md">
                <div class="flex items-center justify-center gap-2 mb-3">
                    <img src="{% static 'imagem/bolt_35dp_10B981_FILL0_wght400_GRAD0_opsz40.png' %}" alt="B√¥nus" class="w-8 h-8">
                </div>
                <div class="text-2xl font-bold text-green-600 mb-2">+<span id="time-bonus">0</span> XP</div>
                <p class="text-sm text-gray-600">B√¥nus por tempo</p>
            </div>
        </div>

        {% if pratica_concluida %}
        <div class="bg-purple-100 border border-purple-300 rounded-xl p-4 mt-4">
            <div class="flex items-center justify-center gap-2 mb-2">
                <img src="{% static 'imagem/refresh_35dp_8B5CF6_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Revis√£o" class="w-6 h-6">
                <span class="font-bold text-purple-800">B√¥nus de Revis√£o</span>
            </div>
            <div class="text-xl font-bold text-purple-600">+<span id="revisao-bonus">5</span> XP</div>
            <p class="text-sm text-purple-700">Por completar a revis√£o</p>
        </div>
        {% endif %}

        <!-- Bot√µes de A√ß√£o -->
        <div class="flex justify-center gap-4 mt-8">
            <button onclick="location.reload()"
                class="bg-gradient-to-r from-green-500 to-green-700 text-white px-8 py-3 rounded-xl shadow-lg hover:from-green-600 hover:to-green-800 transition transform hover:scale-105 font-bold flex items-center gap-2">
                Recome√ßar
            </button>

            <a href="{% url 'tarefas' %}?modulo_id={{ aula.modulo.id }}"
                class="bg-white text-green-600 border border-green-300 px-8 py-3 rounded-xl shadow-lg hover:bg-green-50 transition transform hover:scale-105 font-bold flex items-center gap-2">
                Voltar √†s Tarefas
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- ‚úÖ CARREGAR PYODIDE - PYTHON REAL NO NAVEGADOR -->
<script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
<script>
    // ===== SISTEMA DE LOOP DE QUEST√ïES COM VIDAS =====
    
    // Vari√°veis globais
    let questions = [];
    let currentQuestionIndex = 0;
    let totalQuestions = {{ aula.questoes.count }};
    let seconds = 0;
    let timerInterval;
    let totalXP = 0;
    let correctAnswers = 0;
    let usedHints = {};
    let isReviewMode = document.getElementById('pratica-concluida').value === 'true';
    
    // ‚úÖ SISTEMA DE VIDAS CORRIGIDO - USANDO PERFIL REAL
    let lives = {{ vidas_restantes }}; // Usando vidas reais do perfil
    let maxLives = {{ perfil.max_vidas }};
    
    // ‚úÖ SISTEMA DE CONTROLE CORRIGIDO
    let answeredCorrectly = new Set();
    let pendingQuestions = new Set();
    
    // ‚úÖ VARI√ÅVEL PARA PYODIDE
    let pyodide = null;
    let isPyodideLoaded = false;

    // ‚úÖ CONTROLE PARA EVITAR DUPLO REGISTRO NO MODO REVIS√ÉO
    let revisaoRegistrada = false;

    // ===== INICIALIZA√á√ÉO =====
    document.addEventListener('DOMContentLoaded', async function() {
        console.log("üéØ Iniciando sistema com vidas...");
        console.log(`üíì Vidas iniciais: ${lives}/${maxLives}`);

         // ‚úÖ VERIFICA√á√ÉO CR√çTICA: BLOQUEAR SE ESTIVER SEM VIDAS
        if (checkInitialLives()) {
            return; // Para a execu√ß√£o se estiver sem vidas
        }
        
        // ‚úÖ INICIALIZAR SISTEMA DE VIDAS
        initializeLivesSystem();
    
        
        // ‚úÖ INICIALIZAR SISTEMA DE VIDAS
        initializeLivesSystem();
        
        // ‚úÖ INICIALIZAR PYODIDE PRIMEIRO
        await initializePyodide();
        
        // Inicializar quest√µes
        initializeQuestions();
        initializeHints();
        initializeQuestionEvents();
        initializeCodeEditors();
        initializeFillBlankQuestions(); // ‚úÖ CORRE√á√ÉO: CHAMADA CORRETA
        startTimer();
        updateProgress();
        
        
        // ‚úÖ INICIALIZAR BOT√ÉO DE FINALIZAR REVIS√ÉO
        initializeFinalizarRevisao();
        
        console.log(`‚úÖ Sistema inicializado com ${totalQuestions} quest√µes e ${lives} vidas`);
        console.log(`üéØ Modo: ${isReviewMode ? 'REVIS√ÉO' : 'NORMAL'}`);
    });

    // ===== SISTEMA DE VIDAS CORRIGIDO =====
    function initializeLivesSystem() {
        // ‚úÖ MANTENHA O SISTEMA DE VIDAS FUNCIONANDO, MAS N√ÉO MOSTRE VISUALMENTE
        if (!isReviewMode) {
            const livesContainer = document.getElementById('lives-container');
            if (livesContainer) {
                livesContainer.style.display = 'none'; // ‚úÖ S√≥ esconde, n√£o remove a funcionalidade
            }
            // O sistema de vidas continua funcionando nos bastidores
            console.log(`üíì Sistema de vidas ativo (n√£o vis√≠vel): ${lives}/${maxLives}`);
        } else {
            // ‚úÖ NO MODO REVIS√ÉO, VIDAS ILIMITADAS
            lives = 999;
        }
    }

    function updateLivesDisplay() {
        // ‚úÖ MANTENHA A FUN√á√ÉO, MAS N√ÉO FA√áA NADA VISUALMENTE
        // O sistema ainda controla as vidas internamente
        if (isReviewMode) return;
        
        console.log(`üíì Vidas atualizadas: ${lives}/${maxLives} (n√£o vis√≠vel)`);
        
        // ‚úÖ ATUALIZAR HEADER SE EXISTIR (mantenha essa funcionalidade)
        const headerVidas = document.getElementById('vidas-count');
        if (headerVidas) {
            headerVidas.textContent = lives;
        }
    }

    // ‚úÖ FUN√á√ÉO PARA DEBOUNCE (evita m√∫ltiplas chamadas r√°pidas)
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // ‚úÖ APLICAR DEBOUNCE NAS CHAMADAS CR√çTICAS
    const debouncedLoseLife = debounce(loseLife, 300);

// ‚úÖ FUN√á√ÉO CORRIGIDA: PERDER VIDA COM VERIFICA√á√ÉO RIGOROSA
async function loseLife() {
    console.log("üíî Tentando perder vida...");
    
    if (isReviewMode) {
        console.log("üìù Modo revis√£o - n√£o perde vida");
        return false; // ‚úÖ NO MODO REVIS√ÉO N√ÉO PERDE VIDA
    }
    
    // ‚úÖ VERIFICA√á√ÉO CR√çTICA: Se j√° est√° com 0 vidas, BLOQUEIA imediatamente
    if (lives <= 0) {
        console.log("üíÄ BLOQUEADO: Usu√°rio j√° est√° sem vidas!");
        showNoLivesMessage();
        return true; // ‚úÖ RETORNA VERDADEIRO PARA BLOQUEAR
    }
    
    if (lives > 0) {
        lives--;
        console.log(`üíî Vida perdida! Vidas restantes: ${lives}`);
        updateLivesDisplay();
        
        // ‚úÖ MOSTRAR MENSAGEM DE PERDA DE VIDA
        showLifeLostMessage();
        
        // ‚úÖ ENVIAR PARA BACKEND
        try {
            const aulaId = document.getElementById('aula-id').value;
            const response = await fetch("{% url 'api_usar_vida' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    aula_id: aulaId
                })
            });

            const data = await response.json();
            
            if (data.success) {
                console.log("‚úÖ Vida registrada no backend");
            } else {
                console.error('‚ùå Erro ao usar vida no backend:', data.error);
            }
        } catch (error) {
            console.error('‚ùå Erro na requisi√ß√£o de vida:', error);
        }
        
        // ‚úÖ VERIFICAR SE ACABARAM AS VIDAS
        if (lives === 0) {
            console.log("üíÄ Todas as vidas acabaram! Finalizando pr√°tica...");
            showNoLivesMessage();
            setTimeout(() => {
                finishPractice();
            }, 3000);
            return true; // ‚úÖ RETORNA VERDADEIRO QUANDO ACABARAM AS VIDAS
        }
        
        return false; // ‚úÖ RETORNA FALSO QUANDO AINDA H√Å VIDAS
    }
    
    console.log("üíÄ Sem vidas dispon√≠veis");
    return true; // ‚úÖ RETORNA VERDADEIRO SE J√Å ESTAVA SEM VIDAS
}

// ‚úÖ FUN√á√ÉO PARA MOSTRAR MENSAGEM DE SEM VIDAS
function showNoLivesMessage() {
    // Remover mensagem anterior se existir
    const existingMessage = document.querySelector('.life-lost-message');
    if (existingMessage) {
        existingMessage.remove();
    }
    
    // Criar mensagem de SEM VIDAS
    const message = document.createElement('div');
    message.className = 'life-lost-message';
    message.style.background = '#dc2626'; // Vermelho mais forte
    message.innerHTML = `
        <img src="{% static 'imagem/block_20dp_FFFFFF_FILL0_wght400_GRAD0_opsz20.png' %}" alt="Bloqueado" class="w-5 h-5">
        <span><strong>SEM VIDAS!</strong> Aguarde a regenera√ß√£o ou volte amanh√£.</span>
    `;
    
    document.body.appendChild(message);
    
    // Remover mensagem ap√≥s 5 segundos
    setTimeout(() => {
        message.classList.add('fade-out');
        setTimeout(() => {
            if (message.parentNode) {
                message.parentNode.removeChild(message);
            }
        }, 500);
    }, 5000);
}

// ‚úÖ VERIFICA√á√ÉO INICIAL DE VIDAS - BLOQUEIA SE ESTIVER SEM VIDAS
function checkInitialLives() {
    if (!isReviewMode && lives <= 0) {
        console.log("üö´ BLOQUEADO: Usu√°rio iniciou pr√°tica sem vidas!");
        
        // Desabilitar todos os bot√µes de verifica√ß√£o
        document.querySelectorAll('.check-blank, .check-editor-code, .option-button').forEach(btn => {
            btn.disabled = true;
            btn.style.opacity = '0.5';
            btn.style.cursor = 'not-allowed';
        });
        
        // Mostrar mensagem de bloqueio
        showNoLivesMessage();
        
        // Adicionar overlay bloqueador
        const overlay = document.createElement('div');
        overlay.style.position = 'fixed';
        overlay.style.top = '0';
        overlay.style.left = '0';
        overlay.style.width = '100%';
        overlay.style.height = '100%';
        overlay.style.background = 'rgba(0,0,0,0.5)';
        overlay.style.zIndex = '9998';
        overlay.style.display = 'flex';
        overlay.style.alignItems = 'center';
        overlay.style.justifyContent = 'center';
        overlay.style.color = 'white';
        overlay.style.fontSize = '24px';
        overlay.style.fontWeight = 'bold';
        overlay.innerHTML = 'SEM VIDAS DISPON√çVEIS';
        
        document.body.appendChild(overlay);
        
        return true;
    }
    return false;
}

    // ‚úÖ FUN√á√ÉO PARA MOSTRAR MENSAGEM DE PERDA DE VIDA
    function showLifeLostMessage() {
        // Remover mensagem anterior se existir
        const existingMessage = document.querySelector('.life-lost-message');
        if (existingMessage) {
            existingMessage.remove();
        }
        
        // Criar nova mensagem
        const message = document.createElement('div');
        message.className = 'life-lost-message';
        message.innerHTML = `
            <img src="{% static 'imagem/favorite_20dp_FFFFFF_FILL0_wght400_GRAD0_opsz20.png' %}" alt="Vida" class="w-5 h-5">
            <span>Voc√™ perdeu uma vida! ${lives} restante(s)</span>
        `;
        
        document.body.appendChild(message);
        
        // Remover mensagem ap√≥s 3 segundos
        setTimeout(() => {
            message.classList.add('fade-out');
            setTimeout(() => {
                if (message.parentNode) {
                    message.parentNode.removeChild(message);
                }
            }, 500);
        }, 3000);
    }

    // ===== INICIALIZAR BOT√ÉO FINALIZAR REVIS√ÉO =====
    function initializeFinalizarRevisao() {
        const finalizarBtn = document.getElementById('finalizar-revisao-btn');
        if (finalizarBtn) {
            finalizarBtn.addEventListener('click', function() {
                if (isReviewMode) {
                    finishPractice();
                }
            });
        }
    }

    // ===== INICIALIZAR PYODIDE =====
    async function initializePyodide() {
        console.log("üêç Iniciando Pyodide...");
        
        try {
            // Mostrar loading
            document.querySelectorAll('.terminal-content').forEach(terminal => {
                terminal.innerHTML = `
                    <div class="pyodide-loading">
                        <div class="spinner"></div>
                        <span>Carregando Python...</span>
                    </div>
                `;
            });
            
            // Carregar Pyodide
            pyodide = await loadPyodide({
                indexURL: "https://cdn.jsdelivr.net/pyodide/v0.23.4/full/"
            });
            
            // ‚úÖ Configurar input/output corretamente
            await pyodide.runPythonAsync(`
                import sys
                import io
                
                # Configurar captura de output
                output_capture = io.StringIO()
                sys.stdout = output_capture
                sys.stderr = output_capture
            `);
            
            isPyodideLoaded = true;
            console.log("‚úÖ Pyodide carregado com sucesso!");
            
            // Atualizar terminais
            document.querySelectorAll('.terminal-content').forEach(terminal => {
                terminal.innerHTML = '<div class="text-green-400">‚úÖ Python carregado! Digite seu c√≥digo e clique em "Executar".</div>';
            });
            
        } catch (error) {
            console.error("‚ùå Erro ao carregar Pyodide:", error);
            document.querySelectorAll('.terminal-content').forEach(terminal => {
                terminal.innerHTML = '<div class="text-red-400">‚ùå Erro ao carregar Python. Recarregue a p√°gina.</div>';
            });
        }
    }

    // ===== EXECUTAR C√ìDIGO PYTHON REAL =====
    async function runPythonCode(code) {
        if (!isPyodideLoaded || !pyodide) {
            throw new Error("Python n√£o est√° carregado ainda. Aguarde...");
        }
        
        try {
            console.log("üêç Executando c√≥digo Python...");
            
            // Configurar captura de output
            await pyodide.runPythonAsync(`
                import sys
                from io import StringIO
                sys.stdout = StringIO()
                sys.stderr = StringIO()
            `);
            
            // Executar c√≥digo do usu√°rio
            await pyodide.runPythonAsync(code);
            
            // Pegar o output
            const output = await pyodide.runPythonAsync(`
                output = sys.stdout.getvalue()
                error = sys.stderr.getvalue()
                
                # Restaurar stdout/stderr padr√£o
                sys.stdout = sys.__stdout__
                sys.stderr = sys.__stderr__
                
                # Retornar erro se houver, sen√£o output
                error if error else output
            `);
            
            // Se houve erro, lan√ßar exce√ß√£o
            if (output && (output.includes("Error") || output.includes("Traceback") || output.includes("SyntaxError"))) {
                throw new Error(output);
            }
            
            return output || "";
            
        } catch (error) {
            console.error("Erro no Python:", error);
            throw new Error(error.message || "Erro de execu√ß√£o");
        }
    }

    // ===== BUSCAR SA√çDA ESPERADA DA QUEST√ÉO =====
    function getExpectedOutputForQuestion(questionId) {
        console.log(`üîç Buscando sa√≠da esperada para quest√£o ${questionId}`);
        
        const questionElement = document.querySelector(`[data-question-id="${questionId}"]`);
        if (!questionElement) {
            console.error("Elemento da quest√£o n√£o encontrado");
            return "";
        }
        
        const saidaEsperadaElement = document.getElementById(`saida-esperada-${questionId}`);
        if (saidaEsperadaElement && saidaEsperadaElement.dataset.saidaEsperada) {
            const saida = saidaEsperadaElement.dataset.saidaEsperada.trim();
            console.log("‚úÖ Sa√≠da esperada encontrada em data-saida-esperada:", saida);
            return saida;
        }
        
        const enunciado = questionElement.querySelector('.bg-gray-50');
        if (enunciado) {
            const texto = enunciado.textContent;
            const patterns = [
                /sa√≠da esperada[:\s]*([^\n\.]+)/i,
                /output esperado[:\s]*([^\n\.]+)/i,
                /resultado esperado[:\s]*([^\n\.]+)/i,
                /deve imprimir[:\s]*([^\n\.]+)/i,
                /deve retornar[:\s]*([^\n\.]+)/i
            ];
            
            for (let pattern of patterns) {
                const match = texto.match(pattern);
                if (match && match[1]) {
                    const saida = match[1].trim();
                    console.log("‚úÖ Sa√≠da esperada extra√≠da do enunciado:", saida);
                    return saida;
                }
            }
        }
        
        console.warn("‚ö†Ô∏è Nenhuma sa√≠da esperada encontrada para a quest√£o");
        return "";
    }

    // ===== COMPARA√á√ÉO FLEX√çVEL DE SA√çDAS =====
    function areOutputsEqual(userOutput, expectedOutput) {
        if (!userOutput && !expectedOutput) return true;
        if (!userOutput || !expectedOutput) return false;
        
        const user = userOutput.toString().trim();
        const expected = expectedOutput.toString().trim();
        
        console.log(`üîç Comparando: "${user}" vs "${expected}"`);
        
        // 1. Compara√ß√£o exata
        if (user === expected) {
            console.log("‚úÖ Compara√ß√£o exata - CORRETO");
            return true;
        }
        
        // 2. Ignorar espa√ßos extras e quebras de linha
        const userClean = user.replace(/\s+/g, ' ').trim();
        const expectedClean = expected.replace(/\s+/g, ' ').trim();
        
        if (userClean === expectedClean) {
            console.log("‚úÖ Compara√ß√£o com espa√ßos normalizados - CORRETO");
            return true;
        }
        
        // 3. Case-insensitive para texto
        if (userClean.toLowerCase() === expectedClean.toLowerCase()) {
            console.log("‚úÖ Compara√ß√£o case-insensitive - CORRETO");
            return true;
        }
        
        // 4. Para n√∫meros
        const userNum = parseFloat(userClean);
        const expectedNum = parseFloat(expectedClean);
        
        if (!isNaN(userNum) && !isNaN(expectedNum)) {
            if (userNum === expectedNum) {
                console.log("‚úÖ Compara√ß√£o num√©rica - CORRETO");
                return true;
            }
        }
        
        console.log("‚ùå Sa√≠das diferentes - INCORRETO");
        return false;
    }

    // ===== SISTEMA DE QUEST√ïES EM LOOP CORRIGIDO =====
    function initializeQuestions() {
        document.querySelectorAll('.question-container').forEach(container => {
            const questionId = container.dataset.questionId;
            questions.push({
                id: questionId,
                element: container,
                answered: false,
                correct: false,
                xp: parseInt(container.querySelector('.bg-yellow-100').textContent.match(/\d+/)[0]) || 10
            });
            
            // ‚úÖ INICIALIZAR TODAS COMO PENDENTES
            pendingQuestions.add(questionId);
        });
        
        console.log(`‚úÖ ${questions.length} quest√µes inicializadas`);
        console.log(`üìù Quest√µes pendentes: ${pendingQuestions.size}`);
        
        showQuestion(currentQuestionIndex);
    }

    function showQuestion(index) {
        // Esconder todas as quest√µes
        document.querySelectorAll('.question-container').forEach(container => {
            container.classList.remove('active');
        });
        
        if (questions[index]) {
            const question = questions[index];
            
            // ‚úÖ CORRE√á√ÉO: REDEFINIR ESTADO DOS BOT√ïES AO MUDAR DE QUEST√ÉO
            const optionButtons = question.element.querySelectorAll('.option-button');
            optionButtons.forEach(btn => {
                btn.classList.remove('selected');
                btn.disabled = false;
            });
            
            // ‚úÖ LIMPAR FEEDBACK ANTERIOR
            const feedback = question.element.querySelector('.feedback-message');
            if (feedback) {
                feedback.classList.add('hidden');
                feedback.innerHTML = '';
            }
            
            question.element.classList.add('active');
            updateQuestionIndicator(index);
            scrollToTop();
        }
    }

    // ===== SISTEMA DE LOOP CORRIGIDO =====
    function nextQuestion(isCorrect) {
        const currentQuestion = questions[currentQuestionIndex];
        const questionId = currentQuestion.id;
        
        console.log(`üîÑ Pr√≥xima quest√£o - Correto: ${isCorrect}, ID: ${questionId}`);
        console.log(`üìä Status atual - Corretas: ${answeredCorrectly.size}, Pendentes: ${pendingQuestions.size}`);
        
        // ‚úÖ ATUALIZAR STATUS DA QUEST√ÉO ATUAL
        if (isCorrect) {
            // ‚úÖ VERIFICAR SE J√Å FOI CONTABILIZADA ANTES DE SOMAR XP
            const alreadyCounted = answeredCorrectly.has(questionId);
            
            if (!alreadyCounted) {
                // Resposta correta pela primeira vez: marca e soma XP
                answeredCorrectly.add(questionId);
                if (!isReviewMode) {
                    totalXP += currentQuestion.xp;
                }
                console.log(`‚úÖ Quest√£o ${currentQuestionIndex + 1} respondida corretamente ${!isReviewMode ? '- +' + currentQuestion.xp + ' XP' : ''}`);
            } else {
                // J√° foi contabilizada antes, n√£o soma XP novamente
                console.log(`üîÅ Quest√£o ${currentQuestionIndex + 1} j√° estava correta - XP n√£o duplicado`);
            }
            
            pendingQuestions.delete(questionId);
            currentQuestion.answered = true;
            currentQuestion.correct = true;
            
        } else {
            // Resposta incorreta: mant√©m na lista de pendentes
            currentQuestion.answered = false;
            currentQuestion.correct = false;
            pendingQuestions.add(questionId);
            
            console.log(`‚ùå Quest√£o ${currentQuestionIndex + 1} incorreta.`);
        }
    
        // ‚úÖ VERIFICAR SE TODAS FORAM RESPONDIDAS CORRETAMENTE
        if (answeredCorrectly.size === totalQuestions) {
            console.log("üéâ Todas as quest√µes respondidas corretamente!");
            if (!isReviewMode) {
                console.log(`üí∞ XP Total: ${totalXP}`);
            }
            finishPractice();
            return;
        }
        
        // ‚úÖ SEMPRE BUSCAR PR√ìXIMA QUEST√ÉO PENDENTE
        let nextIndex = findNextPendingQuestion();
        
        if (nextIndex === -1) {
            // Verificar se realmente n√£o h√° mais pendentes
            if (pendingQuestions.size === 0 && answeredCorrectly.size > 0) {
                console.log("üèÅ Todas as quest√µes foram respondidas corretamente!");
                finishPractice();
                return;
            } else {
                console.log("üîÑ Nenhuma pr√≥xima quest√£o encontrada, buscando primeira pendente");
                nextIndex = findFirstPendingQuestion();
            }
        }
        
        if (nextIndex === -1) {
            console.log("üíÄ Nenhuma quest√£o pendente encontrada - finalizando pr√°tica");
            finishPractice();
            return;
        }
        
        currentQuestionIndex = nextIndex;
        showQuestion(currentQuestionIndex);
        updateProgress();
        
        console.log(`‚û°Ô∏è Indo para quest√£o ${currentQuestionIndex + 1} (ID: ${questions[currentQuestionIndex].id})`);
        console.log(`üìä Progresso atualizado - Corretas: ${answeredCorrectly.size}/${totalQuestions}, Pendentes: ${pendingQuestions.size}`);
        if (!isReviewMode) {
            console.log(`üí∞ XP Acumulado: ${totalXP}`);
        }
        console.log('---');

        // ‚úÖ DEBUG: Verificar se est√° indo para pr√≥xima quest√£o
        console.log(`‚û°Ô∏è Indo para quest√£o ${currentQuestionIndex + 1} (ID: ${questions[currentQuestionIndex].id})`);
    }

    function findNextPendingQuestion() {
        console.log(`üîç Buscando pr√≥xima quest√£o pendente a partir da posi√ß√£o ${currentQuestionIndex + 1}`);
        
        // Buscar da posi√ß√£o atual + 1 at√© o final
        for (let i = currentQuestionIndex + 1; i < questions.length; i++) {
            const questionId = questions[i].id;
            if (pendingQuestions.has(questionId)) {
                console.log(`‚úÖ Encontrada quest√£o pendente na posi√ß√£o ${i + 1} (ID: ${questionId})`);
                return i;
            }
        }
        
        // Buscar do in√≠cio at√© a posi√ß√£o atual
        for (let i = 0; i < currentQuestionIndex; i++) {
            const questionId = questions[i].id;
            if (pendingQuestions.has(questionId)) {
                console.log(`‚úÖ Encontrada quest√£o pendente na posi√ß√£o ${i + 1} (ID: ${questionId})`);
                return i;
            }
        }
        
        console.log("‚ùå Nenhuma quest√£o pendente encontrada");
        return -1;
    }

    function findFirstPendingQuestion() {
        console.log("üîç Buscando primeira quest√£o pendente...");
        
        for (let i = 0; i < questions.length; i++) {
            const questionId = questions[i].id;
            if (pendingQuestions.has(questionId)) {
                console.log(`‚úÖ Primeira quest√£o pendente encontrada na posi√ß√£o ${i + 1} (ID: ${questionId})`);
                return i;
            }
        }
        
        console.log("‚ùå Nenhuma quest√£o pendente encontrada");
        return -1;
    }

    function updateProgress() {
        const progress = (answeredCorrectly.size / totalQuestions) * 100;
        document.getElementById('practice-progress-fill').style.width = `${progress}%`;
        document.getElementById('progress-text').textContent = `${answeredCorrectly.size}/${totalQuestions}`;
        updateQuestionIndicator(currentQuestionIndex);
    }
    
    function updateQuestionIndicator(currentIndex) {
        document.querySelectorAll('.question-dot').forEach((dot, index) => {
            dot.classList.remove('current', 'answered', 'pending');
            
            const questionId = questions[index]?.id;
            
            if (index === currentIndex) {
                dot.classList.add('current');
            } else if (answeredCorrectly.has(questionId)) {
                dot.classList.add('answered');
            } else if (pendingQuestions.has(questionId)) {
                dot.classList.add('pending');
            }
        });
    }

    // ===== EDITOR DE C√ìDIGO =====
    function initializeCodeEditors() {
        document.querySelectorAll('.code-textarea').forEach(textarea => {
            const questionId = textarea.id.replace('code-input-', '');
            setupCodeEditor(questionId);
        });
    }
    
    function setupCodeEditor(questionId) {
        const textarea = document.getElementById(`code-input-${questionId}`);
        const lineNumbers = document.getElementById(`line-numbers-${questionId}`);
        
        if (!textarea) return;
        
        updateLineNumbers(textarea, lineNumbers);
        
        textarea.addEventListener('input', () => {
            updateLineNumbers(textarea, lineNumbers);
        });
        
        textarea.addEventListener('scroll', () => {
            lineNumbers.scrollTop = textarea.scrollTop;
        });
        
        textarea.addEventListener('keydown', handleEditorKeydown);
        
        const runBtn = document.querySelector(`.run-editor-code[data-question-id="${questionId}"]`);
        const checkBtn = document.querySelector(`.check-editor-code[data-question-id="${questionId}"]`);
        
        if (runBtn) {
            runBtn.addEventListener('click', () => handleRunEditorCode(questionId));
        }
        
        if (checkBtn) {
            checkBtn.addEventListener('click', () => handleCheckEditorCode(questionId));
        }
    }
    
    function updateLineNumbers(textarea, lineNumbers) {
        const lines = textarea.value.split('\n').length;
        let numbersHTML = '';
        
        for (let i = 1; i <= lines; i++) {
            numbersHTML += `<div class="line-number">${i}</div>`;
        }
        
        lineNumbers.innerHTML = numbersHTML;
        lineNumbers.style.height = textarea.scrollHeight + 'px';
    }
    
    function handleEditorKeydown(e) {
        const textarea = e.target;
        
        if (e.key === 'Tab') {
            e.preventDefault();
            
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            
            textarea.value = textarea.value.substring(0, start) + '    ' + textarea.value.substring(end);
            textarea.selectionStart = textarea.selectionEnd = start + 4;
            
            const questionId = textarea.id.replace('code-input-', '');
            const lineNumbers = document.getElementById(`line-numbers-${questionId}`);
            updateLineNumbers(textarea, lineNumbers);
            
            return false;
        }
    }

    // ===== VERIFICA√á√ÉO DE C√ìDIGO EDITOR - CORRIGIDA =====
    async function handleCheckEditorCode(questionId) {
        console.log("=== üîß VERIFICA√á√ÉO DE C√ìDIGO INICIADA ===");

        // ‚úÖ VERIFICA√á√ÉO DE VIDAS ANTES DE QUALQUER A√á√ÉO
        if (!isReviewMode && lives <= 0) {
            showNoLivesMessage();
            return;
        }
        
        const textarea = document.getElementById(`code-input-${questionId}`);
        const terminal = document.getElementById(`code-output-${questionId}`);
        const questionContainer = document.querySelector(`[data-question-id="${questionId}"]`);
        
        if (!textarea || !terminal) {
            console.error("‚ùå Elementos n√£o encontrados");
            return;
        }
        
        const userCode = textarea.value.trim();
        console.log("üìù C√≥digo do usu√°rio:", userCode);
        
        if (!userCode) {
            showFeedback(questionId, 'incorrect', '‚ùå Digite algum c√≥digo antes de verificar', 0);
            return;
        }
        
        // ‚úÖ BUSCAR SA√çDA ESPERADA
        const expectedOutput = getExpectedOutputForQuestion(questionId);
        console.log("üéØ Sa√≠da esperada:", expectedOutput);
        
        const currentQuestion = questions.find(q => q.id === questionId);
        const xp = currentQuestion ? currentQuestion.xp : 10;
        
        // ‚úÖ EXECUTAR C√ìDIGO
        terminal.innerHTML = '<div class="text-yellow-400">üîß Executando c√≥digo...</div>';
        
        try {
            const output = await runPythonCode(userCode);
            const userOutput = output ? output.toString().trim() : "";
            console.log("üì§ Sa√≠da do usu√°rio:", userOutput);
            
            // ‚úÖ VERIFICAR SE EST√Å CORRETO
            let isCorrect = false;
            
            if (!expectedOutput || expectedOutput.trim() === "") {
                // Se n√£o h√° sa√≠da esperada, considera correto se executou sem erro
                isCorrect = true;
                console.log("‚úÖ Sem sa√≠da esperada - considerado correto");
            } else {
                // Compara√ß√£o flex√≠vel
                isCorrect = areOutputsEqual(userOutput, expectedOutput);
                console.log("üîç Compara√ß√£o:", isCorrect ? "CORRETO" : "INCORRETO");
            }
            
            if (isCorrect) {
                showFeedback(questionId, 'correct', '‚úÖ C√≥digo correto! Parab√©ns!', xp);
                terminal.innerHTML = `<div class="text-green-400">${userOutput || "‚úÖ Executado com sucesso!"}</div>`;
                
                setTimeout(() => {
                    nextQuestion(true);
                }, 1500);
            } else {
                // ‚úÖ CORRE√á√ÉO: PERDER VIDA NO MODO NORMAL (AGORA ATUALIZA BACKEND)
                if (!isReviewMode) {
                    await debouncedLoseLife();
                }
                
                showFeedback(questionId, 'incorrect', '‚ùå C√≥digo incorreto. Tente novamente.', 0);
                terminal.innerHTML = `<div class="text-red-400">
                    <strong>Sua sa√≠da:</strong> ${userOutput || "(nenhuma sa√≠da)"}
                    ${expectedOutput ? `\n<strong>Esperado:</strong> ${expectedOutput}` : ''}
                </div>`;
                
                setTimeout(() => {
                    nextQuestion(false);
                }, 2000);
            }
            
        } catch (error) {
            console.error("‚ùå Erro na execu√ß√£o:", error);
            
            // ‚úÖ CORRE√á√ÉO: PERDER VIDA NO MODO NORMAL (AGORA ATUALIZA BACKEND)
            if (!isReviewMode) {
                await debouncedLoseLife();
            }
            
            showFeedback(questionId, 'incorrect', '‚ùå Erro no c√≥digo. Verifique a sintaxe.', 0);
            terminal.innerHTML = `<div class="text-red-400">Erro: ${error.message}</div>`;
            
            setTimeout(() => {
                nextQuestion(false);
            }, 2000);
        }
        
        console.log("=== üîß VERIFICA√á√ÉO FINALIZADA ===");
    }

    // ===== EXECUTAR C√ìDIGO EDITOR =====
    async function handleRunEditorCode(questionId) {
        const textarea = document.getElementById(`code-input-${questionId}`);
        const terminal = document.getElementById(`code-output-${questionId}`);
        
        if (!textarea || !terminal) return;
        
        const code = textarea.value.trim();
        
        if (!code) {
            terminal.innerHTML = '<div class="text-yellow-400">Digite algum c√≥digo para executar.</div>';
            return;
        }
        
        if (!isPyodideLoaded) {
            terminal.innerHTML = '<div class="text-yellow-400">Aguarde, Python ainda est√° carregando...</div>';
            return;
        }
        
        terminal.innerHTML = '<div class="text-yellow-400">üêç Executando c√≥digo Python...</div>';
        terminal.classList.remove('error');
        
        try {
            console.log("‚ñ∂Ô∏è Executando c√≥digo:", code);
            const output = await runPythonCode(code);
            console.log("‚úÖ Output recebido:", output);
            
            let formattedOutput = output;
            if (!formattedOutput || formattedOutput.trim() === "") {
                formattedOutput = "‚úÖ C√≥digo executado sem output.";
            }
            
            terminal.innerHTML = `<div style="white-space: pre-wrap; font-family: 'Courier New', monospace;" class="text-green-400">${formattedOutput}</div>`;
            terminal.classList.remove('error');
            
        } catch (error) {
            console.error("‚ùå Erro capturado:", error);
            terminal.innerHTML = `<div style="white-space: pre-wrap; font-family: 'Courier New', monospace;" class="text-red-400">${error.message}</div>`;
            terminal.classList.add('error');
        }
    }

    // ===== SISTEMA DE LACUNAS DEFINITIVAMENTE CORRIGIDO =====
    function initializeFillBlankQuestions() {
        document.querySelectorAll('[id^="fill-blank-text-"]').forEach(container => {
            const questionId = container.id.replace('fill-blank-text-', '');
            
            console.log("üîÑ Processando lacunas para quest√£o:", questionId);
            
            // ‚úÖ CORRE√á√ÉO: OBTER TEXTO ORIGINAL DIRETAMENTE
            const originalText = container.textContent || container.innerText;
            console.log("üìù Texto original:", JSON.stringify(originalText));
            
            // ‚úÖ CORRE√á√ÉO: PROCESSAR TEXTO MANTENDO FORMATA√á√ÉO EXATA
            processFillBlankText(container, originalText, questionId);
        });
    }

    // ‚úÖ SOLU√á√ÉO DEFINITIVA - PRESERVA√á√ÉO TOTAL DE ESPA√áOS E FORMATA√á√ÉO
    function processFillBlankText(container, text, questionId) {
        console.log("üéØ Processando texto com lacunas:", JSON.stringify(text));
        
        // ‚úÖ CORRE√á√ÉO CR√çTICA: N√ÉO REMOVER ESPA√áOS INTERNOS - APENAS TRIM GERAL
        const cleanText = text.trim(); // S√≥ remove espa√ßos no in√≠cio e fim do texto completo
        
        const lines = cleanText.split('\n');
        let processedHTML = '';
        
        lines.forEach(line => {
            // ‚úÖ CORRE√á√ÉO: PRESERVAR ESPA√áOS INTERNOS E LINHAS VAZIAS
            if (line.trim() === '') {
                // Linha vazia - manter para preservar espa√ßamento
                processedHTML += '<div class="empty-line">&nbsp;</div>';
                return;
            }
            
            let lineHTML = '<div class="text-line">';
            
            // ‚úÖ Processar preservando TODOS os espa√ßos
            const parts = line.split(/(\[_____\])/);
            
            parts.forEach(part => {
                if (part === '[_____]') {
                    lineHTML += '<input type="text" class="blank-input" placeholder="______" data-question="' + questionId + '">';
                } else if (part !== '') {
                    // ‚úÖ PRESERVAR ESPA√áOS ORIGINAIS - usar &nbsp; para espa√ßos consecutivos
                    const preservedSpaces = part.replace(/  /g, ' &nbsp;');
                    lineHTML += '<span class="preserve-spaces">' + preservedSpaces + '</span>';
                }
            });
            
            lineHTML += '</div>';
            processedHTML += lineHTML;
        });
        
        container.innerHTML = processedHTML;
        console.log("‚úÖ FORMATA√á√ÉO EXATA PRESERVADA:", container.innerHTML);
    }

    // ===== FUN√á√ÉO VERIFICAR LACUNAS CORRIGIDA =====
    async function handleCheckBlank(e) {
        console.log("üéØ INICIANDO VERIFICA√á√ÉO DE LACUNAS");
        
        // ‚úÖ VERIFICA√á√ÉO DE VIDAS ANTES DE QUALQUER A√á√ÉO
        if (!isReviewMode && lives <= 0) {
            showNoLivesMessage();
            return;
        }
        const btn = e.currentTarget;
        const questionContainer = btn.closest('.question-container');
        const questionId = questionContainer.dataset.questionId;
        const currentQuestion = questions.find(q => q.id === questionId);
        
        if (!currentQuestion) {
            console.error("‚ùå Quest√£o n√£o encontrada:", questionId);
            return;
        }
        
        console.log(`üîç Verificando quest√£o de lacunas: ${questionId}`);
        
        // ‚úÖ MODO REVIS√ÉO: MOSTRAR RESPOSTA CORRETA
        if (isReviewMode) {
            console.log("üìù Modo Revis√£o - Mostrando respostas corretas");
            const blankInputs = questionContainer.querySelectorAll('.blank-input');
            const respostasCorretas = await getCorrectAnswersForQuestion(questionId);
            
            console.log("üìù Respostas corretas:", respostasCorretas);
            
            blankInputs.forEach((input, index) => {
                const respostaCorreta = respostasCorretas[index] || "Resposta n√£o dispon√≠vel";
                input.value = respostaCorreta;
                input.classList.add('filled');
                input.disabled = true;
            });
            
            showFeedback(questionId, 'info', 'üìù Modo revis√£o: Respostas corretas mostradas', 0);
            
            setTimeout(() => {
                console.log("üîÑ Indo para pr√≥xima quest√£o (modo revis√£o)");
                nextQuestion(true);
            }, 2000);
            
            return;
        }
        
        // ‚úÖ MODO NORMAL: VERIFICAR RESPOSTAS
        const blankInputs = questionContainer.querySelectorAll('.blank-input');
        let allFilled = true;
        
        console.log(`üìù Verificando ${blankInputs.length} lacunas`);
        
        // Verificar se todas as lacunas foram preenchidas
        blankInputs.forEach(input => {
            if (!input.value.trim()) {
                allFilled = false;
                input.classList.add('shake');
                setTimeout(() => input.classList.remove('shake'), 500);
            }
        });
        
        if (!allFilled) {
            console.log("‚ùå Lacunas n√£o preenchidas completamente");
            showFeedback(questionId, 'incorrect', '‚ùå Preencha todas as lacunas antes de verificar.', 0);
            return;
        }
        
        // ‚úÖ BUSCAR RESPOSTAS CORRETAS
        console.log("üîç Buscando respostas corretas...");
        const respostasCorretas = await getCorrectAnswersForQuestion(questionId);
        console.log("üéØ Respostas corretas encontradas:", respostasCorretas);
        
        if (!respostasCorretas || respostasCorretas.length === 0) {
            console.error("‚ùå Nenhuma resposta correta encontrada");
            showFeedback(questionId, 'incorrect', '‚ùå Erro: Nenhuma resposta correta configurada.', 0);
            return;
        }
        
        // ‚úÖ VERIFICAR RESPOSTAS DO USU√ÅRIO
        let isCorrect = true;
        let incorrectCount = 0;
        
        console.log("üîç Verificando respostas do usu√°rio...");
        
        blankInputs.forEach(input => {
            input.classList.remove('filled', 'shake');
        });
        
        blankInputs.forEach((input, index) => {
            const userAnswer = input.value.trim().toLowerCase();
            const correctAnswer = respostasCorretas[index] ? respostasCorretas[index].toString().toLowerCase() : "";
            
            console.log(`üìù Lacuna ${index + 1}: Usu√°rio="${userAnswer}", Correto="${correctAnswer}"`);
            
            if (correctAnswer && userAnswer === correctAnswer) {
                input.classList.add('filled');
                console.log(`‚úÖ Lacuna ${index + 1} CORRETA`);
            } else {
                isCorrect = false;
                incorrectCount++;
                input.classList.add('shake');
                console.log(`‚ùå Lacuna ${index + 1} INCORRETO`);
            }
        });
        
        // ‚úÖ MOSTRAR RESULTADO E PROCESSAR
        if (isCorrect) {
            console.log("‚úÖ Todas as lacunas corretas!");
            showFeedback(questionId, 'correct', '‚úÖ Todas as lacunas preenchidas corretamente!', currentQuestion.xp);
            
            setTimeout(() => {
                console.log("üîÑ Indo para pr√≥xima quest√£o (resposta correta)");
                nextQuestion(true);
            }, 1500);
        } else {
            console.log(`‚ùå ${incorrectCount} lacuna(s) incorreta(s)`);
            
            // ‚úÖ PERDER VIDA NO MODO NORMAL
            console.log("üíî Perdendo vida...");
            const vidaPerdida = await loseLife();
            
            const errorMessage = incorrectCount > 0 
                ? `‚ùå ${incorrectCount} lacuna(s) incorreta(s). Tente novamente.`
                : '‚ùå Respostas n√£o conferem. Tente novamente.';
                
            showFeedback(questionId, 'incorrect', errorMessage, 0);
            
            console.log("üíì Vidas restantes ap√≥s erro:", lives);
            
            // ‚úÖ CORRE√á√ÉO CR√çTICA: SEMPRE CHAMAR nextQuestion MESMO QUANDO ERRAR
            if (!vidaPerdida) {
                setTimeout(() => {
                    console.log("üîÑ Indo para pr√≥xima quest√£o (resposta incorreta)");
                    nextQuestion(false);
                }, 2000);
            } else {
                console.log("üíÄ Vidas acabaram - pr√°tica ser√° finalizada");
            }
        }
    }

    // ===== FUN√á√ÉO PARA BUSCAR RESPOSTAS CORRETAS =====
    async function getCorrectAnswersForQuestion(questionId) {
        console.log(`üîç Buscando respostas para quest√£o ${questionId}`);
        
        try {
            // ‚úÖ PRIMEIRO: Tentar buscar do elemento de respostas
            const respostasElement = document.getElementById(`respostas-${questionId}`);
            if (respostasElement && respostasElement.dataset.respostas) {
                try {
                    const respostas = JSON.parse(respostasElement.dataset.respostas);
                    console.log("‚úÖ Respostas encontradas no data attribute:", respostas);
                    
                    // ‚úÖ CORRE√á√ÉO: Garantir que √© um array e n√£o est√° vazio
                    if (Array.isArray(respostas) && respostas.length > 0) {
                        return respostas;
                    } else {
                        console.warn("‚ö†Ô∏è Array de respostas vazio ou inv√°lido");
                    }
                } catch (e) {
                    console.error("‚ùå Erro ao parsear respostas:", e);
                }
            }
            
            // ‚úÖ SEGUNDO: Tentar buscar via API
            try {
                const response = await fetch(`/api/questao/${questionId}/respostas/`);
                if (response.ok) {
                    const data = await response.json();
                    console.log("‚úÖ Respostas da API:", data.respostas);
                    
                    if (data.respostas && Array.isArray(data.respostas) && data.respostas.length > 0) {
                        return data.respostas;
                    }
                }
            } catch (apiError) {
                console.log("üî∂ API n√£o dispon√≠vel, usando m√©todos alternativos");
            }
            
            // ‚úÖ TERCEIRO: Tentar extrair do texto com lacunas
            const questionElement = document.querySelector(`[data-question-id="${questionId}"]`);
            if (questionElement) {
                const textoComLacunas = questionElement.querySelector('[id^="fill-blank-text-"]');
                if (textoComLacunas) {
                    const respostasExtraidas = extractAnswersFromText(textoComLacunas.textContent);
                    if (respostasExtraidas.length > 0) {
                        console.log("‚úÖ Respostas extra√≠das do texto:", respostasExtraidas);
                        return respostasExtraidas;
                    }
                }
            }
            
            // ‚úÖ QUARTO: Fallback para op√ß√µes de m√∫ltipla escolha (se aplic√°vel)
            const opcoesCorretas = questionElement?.querySelectorAll('.option-button[data-correct="true"]');
            if (opcoesCorretas && opcoesCorretas.length > 0) {
                const respostas = Array.from(opcoesCorretas).map(opcao => {
                    return opcao.textContent.trim();
                });
                console.log("‚úÖ Respostas das op√ß√µes corretas:", respostas);
                return respostas;
            }
            
            console.warn("‚ö†Ô∏è Nenhuma resposta encontrada para a quest√£o");
            return ["resposta_padrao"]; // Fallback para evitar erro
            
        } catch (error) {
            console.error("‚ùå Erro cr√≠tico ao buscar respostas:", error);
            return ["resposta_padrao"]; // Fallback
        }
    }

    // ===== FUN√á√ÉO AUXILIAR PARA EXTRAIR RESPOSTAS DO TEXTO =====
    function extractAnswersFromText(texto) {
        console.log("üìù Extraindo respostas do texto:", texto);
        
        const respostas = [];
        
        // Padr√µes para encontrar respostas no texto
        const patterns = [
            /resposta[:\s]*([^\n\.]+)/gi,
            /preencha[:\s]*([^\n\.]+)/gi,
            /deve ser[:\s]*([^\n\.]+)/gi,
            /correto[:\s]*([^\n\.]+)/gi,
            /preencha com[:\s]*([^\n\.]+)/gi
        ];
        
        for (let pattern of patterns) {
            const matches = texto.matchAll(pattern);
            for (const match of matches) {
                if (match[1]) {
                    const resposta = match[1].trim();
                    if (resposta && !respostas.includes(resposta)) {
                        respostas.push(resposta);
                    }
                }
            }
        }
        
        // Se n√£o encontrou padr√µes, tentar pegar palavras ap√≥s "_____"
        if (respostas.length === 0) {
            const blankPattern = /_____\s*[:\-]?\s*([^\s\.\,]+)/g;
            const blankMatches = texto.matchAll(blankPattern);
            for (const match of blankMatches) {
                if (match[1]) {
                    respostas.push(match[1].trim());
                }
            }
        }
        
        return respostas;
    }

    // ===== SISTEMA DE DICAS =====
    function initializeHints() {
        document.querySelectorAll('.question-container').forEach(container => {
            const questionId = container.dataset.questionId;
            usedHints[questionId] = 0;
        });
    }
    
    function showHint(questionId) {
        const hintContainer = document.getElementById(`hints-${questionId}`);
        const hintSteps = hintContainer.querySelectorAll('.hint-step');
        const totalHints = hintSteps.length;
        
        if (totalHints === 0) {
            alert("N√£o h√° dicas dispon√≠veis.");
            return;
        }
        
        if (usedHints[questionId] === 0) {
            hintContainer.style.display = 'block';
            usedHints[questionId] = 1;
        } else if (usedHints[questionId] < totalHints) {
            usedHints[questionId]++;
        } else {
            alert("Todas as dicas j√° foram mostradas!");
            return;
        }
        
        for (let i = 0; i < usedHints[questionId]; i++) {
            hintSteps[i].style.display = 'block';
        }
        
        const hintBtn = document.querySelector(`.hint-btn[data-question-id="${questionId}"]`);
        const counter = hintBtn.querySelector('.hint-counter');
        const remaining = totalHints - usedHints[questionId];
        
        counter.textContent = remaining;
        
        if (remaining === 0) {
            hintBtn.disabled = true;
            counter.classList.add('bg-red-500', 'text-white');
        }
    }

    // ===== MANIPULADORES DE RESPOSTAS =====
    function initializeQuestionEvents() {
        document.querySelectorAll('.hint-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const questionId = e.currentTarget.dataset.questionId;
                showHint(questionId);
            });
        });
        
        document.querySelectorAll('.option-button').forEach(btn => {
            btn.addEventListener('click', handleMultipleChoice);
        });
        
        document.querySelectorAll('.check-blank').forEach(btn => {
            btn.addEventListener('click', handleCheckBlank);
        });
    }
    
    // ===== M√öLTIPLA ESCOLHA CORRIGIDA =====
    async function handleMultipleChoice(e) {

        // ‚úÖ VERIFICA√á√ÉO DE VIDAS ANTES DE QUALQUER A√á√ÉO
        if (!isReviewMode && lives <= 0) {
            showNoLivesMessage();
            return;
        }
        const btn = e.currentTarget;
        const questionContainer = btn.closest('.question-container');
        const questionId = questionContainer.dataset.questionId;
        const isCorrect = btn.dataset.correct === 'true';
        const currentQuestion = questions.find(q => q.id === questionId);
        const xp = currentQuestion ? currentQuestion.xp : 10;
        
        // ‚úÖ MODO REVIS√ÉO: MOSTRAR RESPOSTA CORRETA
        if (isReviewMode) {
            questionContainer.querySelectorAll('.option-button').forEach(option => {
                if (option.dataset.correct === 'true') {
                    option.classList.add('selected');
                }
                option.disabled = true;
            });
            
            showFeedback(questionId, 'info', 'üìù Modo revis√£o: Resposta correta destacada', 0);
            
            setTimeout(() => {
                nextQuestion(true);
            }, 2000);
            
            return;
        }
        
        // ‚úÖ MODO NORMAL: VERIFICAR RESPOSTA
        questionContainer.querySelectorAll('.option-button').forEach(option => {
            option.classList.remove('selected');
        });
        
        btn.classList.add('selected');
        
        if (isCorrect) {
            showFeedback(questionId, 'correct', '‚úÖ Resposta correta!', xp);
            
            // ‚úÖ DESABILITAR AP√ìS ACERTAR
            questionContainer.querySelectorAll('.option-button').forEach(option => {
                option.disabled = true;
            });
            
            setTimeout(() => {
                nextQuestion(true);
            }, 1500);
        } else {
            // ‚úÖ CORRE√á√ÉO: PERDER VIDA NO MODO NORMAL (AGORA ATUALIZA BACKEND)
            await debouncedLoseLife();
            
            showFeedback(questionId, 'incorrect', '‚ùå Resposta incorreta. Tente novamente.', 0);
            
            setTimeout(() => {
                nextQuestion(false);
            }, 2000);
        }
    }

    // ===== FUN√á√ïES AUXILIARES =====
    function resetQuestion(questionId) {
        const questionElement = document.querySelector(`[data-question-id="${questionId}"]`);
        if (!questionElement) return;
        
        console.log(`üîÑ Resetando quest√£o ${questionId} para nova tentativa`);
        
        // Resetar op√ß√µes de m√∫ltipla escolha
        const optionButtons = questionElement.querySelectorAll('.option-button');
        optionButtons.forEach(btn => {
            btn.classList.remove('selected', 'shake');
            btn.disabled = false;
        });
        
        // Resetar lacunas
        const blankInputs = questionElement.querySelectorAll('.blank-input');
        blankInputs.forEach(input => {
            input.classList.remove('filled', 'shake');
            input.disabled = false;
            input.value = '';
        });
        
        // Resetar c√≥digo (manter o c√≥digo atual, apenas limpar feedback)
        const terminal = document.getElementById(`code-output-${questionId}`);
        if (terminal) {
            terminal.innerHTML = '<div class="text-green-400">‚úÖ Python carregado! Digite seu c√≥digo e clique em "Executar".</div>';
        }
        
        // Limpar feedback
        const feedback = document.getElementById(`feedback-${questionId}`);
        if (feedback) {
            feedback.classList.add('hidden');
            feedback.innerHTML = '';
        }
    }
    
    function showFeedback(questionId, type, message, xp) {
        const feedback = document.getElementById(`feedback-${questionId}`);
        feedback.innerHTML = message;
        feedback.className = `feedback-message feedback-${type} bounce-in`;
        feedback.classList.remove('hidden');
    }
    
    function scrollToTop() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    function startTimer() {
        timerInterval = setInterval(() => {
            seconds++;
            updateTimerDisplay();
        }, 1000);
    }
    
    function updateTimerDisplay() {
        let minutes = Math.floor(seconds / 60);
        let secs = seconds % 60;
        document.getElementById('timer').textContent = 
            String(minutes).padStart(2, '0') + ":" + String(secs).padStart(2, '0');
    }
    
    function stopTimer() {
        clearInterval(timerInterval);
        return seconds;
    }

    // ===== CALCULAR B√îNUS DE TEMPO =====
    function calculateTimeBonus(elapsedTime, totalXP) {
        const tempoMaximo = {{ aula.tempo_pratica }} * 60; // converter minutos para segundos
        const percentualTempo = Math.max(0, (tempoMaximo - elapsedTime) / tempoMaximo);
        
        // B√¥nus de at√© 20% do XP total por tempo r√°pido
        const bonus = Math.round(totalXP * percentualTempo * 0.2);
        console.log(`‚è∞ B√¥nus de tempo: ${bonus} XP (${Math.round(percentualTempo * 100)}% de efici√™ncia)`);
        
        return bonus;
    }

// ===== FINALIZA√á√ÉO CORRIGIDA - N√ÉO CONCLUI SE PERDEU TODAS AS VIDAS =====
async function finishPractice() {
    const aulaId = document.getElementById('aula-id').value;
    const elapsedTime = stopTimer(); // ‚úÖ Isso j√° pega o tempo do cron√¥metro
    
    console.log(`üèÅ Finalizando pr√°tica - Modo: ${isReviewMode ? 'REVIS√ÉO' : 'NORMAL'}`);
    console.log(`üìä XP acumulado: ${totalXP}`);
    console.log(`‚è∞ Tempo decorrido: ${elapsedTime} segundos`);
    console.log(`üíì Vidas restantes: ${lives}`);
    
    // ‚úÖ VERIFICA√á√ÉO CR√çTICA: Se acabaram as vidas, tratar como FALHA
    const vidasAcabaram = lives <= 0;
    
    let xpFinal = 0;
    let timeBonus = 0;
    let revisaoBonus = 0;
    
    if (isReviewMode) {
        // ‚úÖ MODO REVIS√ÉO: Sempre conclui (n√£o usa vidas)
        revisaoBonus = 5;
        xpFinal = revisaoBonus;
        
        console.log(`üìù Modo Revis√£o: B√¥nus fixo de ${revisaoBonus} XP`);
        
        if (!revisaoRegistrada) {
            try {
                const response = await fetch("{% url 'registrar_xp_revisao' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        aula_id: aulaId,
                        xp_revisao: revisaoBonus
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    revisaoRegistrada = true;
                    console.log("‚úÖ XP de revis√£o registrado com sucesso!");
                } else {
                    console.error("‚ùå Erro ao registrar XP da revis√£o:", data.error);
                }
            } catch (error) {
                console.error('‚ùå Erro ao registrar XP da revis√£o:', error);
            }
        }
    } else if (vidasAcabaram) {
        // ‚úÖ MODO NORMAL COM VIDAS ACABADAS: N√ÉO CONCLUI, ZERO XP
        console.log("üíÄ VIDAS ACABARAM - Pr√°tica N√ÉO conclu√≠da, zero XP");
        xpFinal = 0;
        timeBonus = 0;
        
        // Mostrar tela de derrota
        showDefeatScreen(elapsedTime);
        return; // ‚úÖ PARA AQUI - n√£o mostra tela de sucesso
        
    } else {
        // ‚úÖ MODO NORMAL COM SUCESSO: XP normal + b√¥nus
        const xpQuestoes = Array.from(answeredCorrectly).reduce((total, questionId) => {
            const question = questions.find(q => q.id === questionId);
            return total + (question ? question.xp : 0);
        }, 0);
        
        timeBonus = calculateTimeBonus(elapsedTime, xpQuestoes);
        xpFinal = xpQuestoes + timeBonus;
        
        console.log(`üéØ Modo Normal (Sucesso):`);
        console.log(`   - Quest√µes corretas: ${answeredCorrectly.size}`);
        console.log(`   - XP das quest√µes: ${xpQuestoes}`);
        console.log(`   - B√¥nus de tempo: +${timeBonus} XP`);
        console.log(`   - Total: ${xpFinal} XP`);
    }
    
    // ‚úÖ S√ì ENVIA PARA O BACKEND SE N√ÉO FOR CASO DE VIDAS ACABADAS
    if (!vidasAcabaram) {
        try {
            const response = await fetch("{% url 'finalizar_pratica' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    aula_id: aulaId,
                    xp_total: xpFinal,
                    tempo_decorrido: elapsedTime,
                    vidas_restantes: lives
                })
            });
            
            const data = await response.json();
            if (data.success) {
                console.log("‚úÖ Pr√°tica finalizada com sucesso!");
                
                // ‚úÖ VERIFICAR SE O BACKEND CONFIRMOU QUE AS VIDAS ACABARAM
                if (data.vidas_acabaram) {
                    console.log("üíÄ Backend confirmou: vidas acabaram!");
                    showDefeatScreen(elapsedTime);
                    return;
                }
            } else {
                console.error("‚ùå Erro ao finalizar pr√°tica:", data.error);
            }
        } catch (error) {
            console.error('‚ùå Erro ao finalizar pr√°tica:', error);
        }
    }
    
    // ‚úÖ S√ì MOSTRA TELA DE SUCESSO SE N√ÉO FOR CASO DE DERROTA
    if (!vidasAcabaram) {
        showResultScreen(xpFinal, elapsedTime, timeBonus, revisaoBonus);
    }
}

// ‚úÖ NOVA FUN√á√ÉO: TELA DE DERROTA QUANDO ACABAM AS VIDAS
function showDefeatScreen(elapsedTime) {
    const resultScreen = document.getElementById('result-screen');
    const questionsContainer = document.getElementById('questions-container');
    
    questionsContainer.style.display = 'none';
    resultScreen.classList.remove('hidden');
    
    // Customizar para tela de derrota
    resultScreen.querySelector('h2').innerHTML = 'üíî Vidas Esgotadas';
    resultScreen.querySelector('p').textContent = 'Suas vidas acabaram durante a pr√°tica!';
    
    // Formatar tempo
    const minutes = Math.floor(elapsedTime / 60);
    const secondsRemaining = elapsedTime % 60;
    const timeFormatted = String(minutes).padStart(2, '0') + ':' + String(secondsRemaining).padStart(2, '0');
    
    // Atualizar conte√∫do da tela
    resultScreen.innerHTML = `
        <div class="bg-gradient-to-r from-red-600 to-red-800 text-white rounded-t-2xl p-6 -m-8 mb-6">
            <h2 class="text-3xl font-bold flex items-center justify-center gap-3">
                <span>üíî</span>
                Vidas Esgotadas
            </h2>
            <p class="mt-2 text-red-100">Suas vidas acabaram durante a pr√°tica!</p>
        </div>

        <div class="space-y-6">
            <!-- Estat√≠sticas -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl p-6 shadow-md text-center">
                    <div class="flex items-center justify-center gap-2 mb-3">
                        <img src="{% static 'imagem/timer_35dp_DC2626_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Tempo" class="w-8 h-8">
                    </div>
                    <div class="text-2xl font-bold text-red-600 mb-2">${timeFormatted}</div>
                    <p class="text-sm text-gray-600">Tempo de tentativa</p>
                </div>

                <div class="bg-white rounded-xl p-6 shadow-md text-center">
                    <div class="flex items-center justify-center gap-2 mb-3">
                        <img src="{% static 'imagem/block_35dp_DC2626_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Vidas" class="w-8 h-8">
                    </div>
                    <div class="text-2xl font-bold text-red-600 mb-2">0/${maxLives}</div>
                    <p class="text-sm text-gray-600">Vidas restantes</p>
                </div>
            </div>

            <!-- Mensagem de motiva√ß√£o -->
            <div class="bg-red-50 border border-red-200 rounded-xl p-6 text-center">
                <p class="text-red-700 font-semibold mb-2">N√£o desanime! Tente novamente quando suas vidas regenerarem.</p>
                <p class="text-red-600 text-sm">üí° Dica: Revise a teoria antes de tentar novamente!</p>
            </div>

            <!-- Bot√µes de A√ß√£o -->
            <div class="flex justify-center gap-4 mt-8">
                <a href="{% url 'tarefas' %}?modulo_id={{ aula.modulo.id }}"
                    class="bg-gradient-to-r from-red-500 to-red-700 text-white px-8 py-3 rounded-xl shadow-lg hover:from-red-600 hover:to-red-800 transition transform hover:scale-105 font-bold flex items-center gap-2">
                    Voltar √†s Tarefas
                </a>
            </div>
        </div>
    `;
}
    
    function showResultScreen(totalXP, elapsedTime, timeBonus, revisaoBonus = 0) {
        const resultScreen = document.getElementById('result-screen');
        const questionsContainer = document.getElementById('questions-container');
        
        questionsContainer.style.display = 'none';
        resultScreen.classList.remove('hidden');
        
        if (isReviewMode) {
            resultScreen.querySelector('h2').innerHTML = 'üìù Revis√£o Conclu√≠da';
            resultScreen.querySelector('p').textContent = 'Revis√£o dos exerc√≠cios finalizada!';
            
            // ‚úÖ MOSTRAR APENAS O B√îNUS DE REVIS√ÉO
            document.getElementById('final-xp').textContent = revisaoBonus;
            document.getElementById('time-bonus').textContent = '0';
            document.getElementById('revisao-bonus').textContent = revisaoBonus;
            
        } else {
            if (lives === 0) {
                resultScreen.querySelector('h2').innerHTML = 'üíî Fim das Vidas';
                resultScreen.querySelector('p').textContent = 'Suas vidas acabaram, mas voc√™ ganhou XP pelo progresso!';
            }
            
            // ‚úÖ CORRE√á√ÉO: MOSTRAR XP DAS QUEST√ïES + B√îNUS DE TEMPO
            document.getElementById('final-xp').textContent = totalXP;
            document.getElementById('time-bonus').textContent = timeBonus;
            
            // Esconder se√ß√£o de b√¥nus de revis√£o no modo normal
            const revisaoSection = resultScreen.querySelector('.bg-purple-100');
            if (revisaoSection) {
                revisaoSection.style.display = 'none';
            }
        }
        
        // ‚úÖ FORMATAR TEMPO CORRETAMENTE
        const minutes = Math.floor(elapsedTime / 60);
        const secondsRemaining = elapsedTime % 60;
        document.getElementById('final-time').textContent = 
            String(minutes).padStart(2, '0') + ':' + String(secondsRemaining).padStart(2, '0');
            
        console.log(`üèÅ Tela de Resultados:`);
        console.log(`   - Total XP: ${totalXP}`);
        console.log(`   - Tempo: ${minutes}:${String(secondsRemaining).padStart(2, '0')}`);
        console.log(`   - B√¥nus tempo: ${timeBonus}`);
        console.log(`   - B√¥nus revis√£o: ${revisaoBonus}`);
        console.log(`   - Modo: ${isReviewMode ? 'REVIS√ÉO' : 'NORMAL'}`);
    }

    

    console.log("üöÄ Sistema corrigido - Loop, Vidas e B√¥nus funcionando perfeitamente!");
</script>
{% endblock %}