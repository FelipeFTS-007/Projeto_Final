{% extends "base.html" %}
{% load static %}

{% block title %}Pr√°tica - {{ aula.titulo_pratica|default:aula.titulo_aula }}{% endblock %}

{% block extra_css %}
<style>
    /* Estilos para o sistema de sequ√™ncia de dicas */
    .hint-sequence-counter {
        border-left: 4px solid #3B82F6;
        animation: fadeIn 0.5s ease-in;
    }

    .hint-sequence-step {
        display: inline-block;
        background: #3B82F6;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        text-align: center;
        line-height: 24px;
        font-weight: bold;
        margin: 0 2px;
        animation: bounceIn 0.5s ease-out;
    }

    @keyframes bounceIn {
        0% { transform: scale(0.3); opacity: 0; }
        50% { transform: scale(1.1); opacity: 1; }
        100% { transform: scale(1); opacity: 1; }
    }

    .hint-progress-bar {
        height: 4px;
        background: #e5e7eb;
        border-radius: 2px;
        margin: 8px 0;
        overflow: hidden;
    }

    .hint-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #3B82F6, #1E40AF);
        transition: width 0.5s ease;
    }
    /* SEUS ESTILOS ORIGINAIS - MANTIDOS E MELHORADOS */
    /* ESTILOS MELHORADOS PARA NOTIFICA√á√ÉO DE XP */
    .xp-gain-notification {
        opacity: 0;
        transform: translateY(-20px) scale(0.8);
        transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .xp-gain-notification.show {
        opacity: 1;
        transform: translateY(0) scale(1);
    }

    .xp-gain-notification.hide {
        opacity: 0;
        transform: translateY(-30px) scale(0.9);
    }

    .xp-gain-content {
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        color: white;
        padding: 12px 20px;
        border-radius: 16px;
        box-shadow: 
            0 10px 25px -5px rgba(245, 158, 11, 0.4),
            0 0 15px rgba(255, 255, 255, 0.3) inset;
        display: flex;
        align-items: center;
        gap: 12px;
        border: 2px solid rgba(255, 255, 255, 0.2);
        position: relative;
        overflow: hidden;
    }

    .xp-gain-content::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(
            45deg,
            transparent,
            rgba(255, 255, 255, 0.1),
            transparent
        );
        transform: rotate(45deg);
        animation: shine 3s infinite;
    }

    @keyframes shine {
        0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
        100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
    }

    .xp-icon {
        animation: float 2s ease-in-out infinite;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
    }

    .xp-icon svg {
        width: 24px;
        height: 24px;
    }

    @keyframes float {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-4px); }
    }

    .xp-text {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        line-height: 1;
    }

    .xp-amount {
        font-size: 1.5rem;
        font-weight: 800;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .xp-label {
        font-size: 0.875rem;
        font-weight: 600;
        opacity: 0.9;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    /* Efeito de part√≠culas (opcional) */
    .xp-gain-content::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(
            circle at center,
            transparent 0%,
            rgba(255, 255, 255, 0.1) 100%
        );
        opacity: 0;
        animation: pulse 2s ease-in-out;
    }

    @keyframes pulse {
        0% { opacity: 0; transform: scale(1); }
        50% { opacity: 1; transform: scale(1.05); }
        100% { opacity: 0; transform: scale(1.1); }
    }
    .card-hover {
        transition: all 0.3s ease;
    }
    
    .card-hover:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.4);
    }
    
    .module-card {
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .module-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.4);
    }
    
    .module-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: linear-gradient(90deg, #3B82F6 0%, #1E40AF 100%);
    }
    
    .floating-element {
        animation: float 6s ease-in-out infinite;
    }
    
    @keyframes float {
        0% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
        100% { transform: translateY(0px); }
    }
    
    .pulse-animation {
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    .progress-ring {
        transform: rotate(-90deg);
    }
    
    .progress-ring__circle {
        transition: stroke-dashoffset 0.5s ease;
    }
    
    .typewriter {
        overflow: hidden;
        border-right: .15em solid #3B82F6;
        white-space: nowrap;
        animation: typing 3.5s steps(40, end), blink-caret .75s step-end infinite;
    }
    
    @keyframes typing {
        from { width: 0 }
        to { width: 100 }
    }
    
    @keyframes blink-caret {
        from, to { border-color: transparent }
        50% { border-color: #3B82F6; }
    }
    
    .fade-in {
        animation: fadeIn 1s ease-in;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .interactive-card {
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .interactive-card:hover {
        transform: translateY(-3px) scale(1.02);
        box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.3);
    }
    
    .interactive-card:active {
        transform: translateY(1px) scale(0.98);
    }

    /* ESTILOS ESPEC√çFICOS PARA PR√ÅTICA */
    .question-container {
        display: none;
    }

    .question-container.active {
        display: block;
        animation: fadeIn 0.5s ease-in;
    }

    .hint-container {
        display: none;
        background-color: #f0f9ff;
        border-left: 4px solid #3B82F6;
        padding: 1rem;
        margin-top: 1rem;
        border-radius: 0.5rem;
    }

    .hint-container.active {
        display: block;
    }

    .life-indicator {
        display: flex;
        gap: 4px;
        align-items: center;
    }

    .life {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background-color: #10B981;
        transition: all 0.3s ease;
    }

    .life.lost {
        background-color: #EF4444;
        transform: scale(0.8);
    }

    .correct-answer {
        background-color: #d1fae5 !important;
        border-color: #10b981 !important;
        color: #065f46 !important;
    }

    .wrong-answer {
        background-color: #fee2e2 !important;
        border-color: #ef4444 !important;
        color: #7f1d1d !important;
    }

    .blank-preview {
        display: inline-block;
        min-width: 80px;
        text-align: center;
        font-weight: 500;
        background: #fef3c7;
        border: 2px dashed #f59e0b;
        border-radius: 6px;
        padding: 2px 8px;
        margin: 0 2px;
        transition: all 0.2s ease;
        color: #92400e;
    }

    .blank-filled {
        background: #d1fae5;
        border: 2px solid #10b981;
        color: #065f46;
        font-weight: 600;
    }

    .code-editor {
        font-family: 'Courier New', monospace;
        font-size: 14px;
        line-height: 1.5;
        background: #1e293b;
        color: #e2e8f0;
        border: 1px solid #334155;
        border-radius: 0.5rem;
        padding: 1rem;
        margin: 1rem 0;
        overflow-x: auto;
        white-space: pre-wrap;
    }

    .code-output {
        font-family: 'Courier New', monospace;
        font-size: 14px;
        line-height: 1.4;
        white-space: pre-wrap;
        background: #0f172a;
        color: #10b981;
        padding: 1rem;
        border-radius: 0.5rem;
        border: 1px solid #1e293b;
    }

    .option-button {
        transition: all 0.3s ease;
        border: 2px solid #e2e8f0;
    }

    .option-button:hover {
        border-color: #3B82F6;
        transform: translateY(-2px);
    }

    .feedback-message {
        padding: 1rem;
        border-radius: 0.5rem;
        margin: 1rem 0;
        font-weight: 600;
        text-align: center;
    }

    .feedback-correct {
        background-color: #d1fae5;
        color: #065f46;
        border: 2px solid #10b981;
    }

    .feedback-incorrect {
        background-color: #fee2e2;
        color: #7f1d1d;
        border: 2px solid #ef4444;
    }

    /* Estilos para o sistema de dicas */
    .hint-step {
        display: none;
        padding: 0.5rem 0;
        border-bottom: 1px solid #dbeafe;
    }

    .hint-step:last-child {
        border-bottom: none;
    }

    .hint-step.active {
        display: block;
        animation: fadeIn 0.5s ease-in;
    }

    .hint-counter {
        background: #3B82F6;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: bold;
    }

    /* Anima√ß√µes para feedback */
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
    }

    .shake {
        animation: shake 0.5s ease-in-out;
    }

    @keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
    }

    .bounce {
        animation: bounce 0.5s ease-in-out;
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6 fade-in">
    <!-- Topo: Bot√£o voltar + Cron√¥metro + Streak + Vidas -->
    <div class="flex items-center justify-between border-b border-blue-100 pb-4">
        <!-- Bot√£o Voltar -->
        <a href="{% url 'tarefas' %}?modulo_id={{ aula.modulo.id }}">
            <button class="interactive-card flex items-center gap-2 px-4 py-2 bg-blue-100 text-blue-600 font-semibold rounded-xl hover:bg-blue-200 transition">
                <img src="{% static 'imagem/arrow_back_35dp_2682EA_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Voltar" class="w-5 h-5">
                Voltar
            </button>
        </a>

     
        

        <!-- Cron√¥metro -->
        <div class="flex items-center gap-3 bg-blue-100 text-blue-600 px-4 py-2 rounded-xl font-bold">
            <div class="relative w-8 h-8">
                <svg class="progress-ring w-8 h-8" width="32" height="32">
                    <circle class="progress-ring__circle" stroke="#3B82F6" stroke-width="3" fill="transparent" r="14" cx="16" cy="16"
                        stroke-dasharray="88" stroke-dashoffset="52.8"></circle>
                </svg>
                <img src="{% static 'imagem/timer_100dp_2682EA_FILL0_wght400_GRAD0_opsz48.png' %}" alt="Tempo" class="w-4 h-4 absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2">
            </div>
            <span id="timer">00:00</span>
            <span class="text-xs">/ {{ aula.tempo_pratica }}:00</span>
        </div>
    </div>

    <!-- Campos hidden para controle -->
    <input type="hidden" id="vidas-restantes" value="{{ vidas_restantes }}">
    <input type="hidden" id="max-vidas" value="{{ max_vidas }}">
    <input type="hidden" id="aula-id" value="{{ aula.id }}">
    <input type="hidden" id="pratica-concluida" value="{{ pratica_concluida|yesno:'true,false' }}">
    <!-- ‚úÖ NOVO: Campo para controlar XP da revis√£o -->
    <input type="hidden" id="xp-revisao" value="5">
    <!-- Cabe√ßalho da Pr√°tica com Anima√ß√£o -->
    <div class="flex items-center justify-between">
        <div>
            <h2 class="text-2xl font-bold text-blue-600 typewriter">{{ aula.titulo_pratica|default:aula.titulo_aula }}</h2>
            <!-- ‚úÖ INDICADOR DE MODO REVIS√ÉO -->
            {% if pratica_concluida %}
            <div class="flex items-center gap-2 mt-2">
                <span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm font-semibold flex items-center gap-1">
                    
                    Modo Revis√£o
                </span>
            </div>
            {% endif %}
        </div>
        
        <div class="flex gap-4">
            <div class="bg-blue-100 text-blue-600 px-3 py-1 rounded-xl text-sm font-bold flex items-center card-hover">
                <img src="{% static 'imagem/timer_100dp_2682EA_FILL0_wght400_GRAD0_opsz48.png' %}" alt="" class="h-5 w-5 mx-1"> {{ aula.tempo_pratica }} min
            </div>
            <div class="bg-blue-100 text-blue-600 px-3 py-1 rounded-xl text-sm font-bold flex items-center card-hover pulse-animation">
                +{{ aula.xp_pratica }} XP
            </div>
        </div>
    </div>

    <!-- Descri√ß√£o da Pr√°tica -->
    {% if aula.conteudo_pratico %}
    <div class="bg-gradient-to-br from-white to-blue-50 border border-blue-200 rounded-2xl p-6 shadow-lg module-card">
        <h3 class="text-lg font-bold text-blue-600 mb-3 flex items-center gap-2">
            <img src="{% static 'imagem/description_35dp_2682EA_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Descri√ß√£o" class="w-5 h-5">
            
        </h3>
        <p class="text-gray-700 leading-relaxed">
            {{ aula.conteudo_pratico }}
        </p>
    </div>
    {% endif %}

    <!-- Container Principal das Quest√µes -->
    <div id="questions-container" class="space-y-6">
        {% for questao in aula.questoes.all %}
        <div class="question-container {% if forloop.first %}active{% endif %}" data-question-id="{{ questao.id }}" data-question-type="{{ questao.tipo }}" data-question-number="{{ forloop.counter }}">
            <!-- Cabe√ßalho da Quest√£o -->
            <div class="bg-gradient-to-r from-blue-600 to-blue-800 text-white rounded-t-2xl p-6 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    {% if questao.tipo == 'multiple-choice' %}
                    <img src="{% static 'imagem/quiz_35dp_FFFFFF_FILL0_wght400_GRAD0_opsz40.png' %}" alt="M√∫ltipla Escolha" class="w-6 h-6">
                    {% elif questao.tipo == 'code' %}
                    <img src="{% static 'imagem/code_35dp_FFFFFF_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Programa√ß√£o" class="w-6 h-6">
                    {% elif questao.tipo == 'fill-blank' %}
                    <img src="{% static 'imagem/edit_35dp_FFFFFF_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Completar Lacunas" class="w-6 h-6">
                    {% endif %}
                    <div>
                        <h3 class="font-bold text-lg">Quest√£o {{ forloop.counter }}</h3>
                        <span class="text-sm text-blue-100">
                            {% if questao.tipo == 'multiple-choice' %}M√∫ltipla Escolha
                            {% elif questao.tipo == 'code' %}Programa√ß√£o
                            {% elif questao.tipo == 'fill-blank' %}Completar Lacunas
                            {% else %}{{ questao.tipo }}{% endif %}
                        </span>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <!-- Bot√£o de Dicas -->
                    <button class="hint-btn bg-blue-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-600 transition interactive-card flex items-center gap-2"
                            data-question-id="{{ questao.id }}">
                        <img src="{% static 'imagem/lightbulb_35dp_FFFFFF_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Dicas" class="w-4 h-4">
                        Dicas
                        <span class="hint-counter bg-white text-blue-600">{{ questao.dicas.count }}</span>
                    </button>
                    
                    <!-- XP da Quest√£o -->
                    <div class="bg-yellow-100 text-yellow-800 px-3 py-2 rounded-lg font-bold flex items-center gap-2">
                        
                        +{{ questao.xp }} XP
                    </div>
                </div>
            </div>

            <!-- Conte√∫do da Quest√£o -->
            <div class="bg-white rounded-b-2xl p-6 border border-blue-200 border-t-0">
                {% if questao.descricao %}
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 rounded-r-lg">
                    <p class="text-blue-800 text-sm">{{ questao.descricao }}</p>
                </div>
                {% endif %}
                

                <!-- Container de Dicas -->
                <div class="hint-container mb-6" id="hints-{{ questao.id }}" style="display: none;">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-bold text-blue-800 flex items-center gap-2">
                            <img src="{% static 'imagem/lightbulb_35dp_2682EA_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Dicas" class="w-4 h-4">
                            Dicas Dispon√≠veis
                        </h4>
                        <span class="text-sm text-blue-600">{{ questao.dicas.count }} dica(s)</span>
                    </div>
                    
                    <div class="hints-list space-y-3">
                        {% for dica in questao.dicas.all %}
                        <div class="hint-step bg-blue-50  p-4 rounded-r-lg"
                            style="display: none;">
                            <div class="flex items-start gap-3">
                                <span class="bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold mt-1 flex-shrink-0">
                                    {{ forloop.counter }}
                                </span>
                                <div>
                                    <p class="text-blue-700">{{ dica.texto }}</p>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <p class="text-gray-500 text-center py-2">Nenhuma dica dispon√≠vel para esta quest√£o.</p>
                        {% endfor %}
                    </div>
                    
                    {% if questao.dicas.count > 1 %}
                    <div class="hint-navigation flex justify-between mt-4">
                        <button class="prev-hint bg-gray-500 text-white px-4 py-2 rounded text-sm hover:bg-gray-600 transition"
                                data-question-id="{{ questao.id }}"
                                style="display: none;">
                            ‚Üê Anterior
                        </button>
                        <button class="next-hint bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700 transition"
                                data-question-id="{{ questao.id }}"
                                style="display: none;">
                            Pr√≥xima ‚Üí
                        </button>
                    </div>
                    {% endif %}
                </div>

                <!-- Enunciado da Quest√£o -->
                <div class="mb-6">
                    <h4 class="font-bold text-gray-800 mb-3 text-lg">Enunciado:</h4>
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                        <p class="text-gray-700 whitespace-pre-wrap">{{ questao.enunciado }}</p>
                    </div>
                </div>

                <!-- Conte√∫do Espec√≠fico por Tipo -->
                {% if questao.tipo == 'multiple-choice' %}
                <!-- M√∫ltipla Escolha -->
                <div class="space-y-3">
                    <h4 class="font-bold text-gray-800 mb-3">Selecione a op√ß√£o correta:</h4>
                    <div class="grid gap-3">
                        {% for opcao in questao.opcoes.all %}
                        <button class="option-button bg-white border-2 border-gray-200 rounded-xl p-4 text-left hover:border-blue-400 transition-all"
                                data-option-id="{{ opcao.id }}" data-correct="{{ opcao.correta|yesno:'true,false' }}">
                            <div class="flex items-center gap-3">
                                <span class="bg-blue-100 text-blue-600 rounded-full w-8 h-8 flex items-center justify-center font-bold flex-shrink-0"
                                      data-index="{{ forloop.counter0 }}">
                                    {{ forloop.counter0|add:65|stringformat:"c" }}
                                </span>
                                <span class="text-gray-700">{{ opcao.texto }}</span>
                            </div>
                        </button>
                        {% empty %}
                        <p class="text-gray-500 text-center py-4">Nenhuma op√ß√£o dispon√≠vel.</p>
                        {% endfor %}
                    </div>
                </div>

                {% elif questao.tipo == 'code' %}
                <!-- Programa√ß√£o -->
                <div class="space-y-4">
                    {% if questao.codigo_inicial %}
                    <div>
                        <h4 class="font-bold text-gray-800 mb-2">C√≥digo Inicial:</h4>
                        <div class="code-editor">
                            <pre><code>{{ questao.codigo_inicial }}</code></pre>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- ‚úÖ CORRE√á√ÉO: VERIFICA√á√ÉO SEGURA DA SA√çDA ESPERADA -->
                    {% if questao.saida_esperada %}
                    <div class="mt-4">
                        <h4 class="font-bold text-gray-800 mb-2">Sa√≠da Esperada:</h4>
                        <div class="code-output" data-saida-esperada="{{ questao.saida_esperada|escapejs }}">
                            <pre>{{ questao.saida_esperada }}</pre>
                        </div>
                    </div>

                    
                    
                    //<script>
                        // ‚úÖ DEFINIR VARI√ÅVEL GLOBAL APENAS SE HOUVER SA√çDA
                       // window.saidaEsperada_{{ questao.id }} = {{ questao.saida_esperada|escapejs }};
                       // console.log("üìù Quest√£o {{ questao.id }} - Sa√≠da esperada definida:", window.saidaEsperada_{{ questao.id }});
                    //</script>
                    {% else %}
                    <div class="bg-blue-100 border border-blue-400 p-3 rounded-lg">
                        <h4 class="font-bold text-blue-800">üí° Informa√ß√£o:</h4>
                        <p class="text-blue-700">Execute o c√≥digo para ver o resultado. N√£o h√° sa√≠da espec√≠fica esperada.</p>
                    </div>
                    
                    <script>
                        // ‚úÖ DEFINIR COMO VAZIO SE N√ÉO HOUVER SA√çDA
                        //window.saidaEsperada_{{ questao.id }} = "";
                        //console.log("üìù Quest√£o {{ questao.id }} - Sem sa√≠da esperada definida");
                    </script>
                    {% endif %}

                    <div>
                        <h4 class="font-bold text-gray-800 mb-2">Seu C√≥digo:</h4>
                        <textarea class="w-full h-48 bg-gray-900 text-green-400 p-4 rounded-lg border border-gray-700 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 resize-none font-mono text-sm"
                                placeholder="Escreva seu c√≥digo aqui..." id="code-input-{{ questao.id }}">{{ questao.codigo_inicial|default:"" }}</textarea>
                    </div>

                    <div class="flex gap-3">
                        <button class="run-code bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700 transition interactive-card flex items-center gap-2"
                                data-question-id="{{ questao.id }}">
                            <img src="{% static 'imagem/play_arrow_35dp_FFFFFF_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Executar" class="w-4 h-4">
                            Executar C√≥digo
                        </button>
                        
                        <button class="check-code bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition interactive-card flex items-center gap-2"
                                data-question-id="{{ questao.id }}">
                            <img src="{% static 'imagem/check_circle_35dp_FFFFFF_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Verificar" class="w-4 h-4">
                            Verificar C√≥digo
                        </button>
                    </div>

                    <div id="code-output-{{ questao.id }}" class="code-output hidden">
                        <div class="text-gray-400">Sa√≠da do c√≥digo aparecer√° aqui...</div>
                    </div>
                </div>

                {% elif questao.tipo == 'fill-blank' %}
                
                {% spaceless %}
                <!-- Completar Lacunas -->
                <div class="space-y-4">
                    <h4 class="font-bold text-gray-800 mb-2">Complete as lacunas no texto abaixo:</h4>
                    
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-6">
                    
                        <div id="fill-blank-text-{{ questao.id }}" class="text-gray-700 leading-relaxed whitespace-pre-wrap">{{ questao.enunciado }}</div>
                        
                    </div>
                    
                    <!-- ‚úÖ SOLU√á√ÉO: Vari√°vel global JavaScript -->
                    <script>
                        // Define as respostas como vari√°vel global
                        window.respostasQuestao{{ questao.id }} = {{ questao.respostas_corretas|safe }};
                        console.log("üéØ Respostas definidas para quest√£o {{ questao.id }}:", window.respostasQuestao{{ questao.id }});
                    </script>

                    <div class="correct-answers-data" 
                        data-questao-id="{{ questao.id }}"
                        data-respostas='{{ questao.respostas_corretas|default:"[]"|safe }}'>
                    </div>

                    <button class="check-blank bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition interactive-card flex items-center gap-2"
                            data-question-id="{{ questao.id }}">
                        Verificar
                    </button>
                </div>
                {% endspaceless %}
                {% endif %}

                <!-- Feedback da Quest√£o -->
                <div id="feedback-{{ questao.id }}" class="feedback-message hidden mt-6"></div>

                <!-- Navega√ß√£o entre Quest√µes -->
                <div class="flex justify-between items-center mt-8 pt-6 border-t border-gray-200">
                    <button class="prev-question bg-gray-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-gray-700 transition interactive-card flex items-center gap-2 {% if forloop.first %}opacity-50 cursor-not-allowed{% endif %}"
                            {% if forloop.first %}disabled{% endif %}>
                        ‚Üê Anterior
                        
                    </button>

                    <span class="text-gray-600 font-medium">Quest√£o {{ forloop.counter }} de {{ aula.questoes.count }}</span>

                    <button class="next-question bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-700 transition interactive-card flex items-center gap-2 {% if forloop.last %}hidden{% endif %}"
                            data-question-id="{{ questao.id }}">
                        Pr√≥xima
                        <img src="{% static 'imagem/arrow_forward_35dp_FFFFFF_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Pr√≥xima" class="w-4 h-4">
                    </button>
                    <!-- Bot√£o Finalizar (√∫ltima quest√£o) -->
                    <button class="finish-practice bg-gray-400 text-white px-6 py-2 rounded-lg font-semibold transition interactive-card flex items-center gap-2 opacity-50 cursor-not-allowed {% if not forloop.last %}hidden{% endif %}"
                            data-aula-id="{{ aula.id }}" disabled>
                        
                        Responda todas as quest√µes
                    </button>
                    
                </div>
            </div>
        </div>
        {% empty %}
        <!-- Mensagem quando n√£o h√° quest√µes -->
        <div class="text-center py-12">
            <img src="{% static 'imagem/quiz_100dp_64748b_FILL0_wght400_GRAD0_opsz48.png' %}" alt="Sem quest√µes" class="w-24 h-24 mx-auto mb-4 opacity-50">
            <h3 class="text-xl font-bold text-gray-700 mb-2">Nenhum exerc√≠cio dispon√≠vel</h3>
            <p class="text-gray-500">Esta aula ainda n√£o possui exerc√≠cios pr√°ticos.</p>
            <a href="{% url 'tarefas' %}?modulo_id={{ aula.modulo.id }}" 
               class="inline-block mt-4 bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
                Voltar para Tarefas
            </a>
        </div>
        {% endfor %}
    </div>

    <!-- Tela de Resultados -->
    <div id="result-screen" class="hidden bg-gradient-to-br from-white to-green-50 rounded-2xl shadow-lg p-8 text-center space-y-6 border border-green-200 module-card">
        <div class="bg-gradient-to-r from-green-600 to-green-800 text-white rounded-t-2xl p-6 -m-8 mb-6">
            <h2 class="text-3xl font-bold flex items-center justify-center gap-3">
                <span>üéâ</span>
                Parab√©ns!
            </h2>
            <p class="mt-2 text-green-100">Voc√™ concluiu todos os exerc√≠cios!</p>
        </div>

        <!-- Resumo de Desempenho -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
            <div class="bg-white rounded-xl p-6 shadow-md card-hover">
                <div class="flex items-center justify-center gap-2 mb-3">
                    <img src="{% static 'imagem/auto_awesome_mosaic_35dp_10B981_FILL0_wght400_GRAD0_opsz40.png' %}" alt="XP" class="w-8 h-8">
                </div>
                <div class="text-2xl font-bold text-green-600 mb-2"><span id="final-xp">0</span> XP</div>
                <p class="text-sm text-gray-600">Total conquistado</p>
            </div>

            <div class="bg-white rounded-xl p-6 shadow-md card-hover">
                <div class="flex items-center justify-center gap-2 mb-3">
                    <img src="{% static 'imagem/timer_35dp_10B981_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Tempo" class="w-8 h-8">
                </div>
                <div class="text-2xl font-bold text-green-600 mb-2"><span id="final-time">00:00</span></div>
                <p class="text-sm text-gray-600">Tempo total</p>
            </div>

            <div class="bg-white rounded-xl p-6 shadow-md card-hover">
                <div class="flex items-center justify-center gap-2 mb-3">
                    <img src="{% static 'imagem/bolt_35dp_10B981_FILL0_wght400_GRAD0_opsz40.png' %}" alt="B√¥nus" class="w-8 h-8">
                </div>
                <div class="text-2xl font-bold text-green-600 mb-2">+<span id="time-bonus">0</span> XP</div>
                <p class="text-sm text-gray-600">B√¥nus por tempo</p>
            </div>
        </div>

        <!-- Bot√µes de A√ß√£o -->
        <div class="flex justify-center gap-4 mt-8">
            <button onclick="location.reload()"
                class="bg-gradient-to-r from-green-500 to-green-700 text-white px-8 py-3 rounded-xl shadow-lg hover:from-green-600 hover:to-green-800 transition transform hover:scale-105 font-bold flex items-center gap-2">
                Recome√ßar
                
            </button>

            <a href="{% url 'tarefas' %}?modulo_id={{ aula.modulo.id }}"
                class="bg-white text-green-600 border border-green-300 px-8 py-3 rounded-xl shadow-lg hover:bg-green-50 transition transform hover:scale-105 font-bold flex items-center gap-2">
                
                Voltar √†s Tarefas
            </a>
        </div>
        
    </div>
    
</div>

{% endblock %}

{% block extra_js %}
<script>
    // ===== SISTEMA DIN√ÇMICO DE PR√ÅTICA COM VIDAS =====
    
    // Vari√°veis globais
    // ‚úÖ SISTEMA DE CONTROLE DE QUEST√ïES
    let questionsAnswered = new Set(); // Armazena IDs das quest√µes respondidas
    let canFinish = false; // Controla se pode finalizar
    let currentQuestion = 1;
    let totalQuestions = {{ aula.questoes.count }};
    let seconds = 0;
    let timerInterval;
    let totalXP = 0;
    let correctAnswers = 0;
    let usedHints = {};
    let currentHintIndex = {};
    let userLives = parseInt(document.getElementById('vidas-restantes').value);
    let maxLives = parseInt(document.getElementById('max-vidas').value);
    let isReviewMode = document.getElementById('pratica-concluida').value === 'true';

    // ===== INICIALIZA√á√ÉO =====
    document.addEventListener('DOMContentLoaded', function() {
        
        console.log("üéØ Iniciando sistema de pr√°tica...");
        console.log(`üìù Modo: ${isReviewMode ? 'REVIS√ÉO' : 'NOVA PR√ÅTICA'}`);
       
        // Inicializar sistema
        initializeHints();
        initializeQuestionEvents();
        startTimer();
        
        // ‚úÖ CARREGAR DADOS INICIAIS DO CABE√áALHO
        carregarStreakUsuario().then(() => {
            console.log(`‚ù§Ô∏è Vidas: ${userLives}/${maxLives}`);
            console.log(`üî• Streak: ${streakAtual} dias, +${bonusStreak}% XP`);
            
            // ‚úÖ ATUALIZAR CABE√áALHO COM DADOS INICIAIS
            atualizarCabecalhoDisplay();
            atualizarDisplayStreak();
        });
        
        // ‚úÖ INICIAR ATUALIZA√á√ÉO PERI√ìDICA
        iniciarAtualizacaoPeriodica();
        
        console.log(`‚úÖ Sistema inicializado com ${totalQuestions} quest√µes`);
    });

    // ===== SISTEMA DE VIDAS =====
    function updateLivesDisplay() {
        // ‚úÖ VERIFICA√á√ÉO DE SEGURAN√áA: Se o elemento existe
        const lifeIndicator = document.getElementById('life-indicator');
        
        if (lifeIndicator) {
            const lives = lifeIndicator.querySelectorAll('.life');
            
            lives.forEach((life, index) => {
                if (index < userLives) {
                    life.classList.remove('bg-red-300', 'lost');
                    life.classList.add('bg-green-500');
                } else {
                    life.classList.remove('bg-green-500');
                    life.classList.add('bg-red-300', 'lost');
                }
            });
        } else {
            console.log("‚ö†Ô∏è life-indicator n√£o encontrado, atualizando apenas o n√∫mero");
        }
        
        // ‚úÖ ATUALIZAR O N√öMERO DE VIDAS NO CABE√áALHO (IMPORTANTE)
        const vidaElement = document.querySelector('.bg-blue-200.px-3.py-1\\.5 h2');
        if (vidaElement) {
            vidaElement.textContent = userLives;
        }
        
        // ‚úÖ VERIFICA√á√ÉO DE SEGURAN√áA: Se vidas = 0, finalizar pr√°tica
        if (userLives <= 0 && !isReviewMode) {
            console.log("üíÄ Vidas zeradas - finalizando pr√°tica...");
            setTimeout(() => {
                endPracticeDueToLives();
            }, 1000);
        }
    }
    let isProcessingLifeLoss = false; // Mutex para evitar perda dupla
    async function loseLife() {
        console.log("üîÑ loseLife() chamado");
        console.log(`üìä Estado atual - userLives: ${userLives}, isReviewMode: ${isReviewMode}`);
        if (isProcessingLifeLoss) {
         console.log("üîÑ Perda de vida j√° em processamento...");
         return { perdeuVida: false, vidasAcabaram: false };
        }
        if (isReviewMode) {
            console.log("üìù Modo revis√£o: n√£o perde vidas");
            return false;
        }
        
        if (userLives > 0) {
            userLives--;
            console.log(`üíî Vida perdida! Novas vidas: ${userLives}`);
            
            // ‚úÖ ATUALIZAR CABE√áALHO IMEDIATAMENTE
            atualizarCabecalhoDisplay();
            
            // Salvar no backend
            const aulaId = document.getElementById('aula-id').value;
            console.log(`üì° Enviando requisi√ß√£o para aula: ${aulaId}`);
            
            try {
                const response = await fetch("{% url 'usar_vida_pratica' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        aula_id: aulaId
                    })
                });
                
                console.log("üì® Resposta recebida:", response);
                const data = await response.json();
                console.log("üìä Dados da resposta:", data);
                
                if (data.success) {
                    userLives = data.vidas_restantes;
                    console.log(`‚úÖ Vidas atualizadas do backend: ${userLives}`);
                    
                    // ‚úÖ ATUALIZAR CABE√áALHO NOVAMENTE COM OS DADOS DO BACKEND
                    atualizarCabecalhoDisplay();
                } else {
                    console.error("‚ùå Erro do backend:", data.error);
                }
            } catch (error) {
                console.error('‚ùå Erro na requisi√ß√£o:', error);
            }
            
            return true; // Indica que perdeu vida
        } else {
            console.log("üíÄ Sem vidas dispon√≠veis");
            return false; // Indica que n√£o perdeu vida (j√° estava sem)
        }
        // ‚úÖ BLOQUEAR para evitar chamadas simult√¢neas
        isProcessingLifeLoss = true;
        console.log("üîÑ loseLife() iniciado - Vidas antes:", userLives);
    }

    function endPracticeDueToLives() {
        stopTimer();
        
        // Mostrar tela de game over
        const resultScreen = document.getElementById('result-screen');
        const questionsContainer = document.getElementById('questions-container');
        
        questionsContainer.style.display = 'none';
        resultScreen.classList.remove('hidden');
        
        // Customizar mensagem para game over
        resultScreen.querySelector('h2').innerHTML = 'üíî Fim da Pr√°tica';
        resultScreen.querySelector('p').textContent = 'Suas vidas acabaram! Tente novamente.';
        
        document.getElementById('final-xp').textContent = totalXP;
        document.getElementById('time-bonus').textContent = '0';
        
        const minutes = Math.floor(seconds / 60);
        const secondsRemaining = seconds % 60;
        document.getElementById('final-time').textContent = 
            String(minutes).padStart(2, '0') + ':' + String(secondsRemaining).padStart(2, '0');
        
        // Customizar bot√£o
        const restartBtn = resultScreen.querySelector('button[onclick="location.reload()"]');
        restartBtn.innerHTML = 'Tentar Novamente üîÑ';
        restartBtn.onclick = function() { location.reload(); };
    }

    
    // ===== SISTEMA DE DICAS COM SEQU√äNCIA VIS√çVEL =====
    function initializeHints() {
        document.querySelectorAll('.question-container').forEach(container => {
            const questionId = container.dataset.questionId;
            usedHints[questionId] = 0;
            currentHintIndex[questionId] = 0;
            
            // Garantir que tudo est√° escondido
            const hintContainer = document.getElementById(`hints-${questionId}`);
            if (hintContainer) {
                hintContainer.style.display = 'none';
                const hintSteps = hintContainer.querySelectorAll('.hint-step');
                hintSteps.forEach(step => {
                    step.style.display = 'none';
                });
                
                // ‚úÖ INICIALIZAR CONTADOR DE SEQU√äNCIA
                const sequenceCounter = document.createElement('div');
                sequenceCounter.id = `hint-sequence-${questionId}`;
                sequenceCounter.className = 'hint-sequence-counter mb-3 p-2 bg-blue-100 rounded-lg text-center hidden';
                sequenceCounter.innerHTML = `
                    <span class="text-blue-700 font-semibold">Dicas visualizadas: </span>
                    <span id="hint-sequence-text-${questionId}" class="text-blue-800 font-bold"></span>
                `;
                hintContainer.insertBefore(sequenceCounter, hintContainer.firstChild);
            }
        });
    }

    function showHint(questionId) {
        const hintContainer = document.getElementById(`hints-${questionId}`);
        const hintSteps = hintContainer.querySelectorAll('.hint-step');
        const totalHints = hintSteps.length;
        
        if (totalHints === 0) {
            alert("N√£o h√° dicas dispon√≠veis.");
            return;
        }
        
        // Se √© o primeiro clique
        if (usedHints[questionId] === 0) {
            // Mostrar container
            hintContainer.style.display = 'block';
            usedHints[questionId] = 1;
        } else if (usedHints[questionId] < totalHints) {
            // Mostrar pr√≥xima dica
            usedHints[questionId]++;
        } else {
            alert("Todas as dicas j√° foram mostradas!");
            return;
        }
        
        // ‚úÖ MOSTRAR TODAS AS DICAS J√Å USADAS (n√£o apenas a √∫ltima)
        for (let i = 0; i < usedHints[questionId]; i++) {
            hintSteps[i].style.display = 'block';
        }
        
        // Atualizar contador do bot√£o
        const hintBtn = document.querySelector(`.hint-btn[data-question-id="${questionId}"]`);
        const counter = hintBtn.querySelector('.hint-counter');
        const remaining = totalHints - usedHints[questionId];
        
        counter.textContent = remaining;
        
        if (remaining === 0) {
            hintBtn.disabled = true;
            counter.classList.add('bg-red-500', 'text-white');
        }
        
        // ‚úÖ MOSTRAR CONTADOR DE SEQU√äNCIA (opcional)
        showHintSequence(questionId);
    }

    // ===== SISTEMA DE QUEST√ïES =====
    function initializeQuestionEvents() {
        // Sistema de dicas - APENAS o bot√£o principal
        document.querySelectorAll('.hint-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const questionId = e.currentTarget.dataset.questionId;
                showHint(questionId);
            });
        });

        

        // ... resto dos event listeners



        // M√∫ltipla escolha
        document.querySelectorAll('.option-button').forEach(btn => {
            btn.addEventListener('click', handleMultipleChoice);
        });

        // Programa√ß√£o
        document.querySelectorAll('.run-code').forEach(btn => {
            btn.addEventListener('click', handleRunCode);
        });

        document.querySelectorAll('.check-code').forEach(btn => {
            btn.addEventListener('click', handleCheckCode);
        });

        // Completar lacunas
        document.querySelectorAll('.check-blank').forEach(btn => {
            btn.addEventListener('click', handleCheckBlank);
        });

        document.querySelectorAll('.word-option').forEach(option => {
            option.addEventListener('click', handleWordSelection);
        });

        // Navega√ß√£o
        document.querySelectorAll('.next-question').forEach(btn => {
            btn.addEventListener('click', nextQuestion);
        });

        document.querySelectorAll('.prev-question').forEach(btn => {
            btn.addEventListener('click', prevQuestion);
        });

        // Finalizar pr√°tica
        document.querySelectorAll('.finish-practice').forEach(btn => {
            btn.addEventListener('click', finishPractice);
        });
    }

    // ===== MANIPULADORES DE RESPOSTAS =====
    // Fun√ß√£o auxiliar para mostrar feedback no modo revis√£o
    function showReviewModeFeedback(questionId, tipo) {
        const messages = {
            'multiple-choice': 'üìù Modo revis√£o: Aprenda com os erros anteriores',
            'code': 'üìù Modo revis√£o: Melhore seu c√≥digo',
            'fill-blank': 'üìù Modo revis√£o: Complete corretamente as lacunas'
        };
        
        showFeedback(questionId, 'info', messages[tipo] || 'üìù Modo revis√£o: Aprendizado ativo', 0);
    }

    // Modifique as fun√ß√µes de verifica√ß√£o para o modo revis√£o
    async function handleMultipleChoice(e) {
        const btn = e.currentTarget;
        const questionContainer = btn.closest('.question-container');
        const questionId = questionContainer.dataset.questionId;
        const isCorrect = btn.dataset.correct === 'true';
        const xp = parseInt(questionContainer.querySelector('.bg-yellow-100').textContent.match(/\d+/)[0]);
        
        if (isReviewMode) {
            // ‚úÖ MODO REVIS√ÉO: Mostrar resposta correta e feedback educativo
            questionContainer.querySelectorAll('.option-button').forEach(option => {
                if (option.dataset.correct === 'true') {
                    option.classList.add('correct-answer', 'pulse-animation');
                }
                option.classList.add('opacity-70');
            });
            
            showReviewModeFeedback(questionId, 'multiple-choice');
            return;
        }
        
        // Remover sele√ß√£o anterior
        questionContainer.querySelectorAll('.option-button').forEach(option => {
            option.classList.remove('correct-answer', 'wrong-answer');
        });
        
        if (isCorrect) {
            btn.classList.add('correct-answer', 'bounce');
            showFeedback(questionId, 'correct', '‚úÖ Resposta correta!', xp);
            correctAnswers++;
            
            // ‚úÖ REGISTRAR ATIVIDADE COM STREAK (ACERTOU)
            const resultado = await registrarAtividadeStreak(xp, 'questao');
            const xpComBonus = resultado.xp_total;
            
            totalXP += xpComBonus;
            await saveProgress(questionId, true, xpComBonus);
            
            setTimeout(() => {
                if (currentQuestion < totalQuestions) {
                    nextQuestion();
                }
            }, 2000);
        } else {
            btn.classList.add('wrong-answer', 'shake');
            showFeedback(questionId, 'incorrect', '‚ùå Resposta incorreta.', 0);
            
            // ‚úÖ REGISTRAR ATIVIDADE COM STREAK (ERROU - mas mant√©m streak)
            await registrarAtividadeStreak(0, 'questao');
            
            // ‚úÖ CORRE√á√ÉO: Capturar o resultado do loseLife
            const resultado = await loseLife();
            
            // ‚úÖ ATUALIZAR CABE√áALHO AP√ìS ERRO
            await atualizarAposErro();
            await saveProgress(questionId, false, 0);
            
            // ‚úÖ CHAMAR END PRACTICE SE VIDAS ACABARAM (AGORA DEPOIS DO loseLife)
            if (resultado.vidasAcabaram) {
                setTimeout(() => {
                    endPracticeDueToLives();
                }, 1500);
                return; // Impede continuar
            }
        }
        // ‚úÖ MARCAR QUEST√ÉO COMO RESPONDIDA
        
        questionsAnswered.add(questionId);
        
        // ‚úÖ VERIFICAR SE PODE FINALIZAR
        checkAllQuestionsAnswered();
    }
    // ‚úÖ DEBUG ESPEC√çFICO PARA QUEST√ïES DE C√ìDIGO
    function debugQuestaoCodigo(questionId) {
        console.log("üíª === DEBUG DETALHADO C√ìDIGO ===");
        
        const questionContainer = document.querySelector(`[data-question-id="${questionId}"]`);
        const codeInput = document.getElementById(`code-input-${questionId}`);
        
        // 1. Verificar a sa√≠da esperada do template
        const expectedOutputRaw = `{{ questao.saida_esperada|default:"" }}`;
        console.log("üì• Sa√≠da esperada RAW:", expectedOutputRaw);
        console.log("üìè Tamanho RAW:", expectedOutputRaw.length);
        console.log("üîç Caracteres especiais:", Array.from(expectedOutputRaw).map(char => 
            char.charCodeAt(0)
        ));
        
        // 2. Verificar o c√≥digo do usu√°rio
        console.log("üìù C√≥digo do usu√°rio:", codeInput ? codeInput.value : 'N√ÉO ENCONTRADO');
        
        // 3. Testar a interpreta√ß√£o
        if (codeInput && codeInput.value) {
            console.log("üß™ Testando interpretPythonCode:");
            try {
                const output = interpretPythonCode(codeInput.value);
                console.log("üñ®Ô∏è Sa√≠da gerada:", output);
                console.log("üìè Tamanho sa√≠da:", output.length);
                
                // Compara√ß√£o EXTREMAMENTE detalhada
                const normalizedOutput = output.trim();
                const normalizedExpected = expectedOutputRaw.trim();
                
                console.log("üîç COMPARA√á√ÉO DETALHADA:");
                console.log("   Sa√≠da normalizada: '" + normalizedOutput + "'");
                console.log("   Esperada normalizada: '" + normalizedExpected + "'");
                console.log("   S√£o iguais?", normalizedOutput === normalizedExpected);
                
                // Compara√ß√£o case insensitive
                console.log("üîç COMPARA√á√ÉO CASE INSENSITIVE:");
                console.log("   Sa√≠da (lower): '" + normalizedOutput.toLowerCase() + "'");
                console.log("   Esperada (lower): '" + normalizedExpected.toLowerCase() + "'");
                console.log("   S√£o iguais?", normalizedOutput.toLowerCase() === normalizedExpected.toLowerCase());
                
            } catch (error) {
                console.error("‚ùå Erro na interpreta√ß√£o:", error);
            }
        }
        
        console.log("üíª === FIM DEBUG C√ìDIGO ===");
    }


    async function handleCheckCode(e) {
        const btn = e.currentTarget;
        const questionContainer = btn.closest('.question-container');
        const questionId = questionContainer.dataset.questionId;
        
        console.log("üéØ === IN√çCIO VERIFICA√á√ÉO C√ìDIGO ===");
        console.log("ID Quest√£o:", questionId);
        
        // ‚úÖ BUSCA ROBUSTA DA SA√çDA ESPERADA
        // ‚úÖ BUSCA ROBUSTA DA SA√çDA ESPERADA (CORRIGIDA)
        let expectedOutput = "";
        let source = "none";

        // ‚úÖ M√âTODO 1: Data attribute (MAIS SEGURO)
        const saidaElement = questionContainer.querySelector('[data-saida-esperada]');
        if (saidaElement) {
            expectedOutput = saidaElement.dataset.saidaEsperada;
            source = "data_attribute";
            console.log("üì• Sa√≠da esperada (data attribute):", expectedOutput);
        }

        // ‚úÖ M√âTODO 2: Elemento por ID (fallback)
        if (!expectedOutput) {
            const expectedOutputElement = questionContainer.querySelector('[id^="saida-esperada-"]');
            if (expectedOutputElement) {
                expectedOutput = expectedOutputElement.textContent.trim();
                source = "html";
                console.log("üì• Sa√≠da esperada (HTML):", expectedOutput);
            }
        }

        // ‚úÖ M√âTODO 3: Busca inteligente com filtros (√∫ltimo recurso)
        if (!expectedOutput) {
            const possibleOutputElements = questionContainer.querySelectorAll('pre, .code-output, [class*="output"]');
            possibleOutputElements.forEach(el => {
                const text = el.textContent.trim();
                
                // ‚úÖ FILTROS MAIS RESTRITIVOS
                const isExpectedOutput = 
                    !text.includes('C√≥digo Inicial') &&
                    !text.includes('Seu C√≥digo') &&
                    !text.includes('Dicas visualizadas') &&
                    !text.includes('Sa√≠da do c√≥digo') &&
                    !text.includes('Executando c√≥digo') &&
                    text.length > 2 &&
                    !el.closest('.hint-container');
                
                if (isExpectedOutput && !expectedOutput) { // S√≥ pega o primeiro
                    expectedOutput = text;
                    source = "auto_filtrado";
                    console.log("üì• Sa√≠da esperada (auto filtrado):", expectedOutput);
                }
            });
        }
        
        console.log("üéØ Sa√≠da esperada final:", expectedOutput, "(fonte:", source + ")");
        
        const codeInput = document.getElementById(`code-input-${questionId}`);
        const xpElement = questionContainer.querySelector('.bg-yellow-100');
        const xp = xpElement ? parseInt(xpElement.textContent.match(/\d+/)[0]) : 10;
        
        if (isReviewMode) {
            if (expectedOutput) {
                showFeedback(questionId, 'info', `üìù Modo revis√£o: Sa√≠da esperada:\n${expectedOutput}`, 0);
            } else {
                showFeedback(questionId, 'info', `üìù Modo revis√£o: Execute o c√≥digo para ver o resultado`, 0);
            }
            return;
        }
        
        const userCode = codeInput.value.trim();
        console.log("üìù C√≥digo do usu√°rio:", userCode);
        
        let isCorrect = false;
        let feedbackMessage = '';
        let output = "";
        
        try {
            output = interpretPythonCode(userCode);
            console.log("üñ®Ô∏è Sa√≠da gerada:", output);
            
            // ‚úÖ L√ìGICA DE VERIFICA√á√ÉO INTELIGENTE
            if (!expectedOutput) {
                // Caso 1: N√£o h√° sa√≠da esperada - verificar se executa sem erro
                isCorrect = true;
                feedbackMessage = '‚úÖ C√≥digo executado com sucesso!\nSa√≠da: ' + output;
                console.log("‚úÖ Sem sa√≠da esperada - aprovado por execu√ß√£o");
            } else if (!output.trim() && expectedOutput.trim()) {
                // Caso 2: H√° sa√≠da esperada mas o c√≥digo n√£o produz nada
                isCorrect = false;
                feedbackMessage = `‚ùå C√≥digo n√£o produz a sa√≠da esperada.\nEsperado: "${expectedOutput}"\nSeu c√≥digo n√£o imprime nada.`;
                console.log("‚ùå C√≥digo n√£o produz sa√≠da");
            } else {
                // Caso 3: Comparar sa√≠das
                const normalizedOutput = output.trim();
                const normalizedExpected = expectedOutput.trim();
                
                console.log("üîç COMPARA√á√ÉO DETALHADA:");
                console.log("   Sa√≠da gerada:", `"${normalizedOutput}"`);
                console.log("   Esperada:", `"${normalizedExpected}"`);
                
                // Estrat√©gias de compara√ß√£o
                if (normalizedOutput === normalizedExpected) {
                    isCorrect = true;
                    feedbackMessage = '‚úÖ C√≥digo correto! Sa√≠da esperada alcan√ßada.';
                } else if (normalizedOutput.toLowerCase() === normalizedExpected.toLowerCase()) {
                    isCorrect = true;
                    feedbackMessage = '‚úÖ C√≥digo correto! (Diferen√ßa de case ignorada)';
                } else if (normalizedOutput.replace(/\s+/g, ' ') === normalizedExpected.replace(/\s+/g, ' ')) {
                    isCorrect = true;
                    feedbackMessage = '‚úÖ C√≥digo correto! (Espa√ßos normalizados)';
                } else {
                    isCorrect = false;
                    feedbackMessage = `‚ùå C√≥digo incorreto.\nSua sa√≠da: "${output}"\nEsperado: "${expectedOutput}"`;
                }
            }
            
            // ‚úÖ REGISTRAR NO STREAK
            if (isCorrect) {
                correctAnswers++;
                const resultadoStreak = await registrarAtividadeStreak(xp, 'codigo');
                const xpComBonus = resultadoStreak.xp_total;
                totalXP += xpComBonus;
                console.log("üí∞ XP ganho:", xpComBonus);
            } else {
                await registrarAtividadeStreak(0, 'codigo');
            }
            
        } catch (error) {
            isCorrect = false;
            feedbackMessage = `‚ùå Erro na execu√ß√£o: ${error.message}`;
            await registrarAtividadeStreak(0, 'codigo');
            console.error("üí• Erro:", error);
        }
        
        console.log("üìä Resultado final:", isCorrect ? "‚úÖ CORRETO" : "‚ùå ERRADO");
        console.log("üéØ === FIM VERIFICA√á√ÉO ===");
        
        showFeedback(questionId, isCorrect ? 'correct' : 'incorrect', feedbackMessage, isCorrect ? xp : 0);
        await saveProgress(questionId, isCorrect, isCorrect ? xp : 0);
        
        // ‚úÖ MARCAR QUEST√ÉO COMO RESPONDIDA
        questionsAnswered.add(questionId);
        checkAllQuestionsAnswered();
        
        if (isCorrect) {
            setTimeout(() => {
                if (currentQuestion < totalQuestions) {
                    nextQuestion();
                }
            }, 2000);
        } else {
            const resultado = await loseLife();
            await atualizarAposErro();
            
            if (resultado.vidasAcabaram) {
                setTimeout(() => {
                    endPracticeDueToLives();
                }, 1500);
                return;
            }
        }
    }
    async function handleCheckBlank(e) {
        const btn = e.currentTarget;
        const questionContainer = btn.closest('.question-container');
        const questionId = questionContainer.dataset.questionId;
        const xp = parseInt(questionContainer.querySelector('.bg-yellow-100').textContent.match(/\d+/)[0]);
        
        console.log("üéØ === IN√çCIO VERIFICA√á√ÉO LACUNAS ===");
        console.log("ID Quest√£o:", questionId);
        
        if (isReviewMode) {
            // ‚úÖ MODO REVIS√ÉO: Preencher automaticamente as lacunas corretas
            const blankInputs = questionContainer.querySelectorAll('.blank-input');
            const respostasCorretas = getCorrectAnswersForReview(questionId);
            
            console.log("üìù MODO REVIS√ÉO - Preenchendo respostas:", respostasCorretas);
            
            blankInputs.forEach((input, index) => {
                const respostaCorreta = respostasCorretas[index] || "Resposta n√£o dispon√≠vel";
                input.value = respostaCorreta;
                input.classList.add('blank-filled', 'correct-answer');
                input.disabled = true;
            });
            
            showReviewModeFeedback(questionId, 'fill-blank');
            return;
        }
        
        // Verificar se todas as lacunas foram preenchidas
        const blankInputs = questionContainer.querySelectorAll('.blank-input');
        let allFilled = true;
        
        blankInputs.forEach(input => {
            if (!input.value.trim()) {
                allFilled = false;
                input.classList.add('shake');
                setTimeout(() => input.classList.remove('shake'), 500);
            }
        });
        
        if (!allFilled) {
            showFeedback(questionId, 'incorrect', '‚ùå Preencha todas as lacunas antes de verificar.', 0);
            return;
        }
        
        // ‚úÖ CORRE√á√ÉO COMPLETA: Verifica√ß√£o real das respostas
        let isCorrect = true;
        let incorrectAnswers = [];
        const respostasCorretas = getCorrectAnswersForReview(questionId);
        
        console.log("üîç VERIFICA√á√ÉO DAS RESPOSTAS:");
        console.log("   Respostas corretas:", respostasCorretas);
        
        // Remover classes anteriores
        blankInputs.forEach(input => {
            input.classList.remove('correct-answer', 'wrong-answer', 'blank-filled');
        });
        
        // Verificar cada lacuna
        blankInputs.forEach((input, index) => {
            const userAnswer = input.value.trim().toLowerCase();
            const correctAnswer = respostasCorretas[index] ? respostasCorretas[index].toLowerCase() : "";
            
            console.log(`   Lacuna ${index + 1}:`);
            console.log(`      Usu√°rio: "${userAnswer}"`);
            console.log(`      Correto: "${correctAnswer}"`);
            
            if (userAnswer === correctAnswer) {
                // ‚úÖ RESPOSTA CORRETA
                input.classList.add('correct-answer', 'blank-filled');
                console.log(`      ‚úÖ CORRETO`);
            } else {
                // ‚ùå RESPOSTA ERRADA
                isCorrect = false;
                incorrectAnswers.push(index + 1);
                input.classList.add('wrong-answer', 'shake');
                console.log(`      ‚ùå ERRADO`);
            }
        });
        
        console.log(`üìä RESULTADO: ${isCorrect ? '‚úÖ TODAS CORRETAS' : '‚ùå ALGUMAS ERRADAS'}`);
        
        if (isCorrect) {
            showFeedback(questionId, 'correct', '‚úÖ Todas as lacunas preenchidas corretamente!', xp);
            correctAnswers++;
            
            const resultadoStreak = await registrarAtividadeStreak(xp, 'lacunas');
            const xpComBonus = resultadoStreak.xp_total;
            
            totalXP += xpComBonus;
            await saveProgress(questionId, true, xpComBonus);
            
            setTimeout(() => {
                if (currentQuestion < totalQuestions) {
                    nextQuestion();
                }
            }, 2000);
        } else {
            let errorMessage = '‚ùå Algumas lacunas est√£o incorretas.';
            if (incorrectAnswers.length > 0) {
                errorMessage += ` Lacunas ${incorrectAnswers.join(', ')} est√£o erradas.`;
            }
            
            showFeedback(questionId, 'incorrect', errorMessage, 0);
            
            await registrarAtividadeStreak(0, 'lacunas');
            
            const resultado = await loseLife();
            
            await atualizarAposErro();
            
            if (resultado.vidasAcabaram) {
                setTimeout(() => {
                    endPracticeDueToLives();
                }, 1500);
                return;
            }
            
            await saveProgress(questionId, false, 0);
        }
        // ‚úÖ MARCAR QUEST√ÉO COMO RESPONDIDA
        
        questionsAnswered.add(questionId);
        
        // ‚úÖ VERIFICAR SE PODE FINALIZAR
        checkAllQuestionsAnswered();
        
        console.log("üéØ === FIM VERIFICA√á√ÉO LACUNAS ===");
    }

    function handleWordSelection(e) {
        const word = e.currentTarget;
        const wordText = word.dataset.answer;
        
        // Encontrar a primeira lacuna vazia
        const blankInput = document.querySelector('.blank-input:placeholder-shown');
        if (blankInput) {
            blankInput.value = wordText;
            blankInput.classList.add('blank-filled');
            word.style.display = 'none'; // Esconder palavra usada
            
            
        }
    }
    // ‚úÖ DEBUG DETALHADO DA ATRIBUI√á√ÉO
    function debugAtribuicao() {
        console.log("=== üêõ DEBUG ATRIBUI√á√ÉO ===");
        
        // Teste direto do regex
        const testLines = [
            "x=1",
            "x = 1", 
            "y = \"texto\"",
            "z = [1, 2, 3]"
        ];
        
        testLines.forEach(line => {
            const match = line.match(/^(\w+)\s*=\s*(.+)$/);
            console.log(`Linha: "${line}"`);
            console.log(`Match:`, match);
            if (match) {
                console.log(`Vari√°vel: ${match[1]}, Valor: ${match[2]}`);
            }
            console.log('---');
        });
        
        console.log("=== FIM DEBUG ===");
    }

    // Execute para ver o problema
    debugAtribuicao();

    function interpretPythonCode(code) {
        let output = "";
        const variables = {};
        const functions = {};
        
        try {
            const lines = code.split('\n');
            let i = 0;
            
            // ‚úÖ FUN√á√ÉO PARA VERIFICAR INDENTA√á√ÉO
            function isIndented(line, referenceLine) {
                if (!referenceLine || !line || line.trim() === '') return false;
                
                const refIndent = referenceLine.length - referenceLine.trimStart().length;
                const lineIndent = line.length - line.trimStart().length;
                
                return lineIndent > refIndent;
            }
            
            // ‚úÖ FUN√á√ÉO PARA PROCESSAR BLOCO DE C√ìDIGO
            function processBlock(blockLines, localVars = {}) {
                console.log("üì¶ Processando bloco com", blockLines.length, "linhas:", blockLines);
                
                const mergedVars = { ...variables, ...localVars };
                let blockOutput = "";
                let j = 0;
                
                while (j < blockLines.length) {
                    let currentLine = blockLines[j];
                    
                    // Manter linhas originais para verifica√ß√£o de indenta√ß√£o
                    if (!currentLine || currentLine.trim() === '' || currentLine.trim().startsWith('#')) {
                        j++;
                        continue;
                    }
                    
                    const trimmedLine = currentLine.trim();
                    console.log(`   üìù Linha ${j} [original]: "${currentLine}"`);
                    console.log(`   üìù Linha ${j} [trimmed]: "${trimmedLine}"`);
                    // ‚úÖ ATRIBUI√á√ÉO DE VARI√ÅVEIS - DEVE VIR PRIMEIRO!
                    const assignmentMatch = trimmedLine.match(/^(\w+)\s*=\s*(.+)$/);
                    if (assignmentMatch) {
                        const varName = assignmentMatch[1];
                        const valueExpr = assignmentMatch[2];
                        
                        console.log(`   üíæ Atribui√ß√£o encontrada: ${varName} = ${valueExpr}`);
                        
                        // Avaliar a express√£o do valor
                        const value = evaluateExpression(valueExpr, mergedVars);
                        console.log(`   ‚úÖ ${varName} = ${value}`);
                        
                        // ‚úÖ SALVAR NO ESCOPO LOCAL E GLOBAL
                        mergedVars[varName] = value;
                        variables[varName] = value; // ‚Üê LINHA CR√çTICA QUE FALTAVA
                        
                        j++;
                        continue;
                    }
                    
                    
                    // ‚úÖ IF/ELIF/ELSE
                    if (trimmedLine.startsWith('if ') || trimmedLine.startsWith('elif ') || trimmedLine.startsWith('else:')) {
                        let conditionResult = false;
                        let blockToExecute = [];
                        
                        // PROCESSAR CONDI√á√ÉO
                        if (trimmedLine.startsWith('if ')) {
                            const ifMatch = trimmedLine.match(/^if\s+(.+):$/);
                            if (ifMatch) {
                                conditionResult = evaluateCondition(ifMatch[1], mergedVars);
                                console.log(`   üîç IF "${ifMatch[1]}": ${conditionResult}`);
                            }
                        }
                        else if (trimmedLine.startsWith('elif ')) {
                            const elifMatch = trimmedLine.match(/^elif\s+(.+):$/);
                            if (elifMatch) {
                                let previousExecuted = false;
                                for (let k = 0; k < j; k++) {
                                    const prevLine = blockLines[k].trim();
                                    if (prevLine.startsWith('if ') || prevLine.startsWith('elif ')) {
                                        const prevMatch = prevLine.match(/^(if|elif)\s+(.+):$/);
                                        if (prevMatch && evaluateCondition(prevMatch[2], mergedVars)) {
                                            previousExecuted = true;
                                            break;
                                        }
                                    }
                                }
                                
                                conditionResult = !previousExecuted && evaluateCondition(elifMatch[1], mergedVars);
                                console.log(`   üîç ELIF "${elifMatch[1]}": ${conditionResult}`);
                            }
                        }
                        else if (trimmedLine.startsWith('else:')) {
                            let anyPreviousExecuted = false;
                            for (let k = 0; k < j; k++) {
                                const prevLine = blockLines[k].trim();
                                if (prevLine.startsWith('if ') || prevLine.startsWith('elif ')) {
                                    const prevMatch = prevLine.match(/^(if|elif)\s+(.+):$/);
                                    if (prevMatch && evaluateCondition(prevMatch[2], mergedVars)) {
                                        anyPreviousExecuted = true;
                                        break;
                                    }
                                }
                            }
                            conditionResult = !anyPreviousExecuted;
                            console.log(`   üîç ELSE: ${conditionResult}`);
                        }
                        
                        // ENCONTRAR BLOCO
                        let k = j + 1;
                        while (k < blockLines.length && isIndented(blockLines[k], currentLine)) {
                            blockToExecute.push(blockLines[k]);
                            k++;
                        }
                        
                        console.log(`   üìÇ Bloco da condi√ß√£o: ${blockToExecute.length} linhas`);
                        
                        if (conditionResult) {
                            console.log("   ‚úÖ Executando bloco");
                            blockOutput += processBlock(blockToExecute, mergedVars);
                        } else {
                            console.log("   ‚ùå Pulando bloco");
                        }
                        
                        j = k;
                        continue;
                    }
                    
                    // ‚úÖ ATRIBUI√á√ÉO
                    
                    
                    // ‚úÖ PRINT
                    if (trimmedLine.startsWith('print(') && trimmedLine.endsWith(')')) {
                        const content = trimmedLine.slice(6, -1).trim();
                        const result = processPrintContent(content, mergedVars);
                        blockOutput += result + '\n';
                        console.log(`   üñ®Ô∏è "${result}"`);
                    }
                    
                    j++;
                }
                
                return blockOutput;
            }
            // ‚úÖ FUN√á√ÉO PARA CALCULAR EXPRESS√ïES MATEM√ÅTICAS
            function calcularExpressao(expr, vars) {
                expr = expr.trim();
                console.log(`   üßÆ Calculando express√£o: "${expr}"`);
                
                // Tentar como n√∫mero simples
                if (/^\-?\d+$/.test(expr)) {
                    return parseInt(expr);
                }
                
                // Tentar como soma: x + z
                if (expr.includes('+')) {
                    const partes = expr.split('+').map(p => p.trim());
                    console.log(`   ‚ûï Partes da soma:`, partes);
                    
                    let resultado = 0;
                    for (const parte of partes) {
                        // Se for n√∫mero
                        if (/^\-?\d+$/.test(parte)) {
                            resultado += parseInt(parte);
                            console.log(`   üî¢ Somando n√∫mero: ${parte} ‚Üí ${resultado}`);
                        } 
                        // Se for vari√°vel
                        else if (vars[parte] !== undefined) {
                            const valor = vars[parte];
                            if (typeof valor === 'number') {
                                resultado += valor;
                                console.log(`   üíæ Somando vari√°vel ${parte}=${valor} ‚Üí ${resultado}`);
                            } else {
                                console.log(`   ‚ö†Ô∏è  Vari√°vel ${parte} n√£o √© n√∫mero: ${valor}`);
                                
                            }
                        }
                        // Se n√£o for reconhecido
                        else {
                            console.log(`   ‚ùå Parte n√£o reconhecida: "${parte}"`);
                            ;
                        }
                    }
                    console.log(`   ‚úÖ Resultado da soma: ${resultado}`);
                    return resultado;
                }
                
                // Se for apenas uma vari√°vel
                if (vars[expr] !== undefined) {
                    console.log(`   üíæ Retornando vari√°vel: ${expr} = ${vars[expr]}`);
                    return vars[expr];
                }
                
                // Se n√£o for reconhecido, retorna como string
                console.log(`   ‚ö†Ô∏è  Express√£o n√£o reconhecida, retornando como string: "${expr}"`);
                
            }
            // ‚úÖ FUN√á√ÉO CORRIGIDA PARA AVALIAR EXPRESS√ïES
            function evaluateExpression(expr, vars) {
                expr = expr.trim();
                console.log(`   üßÆ Avaliando express√£o: "${expr}"`);
                
                // ‚úÖ N√∫meros inteiros
                if (/^\-?\d+$/.test(expr)) {
                    const result = parseInt(expr);
                    console.log(`   üî¢ N√∫mero inteiro: ${result}`);
                    return result;
                }
                
                // ‚úÖ Listas - CORRE√á√ÉO CR√çTICA
                const listMatch = expr.match(/^\[([^\]]*)\]$/);
                if (listMatch) {
                    console.log(`   üìã Detectada lista: ${expr}`);
                    
                    // ‚úÖ CASO: lista vazia []
                    if (listMatch[1].trim() === '') {
                        console.log(`   ‚úÖ Lista vazia: []`);
                        return [];
                    }
                    
                    const items = listMatch[1].split(',').map(item => {
                        let trimmed = item.trim();
                        if (trimmed === '') return undefined;
                        
                        // ‚úÖ Converter n√∫meros (incluindo negativos)
                        if (/^\-?\d+$/.test(trimmed)) {
                            const num = parseInt(trimmed);
                            console.log(`   üî¢ Convertido para n√∫mero: ${num}`);
                            return num;
                        }
                        
                        // ‚úÖ Remover aspas de strings
                        if ((trimmed.startsWith('"') && trimmed.endsWith('"')) || 
                            (trimmed.startsWith("'") && trimmed.endsWith("'"))) {
                            const str = trimmed.slice(1, -1);
                            console.log(`   üìù Convertido para string: "${str}"`);
                            return str;
                        }
                        
                        // ‚úÖ Buscar vari√°veis
                        if (vars[trimmed] !== undefined) {
                            console.log(`   üíæ Usando vari√°vel: ${trimmed} = ${vars[trimmed]}`);
                            return vars[trimmed];
                        }
                        
                        console.log(`   ‚ö†Ô∏è  Item mantido como string: "${trimmed}"`);
                        return trimmed;
                    }).filter(item => item !== undefined);
                    
                    console.log(`   ‚úÖ Lista final:`, items);
                    return items;
                }

                // ‚úÖ ‚úÖ ‚úÖ ADICIONAR ESTA SE√á√ÉO PARA SOMA (FALTANDO) ‚úÖ ‚úÖ ‚úÖ
                // ‚úÖ SOMA: x + y
                if (expr.includes('+')) {
                    const partes = expr.split('+').map(p => p.trim());
                    console.log(`   ‚ûï Detectada soma:`, partes);
                    
                    let resultado = 0;
                    let todasPartesNumericas = true;
                    
                    for (const parte of partes) {
                        // Se for n√∫mero
                        if (/^\-?\d+$/.test(parte)) {
                            resultado += parseInt(parte);
                            console.log(`   üî¢ Somando n√∫mero: ${parte} ‚Üí ${resultado}`);
                        } 
                        // Se for vari√°vel
                        else if (vars[parte] !== undefined) {
                            const valor = vars[parte];
                            if (typeof valor === 'number') {
                                resultado += valor;
                                console.log(`   üíæ Somando vari√°vel ${parte}=${valor} ‚Üí ${resultado}`);
                            } else {
                                console.log(`   ‚ö†Ô∏è  Vari√°vel ${parte} n√£o √© n√∫mero: ${valor}`);
                                todasPartesNumericas = false;
                                break;
                            }
                        }
                        // Se n√£o for reconhecido
                        else {
                            console.log(`   ‚ùå Parte n√£o reconhecida: "${parte}"`);
                            todasPartesNumericas = false;
                            break;
                        }
                    }
                    
                    if (todasPartesNumericas) {
                        console.log(`   ‚úÖ Resultado da soma: ${resultado}`);
                        return resultado;
                    } else {
                        console.log(`   ‚ùå N√£o foi poss√≠vel calcular a soma, retornando express√£o`);
                        
                    }
                }

                // ‚úÖ Strings entre aspas
                if ((expr.startsWith('"') && expr.endsWith('"')) || 
                    (expr.startsWith("'") && expr.endsWith("'"))) {
                    const result = expr.slice(1, -1);
                    console.log(`   üìù String: "${result}"`);
                    return result;
                }
                
                // ‚úÖ Vari√°veis existentes
                if (vars[expr] !== undefined) {
                    console.log(`   üíæ Vari√°vel ${expr} =`, vars[expr]);
                    return vars[expr];
                }
                
                
            }
            
            // ‚úÖ PROCESSAR LINHAS PRINCIPAIS
            while (i < lines.length) {
                const line = lines[i];
                const trimmedLine = line.trim();
                
                if (!trimmedLine || trimmedLine.startsWith('#')) {
                    i++;
                    continue;
                }
                
                console.log(`üî∑ Linha ${i}: "${line}"`);

                // ‚úÖ CORRE√á√ÉO: ATRIBUI√á√ÉO GLOBAL
                if (line.includes('=')) {
                    const parts = line.split('=').map(p => p.trim());
                    if (parts.length === 2 && /^[a-zA-Z_][a-zA-Z0-9_]*$/.test(parts[0])) {
                        const varName = parts[0];
                        const valueExpr = parts[1];
                        
                        console.log(`üíæ DETECTEI ATRIBUI√á√ÉO: ${varName} = ${valueExpr}`);
                        
                        // ‚úÖ USAR evaluateExpression CORRIGIDA
                        let value = evaluateExpression(valueExpr, variables);
                        
                        // ‚úÖ VERIFICAR SE A LISTA FOI CONVERTIDA CORRETAMENTE
                        console.log(`   üîç Valor ap√≥s evaluateExpression:`, value, `(tipo: ${typeof value})`);
                        
                        if (typeof value === 'string' && value.startsWith('[') && value.endsWith(']')) {
                            // ‚ùå CASO DE FALHA: tentar converter manualmente
                            console.log(`   ‚ö†Ô∏è  Lista ainda como string - convertendo manualmente`);
                            try {
                                value = JSON.parse(value.replace(/'/g, '"'));
                                console.log(`   ‚úÖ Lista convertida manualmente:`, value);
                            } catch (e) {
                                console.log(`   ‚ùå Falha na convers√£o manual`);
                            }
                        }
                        
                        // ‚úÖ SALVAR VARI√ÅVEL
                        variables[varName] = value;
                        console.log(`‚úÖ VARI√ÅVEL SALVA: variables["${varName}"] =`, value);
                        console.log("üìä VARI√ÅVEIS DEPOIS:", variables);
                        
                        i++;
                        continue;
                    }
                }
                // ‚úÖ FOR LOOPS NO ESCOPO GLOBAL - ADICIONAR ESTA SE√á√ÉO
                    const forListMatchGlobal = trimmedLine.match(/^for\s+(\w+)\s+in\s+(\w+):$/);
                    if (forListMatchGlobal) {
                        const varName = forListMatchGlobal[1];
                        const listName = forListMatchGlobal[2];
                        
                        console.log(`üéØüéØüéØ FOR LOOP GLOBAL DETECTADO: for ${varName} in ${listName}`);
                        
                        if (variables[listName] && Array.isArray(variables[listName])) {
                            const lista = variables[listName];
                            
                            console.log(`   üìä Lista encontrada:`, lista);
                            
                            // ‚úÖ ENCONTRAR BLOCO DO LOOP
                            const forBlockLines = [];
                            let k = i + 1;
                            
                            while (k < lines.length) {
                                const currentLine = lines[k];
                                
                                if (currentLine.trim() === '') {
                                    k++;
                                    continue;
                                }
                                
                                const lineIndent = currentLine.length - currentLine.trimStart().length;
                                const forIndent = line.length - line.trimStart().length;
                                
                                if (lineIndent > forIndent) {
                                    console.log(`   ‚úÖ Adicionando ao bloco: "${currentLine}"`);
                                    forBlockLines.push(currentLine);
                                    k++;
                                } else {
                                    console.log(`   ‚ùå Fim do bloco: "${currentLine}"`);
                                    break;
                                }
                            }
                            
                            console.log(`   üì¶ Bloco do loop: ${forBlockLines.length} linhas`, forBlockLines);
                            
                            // ‚úÖ EXECUTAR LOOP
                            let loopOutput = "";
                            for (const valor of lista) {
                                console.log(`   üîÑ ${varName} = ${valor}`);
                                
                                const loopVars = { ...variables, [varName]: valor };
                                
                                // ‚úÖ PROCESSAR BLOCO DO LOOP
                                const iterationOutput = processBlock(forBlockLines, loopVars);
                                loopOutput += iterationOutput;
                            }
                            
                            output += loopOutput;
                            i = k; // Pular para depois do bloco
                            continue;
                            
                        } else {
                            console.log(`‚ùå Lista ${listName} n√£o encontrada:`, variables[listName]);
                        }
                        
                        i++;
                        continue;
                    }

                // ... resto do seu c√≥digo (def, function call, print, etc)

                
                // ‚úÖ DEF FUNCTIONS - CORRIGIDO
                const defMatch = trimmedLine.match(/^def\s+(\w+)\(\):/);
                if (defMatch) {
                    const funcName = defMatch[1];
                    
                    // ENCONTRAR BLOCO COMPLETO
                    const funcBlockLines = [];
                    let k = i + 1;
                    
                    while (k < lines.length) {
                        const currentLine = lines[k];
                        
                        if (currentLine.trim() === '') {
                            funcBlockLines.push(currentLine);
                            k++;
                        } else {
                            const lineIndent = currentLine.length - currentLine.trimStart().length;
                            const defIndent = line.length - line.trimStart().length;
                            
                            if (lineIndent > defIndent) {
                                funcBlockLines.push(currentLine);
                                k++;
                            } else {
                                break;
                            }
                        }
                    }
                    
                    functions[funcName] = funcBlockLines;
                    console.log(`üìù Fun√ß√£o ${funcName} definida com ${funcBlockLines.length} linhas`);
                    
                    i = k;
                    continue;
                }
                
                // ‚úÖ CHAMADA DE FUN√á√ÉO
                const callMatch = trimmedLine.match(/^(\w+)\(\)$/);
                if (callMatch && functions[callMatch[1]]) {
                    const funcName = callMatch[1];
                    console.log(`üî§ Chamando ${funcName}()`);
                    output += processBlock(functions[funcName], {});
                    i++;
                    continue;
                }
                
                
                
                // ‚úÖ PRINT
                if (trimmedLine.startsWith('print(') && trimmedLine.endsWith(')')) {
                    const content = trimmedLine.slice(6, -1).trim();
                    const result = processPrintContent(content, variables);
                    output += result + '\n';
                    console.log(`üñ®Ô∏è "${result}"`);
                }
                
                i++;
            }
            
            return output.trim() || "# Execu√ß√£o conclu√≠da";
            
        } catch (error) {
            return `# Erro: ${error.message}`;
        }
    }

    // ‚úÖ FUN√á√ïES AUXILIARES (manter as mesmas)
    function evaluateCondition(condition, variables) {
        condition = condition.trim();
        console.log(`   üßÆ Avaliando: "${condition}"`);
        
        if (condition.includes(' and ')) {
            const parts = condition.split(' and ').map(part => part.trim());
            for (const part of parts) {
                if (!evaluateCondition(part, variables)) return false;
            }
            return true;
        }
        
        const patterns = [
            [/^(\w+)\s*<\s*(\d+)$/, (v, n) => variables[v] < parseInt(n)],
            [/^(\w+)\s*<=\s*(\d+)$/, (v, n) => variables[v] <= parseInt(n)],
            [/^(\w+)\s*>\s*(\d+)$/, (v, n) => variables[v] > parseInt(n)],
            [/^(\w+)\s*>=\s*(\d+)$/, (v, n) => variables[v] >= parseInt(n)],
        ];
        
        for (const [pattern, fn] of patterns) {
            const match = condition.match(pattern);
            if (match && variables[match[1]] !== undefined) {
                const result = fn(match[1], match[2]);
                console.log(`   üìä ${match[1]}=${variables[match[1]]}, ${condition} = ${result}`);
                return result;
            }
        }
        
        return false;
    }

    // ‚úÖ FUN√á√ÉO CORRIGIDA PARA PROCESSAR CONTE√öDO DO PRINT
    // ‚úÖ FUN√á√ÉO processPrintContent CORRIGIDA
    function processPrintContent(content, variables) {
        content = content.trim();
        console.log(`   üîç Processando print: "${content}"`);
        
        // ‚úÖ CORRE√á√ÉO: Divis√£o inteligente que respeita strings
        const args = splitRespectingStrings(content);
        
        if (args.length > 1) {
            let result = '';
            
            console.log(`   üîó Argumentos com v√≠rgula:`, args);
            
            for (const arg of args) {
                if (result !== '') result += ' '; // Espa√ßo entre argumentos
                
                let argValue = processPrintArgument(arg, variables);
                result += argValue;
            }
            
            console.log(`   üéØ Resultado final: "${result}"`);
            return result;
        }
        
        // ‚úÖ Processamento normal para √∫nico argumento
        return processPrintArgument(content, variables);
    }

    // ‚úÖ NOVA FUN√á√ÉO: Divide respeitando strings
    function splitRespectingStrings(content) {
        const args = [];
        let current = '';
        let inString = false;
        let stringChar = '';
        
        for (let i = 0; i < content.length; i++) {
            const char = content[i];
            
            // Toggle string mode
            if ((char === '"' || char === "'") && !inString) {
                inString = true;
                stringChar = char;
                current += char;
            } else if (char === stringChar && inString) {
                inString = false;
                current += char;
            } 
            // Split on comma only when not in string
            else if (char === ',' && !inString) {
                args.push(current.trim());
                current = '';
            } else {
                current += char;
            }
        }
        
        // Add the last part
        if (current.trim()) {
            args.push(current.trim());
        }
        
        return args;
    }

    // ‚úÖ NOVA FUN√á√ÉO: Processa um √∫nico argumento do print
    function processPrintArgument(arg, variables) {
        console.log(`   üß© Processando argumento: "${arg}"`);
        
        // 1. str(idade) - converter vari√°vel para string
        if (arg.startsWith('str(') && arg.endsWith(')')) {
            const varName = arg.slice(4, -1).trim();
            const value = variables[varName];
            console.log(`   üß™ str(${varName}) = ${value}`);
            return value !== undefined ? String(value) : `# Erro: '${varName}' n√£o definida`;
        }
        
        // 2. Concatena√ß√£o com +
        if (arg.includes('+')) {
            const parts = arg.split('+').map(part => part.trim());
            let result = '';
            
            console.log(`   üîó Partes da concatena√ß√£o:`, parts);
            
            for (const part of parts) {
                let partValue = processPrintArgument(part, variables); // ‚úÖ Recursivo
                result += partValue;
            }
            
            return result;
        }
        
        // 3. String literal
        if ((arg.startsWith('"') && arg.endsWith('"')) || 
            (arg.startsWith("'") && arg.endsWith("'"))) {
            const result = arg.slice(1, -1);
            console.log(`   üìù String literal: "${result}"`);
            return result;
        }
        
        // 4. Vari√°vel
        if (variables[arg] !== undefined) {
            const value = variables[arg];
            const result = formatValueForPrint(value);
            console.log(`   üíæ Vari√°vel ${arg} = "${result}"`);
            return result;
        }
        
        // 5. Vari√°vel n√£o definida
        if (/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(arg)) {
            console.log(`   ‚ùå Vari√°vel n√£o definida: "${arg}"`);
            return `# Erro: '${arg}' n√£o definida`;
        }
        
        // 6. N√∫mero ou texto simples
        console.log(`   üî§ Texto simples: "${arg}"`);
        return arg;
    }

    // ‚úÖ NOVA FUN√á√ÉO: FORMATAR VALORES PARA PRINT
    function formatValueForPrint(value) {
        if (Array.isArray(value)) {
            // ‚úÖ FORMATAR ARRAY como string Python-style
            return '[' + value.map(item => 
                typeof item === 'string' ? `"${item}"` : String(item)
            ).join(', ') + ']';
        }
        return String(value);
    }

    function toString(value) {
        if (value === undefined || value === null) return "None";
        if (Array.isArray(value)) return `[${value.join(', ')}]`;
        return String(value);
    }

    // Fun√ß√£o handleRunCode usando o interpretador
    function handleRunCode(e) {
        const btn = e.currentTarget;
        const questionContainer = btn.closest('.question-container');
        const questionId = questionContainer.dataset.questionId;
        const codeInput = document.getElementById(`code-input-${questionId}`);
        const codeOutput = document.getElementById(`code-output-${questionId}`);
        
        const userCode = codeInput.value;
        
        codeOutput.innerHTML = '<div class="text-yellow-400">Executando c√≥digo...</div>';
        codeOutput.classList.remove('hidden');
        
        setTimeout(() => {
            try {
                let output = interpretPythonCode(userCode);
                codeOutput.innerHTML = `<pre class="text-green-400 bg-gray-900 p-4 rounded-lg">${output}</pre>`;
                
            } catch (error) {
                codeOutput.innerHTML = `<pre class="text-red-400 bg-gray-900 p-4 rounded-lg">Erro: ${error.message}</pre>`;
            }
        }, 500);
    }

    // ===== FEEDBACK E NAVEGA√á√ÉO =====
    function showFeedback(questionId, type, message, xp) {
        const feedback = document.getElementById(`feedback-${questionId}`);
        feedback.innerHTML = message;
        feedback.className = `feedback-message feedback-${type}`;
        feedback.classList.remove('hidden');
        
        if (type === 'correct' && xp > 0 && !isReviewMode) {
            showXPGain(xp);
        }
    }

    function showXPGain(amount) {
        const xpEffect = document.createElement('div');
        xpEffect.className = 'fixed top-6 right-6 xp-gain-notification z-30';
        xpEffect.innerHTML = `
            <div class="xp-gain-content">
                <div class="xp-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2L13.09 8.26L20 8.26L14.55 12.77L16.18 19.02L12 15.77L7.82 19.02L9.45 12.77L4 8.26L10.91 8.26L12 2Z" 
                            fill="currentColor"/>
                    </svg>
                </div>
                <div class="xp-text">
                    <span class="xp-amount">+${amount}</span>
                    <span class="xp-label">XP</span>
                </div>
            </div>
        `;
        document.body.appendChild(xpEffect);
        
        // Anima√ß√£o de entrada
        setTimeout(() => {
            xpEffect.classList.add('show');
        }, 10);
        
        // Remover ap√≥s anima√ß√£o
        setTimeout(() => {
            xpEffect.classList.add('hide');
            setTimeout(() => {
                if (xpEffect.parentNode) {
                    xpEffect.remove();
                }
            }, 500);
        }, 2000);
    }

    function nextQuestion() {
        if (currentQuestion < totalQuestions) {
            document.querySelector(`.question-container[data-question-number="${currentQuestion}"]`).classList.remove('active');
            currentQuestion++;
            document.querySelector(`.question-container[data-question-number="${currentQuestion}"]`).classList.add('active');
            scrollToTop();
        }
    }

    function prevQuestion() {
        if (currentQuestion > 1) {
            document.querySelector(`.question-container[data-question-number="${currentQuestion}"]`).classList.remove('active');
            currentQuestion--;
            document.querySelector(`.question-container[data-question-number="${currentQuestion}"]`).classList.add('active');
            scrollToTop();
        }
    }

    function scrollToTop() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // ===== TIMER E PROGRESSO =====
    function startTimer() {
        timerInterval = setInterval(() => {
            seconds++;
            updateTimerDisplay();
            
            const progress = (seconds / ({{ aula.tempo_pratica }} * 60)) * 88;
            const circle = document.querySelector('.progress-ring__circle');
            if (circle) {
                circle.style.strokeDashoffset = Math.max(0, 88 - progress);
            }
        }, 1000);
    }

    function updateTimerDisplay() {
        let minutes = Math.floor(seconds / 60);
        let secs = seconds % 60;
        document.getElementById('timer').textContent = 
            String(minutes).padStart(2, '0') + ":" + String(secs).padStart(2, '0');
    }

    function stopTimer() {
        clearInterval(timerInterval);
        return seconds;
    }

    // ===== FINALIZA√á√ÉO E BACKEND =====
    async function finishPractice(e) {
        // ‚úÖ VERIFICAR SE TODAS AS QUEST√ïES FORAM RESPONDIDAS
        if (!checkAllQuestionsAnswered()) {
            showErrorMessage('‚ùå Responda todas as quest√µes antes de finalizar!');
            return; // Impede a finaliza√ß√£o
        }
        const aulaId = e.currentTarget.dataset.aulaId;
        const elapsedTime = stopTimer();
        
        // ‚úÖ CALCULAR B√îNUS POR REVIS√ÉO
        let revisaoBonus = 0;
        if (isReviewMode) {
            revisaoBonus = parseInt(document.getElementById('xp-revisao').value) || 5;
            totalXP += revisaoBonus;
            
            // ‚úÖ REGISTRAR XP DA REVIS√ÉO NO BACKEND
            try {
                const response = await fetch("{% url 'registrar_xp_revisao' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        aula_id: aulaId,
                        xp_revisao: revisaoBonus
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    console.log(`‚úÖ ${revisaoBonus} XP de revis√£o registrados!`);
                }
            } catch (error) {
                console.error('‚ùå Erro ao registrar XP da revis√£o:', error);
            }
        }
        
        // Calcular b√¥nus por tempo (apenas se n√£o for revis√£o)
        let timeBonus = 0;
        if (!isReviewMode) {
            const expectedTime = {{ aula.tempo_pratica }} * 60;
            if (elapsedTime < expectedTime * 0.5) {
                timeBonus = 50;
            } else if (elapsedTime < expectedTime * 0.8) {
                timeBonus = 25;
            }
            totalXP += timeBonus;
        }
        
        // Finalizar no backend (apenas se n√£o for revis√£o)
        if (!isReviewMode) {
            try {
                const response = await fetch("{% url 'finalizar_pratica' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        aula_id: aulaId,
                        xp_total: totalXP,
                        vidas_restantes: userLives
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    totalXP = data.xp_total;
                    showSuccessMessage(`üéâ Pr√°tica conclu√≠da! Voc√™ ganhou ${totalXP} XP!`);
                }
            } catch (error) {
                console.error('Erro ao finalizar pr√°tica:', error);
                showSuccessMessage(`üéâ Pr√°tica conclu√≠da! Voc√™ ganhou ${totalXP} XP!`);
            }
        } else {
            showSuccessMessage(`üìù Revis√£o conclu√≠da! Voc√™ ganhou ${revisaoBonus} XP!`);
        }
        
        // Mostrar tela de resultados
        showResultScreen(totalXP, elapsedTime, timeBonus, revisaoBonus);
    }

    function showResultScreen(totalXP, elapsedTime, timeBonus, revisaoBonus = 0) {
        const resultScreen = document.getElementById('result-screen');
        const questionsContainer = document.getElementById('questions-container');
        
        questionsContainer.style.display = 'none';
        resultScreen.classList.remove('hidden');
        
        // Ajustar mensagem baseada no modo
        if (isReviewMode) {
            resultScreen.querySelector('h2').innerHTML = 'üìù Revis√£o Conclu√≠da';
            resultScreen.querySelector('p').textContent = 'Revis√£o dos exerc√≠cios finalizada!';
            
            // ‚úÖ ADICIONAR CARD DE XP DA REVIS√ÉO
            const bonusGrid = resultScreen.querySelector('.grid');
            if (revisaoBonus > 0) {
                const revisaoCard = `
                    <div class="bg-white rounded-xl p-6 shadow-md card-hover">
                        <div class="flex items-center justify-center gap-2 mb-3">
                            <img src="{% static 'imagem/visibility_35dp_10B981_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Revis√£o" class="w-8 h-8">
                        </div>
                        <div class="text-2xl font-bold text-green-600 mb-2">+${revisaoBonus} XP</div>
                        <p class="text-sm text-gray-600">B√¥nus de Revis√£o</p>
                    </div>
                `;
                bonusGrid.innerHTML += revisaoCard;
            }
        }
        
        document.getElementById('final-xp').textContent = totalXP - timeBonus - revisaoBonus;
        document.getElementById('time-bonus').textContent = isReviewMode ? '0' : timeBonus;
        
        const minutes = Math.floor(elapsedTime / 60);
        const secondsRemaining = elapsedTime % 60;
        document.getElementById('final-time').textContent = 
            String(minutes).padStart(2, '0') + ':' + String(secondsRemaining).padStart(2, '0');
    }

    // ===== INTEGRA√á√ÉO COM BACKEND =====
    async function saveProgress(questaoId, concluida, xpGanho) {
        try {
            const response = await fetch("{% url 'marcar_aula_concluida' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    aula_id: {{ aula.id }},
                    tipo: 'pratica',
                    questao_id: questaoId,
                    concluida: concluida,
                    xp_ganho: xpGanho
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                console.log('‚úÖ Progresso salvo:', data);
                return true;
            } else {
                console.error('‚ùå Erro ao salvar progresso:', data.error);
                return false;
            }
        } catch (error) {
            console.error('‚ùå Erro na requisi√ß√£o:', error);
            return true;
        }
    }

    function showSuccessMessage(message) {
        const successDiv = document.createElement('div');
        successDiv.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-xl shadow-lg z-50 animate-bounce';
        successDiv.innerHTML = `
            <div class="flex items-center gap-2">
                <span>üéâ</span>
                <span class="font-bold">${message}</span>
            </div>
        `;
        document.body.appendChild(successDiv);
        
        setTimeout(() => {
            successDiv.remove();
        }, 3000);
    }

    // Fun√ß√£o auxiliar para processar texto com lacunas
    function processFillBlankText(text) {
        return text.replace(/\[_____\]/g, 
            '<input type="text" class="blank-input w-32 border-b-2 border-blue-400 text-center px-2 bg-transparent focus:outline-none focus:border-blue-600" placeholder="______">'
        );
    }

    // Inicializar textos com lacunas
    document.querySelectorAll('[id^="fill-blank-text-"]').forEach(container => {
        const originalText = container.textContent;
        container.innerHTML = processFillBlankText(originalText);
    });

    console.log("üöÄ Sistema de pr√°tica com vidas carregado com sucesso!");
    // ===== SISTEMA DE STREAK =====
    let streakAtual = 0;
    let bonusStreak = 0;
    let tempoRestanteStreak = 24;

    // Carregar dados do streak do usu√°rio
    async function carregarStreakUsuario() {
        try {
            const response = await fetch("{% url 'api_streak_usuario' %}");
            const data = await response.json();
            
            if (data.success) {
                streakAtual = data.streak_atual;
                bonusStreak = data.bonus_streak;
                tempoRestanteStreak = data.tempo_restante;
                atualizarDisplayStreak();
                
                console.log(`üî• Streak carregado: ${streakAtual} dias, +${bonusStreak}% XP`);
            }
        } catch (error) {
            console.log('‚ö†Ô∏è N√£o foi poss√≠vel carregar streak, usando valores padr√£o');
            streakAtual = 0;
            bonusStreak = 0;
            tempoRestanteStreak = 24;
            atualizarDisplayStreak();
        }
    }

    function atualizarDisplayStreak() {
        const streakElement = document.getElementById('streak-atual');
        const bonusElement = document.getElementById('bonus-streak');
        const container = document.getElementById('streak-container');
        
        if (streakElement) streakElement.textContent = streakAtual;
        if (bonusElement) bonusElement.textContent = Math.round(bonusStreak);
        
        // Efeitos visuais baseados no streak
        if (container) {
            // Reset classes
            container.className = 'px-4 py-2 rounded-xl font-bold flex items-center gap-3 card-hover';
            
            if (streakAtual === 0) {
                container.classList.add('bg-gray-500', 'text-white');
            } else if (streakAtual < 3) {
                container.classList.add('bg-orange-500', 'text-white');
            } else if (streakAtual < 7) {
                container.classList.add('bg-orange-600', 'text-white');
            } else if (streakAtual < 14) {
                container.classList.add('bg-red-500', 'text-white', 'pulse-animation');
            } else {
                container.classList.add('bg-gradient-to-r', 'from-purple-600', 'to-pink-600', 'text-white', 'pulse-animation');
            }
        }
    }

    // Registrar atividade e atualizar streak
    async function registrarAtividadeStreak(xpBase = 0, tipo = 'questao') {
        if (isReviewMode) {
            console.log("üìù Modo revis√£o: n√£o registra streak");
            return { xp_total: xpBase, xp_bonus: 0 };
        }
        
        try {
            const response = await fetch("{% url 'registrar_atividade_streak' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    tipo: tipo,
                    xp_base: xpBase
                })
            });
            
            const data = await response.json();
            if (data.success) {
                console.log(`üî• Streak: ${data.streak_anterior} ‚Üí ${data.streak_atual}`);
                console.log(`üí∞ XP: ${data.xp_base} + ${data.xp_bonus} (b√¥nus) = ${data.xp_total}`);
                
                // Atualizar vari√°veis locais
                streakAtual = data.streak_atual;
                bonusStreak = parseInt(data.bonus_streak);
                atualizarDisplayStreak();
                
                // Mostrar feedbacks
                if (data.streak_zerado) {
                    showStreakZerado(data.streak_anterior);
                } else if (data.streak_aumentado) {
                    showStreakAumentado(data.streak_atual);
                }
                
                if (data.level_up) {
                    showLevelUp(data.nivel_atual);
                }
                
                if (data.conquistas_desbloqueadas.length > 0) {
                    data.conquistas_desbloqueadas.forEach(conquista => {
                        showConquistaDesbloqueada(conquista);
                    });
                }
                
                return {
                    xp_total: data.xp_total,
                    xp_bonus: data.xp_bonus,
                    streak_atual: data.streak_atual
                };
            }
        } catch (error) {
            console.error('‚ùå Erro ao registrar atividade streak:', error);
        }
        
        // Fallback: retorna XP base se a requisi√ß√£o falhar
        return { xp_total: xpBase, xp_bonus: 0 };
    }

    // Fun√ß√µes de feedback visual
    function showStreakAumentado(novoStreak) {
        const effect = document.createElement('div');
        effect.className = 'fixed top-20 right-4 bg-orange-500 text-white px-4 py-2 rounded-xl font-bold animate-bounce z-50 shadow-lg';
        effect.innerHTML = `
            <div class="flex items-center gap-2">
                <span>üî•</span>
                <span>Streak: ${novoStreak} dias!</span>
            </div>
        `;
        document.body.appendChild(effect);
        
        setTimeout(() => effect.remove(), 3000);
    }

    function showStreakZerado(streakAnterior) {
        const effect = document.createElement('div');
        effect.className = 'fixed top-20 right-4 bg-gray-600 text-white px-4 py-2 rounded-xl font-bold animate-bounce z-50 shadow-lg';
        effect.innerHTML = `
            <div class="flex items-center gap-2">
                <span>üíÄ</span>
                <span>Streak zerado! Era ${streakAnterior} dias</span>
            </div>
        `;
        document.body.appendChild(effect);
        
        setTimeout(() => effect.remove(), 4000);
    }

    function showLevelUp(novoNivel) {
        const effect = document.createElement('div');
        effect.className = 'fixed top-32 right-4 bg-yellow-500 text-white px-4 py-2 rounded-xl font-bold animate-bounce z-50 shadow-lg';
        effect.innerHTML = `
            <div class="flex items-center gap-2">
                <span>‚≠ê</span>
                <span>Level Up! N√≠vel ${novoNivel}</span>
            </div>
        `;
        document.body.appendChild(effect);
        
        setTimeout(() => effect.remove(), 3000);
    }

    function showConquistaDesbloqueada(conquista) {
        const effect = document.createElement('div');
        effect.className = 'fixed top-44 right-4 bg-purple-500 text-white px-4 py-2 rounded-xl font-bold animate-bounce z-50 shadow-lg';
        effect.innerHTML = `
            <div class="flex items-center gap-2">
                <span>üèÜ</span>
                <span>${conquista}</span>
            </div>
        `;
        document.body.appendChild(effect);
        
        setTimeout(() => effect.remove(), 4000);
    }

    
    // ===== ATUALIZA√á√ÉO AUTOM√ÅTICA DO CABE√áALHO =====

    // ===== ATUALIZA√á√ÉO AUTOM√ÅTICA DO CABE√áALHO =====
    async function atualizarCabecalhoUsuario() {
        try {
            // Buscar dados atualizados do usu√°rio
            const response = await fetch("{% url 'api_streak_usuario' %}");
            const data = await response.json();
            
            if (data.success) {
                // Atualizar vidas
                userLives = data.vidas_restantes || userLives;
                maxLives = data.max_vidas || maxLives;
                
                // Atualizar streak
                streakAtual = data.streak_atual;
                bonusStreak = data.bonus_streak;
                
                // Atualizar displays NO CABE√áALHO
                atualizarCabecalhoDisplay();
                atualizarDisplayStreak();
                
                console.log(`üîÑ Cabe√ßalho atualizado: ${userLives} vidas, ${streakAtual} dias streak`);
                
                // Retornar os dados para uso externo se necess√°rio
                return data;
            }
        } catch (error) {
            console.log('‚ö†Ô∏è N√£o foi poss√≠vel atualizar cabe√ßalho:', error);
            return null;
        }
    }

    // Fun√ß√£o espec√≠fica para atualizar o cabe√ßalho (base.html)
    function atualizarCabecalhoDisplay() {
        console.log("üîÑ atualizarCabecalhoDisplay() - Vidas:", userLives);
        
        // Atualizar vidas no cabe√ßalho
        const vidaElement = document.querySelector('.bg-blue-200.px-3.py-1\\.5 h2');
        if (vidaElement) {
            vidaElement.textContent = userLives;
            console.log("‚úÖ N√∫mero de vidas atualizado no cabe√ßalho:", userLives);
        } else {
            console.log("‚ùå Elemento de vidas n√£o encontrado no cabe√ßalho");
        }
        
        // ‚úÖ VERIFICA√á√ÉO CR√çTICA: Se vidas = 0, finalizar pr√°tica
        if (userLives <= 0 && !isReviewMode) {
            console.log("üö® VIDAS ZERADAS - Chamando endPracticeDueToLives()");
            setTimeout(() => {
                endPracticeDueToLives();
            }, 1000);
        }
        
        // Atualizar sequ√™ncia (streak)
        const sequenciaElement = document.querySelector('.bg-blue-200.px-3.py-1\\.5:nth-child(3) h2');
        if (sequenciaElement) {
            sequenciaElement.textContent = streakAtual;
        }
    }

    // Fun√ß√£o para atualizar vidas ap√≥s errar
    async function atualizarAposErro() {
        const dadosAtualizados = await atualizarCabecalhoUsuario();
        
        if (dadosAtualizados) {
            // Feedback visual adicional
            const header = document.querySelector('header');
            if (header) {
                header.classList.add('shake');
                setTimeout(() => header.classList.remove('shake'), 500);
            }
            
            // Mostrar notifica√ß√£o de vida perdida
            showLifeLostNotification();
        }
    }

    // Fun√ß√£o para atualizar ap√≥s acerto
    async function atualizarAposAcerto() {
        await atualizarCabecalhoUsuario();
        
        // Feedback visual positivo
        const header = document.querySelector('header');
        if (header) {
            header.classList.add('bounce');
            setTimeout(() => header.classList.remove('bounce'), 500);
        }
    }

    // Notifica√ß√£o visual quando perde vida
    function showLifeLostNotification() {
        const notification = document.createElement('div');
        notification.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-6 py-3 rounded-xl shadow-lg z-50 animate-bounce';
        notification.innerHTML = `
            <div class="flex items-center gap-2">
                <span>üíî</span>
                <span class="font-bold">Vida perdida! ${userLives} restantes</span>
            </div>
        `;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }

    // Atualizar periodicamente o cabe√ßalho (a cada 30 segundos)
    function iniciarAtualizacaoPeriodica() {
        setInterval(async () => {
            await atualizarCabecalhoUsuario();
        }, 30000); // 30 segundos
    }
    // Fun√ß√£o para for√ßar atualiza√ß√£o manual do cabe√ßalho (√∫til para debugging)
    function forcarAtualizacaoCabecalho() {
        console.log("üîÑ For√ßando atualiza√ß√£o do cabe√ßalho...");
        atualizarCabecalhoUsuario();
    }
    // ‚úÖ FUN√á√ÉO CORRIGIDA PARA OBTER RESPOSTAS
    function getCorrectAnswersForReview(questionId) {
        console.log(`üîç Buscando respostas para quest√£o ${questionId}`);
        
        // ‚úÖ PRIMEIRO: Tenta pela vari√°vel global
        const respostasGlobal = window[`respostasQuestao${questionId}`];
        if (respostasGlobal) {
            console.log("‚úÖ Respostas da vari√°vel global:", respostasGlobal);
            return respostasGlobal;
        }
        
        // ‚úÖ SEGUNDO: Tenta pelo data attribute
        const answersContainer = document.querySelector(`[data-questao-id="${questionId}"]`);
        if (answersContainer && answersContainer.dataset.respostas) {
            try {
                // Remove caracteres problem√°ticos antes de parsear
                let respostasData = answersContainer.dataset.respostas
                    .replace(/^\[/, '[')
                    .replace(/\]$/, ']')
                    .replace(/\\u0027/g, "'");
                
                const respostas = JSON.parse(respostasData);
                console.log("‚úÖ Respostas do data attribute:", respostas);
                return respostas;
            } catch (e) {
                console.error("‚ùå Erro ao parsear data attribute:", e);
            }
        }
        
        console.log("üö® N√£o foi poss√≠vel carregar respostas");
        return [];
    }
    // ‚úÖ SISTEMA COMPLETO DE DEBUG
    function debugSistema() {
        console.log("üêõ === DEBUG COMPLETO DO SISTEMA ===");
        
        // Debug da quest√£o ativa
        const activeQuestion = document.querySelector('.question-container.active');
        if (!activeQuestion) {
            console.log("‚ùå Nenhuma quest√£o ativa encontrada");
            return;
        }
        
        const questionId = activeQuestion.dataset.questionId;
        const questionType = activeQuestion.dataset.questionType;
        
        console.log("üìã Informa√ß√µes da Quest√£o:");
        console.log("   ID:", questionId);
        console.log("   Tipo:", questionType);
        console.log("   Elemento:", activeQuestion);
        
        // Debug espec√≠fico para lacunas
        if (questionType === 'fill-blank') {
            debugLacunas(questionId, activeQuestion);
        }
        
        // Debug espec√≠fico para c√≥digo
        if (questionType === 'code') {
            debugCodigo(questionId, activeQuestion);
        }
        
        console.log("üêõ === FIM DEBUG ===");
    }

    // ‚úÖ DEBUG ESPEC√çFICO PARA LACUNAS
    function debugLacunas(questionId, questionContainer) {
        console.log("üîç === DEBUG LACUNAS ===");
        
        // Verificar TODAS as fontes poss√≠veis de respostas
        const sources = [
            { 
                name: 'data-questao-id', 
                selector: `[data-questao-id="${questionId}"]`,
                dataField: 'respostas'
            },
            { 
                name: 'question-container', 
                selector: `[data-question-id="${questionId}"]`,
                dataField: 'correctAnswers'
            },
            { 
                name: 'hidden answers', 
                selector: '.correct-answers-data',
                dataField: 'respostas'
            }
        ];
        
        let respostasEncontradas = null;
        
        sources.forEach(source => {
            const element = document.querySelector(source.selector);
            if (element) {
                console.log(`‚úÖ ${source.name} encontrado:`, element);
                
                const dataValue = element.dataset[source.dataField];
                console.log(`   data-${source.dataField}:`, dataValue);
                
                if (dataValue && !respostasEncontradas) {
                    try {
                        respostasEncontradas = JSON.parse(dataValue);
                        console.log(`üéØ RESPOSTAS ENCONTRADAS:`, respostasEncontradas);
                    } catch (e) {
                        console.error(`‚ùå Erro ao parsear:`, e);
                    }
                }
            } else {
                console.log(`‚ùå ${source.name}: N√£o encontrado`);
            }
        });
        
        // Verificar lacunas
        const blankInputs = questionContainer.querySelectorAll('.blank-input');
        console.log(`üìù Lacunas encontradas: ${blankInputs.length}`);
        
        blankInputs.forEach((input, index) => {
            console.log(`   Lacuna ${index + 1}:`, {
                valor: input.value,
                dataCorrect: input.dataset.correctAnswer,
                placeholder: input.placeholder
            });
        });
        
        // Testar a fun√ß√£o getCorrectAnswersForReview
        console.log("üß™ Testando getCorrectAnswersForReview:");
        const respostasFuncao = getCorrectAnswersForReview(questionId);
        console.log("   Resultado:", respostasFuncao);
    }

    // ‚úÖ DEBUG ESPEC√çFICO PARA C√ìDIGO
    function debugCodigo(questionId, questionContainer) {
        console.log("üíª === DEBUG C√ìDIGO ===");
        
        const codeInput = document.getElementById(`code-input-${questionId}`);
        const expectedOutput = `{{ questao.saida_esperada|default:"" }}`.trim();
        
        console.log("üì• Sa√≠da esperada do template:", expectedOutput);
        console.log("üìù C√≥digo do usu√°rio:", codeInput ? codeInput.value : 'N√ÉO ENCONTRADO');
        
        // Testar a fun√ß√£o de interpreta√ß√£o
        if (codeInput && codeInput.value) {
            console.log("üß™ Testando interpretPythonCode:");
            try {
                const output = interpretPythonCode(codeInput.value);
                console.log("   Sa√≠da gerada:", output);
                console.log("   Tipo:", typeof output);
                
                // Compara√ß√£o detalhada
                console.log("üîç Compara√ß√£o detalhada:");
                console.log("   Sa√≠da gerada (trim/lower):", output.trim().toLowerCase());
                console.log("   Esperada (trim/lower):", expectedOutput.toLowerCase().trim());
                console.log("   S√£o iguais?", output.trim().toLowerCase() === expectedOutput.toLowerCase().trim());
                
            } catch (error) {
                console.error("‚ùå Erro na interpreta√ß√£o:", error);
            }
        }
    }

    

    
    
    // ‚úÖ BOT√ÉO ESPEC√çFICO PARA DEBUG DE C√ìDIGO
    

    
    // ‚úÖ DEBUG ESPEC√çFICO PARA LACUNAS
    function debugLacunasDetalhado(questionId) {
        console.log("üîç === DEBUG LACUNAS DETALHADO ===");
        
        const questionContainer = document.querySelector(`[data-question-id="${questionId}"]`);
        const blankInputs = questionContainer.querySelectorAll('.blank-input');
        
        // 1. Verificar respostas corretas
        console.log("üìã RESPOSTAS CORRETAS:");
        const respostasCorretas = getCorrectAnswersForReview(questionId);
        console.log("   Array:", respostasCorretas);
        console.log("   Tipo:", typeof respostasCorretas);
        console.log("   Tamanho:", respostasCorretas.length);
        
        respostasCorretas.forEach((resposta, index) => {
            console.log(`   Lacuna ${index + 1}: "${resposta}"`);
        });
        
        // 2. Verificar inputs do usu√°rio
        console.log("üìù INPUTS DO USU√ÅRIO:");
        blankInputs.forEach((input, index) => {
            console.log(`   Lacuna ${index + 1}:`, {
                valor: `"${input.value}"`,
                valor_trim: `"${input.value.trim()}"`,
                valor_lower: `"${input.value.trim().toLowerCase()}"`,
                dataCorrect: input.dataset.correctAnswer
            });
        });
        
        // 3. Simular verifica√ß√£o
        console.log("üß™ SIMULA√á√ÉO DE VERIFICA√á√ÉO:");
        let todasCorretas = true;
        
        blankInputs.forEach((input, index) => {
            const userAnswer = input.value.trim().toLowerCase();
            const correctAnswer = respostasCorretas[index] ? respostasCorretas[index].toLowerCase() : "";
            
            const estaCorreta = userAnswer === correctAnswer;
            todasCorretas = todasCorretas && estaCorreta;
            
            console.log(`   Lacuna ${index + 1}:`);
            console.log(`      Usu√°rio: "${userAnswer}"`);
            console.log(`      Correto: "${correctAnswer}"`);
            console.log(`      Resultado: ${estaCorreta ? '‚úÖ CORRETO' : '‚ùå ERRADO'}`);
        });
        
        console.log(`üìä RESULTADO FINAL: ${todasCorretas ? '‚úÖ TODAS CORRETAS' : '‚ùå ALGUMAS ERRADAS'}`);
        console.log("üîç === FIM DEBUG LACUNAS ===");
        
        return todasCorretas;
    }
    
    // ===== SISTEMA DE RASTREAMENTO DE TEMPO =====
    let startTime;
    let totalPracticeTime = 0;
    let isTracking = false;

    function startTimeTracking() {
        if (!isTracking) {
            startTime = new Date();
            isTracking = true;
            console.log("‚è±Ô∏è Iniciando rastreamento de tempo da pr√°tica...");
        }
    }

    function stopTimeTracking() {
        if (isTracking && startTime) {
            const endTime = new Date();
            const timeSpent = Math.floor((endTime - startTime) / 1000); // tempo em segundos
            totalPracticeTime += timeSpent;
            isTracking = false;
            console.log(`‚è±Ô∏è Tempo gasto na pr√°tica: ${timeSpent} segundos`);
            return timeSpent;
        }
        return 0;
    }

    // Fun√ß√£o para salvar o tempo da pr√°tica
    async function savePracticeTime() {
        const timeSpent = stopTimeTracking();
        if (timeSpent > 0) {
            console.log(`üíæ Tentando salvar ${timeSpent} segundos de pr√°tica...`);
            
            try {
                const response = await fetch("{% url 'salvar_tempo_pratica' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        aula_id: {{ aula.id }},
                        tempo_segundos: timeSpent
                    })
                });
                
                const data = await response.json();
                console.log("üì® Resposta do servidor:", data);
                
                if (data.success) {
                    console.log(`‚úÖ Tempo de pr√°tica salvo: ${timeSpent} segundos`);
                    console.log(`üìä Tempo total agora: ${data.tempo_total} segundos`);
                    
                    
                } else {
                    console.error('‚ùå Erro do servidor:', data.error);
                }
            } catch (error) {
                console.error('‚ùå Erro na requisi√ß√£o:', error);
            }
        }
    }

    // Fun√ß√£o para mostrar notifica√ß√£o de tempo salvo
    function showTimeSavedNotification(segundos) {
        const minutos = Math.floor(segundos / 60);
        const notification = document.createElement('div');
        notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
        notification.innerHTML = `
            <div class="flex items-center gap-2">
                <span>‚è±Ô∏è</span>
                <span>${minutos} min de estudo salvos!</span>
            </div>
        `;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }

    // Iniciar tracking quando a p√°gina carregar
    document.addEventListener('DOMContentLoaded', function() {
        startTimeTracking();
        
        // Salvar tempo quando o usu√°rio sair da p√°gina
        window.addEventListener('beforeunload', function() {
            savePracticeTime();
        });
        
        // Salvar tempo quando finalizar a pr√°tica
        document.querySelectorAll('.finish-practice').forEach(btn => {
            btn.addEventListener('click', function() {
                setTimeout(savePracticeTime, 1000);
            });
        });
    });
    // ===== SISTEMA DE TAB E AUTO-INDENTA√á√ÉO =====
    function setupCodeEditor(questionId) {
    const textarea = document.getElementById(`code-input-${questionId}`);
    
    if (!textarea) return;
    
    textarea.addEventListener('keydown', function(e) {
        // ‚úÖ APENAS TAB - vers√£o ultra-simplificada
        if (e.key === 'Tab') {
            e.preventDefault();
            
            const start = this.selectionStart;
            const end = this.selectionEnd;
            
            // ‚úÖ SEMPRE 4 espa√ßos, sem l√≥gica complexa
            this.value = this.value.substring(0, start) + '    ' + this.value.substring(end);
            this.selectionStart = this.selectionEnd = start + 4;
            
            // ‚úÖ PARAR aqui - n√£o processar mais nada
            return false;
        }
    });
}

    // Inicializar todos os editores
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('[id^="code-input-"]').forEach(input => {
            const questionId = input.id.replace('code-input-', '');
            setupCodeEditor(questionId);
        });
    });
    // ‚úÖ VERIFICAR SE TODAS AS QUEST√ïES FORAM RESPONDIDAS
    // ‚úÖ FUN√á√ÉO CORRIGIDA - ATUALIZA√á√ÉO VISUAL DO BOT√ÉO
    function checkAllQuestionsAnswered() {
        const allAnswered = questionsAnswered.size === totalQuestions;
        
        console.log(`üìä Progresso: ${questionsAnswered.size}/${totalQuestions} quest√µes respondidas`);
        
        // ‚úÖ ENCONTRAR BOT√ïES DE FORMA MAIS EFETIVA
        const finishBtns = document.querySelectorAll('.finish-practice');
        
        console.log(`üîç Encontrados ${finishBtns.length} bot√µes de finalizar`);
        
        if (finishBtns.length === 0) {
            console.log("‚ùå NENHUM bot√£o finalizar encontrado!");
            // Tentar encontrar de outra forma
            const alternativeBtns = document.querySelectorAll('button[data-aula-id]');
            console.log("Bot√µes alternativos encontrados:", alternativeBtns.length);
        }
        
        finishBtns.forEach((btn, index) => {
            console.log(`üîÑ Atualizando bot√£o ${index + 1}:`, btn);
            
            if (allAnswered) {
                // ‚úÖ LIBERAR COMPLETAMENTE
                btn.classList.remove('bg-gray-400', 'opacity-50', 'cursor-not-allowed');
                btn.classList.add('bg-green-600', 'hover:bg-green-700');
                btn.disabled = false;
                
                // ‚úÖ CORRE√á√ÉO: Usar innerHTML de forma segura
                const iconHTML = `<img src="{% static 'imagem/check_circle_35dp_FFFFFF_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Finalizar" class="w-4 h-4">`;
                btn.innerHTML = `${iconHTML} Finalizar Pr√°tica`;
                
                console.log(`‚úÖ Bot√£o ${index + 1} LIBERADO`);
            } else {
                // ‚úÖ MANTER BLOQUEADO
                btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                btn.classList.add('bg-gray-400', 'opacity-50', 'cursor-not-allowed');
                btn.disabled = true;
                
                const iconHTML = `<img src="{% static 'imagem/block_35dp_FFFFFF_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Bloqueado" class="w-4 h-4">`;
                btn.innerHTML = `${iconHTML} Responda todas (${questionsAnswered.size}/${totalQuestions})`;
                
                console.log(`‚ùå Bot√£o ${index + 1} BLOQUEADO`);
            }
        });
        
        
        
       
        
        return allAnswered;
    }
    // ‚úÖ MENSAGEM DE SUCESSO
    function showSuccessMessage(message) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-xl shadow-lg z-50 animate-bounce';
        messageDiv.innerHTML = `
            <div class="flex items-center gap-2">
                <span>‚úÖ</span>
                <span class="font-bold">${message}</span>
            </div>
        `;
        document.body.appendChild(messageDiv);
        
        setTimeout(() => {
            messageDiv.remove();
        }, 3000);
    }

    // ‚úÖ MENSAGEM DE ERRO
    function showErrorMessage(message) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-6 py-3 rounded-xl shadow-lg z-50 animate-shake';
        messageDiv.innerHTML = `
            <div class="flex items-center gap-2">
                <span>‚ùå</span>
                <span class="font-bold">${message}</span>
            </div>
        `;
        document.body.appendChild(messageDiv);
        
        setTimeout(() => {
            messageDiv.remove();
        }, 3000);
    }
    // Adicione um bot√£o de teste se necess√°rio (remova em produ√ß√£o)
    // <button onclick="forcarAtualizacaoCabecalho()" class="fixed bottom-4 right-4 bg-blue-500 text-white p-2 rounded">üîÑ Atualizar Cabe√ßalho</button>
</script>
{% endblock %}