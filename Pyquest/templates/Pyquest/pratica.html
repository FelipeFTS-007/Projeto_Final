{% extends "base.html" %}
{% load static %}

{% block title %}Pr√°tica - {{ aula.titulo_pratica|default:aula.titulo_aula }}{% endblock %}

{% block extra_css %}
<style>
    /* ESTILOS OTIMIZADOS E FLUIDOS */
    .fade-in {
        animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .slide-in {
        animation: slideIn 0.4s ease-out;
    }
    
    @keyframes slideIn {
        from { opacity: 0; transform: translateX(30px); }
        to { opacity: 1; transform: translateX(0); }
    }
    
    .bounce-in {
        animation: bounceIn 0.6s ease-out;
    }
    
    @keyframes bounceIn {
        0% { transform: scale(0.3); opacity: 0; }
        50% { transform: scale(1.05); opacity: 1; }
        70% { transform: scale(0.95); }
        100% { transform: scale(1); opacity: 1; }
    }
    
    .shake {
        animation: shake 0.5s ease-in-out;
    }
    
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-8px); }
        75% { transform: translateX(8px); }
    }
    
    /* Sistema de dicas */
    .hint-container {
        display: none;
        background-color: #f0f9ff;
        border-left: 4px solid #3B82F6;
        padding: 1rem;
        margin-top: 1rem;
        border-radius: 0.5rem;
    }
    
    .hint-container.active {
        display: block;
    }
    
    .correct-answer {
        background-color: #d1fae5 !important;
        border-color: #10b981 !important;
        color: #065f46 !important;
    }
    
    .wrong-answer {
        background-color: #fee2e2 !important;
        border-color: #ef4444 !important;
        color: #7f1d1d !important;
    }
    
    .blank-input {
        border-bottom: 2px solid #3B82F6;
        text-align: center;
        padding: 4px 8px;
        margin: 0 4px;
        background: transparent;
        outline: none;
        min-width: 80px;
        font-weight: 500;
    }
    
    .blank-input:focus {
        border-color: #1E40AF;
        background: #f0f9ff;
    }
    
    .blank-filled {
        background: #d1fae5;
        border-color: #10b981;
        color: #065f46;
        font-weight: 600;
    }
    
    .code-output {
        font-family: 'Courier New', monospace;
        font-size: 14px;
        line-height: 1.4;
        white-space: pre-wrap;
        background: #0f172a;
        color: #10b981;
        padding: 1rem;
        border-radius: 0.5rem;
        border: 1px solid #1e293b;
    }
    
    .option-button {
        transition: all 0.3s ease;
        border: 2px solid #e2e8f0;
    }
    
    .option-button:hover {
        border-color: #3B82F6;
        transform: translateY(-2px);
    }
    
    .feedback-message {
        padding: 1rem;
        border-radius: 0.5rem;
        margin: 1rem 0;
        font-weight: 600;
        text-align: center;
    }
    
    .feedback-correct {
        background-color: #d1fae5;
        color: #065f46;
        border: 2px solid #10b981;
    }
    
    .feedback-incorrect {
        background-color: #fee2e2;
        color: #7f1d1d;
        border: 2px solid #ef4444;
    }
    
    /* Bot√£o voltar */
    .back-button {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background: white;
        border: 1px solid #CBD5E1;
        border-radius: 0.75rem;
        padding: 0.75rem 1.25rem;
        font-size: 0.875rem;
        font-weight: 500;
        color: #64748B;
        transition: all 0.3s ease;
        margin-bottom: 2rem;
    }
    
    .back-button:hover {
        border-color: var(--primary-blue);
        color: var(--primary-blue);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
    }
    
    /* Progresso da pr√°tica */
    .practice-progress {
        height: 6px;
        background: #e5e7eb;
        border-radius: 3px;
        overflow: hidden;
        margin: 1rem 0;
    }
    
    .practice-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #3B82F6, #1E40AF);
        transition: width 0.5s ease;
    }
    
    /* Indicador de quest√µes */
    .questions-indicator {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin: 1rem 0;
    }
    
    .question-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #e5e7eb;
        transition: all 0.3s ease;
    }
    
    .question-dot.answered {
        background: #10b981;
    }
    
    .question-dot.current {
        background: #3B82F6;
        transform: scale(1.2);
    }
    
    .question-dot.wrong {
        background: #ef4444;
    }
    
    /* EDITOR DE C√ìDIGO */
    .code-editor-container {
        position: relative;
        border: 1px solid #334155;
        border-radius: 0.5rem;
        overflow: hidden;
        margin: 1rem 0;
        background: #0f172a;
    }
    
    .editor-header {
        background: #1e293b;
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #334155;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .editor-title {
        color: #e2e8f0;
        font-size: 0.875rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .editor-actions {
        display: flex;
        gap: 0.5rem;
    }
    
    .editor-btn {
        background: #374151;
        border: 1px solid #4b5563;
        color: #e2e8f0;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .editor-btn:hover {
        background: #4b5563;
        border-color: #6b7280;
    }
    
    .editor-btn.primary {
        background: #3B82F6;
        border-color: #2563eb;
    }
    
    .editor-btn.primary:hover {
        background: #2563eb;
    }
    
    .editor-content {
        position: relative;
        display: flex;
        min-height: 300px;
    }
    
    .editor-line-numbers {
        background: #1e293b;
        color: #64748b;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        line-height: 1.5;
        padding: 1rem 0.5rem;
        text-align: right;
        border-right: 1px solid #334155;
        user-select: none;
        min-width: 50px;
        overflow: hidden;
    }
    
    .line-number {
        height: 21px;
        display: block;
    }
    
    .code-textarea {
        flex: 1;
        background: #0f172a;
        color: #e2e8f0;
        border: none;
        padding: 1rem;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        line-height: 1.5;
        resize: none;
        outline: none;
        tab-size: 4;
        white-space: pre;
        overflow-wrap: normal;
        overflow: auto;
    }
    
    .code-textarea:focus {
        box-shadow: none;
    }
    
    /* Terminal de sa√≠da */
    .terminal {
        background: #0f172a;
        border: 1px solid #334155;
        border-radius: 0.5rem;
        margin-top: 1rem;
        overflow: hidden;
    }
    
    .terminal-header {
        background: #1e293b;
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #334155;
        color: #e2e8f0;
        font-size: 0.875rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .terminal-content {
        padding: 1rem;
        color: #10b981;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        line-height: 1.4;
        white-space: pre-wrap;
        min-height: 60px;
        max-height: 300px;
        overflow-y: auto;
    }
    
    .terminal-content.error {
        color: #ef4444;
    }
    
    .question-container {
        display: none;
    }
    
    .question-container.active {
        display: block;
        animation: slideIn 0.4s ease-out;
    }

    /* Loading do Pyodide */
    .pyodide-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 1rem;
        color: #6b7280;
    }
    
    .spinner {
        border: 2px solid #f3f4f6;
        border-top: 2px solid #3b82f6;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        animation: spin 1s linear infinite;
    }

/* ‚úÖ CONTAINER COM ESPA√áOS COMPACTOS */
.fill-blank-container {
    white-space: pre-wrap;
    word-wrap: break-word;
    line-height: 1.4 !important;      /* ‚úÖ LINHAS MAIS JUNTAS */
    font-family: inherit;
    font-size: 14px;
    letter-spacing: -0.2px;           /* ‚úÖ ESPA√áO ENTRE LETRAS REDUZIDO */
    word-spacing: -0.5px;             /* ‚úÖ ESPA√áO ENTRE PALAVRAS REDUZIDO */
}

/* ‚úÖ ESPA√áOS ENTRE PAR√ÅGRAFOS MENORES */
.fill-blank-container br {
    line-height: 0.8 !important;      /* ‚úÖ QUEBRAS MAIS COMPACTAS */
    margin-bottom: 2px !important;
}

/* Classe para preservar espa√ßos de forma natural */
.preserve-spaces {
    white-space: pre-wrap;
    word-wrap: break-word;
    display: inline;
}

/* Inputs de lacuna - TAMANHO REDUZIDO */
.blank-input {
    border-bottom: 2px solid #3B82F6;
    text-align: center;
    padding: 1px 3px !important; 
    margin: 0 1px !important;
    background: transparent;
    outline: none;
    min-width: 60px !important;      
    max-width: 80px !important;       
    font-weight: 500;
    display: inline-block;
    vertical-align: baseline;
    font-family: inherit;
    font-size: 13px !important;
    border-radius: 2px;
    height: 20px !important;
    line-height: 1;
}

.blank-input:focus {
    border-color: #1E40AF;
    background: #f0f9ff;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
}

.blank-input.correct-answer {
    background: #d1fae5 !important;
    border-color: #10b981 !important;
    color: #065f46 !important;
}

.blank-input.wrong-answer {
    background: #fee2e2 !important;
    border-color: #ef4444 !important;
    color: #7f1d1d !important;
}
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6 fade-in">
    <!-- Topo: Bot√£o voltar + Cron√¥metro + Streak + Vidas -->
    <div class="flex items-center justify-between border-b border-blue-100 pb-4">
        <!-- Bot√£o Voltar -->
        <a href="{% url 'tarefas' %}?modulo_id={{ aula.modulo.id }}" class="back-button">
            <img src="{% static 'imagem/arrow_back_20dp_64748B_FILL0_wght400_GRAD0_opsz20.png' %}" alt="Voltar" class="w-4 h-4">
            <span>Voltar as Tarefas</span>
        </a>

        <!-- Cron√¥metro -->
        <div class="flex items-center gap-3 bg-blue-100 text-blue-600 px-4 py-2 rounded-xl font-bold">
            <div class="relative w-8 h-8">
                <svg class="progress-ring w-8 h-8" width="32" height="32">
                    <circle class="progress-ring__circle" stroke="#3B82F6" stroke-width="3" fill="transparent" r="14" cx="16" cy="16"
                        stroke-dasharray="88" stroke-dashoffset="52.8"></circle>
                </svg>
                <img src="{% static 'imagem/timer_100dp_2682EA_FILL0_wght400_GRAD0_opsz48.png' %}" alt="Tempo" class="w-4 h-4 absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2">
            </div>
            <span id="timer">00:00</span>
            <span class="text-xs">/ {{ aula.tempo_pratica }}:00</span>
        </div>
    </div>

    <!-- Campos hidden para controle -->
    <input type="hidden" id="vidas-restantes" value="{{ vidas_restantes }}">
    <input type="hidden" id="max-vidas" value="{{ max_vidas }}">
    <input type="hidden" id="aula-id" value="{{ aula.id }}">
    <input type="hidden" id="pratica-concluida" value="{{ pratica_concluida|yesno:'true,false' }}">
    <input type="hidden" id="xp-revisao" value="5">
    <input type="hidden" id="questoes_json" value='{{ questoes_json|escapejs }}'>

    <!-- Cabe√ßalho da Pr√°tica -->
    <div class="flex items-center justify-between">
        <div>
            <h2 class="text-2xl font-bold text-blue-600">{{ aula.titulo_pratica|default:aula.titulo_aula }}</h2>
            {% if pratica_concluida %}
            <div class="flex items-center gap-2 mt-2">
                <span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm font-semibold flex items-center gap-1">
                    Modo Revis√£o
                </span>
            </div>
            {% endif %}
        </div>
        
        <div class="flex gap-4">
            <div class="bg-blue-100 text-blue-600 px-3 py-1 rounded-xl text-sm font-bold flex items-center">
                <img src="{% static 'imagem/timer_100dp_2682EA_FILL0_wght400_GRAD0_opsz48.png' %}" alt="" class="h-5 w-5 mx-1"> {{ aula.tempo_pratica }} min
            </div>
            <div class="bg-blue-100 text-blue-600 px-3 py-1 rounded-xl text-sm font-bold flex items-center">
                +{{ aula.xp_pratica }} XP
            </div>
        </div>
    </div>

    <!-- Descri√ß√£o da Pr√°tica -->
    {% if aula.conteudo_pratico %}
    <div class="bg-gradient-to-br from-white to-blue-50 border border-blue-200 rounded-2xl p-6 shadow-lg">
        <h3 class="text-lg font-bold text-blue-600 mb-3 flex items-center gap-2">
            <img src="{% static 'imagem/description_35dp_2682EA_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Descri√ß√£o" class="w-5 h-5">
            Descri√ß√£o da Pr√°tica
        </h3>
        <p class="text-gray-700 leading-relaxed">
            {{ aula.conteudo_pratico }}
        </p>
    </div>
    {% endif %}

    <!-- Progresso da Pr√°tica -->
    <div class="bg-white rounded-xl p-4 shadow-md">
        <div class="flex justify-between items-center mb-2">
            <span class="text-sm font-medium text-gray-700">Progresso</span>
            <span class="text-sm font-bold text-blue-600" id="progress-text">0/{{ aula.questoes.count }}</span>
        </div>
        <div class="practice-progress">
            <div class="practice-progress-fill" id="practice-progress-fill" style="width: 0%"></div>
        </div>
        <div class="questions-indicator" id="questions-indicator">
            {% for questao in aula.questoes.all %}
            <div class="question-dot" data-question-id="{{ questao.id }}"></div>
            {% endfor %}
        </div>
    </div>

    <!-- Container Principal das Quest√µes -->
    <div id="questions-container" class="space-y-6">
        {% for questao in aula.questoes.all %}
        <div class="question-container {% if forloop.first %}active{% endif %}" data-question-id="{{ questao.id }}" data-question-type="{{ questao.tipo }}" data-question-number="{{ forloop.counter }}">
            <!-- Cabe√ßalho da Quest√£o -->
            <div class="bg-gradient-to-r from-blue-600 to-blue-800 text-white rounded-t-2xl p-6 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    {% if questao.tipo == 'multiple-choice' %}
                    <img src="{% static 'imagem/quiz_35dp_FFFFFF_FILL0_wght400_GRAD0_opsz40.png' %}" alt="M√∫ltipla Escolha" class="w-6 h-6">
                    {% elif questao.tipo == 'code' %}
                    <img src="{% static 'imagem/code_35dp_FFFFFF_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Programa√ß√£o" class="w-6 h-6">
                    {% elif questao.tipo == 'fill-blank' %}
                    <img src="{% static 'imagem/edit_35dp_FFFFFF_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Completar Lacunas" class="w-6 h-6">
                    {% endif %}
                    <div>
                        <h3 class="font-bold text-lg">Quest√£o {{ forloop.counter }}</h3>
                        <span class="text-sm text-blue-100">
                            {% if questao.tipo == 'multiple-choice' %}M√∫ltipla Escolha
                            {% elif questao.tipo == 'code' %}Programa√ß√£o
                            {% elif questao.tipo == 'fill-blank' %}Completar Lacunas
                            {% else %}{{ questao.tipo }}{% endif %}
                        </span>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <!-- Bot√£o de Dicas -->
                    <button class="hint-btn bg-blue-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-600 transition flex items-center gap-2"
                            data-question-id="{{ questao.id }}">
                        <img src="{% static 'imagem/lightbulb_35dp_FFFFFF_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Dicas" class="w-4 h-4">
                        Dicas
                        <span class="hint-counter bg-white text-blue-600 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold">{{ questao.dicas.count }}</span>
                    </button>
                    
                    <!-- XP da Quest√£o -->
                    <div class="bg-yellow-100 text-yellow-800 px-3 py-2 rounded-lg font-bold flex items-center gap-2">
                        +{{ questao.xp }} XP
                    </div>
                </div>
            </div>

            <!-- Conte√∫do da Quest√£o -->
            <div class="bg-white rounded-b-2xl p-6 border border-blue-200 border-t-0">
                {% if questao.descricao %}
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 rounded-r-lg">
                    <p class="text-blue-800 text-sm">{{ questao.descricao }}</p>
                </div>
                {% endif %}
                
                <!-- Container de Dicas -->
                <div class="hint-container mb-6" id="hints-{{ questao.id }}" style="display: none;">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-bold text-blue-800 flex items-center gap-2">
                            <img src="{% static 'imagem/lightbulb_35dp_2682EA_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Dicas" class="w-4 h-4">
                            Dicas Dispon√≠veis
                        </h4>
                        <span class="text-sm text-blue-600">{{ questao.dicas.count }} dica(s)</span>
                    </div>
                    
                    <div class="hints-list space-y-3">
                        {% for dica in questao.dicas.all %}
                        <div class="hint-step bg-blue-50 p-4 rounded-r-lg"
                            style="display: none;">
                            <div class="flex items-start gap-3">
                                <span class="bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold mt-1 flex-shrink-0">
                                    {{ forloop.counter }}
                                </span>
                                <div>
                                    <p class="text-blue-700">{{ dica.texto }}</p>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <p class="text-gray-500 text-center py-2">Nenhuma dica dispon√≠vel para esta quest√£o.</p>
                        {% endfor %}
                    </div>
                </div>

                <!-- Enunciado da Quest√£o -->
                <div class="mb-6">
                    <h4 class="font-bold text-gray-800 mb-3 text-lg">Enunciado:</h4>
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                        <p class="text-gray-700 whitespace-pre-wrap">{{ questao.enunciado }}</p>
                    </div>
                </div>

                <!-- Conte√∫do Espec√≠fico por Tipo -->
                {% if questao.tipo == 'multiple-choice' %}
                <!-- M√∫ltipla Escolha -->
                <div class="space-y-3">
                    <h4 class="font-bold text-gray-800 mb-3">Selecione a op√ß√£o correta:</h4>
                    <div class="grid gap-3">
                        {% for opcao in questao.opcoes.all %}
                        <button class="option-button bg-white border-2 border-gray-200 rounded-xl p-4 text-left hover:border-blue-400 transition-all"
                                data-option-id="{{ opcao.id }}" data-correct="{{ opcao.correta|yesno:'true,false' }}">
                            <div class="flex items-center gap-3">
                                <span class="bg-blue-100 text-blue-600 rounded-full w-8 h-8 flex items-center justify-center font-bold flex-shrink-0"
                                      data-index="{{ forloop.counter0 }}">
                                    {{ forloop.counter0|add:65|stringformat:"c" }}
                                </span>
                                <span class="text-gray-700">{{ opcao.texto }}</span>
                            </div>
                        </button>
                        {% empty %}
                        <p class="text-gray-500 text-center py-4">Nenhuma op√ß√£o dispon√≠vel.</p>
                        {% endfor %}
                    </div>
                </div>

                {% elif questao.tipo == 'code' %}
                <!-- EDITOR DE C√ìDIGO COM PYODIDE - CORRIGIDO -->
                <div class="space-y-4">
                    <!-- ‚úÖ ELEMENTO OCULTO COM SA√çDA ESPERADA - AGORA FUNCIONAL -->
                    <div id="saida-esperada-{{ questao.id }}" 
                         data-saida-esperada="{{ questao.saida_esperada|default:'' }}" 
                         style="display: none;">
                    </div>
                    
                    <!-- EDITOR DE C√ìDIGO -->
                    <div>
                        <h4 class="font-bold text-gray-800 mb-2">Escreva seu c√≥digo Python:</h4>
                        <div class="code-editor-container" id="editor-container-{{ questao.id }}">
                            <div class="editor-header">
                                <div class="editor-title">
                                    <img src="{% static 'imagem/code_35dp_FFFFFF_FILL0_wght400_GRAD0_opsz40.png' %}" alt="C√≥digo" class="w-4 h-4">
                                    main.py
                                </div>
                                <div class="editor-actions">
                                    <button class="editor-btn run-editor-code" data-question-id="{{ questao.id }}">
                                        <img src="{% static 'imagem/play_arrow_35dp_FFFFFF_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Executar" class="w-4 h-4">
                                        Executar
                                    </button>
                                    <button class="editor-btn primary check-editor-code" data-question-id="{{ questao.id }}">
                                        <img src="{% static 'imagem/check_circle_35dp_FFFFFF_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Verificar" class="w-4 h-4">
                                        Verificar
                                    </button>
                                </div>
                            </div>
                            <div class="editor-content">
                                <div class="editor-line-numbers" id="line-numbers-{{ questao.id }}">1</div>
                                <textarea class="code-textarea" id="code-input-{{ questao.id }}" 
                                          placeholder="Escreva seu c√≥digo Python aqui..." 
                                          spellcheck="false">{{ questao.codigo_inicial|default:"# Escreva seu c√≥digo aqui\n" }}</textarea>
                            </div>
                        </div>
                    </div>

                    <!-- TERMINAL DE SA√çDA -->
                    <div class="terminal" id="terminal-{{ questao.id }}">
                        <div class="terminal-header">
                            <img src="{% static 'imagem/terminal_35dp_FFFFFF_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Terminal" class="w-4 h-4">
                            Sa√≠da do C√≥digo
                        </div>
                        <div class="terminal-content" id="code-output-{{ questao.id }}">
                            <div class="pyodide-loading">
                                <div class="spinner"></div>
                                <span>Carregando Python...</span>
                            </div>
                        </div>
                    </div>
                </div>

                {% elif questao.tipo == 'fill-blank' %}
                <!-- Completar Lacunas CORRIGIDO -->
                <div class="space-y-4">
                    <h4 class="font-bold text-gray-800 mb-2">Complete as lacunas no texto abaixo:</h4>
                    
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-6">
                        <div id="fill-blank-text-{{ questao.id }}" class="text-gray-700 leading-relaxed whitespace-pre-line">
                            {{ questao.enunciado }}
                        </div>
                    </div>

                    <!-- ‚úÖ DIV OCULTA COM AS RESPOSTAS CORRETAS -->
                    <div id="respostas-{{ questao.id }}" 
                        data-questao-id="{{ questao.id }}"
                        data-respostas='{{ questao.respostas_corretas|default:"[]" }}'
                        style="display: none;">
                    </div>

                    <button class="check-blank bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition flex items-center gap-2"
                            data-question-id="{{ questao.id }}">
                        Verificar Respostas
                    </button>
                </div>
                {% endif %}

                <!-- Feedback da Quest√£o -->
                <div id="feedback-{{ questao.id }}" class="feedback-message hidden mt-6"></div>
            </div>
        </div>
        {% empty %}
        <!-- Mensagem quando n√£o h√° quest√µes -->
        <div class="text-center py-12">
            <img src="{% static 'imagem/quiz_100dp_64748b_FILL0_wght400_GRAD0_opsz48.png' %}" alt="Sem quest√µes" class="w-24 h-24 mx-auto mb-4 opacity-50">
            <h3 class="text-xl font-bold text-gray-700 mb-2">Nenhum exerc√≠cio dispon√≠vel</h3>
            <p class="text-gray-500">Esta aula ainda n√£o possui exerc√≠cios pr√°ticos.</p>
            <a href="{% url 'tarefas' %}?modulo_id={{ aula.modulo.id }}" 
               class="inline-block mt-4 bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
                Voltar para Tarefas
            </a>
        </div>
        {% endfor %}
    </div>

    <!-- Tela de Resultados -->
    <div id="result-screen" class="hidden bg-gradient-to-br from-white to-green-50 rounded-2xl shadow-lg p-8 text-center space-y-6 border border-green-200">
        <div class="bg-gradient-to-r from-green-600 to-green-800 text-white rounded-t-2xl p-6 -m-8 mb-6">
            <h2 class="text-3xl font-bold flex items-center justify-center gap-3">
                <span>üéâ</span>
                Parab√©ns!
            </h2>
            <p class="mt-2 text-green-100">Voc√™ concluiu todos os exerc√≠cios!</p>
        </div>

        <!-- Resumo de Desempenho -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
            <div class="bg-white rounded-xl p-6 shadow-md">
                <div class="flex items-center justify-center gap-2 mb-3">
                    <img src="{% static 'imagem/auto_awesome_mosaic_35dp_10B981_FILL0_wght400_GRAD0_opsz40.png' %}" alt="XP" class="w-8 h-8">
                </div>
                <div class="text-2xl font-bold text-green-600 mb-2"><span id="final-xp">0</span> XP</div>
                <p class="text-sm text-gray-600">Total conquistado</p>
            </div>

            <div class="bg-white rounded-xl p-6 shadow-md">
                <div class="flex items-center justify-center gap-2 mb-3">
                    <img src="{% static 'imagem/timer_35dp_10B981_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Tempo" class="w-8 h-8">
                </div>
                <div class="text-2xl font-bold text-green-600 mb-2"><span id="final-time">00:00</span></div>
                <p class="text-sm text-gray-600">Tempo total</p>
            </div>

            <div class="bg-white rounded-xl p-6 shadow-md">
                <div class="flex items-center justify-center gap-2 mb-3">
                    <img src="{% static 'imagem/bolt_35dp_10B981_FILL0_wght400_GRAD0_opsz40.png' %}" alt="B√¥nus" class="w-8 h-8">
                </div>
                <div class="text-2xl font-bold text-green-600 mb-2">+<span id="time-bonus">0</span> XP</div>
                <p class="text-sm text-gray-600">B√¥nus por tempo</p>
            </div>
        </div>

        <!-- ‚úÖ CORRE√á√ÉO: ADICIONAR B√îNUS DE REVIS√ÉO -->
        {% if pratica_concluida %}
        <div class="bg-purple-100 border border-purple-300 rounded-xl p-4 mt-4">
            <div class="flex items-center justify-center gap-2 mb-2">
                <img src="{% static 'imagem/refresh_35dp_8B5CF6_FILL0_wght400_GRAD0_opsz40.png' %}" alt="Revis√£o" class="w-6 h-6">
                <span class="font-bold text-purple-800">B√¥nus de Revis√£o</span>
            </div>
            <div class="text-xl font-bold text-purple-600">+<span id="revisao-bonus">5</span> XP</div>
            <p class="text-sm text-purple-700">Por completar a revis√£o</p>
        </div>
        {% endif %}

        <!-- Bot√µes de A√ß√£o -->
        <div class="flex justify-center gap-4 mt-8">
            <button onclick="location.reload()"
                class="bg-gradient-to-r from-green-500 to-green-700 text-white px-8 py-3 rounded-xl shadow-lg hover:from-green-600 hover:to-green-800 transition transform hover:scale-105 font-bold flex items-center gap-2">
                Recome√ßar
            </button>

            <a href="{% url 'tarefas' %}?modulo_id={{ aula.modulo.id }}"
                class="bg-white text-green-600 border border-green-300 px-8 py-3 rounded-xl shadow-lg hover:bg-green-50 transition transform hover:scale-105 font-bold flex items-center gap-2">
                Voltar √†s Tarefas
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- ‚úÖ CARREGAR PYODIDE - PYTHON REAL NO NAVEGADOR -->
<script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
<script>
    // ===== SISTEMA DE LOOP DE QUEST√ïES =====
    
    // Vari√°veis globais
    let questions = [];
    let currentQuestionIndex = 0;
    let totalQuestions = {{ aula.questoes.count }};
    let seconds = 0;
    let timerInterval;
    let totalXP = 0;
    let correctAnswers = 0;
    let usedHints = {};
    let userLives = parseInt(document.getElementById('vidas-restantes').value);
    let maxLives = parseInt(document.getElementById('max-vidas').value);
    let isReviewMode = document.getElementById('pratica-concluida').value === 'true';
    
    // ‚úÖ VARI√ÅVEL PARA PYODIDE
    let pyodide = null;
    let isPyodideLoaded = false;
    
    // Quest√µes respondidas corretamente
    let answeredQuestions = new Set();
    // Quest√µes que ainda precisam ser respondidas
    let pendingQuestions = new Set();
    
    // ===== INICIALIZA√á√ÉO =====
    document.addEventListener('DOMContentLoaded', async function() {
        console.log("üéØ Iniciando sistema de loop de quest√µes...");
        
        // ‚úÖ INICIALIZAR PYODIDE PRIMEIRO
        await initializePyodide();
        
        // Inicializar quest√µes
        initializeQuestions();
        initializeHints();
        initializeQuestionEvents();
        initializeCodeEditors();
        initializeFillBlankQuestions();
        startTimer();
        updateProgress();
        
        console.log(`‚úÖ Sistema inicializado com ${totalQuestions} quest√µes`);
    });

    // ===== INICIALIZAR PYODIDE =====
    async function initializePyodide() {
        console.log("üêç Iniciando Pyodide...");
        
        try {
            // Mostrar loading
            document.querySelectorAll('.terminal-content').forEach(terminal => {
                terminal.innerHTML = `
                    <div class="pyodide-loading">
                        <div class="spinner"></div>
                        <span>Carregando Python...</span>
                    </div>
                `;
            });
            
            // Carregar Pyodide
            pyodide = await loadPyodide({
                indexURL: "https://cdn.jsdelivr.net/pyodide/v0.23.4/full/"
            });
            
            // ‚úÖ CORRE√á√ÉO: Configurar input/output corretamente
            await pyodide.runPythonAsync(`
                import sys
                import js
                
                class PythonInput:
                    def __init__(self):
                        self.buffer = ""
                    
                    def readline(self):
                        # Para input() - retorna string vazia por enquanto
                        return "\\\\n"
                
                class PythonOutput:
                    def __init__(self):
                        self.content = ""
                    
                    def write(self, text):
                        self.content += text
                        # Enviar para o terminal JavaScript
                        js.console.log("Python output:", text)
                    
                    def flush(self):
                        pass
                
                # Configurar stdin e stdout
                sys.stdin = PythonInput()
                output_capture = PythonOutput()
                sys.stdout = output_capture
                sys.stderr = output_capture
            `);
            
            isPyodideLoaded = true;
            console.log("‚úÖ Pyodide carregado com sucesso!");
            
            // Atualizar terminais
            document.querySelectorAll('.terminal-content').forEach(terminal => {
                terminal.innerHTML = '<div class="text-green-400">‚úÖ Python carregado! Digite seu c√≥digo e clique em "Executar".</div>';
            });
            
        } catch (error) {
            console.error("‚ùå Erro ao carregar Pyodide:", error);
            document.querySelectorAll('.terminal-content').forEach(terminal => {
                terminal.innerHTML = '<div class="text-red-400">‚ùå Erro ao carregar Python. Recarregue a p√°gina.</div>';
            });
        }
    }

    // ===== EXECUTAR C√ìDIGO PYTHON REAL =====
    async function runPythonCode(code) {
        if (!isPyodideLoaded || !pyodide) {
            throw new Error("Python n√£o est√° carregado ainda. Aguarde...");
        }
        
        try {
            // ‚úÖ CORRE√á√ÉO: Configurar output capture de forma correta
            await pyodide.runPythonAsync(`
                import sys
                import io
                
                # Criar um StringIO para capturar output
                output_capture = io.StringIO()
                sys.stdout = output_capture
                sys.stderr = output_capture
            `);
            
            // ‚úÖ EXECUTAR C√ìDIGO E CAPTURAR OUTPUT
            await pyodide.runPythonAsync(code);
            
            // ‚úÖ PEGAR O OUTPUT CAPTURADO
            const output = await pyodide.runPythonAsync(`
                output_text = output_capture.getvalue()
                # Restaurar stdout/stderr padr√£o
                sys.stdout = sys.__stdout__
                sys.stderr = sys.__stderr__
                output_text
            `);
            
            return output || "";
            
        } catch (error) {
            // ‚úÖ CAPTURAR ERRO CORRETAMENTE
            const errorOutput = await pyodide.runPythonAsync(`
                try:
                    # Tentar pegar o erro do output_capture
                    error_text = output_capture.getvalue()
                    sys.stdout = sys.__stdout__
                    sys.stderr = sys.__stderr__
                    error_text if error_text else "Erro durante a execu√ß√£o"
                except:
                    "Erro: ${error.message}"
            `);
            
            throw new Error(errorOutput || error.message);
        }
    }

    // ===== BUSCAR SA√çDA ESPERADA DA QUEST√ÉO - CORRIGIDO =====
    function getExpectedOutputForQuestion(questionId) {
        console.log(`üîç Buscando sa√≠da esperada para quest√£o ${questionId}`);
        
        // M√©todo 1: Buscar diretamente do elemento da quest√£o
        const questionElement = document.querySelector(`[data-question-id="${questionId}"]`);
        if (!questionElement) {
            console.error("Elemento da quest√£o n√£o encontrado");
            return "";
        }
        
        // Buscar do campo saida_esperada do modelo Questao (se estiver no HTML)
        const saidaEsperadaElement = document.getElementById(`saida-esperada-${questionId}`);
        if (saidaEsperadaElement && saidaEsperadaElement.dataset.saidaEsperada) {
            const saida = saidaEsperadaElement.dataset.saidaEsperada.trim();
            console.log("‚úÖ Sa√≠da esperada encontrada em data-saida-esperada:", saida);
            return saida;
        }
        
        // Buscar de elementos com classe espec√≠fica
        const outputElements = questionElement.querySelectorAll('.saida-esperada, .expected-output, [data-expected]');
        for (let element of outputElements) {
            if (element.value || element.textContent || element.dataset.expected) {
                const saida = (element.value || element.textContent || element.dataset.expected).trim();
                if (saida) {
                    console.log("‚úÖ Sa√≠da esperada encontrada em elemento:", saida);
                    return saida;
                }
            }
        }
        
        // Buscar do texto da quest√£o (fallback)
        const enunciado = questionElement.querySelector('.bg-gray-50, .enunciado, p');
        if (enunciado) {
            const texto = enunciado.textContent;
            // Padr√µes comuns para identificar sa√≠da esperada
            const patterns = [
                /sa√≠da esperada[:\s]*([^\n\.]+)/i,
                /output esperado[:\s]*([^\n\.]+)/i,
                /resultado esperado[:\s]*([^\n\.]+)/i,
                /deve imprimir[:\s]*([^\n\.]+)/i,
                /deve retornar[:\s]*([^\n\.]+)/i
            ];
            
            for (let pattern of patterns) {
                const match = texto.match(pattern);
                if (match && match[1]) {
                    const saida = match[1].trim();
                    console.log("‚úÖ Sa√≠da esperada extra√≠da do enunciado:", saida);
                    return saida;
                }
            }
        }
        
        console.warn("‚ö†Ô∏è Nenhuma sa√≠da esperada encontrada para a quest√£o");
        return "";
    }

    // ===== COMPARA√á√ÉO RIGOROSA DE SA√çDAS - CORRIGIDA =====
    function areOutputsEqual(userOutput, expectedOutput) {
        if (!userOutput || !expectedOutput) {
            console.log("‚ùå Uma das sa√≠das est√° vazia");
            return false;
        }
        
        const user = userOutput.toString().trim();
        const expected = expectedOutput.toString().trim();
        
        console.log(`üîç Comparando: "${user}" vs "${expected}"`);
        
        // 1. Compara√ß√£o exata (case-sensitive)
        if (user === expected) {
            console.log("‚úÖ Compara√ß√£o exata - CORRETO");
            return true;
        }
        
        // 2. Compara√ß√£o case-insensitive
        if (user.toLowerCase() === expected.toLowerCase()) {
            console.log("‚úÖ Compara√ß√£o case-insensitive - CORRETO");
            return true;
        }
        
        // 3. Para n√∫meros: comparar valores num√©ricos
        const userNum = parseFloat(user);
        const expectedNum = parseFloat(expected);
        
        if (!isNaN(userNum) && !isNaN(expectedNum)) {
            if (userNum === expectedNum) {
                console.log("‚úÖ Compara√ß√£o num√©rica - CORRETO");
                return true;
            }
        }
        
        // 4. Para m√∫ltiplas linhas: comparar linha por linha
        const userLines = user.split('\n').map(line => line.trim()).filter(line => line !== '');
        const expectedLines = expected.split('\n').map(line => line.trim()).filter(line => line !== '');
        
        if (userLines.length === expectedLines.length) {
            let todasLinhasIguais = true;
            for (let i = 0; i < userLines.length; i++) {
                if (userLines[i] !== expectedLines[i]) {
                    // Tentar compara√ß√£o num√©rica para cada linha
                    const userLineNum = parseFloat(userLines[i]);
                    const expectedLineNum = parseFloat(expectedLines[i]);
                    
                    if (isNaN(userLineNum) || isNaN(expectedLineNum) || userLineNum !== expectedLineNum) {
                        todasLinhasIguais = false;
                        break;
                    }
                }
            }
            if (todasLinhasIguais) {
                console.log("‚úÖ Todas as linhas s√£o iguais - CORRETO");
                return true;
            }
        }
        
        console.log("‚ùå Sa√≠das diferentes - INCORRETO");
        return false;
    }

    // ===== VERIFICA√á√ÉO DE C√ìDIGO EDITOR - CORRIGIDA =====
    async function handleCheckEditorCode(questionId) {
        console.log("=== üö® INICIANDO VERIFICA√á√ÉO DE C√ìDIGO ===");
        
        const textarea = document.getElementById(`code-input-${questionId}`);
        const terminal = document.getElementById(`code-output-${questionId}`);
        const questionContainer = document.querySelector(`[data-question-id="${questionId}"]`);
        
        if (!textarea || !terminal || !questionContainer) {
            console.error("‚ùå Elementos n√£o encontrados");
            return;
        }
        
        // ‚úÖ BUSCAR SA√çDA ESPERADA - AGORA FUNCIONAL
        const expectedOutput = getExpectedOutputForQuestion(questionId);
        console.log("üö® SA√çDA ESPERADA ENCONTRADA:", expectedOutput);
        
        const userCode = textarea.value.trim();
        console.log("üö® C√ìDIGO DO USU√ÅRIO:", userCode);
        
        let isCorrect = false;
        let output = "";
        
        try {
            output = await runPythonCode(userCode);
            output = output.trim();
            console.log("üö® SA√çDA DO USU√ÅRIO:", output);
            
            // ‚úÖ COMPARA√á√ÉO EXATA E RIGOROSA - AGORA FUNCIONAL
            if (expectedOutput && expectedOutput.trim() !== "") {
                isCorrect = areOutputsEqual(output, expectedOutput);
                console.log("üö® RESULTADO DA COMPARA√á√ÉO:", isCorrect ? "CORRETO" : "INCORRETO");
            } else {
                console.log("üö® SEM SA√çDA ESPERADA - APENAS EXECUTA");
                isCorrect = true; // Se n√£o h√° sa√≠da esperada, considera correto se executou sem erro
            }
            
        } catch (error) {
            console.log("üö® ERRO NA EXECU√á√ÉO:", error);
            isCorrect = false;
            output = error.message;
        }
        
        // ‚úÖ FEEDBACK CLARO E CORRETO
        if (isCorrect) {
            showFeedback(questionId, 'correct', `‚úÖ Correto!`, 10);
            terminal.innerHTML = `<div class="text-green-400">${output}</div>`;
            setTimeout(() => nextQuestion(true), 1500);
        } else {
            showFeedback(questionId, 'incorrect', `‚ùå Incorreto! Verifique sua solu√ß√£o.`, 0);
            terminal.innerHTML = `<div class="text-red-400">${output}</div>`;
            await loseLife();
            setTimeout(() => nextQuestion(false), 1500);
        }
        
        console.log("=== üö® VERIFICA√á√ÉO FINALIZADA ===");
    }

    // ===== EXECUTAR C√ìDIGO EDITOR =====
    async function handleRunEditorCode(questionId) {
        const textarea = document.getElementById(`code-input-${questionId}`);
        const terminal = document.getElementById(`code-output-${questionId}`);
        
        if (!textarea || !terminal) return;
        
        const code = textarea.value.trim();
        
        if (!code) {
            terminal.innerHTML = '<div class="text-yellow-400">Digite algum c√≥digo para executar.</div>';
            return;
        }
        
        if (!isPyodideLoaded) {
            terminal.innerHTML = '<div class="text-yellow-400">Aguarde, Python ainda est√° carregando...</div>';
            return;
        }
        
        // Mostrar "executando..."
        terminal.innerHTML = '<div class="text-yellow-400">üêç Executando c√≥digo Python...</div>';
        terminal.classList.remove('error');
        
        try {
            console.log("‚ñ∂Ô∏è Executando c√≥digo:", code);
            const output = await runPythonCode(code);
            console.log("‚úÖ Output recebido:", output);
            
            // ‚úÖ FORMATAR OUTPUT CORRETAMENTE
            let formattedOutput = output;
            if (!formattedOutput || formattedOutput.trim() === "") {
                formattedOutput = "‚úÖ C√≥digo executado sem output.";
            }
            
            terminal.innerHTML = `<div style="white-space: pre-wrap; font-family: 'Courier New', monospace;" class="text-green-400">${formattedOutput}</div>`;
            terminal.classList.remove('error');
            
        } catch (error) {
            console.error("‚ùå Erro capturado:", error);
            terminal.innerHTML = `<div style="white-space: pre-wrap; font-family: 'Courier New', monospace;" class="text-red-400">${error.message}</div>`;
            terminal.classList.add('error');
        }
    }
    
    // ===== SIMPLES: PRIMEIRA LINHA SEM ESPA√áO =====
    function initializeFillBlankQuestions() {
        document.querySelectorAll('[id^="fill-blank-text-"]').forEach(container => {
            const questionId = container.id.replace('fill-blank-text-', '');
            
            const originalText = container.textContent;
            
            // ‚úÖ ENCONTRAR ONDE COME√áA A PRIMEIRA LINHA
            const firstLineStart = originalText.search(/\S/); // Primeiro caractere n√£o-espa√ßo
            if (firstLineStart > 0) {
                // ‚úÖ REMOVER ESPA√áOS APENAS DO IN√çCIO DO TEXTO TODO
                const correctedText = originalText.substring(firstLineStart);
                
                const processedHTML = correctedText.replace(/\[_____\]/g, 
                    '<input type="text" class="blank-input" placeholder="______">'
                );
                
                container.innerHTML = processedHTML;
            } else {
                // ‚úÖ J√Å EST√Å CORRETO
                const processedHTML = originalText.replace(/\[_____\]/g, 
                    '<input type="text" class="blank-input" placeholder="______">'
                );
                container.innerHTML = processedHTML;
            }
            
            container.style.whiteSpace = 'pre-wrap';
            container.style.wordWrap = 'break-word';
            container.style.fontFamily = 'monospace';
        });
    }
        
    // ===== SISTEMA DE QUEST√ïES EM LOOP =====
    function initializeQuestions() {
        // Coletar todas as quest√µes
        document.querySelectorAll('.question-container').forEach(container => {
            const questionId = container.dataset.questionId;
            questions.push({
                id: questionId,
                element: container,
                answered: false,
                correct: false
            });
            
            // Adicionar √† lista de quest√µes pendentes
            pendingQuestions.add(questionId);
        });
        
        // Mostrar primeira quest√£o
        showQuestion(currentQuestionIndex);
    }
    
    function showQuestion(index) {
        // Esconder todas as quest√µes
        document.querySelectorAll('.question-container').forEach(container => {
            container.classList.remove('active');
        });
        
        // Mostrar quest√£o atual
        if (questions[index]) {
            questions[index].element.classList.add('active');
            
            // Atualizar indicador visual
            updateQuestionIndicator(index);
            
            // Scroll para o topo
            scrollToTop();
        }
    }
    
    function updateQuestionIndicator(currentIndex) {
        // Atualizar dots de quest√µes
        document.querySelectorAll('.question-dot').forEach((dot, index) => {
            dot.classList.remove('current', 'answered', 'wrong');
            
            if (index === currentIndex) {
                dot.classList.add('current');
            } else if (answeredQuestions.has(questions[index].id)) {
                dot.classList.add('answered');
            } else if (!pendingQuestions.has(questions[index].id)) {
                dot.classList.add('wrong');
            }
        });
    }
    
    function nextQuestion(isCorrect) {
    const currentQuestion = questions[currentQuestionIndex];
    
    // ‚úÖ CORRE√á√ÉO MELHORADA: Modo revis√£o sempre marca como respondida e passa
    if (isCorrect || isReviewMode) {
        answeredQuestions.add(currentQuestion.id);
        pendingQuestions.delete(currentQuestion.id);
        currentQuestion.answered = true;
        currentQuestion.correct = true;
        
        if (answeredQuestions.size === totalQuestions) {
            finishPractice();
            return;
        }
    } else {
        pendingQuestions.add(currentQuestion.id);
    }
    
    // Resto do c√≥digo permanece igual...
    let nextIndex = -1;
    for (let i = currentQuestionIndex + 1; i < questions.length; i++) {
        if (pendingQuestions.has(questions[i].id)) {
            nextIndex = i;
            break;
        }
    }
    
    if (nextIndex === -1) {
        for (let i = 0; i < questions.length; i++) {
            if (pendingQuestions.has(questions[i].id)) {
                nextIndex = i;
                break;
            }
        }
    }
    
    if (nextIndex === -1) {
        finishPractice();
        return;
    }
    
    currentQuestionIndex = nextIndex;
    showQuestion(currentQuestionIndex);
    updateProgress();
}
    
    function updateProgress() {
        const progress = (answeredQuestions.size / totalQuestions) * 100;
        document.getElementById('practice-progress-fill').style.width = `${progress}%`;
        document.getElementById('progress-text').textContent = `${answeredQuestions.size}/${totalQuestions}`;
    }
    
    // ===== EDITOR DE C√ìDIGO =====
    function initializeCodeEditors() {
        document.querySelectorAll('.code-textarea').forEach(textarea => {
            const questionId = textarea.id.replace('code-input-', '');
            setupCodeEditor(questionId);
        });
    }
    
    function setupCodeEditor(questionId) {
        const textarea = document.getElementById(`code-input-${questionId}`);
        const lineNumbers = document.getElementById(`line-numbers-${questionId}`);
        
        if (!textarea) return;
        
        // Inicializar n√∫meros de linha
        updateLineNumbers(textarea, lineNumbers);
        
        // Event listeners para o editor
        textarea.addEventListener('input', () => {
            updateLineNumbers(textarea, lineNumbers);
        });
        
        textarea.addEventListener('scroll', () => {
            lineNumbers.scrollTop = textarea.scrollTop;
        });
        
        textarea.addEventListener('keydown', handleEditorKeydown);
        
        // Event listeners para os bot√µes
        const runBtn = document.querySelector(`.run-editor-code[data-question-id="${questionId}"]`);
        const checkBtn = document.querySelector(`.check-editor-code[data-question-id="${questionId}"]`);
        
        if (runBtn) {
            runBtn.addEventListener('click', () => handleRunEditorCode(questionId));
        }
        
        if (checkBtn) {
            checkBtn.addEventListener('click', () => handleCheckEditorCode(questionId));
        }
    }
    
    function updateLineNumbers(textarea, lineNumbers) {
        const lines = textarea.value.split('\n').length;
        let numbersHTML = '';
        
        for (let i = 1; i <= lines; i++) {
            numbersHTML += `<div class="line-number">${i}</div>`;
        }
        
        lineNumbers.innerHTML = numbersHTML;
        lineNumbers.style.height = textarea.scrollHeight + 'px';
    }
    
    function handleEditorKeydown(e) {
        const textarea = e.target;
        
        // Tab com 4 espa√ßos
        if (e.key === 'Tab') {
            e.preventDefault();
            
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            
            // Inserir 4 espa√ßos
            textarea.value = textarea.value.substring(0, start) + '    ' + textarea.value.substring(end);
            textarea.selectionStart = textarea.selectionEnd = start + 4;
            
            // Atualizar n√∫meros de linha
            const questionId = textarea.id.replace('code-input-', '');
            const lineNumbers = document.getElementById(`line-numbers-${questionId}`);
            updateLineNumbers(textarea, lineNumbers);
            
            return false;
        }
    }
    
    // ===== SISTEMA DE LACUNAS CORRIGIDO =====
    async function handleCheckBlank(e) {
        const btn = e.currentTarget;
        const questionContainer = btn.closest('.question-container');
        const questionId = questionContainer.dataset.questionId;
        const xpElement = questionContainer.querySelector('.bg-yellow-100');
        const xp = xpElement ? parseInt(xpElement.textContent.match(/\d+/)[0]) : 10;
        
        console.log(`üîç Verificando quest√£o de lacunas: ${questionId}`);
        
        if (isReviewMode) {
            const blankInputs = questionContainer.querySelectorAll('.blank-input');
            const respostasCorretas = getCorrectAnswersForReview(questionId);
            
            blankInputs.forEach((input, index) => {
                const respostaCorreta = respostasCorretas[index] || "Resposta n√£o dispon√≠vel";
                input.value = respostaCorreta;
                input.classList.add('blank-filled', 'correct-answer');
                input.disabled = true;
            });
            
            showFeedback(questionId, 'info', 'üìù Modo revis√£o: Complete corretamente as lacunas', 0);
            return;
        }
        
        const blankInputs = questionContainer.querySelectorAll('.blank-input');
        let allFilled = true;
        
        // Verificar se todas as lacunas foram preenchidas
        blankInputs.forEach(input => {
            if (!input.value.trim()) {
                allFilled = false;
                input.classList.add('shake');
                setTimeout(() => input.classList.remove('shake'), 500);
            }
        });
        
        if (!allFilled) {
            showFeedback(questionId, 'incorrect', '‚ùå Preencha todas as lacunas antes de verificar.', 0);
            return;
        }
        
        // ‚úÖ BUSCAR RESPOSTAS CORRETAS DE FORMA ROBUSTA
        const respostasCorretas = await getCorrectAnswersForQuestion(questionId);
        console.log("Respostas corretas encontradas:", respostasCorretas);
        console.log("N√∫mero de inputs:", blankInputs.length);
        
        let isCorrect = true;
        let incorrectAnswers = [];
        
        // Remover classes anteriores
        blankInputs.forEach(input => {
            input.classList.remove('correct-answer', 'wrong-answer', 'blank-filled');
        });
        
        // Verificar cada lacuna
        blankInputs.forEach((input, index) => {
            const userAnswer = input.value.trim().toLowerCase();
            const correctAnswer = respostasCorretas[index] ? respostasCorretas[index].toString().toLowerCase() : "";
            
            console.log(`Lacuna ${index}: Usu√°rio="${userAnswer}", Correto="${correctAnswer}"`);
            
            if (userAnswer === correctAnswer) {
                input.classList.add('correct-answer', 'blank-filled', 'bounce-in');
            } else {
                isCorrect = false;
                incorrectAnswers.push(index + 1);
                input.classList.add('wrong-answer', 'shake');
            }
        });
        
        if (isCorrect) {
            showFeedback(questionId, 'correct', '‚úÖ Todas as lacunas preenchidas corretamente!', xp);
            correctAnswers++;
            totalXP += xp;
            
            setTimeout(() => {
                nextQuestion(true);
            }, 1500);
        } else {
            let errorMessage = '‚ùå Algumas lacunas est√£o incorretas.';
            if (incorrectAnswers.length > 0) {
                errorMessage += ` Lacunas ${incorrectAnswers.join(', ')} est√£o erradas.`;
            }
            
            showFeedback(questionId, 'incorrect', errorMessage, 0);
            
            await loseLife();
            
            setTimeout(() => {
                nextQuestion(false);
            }, 1500);
        }
    }

    // ‚úÖ FUN√á√ÉO MELHORADA PARA BUSCAR RESPOSTAS CORRETAS
    async function getCorrectAnswersForQuestion(questionId) {
        console.log(`üîç Buscando respostas para quest√£o ${questionId}`);
        
        try {
            // Tentar buscar via API
            const response = await fetch(`/api/questao/${questionId}/respostas/`);
            if (response.ok) {
                const data = await response.json();
                console.log("Respostas da API:", data.respostas);
                return data.respostas || [];
            }
        } catch (error) {
            console.log("API n√£o dispon√≠vel, usando m√©todo alternativo");
        }
        
        // M√©todo alternativo: buscar das op√ß√µes corretas
        const questionElement = document.querySelector(`[data-question-id="${questionId}"]`);
        if (!questionElement) {
            console.error("Elemento da quest√£o n√£o encontrado");
            return [];
        }
        
        // Buscar todas as op√ß√µes marcadas como corretas
        const opcoesCorretas = questionElement.querySelectorAll('.option-button[data-correct="true"]');
        const respostas = Array.from(opcoesCorretas).map(opcao => {
            return opcao.textContent.trim();
        });
        
        console.log("Respostas das op√ß√µes:", respostas);
        
        // Se n√£o encontrou op√ß√µes, tentar do data attribute
        if (respostas.length === 0) {
            const questaoData = questionElement.querySelector('[data-respostas]');
            if (questaoData && questaoData.dataset.respostas) {
                try {
                    const respostasData = JSON.parse(questaoData.dataset.respostas);
                    console.log("Respostas do data attribute:", respostasData);
                    return respostasData;
                } catch (e) {
                    console.error("Erro ao parsear respostas:", e);
                }
            }
        }
        
        return respostas;
    }

    // ‚úÖ FUN√á√ÉO AUXILIAR PARA MODO REVIS√ÉO (mantida para compatibilidade)
    function getCorrectAnswersForReview(questionId) {
        let respostas = [];
        
        // Tentar da vari√°vel global
        if (window[`respostasQuestao${questionId}`]) {
            respostas = window[`respostasQuestao${questionId}`];
        }
        // Tentar do data attribute
        else {
            const answersContainer = document.querySelector(`[data-questao-id="${questionId}"]`);
            if (answersContainer && answersContainer.dataset.respostas) {
                try {
                    respostas = JSON.parse(answersContainer.dataset.respostas);
                } catch (e) {
                    console.error("‚ùå Erro ao parsear respostas:", e);
                }
            }
        }
        
        console.log(`Respostas para quest√£o ${questionId}:`, respostas);
        return Array.isArray(respostas) ? respostas : [];
    }
        
    // ===== SISTEMA DE DICAS =====
    function initializeHints() {
        document.querySelectorAll('.question-container').forEach(container => {
            const questionId = container.dataset.questionId;
            usedHints[questionId] = 0;
        });
    }
    
    function showHint(questionId) {
        const hintContainer = document.getElementById(`hints-${questionId}`);
        const hintSteps = hintContainer.querySelectorAll('.hint-step');
        const totalHints = hintSteps.length;
        
        if (totalHints === 0) {
            alert("N√£o h√° dicas dispon√≠veis.");
            return;
        }
        
        if (usedHints[questionId] === 0) {
            hintContainer.style.display = 'block';
            usedHints[questionId] = 1;
        } else if (usedHints[questionId] < totalHints) {
            usedHints[questionId]++;
        } else {
            alert("Todas as dicas j√° foram mostradas!");
            return;
        }
        
        for (let i = 0; i < usedHints[questionId]; i++) {
            hintSteps[i].style.display = 'block';
        }
        
        const hintBtn = document.querySelector(`.hint-btn[data-question-id="${questionId}"]`);
        const counter = hintBtn.querySelector('.hint-counter');
        const remaining = totalHints - usedHints[questionId];
        
        counter.textContent = remaining;
        
        if (remaining === 0) {
            hintBtn.disabled = true;
            counter.classList.add('bg-red-500', 'text-white');
        }
    }
    
    // ===== MANIPULADORES DE RESPOSTAS =====
    function initializeQuestionEvents() {
        // Sistema de dicas
        document.querySelectorAll('.hint-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const questionId = e.currentTarget.dataset.questionId;
                showHint(questionId);
            });
        });
        
        // M√∫ltipla escolha
        document.querySelectorAll('.option-button').forEach(btn => {
            btn.addEventListener('click', handleMultipleChoice);
        });
        
        // Completar lacunas
        document.querySelectorAll('.check-blank').forEach(btn => {
            btn.addEventListener('click', handleCheckBlank);
        });
    }
    
    function handleMultipleChoice(e) {
    const btn = e.currentTarget;
    const questionContainer = btn.closest('.question-container');
    const questionId = questionContainer.dataset.questionId;
    const isCorrect = btn.dataset.correct === 'true';
    const xp = parseInt(questionContainer.querySelector('.bg-yellow-100').textContent.match(/\d+/)[0]);
    
    if (isReviewMode) {
        questionContainer.querySelectorAll('.option-button').forEach(option => {
            if (option.dataset.correct === 'true') {
                option.classList.add('correct-answer', 'bounce-in');
            }
            option.classList.add('opacity-70');
        });
        
        showFeedback(questionId, 'info', 'üìù Modo revis√£o: Aprenda com os erros anteriores', 0);
        
        // ‚úÖ CORRE√á√ÉO: No modo revis√£o, passar automaticamente para pr√≥xima quest√£o ap√≥s 2 segundos
        setTimeout(() => {
            nextQuestion(true); // true porque no modo revis√£o sempre passa
        }, 2000);
        
        return;
    }
    
    questionContainer.querySelectorAll('.option-button').forEach(option => {
        option.classList.remove('correct-answer', 'wrong-answer');
    });
    
    if (isCorrect) {
        btn.classList.add('correct-answer', 'bounce-in');
        showFeedback(questionId, 'correct', '‚úÖ Resposta correta!', xp);
        correctAnswers++;
        totalXP += xp;
        
        setTimeout(() => {
            nextQuestion(true);
        }, 1500);
    } else {
        btn.classList.add('wrong-answer', 'shake');
        showFeedback(questionId, 'incorrect', '‚ùå Resposta incorreta.', 0);
        
        loseLife().then(() => {
            setTimeout(() => {
                nextQuestion(false);
            }, 1500);
        });
    }
}
    
    // ===== FUN√á√ïES AUXILIARES =====
    async function loseLife() {
        if (isReviewMode) return false;
        
        if (userLives > 0) {
            userLives--;
            
            const aulaId = document.getElementById('aula-id').value;
            
            try {
                const response = await fetch("{% url 'usar_vida_pratica' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        aula_id: aulaId
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    userLives = data.vidas_restantes;
                }
            } catch (error) {
                console.error('‚ùå Erro na requisi√ß√£o:', error);
            }
            
            if (userLives <= 0) {
                setTimeout(() => {
                    endPracticeDueToLives();
                }, 1000);
            }
            
            return true;
        }
        
        return false;
    }
    
    function showFeedback(questionId, type, message, xp) {
        const feedback = document.getElementById(`feedback-${questionId}`);
        feedback.innerHTML = message;
        feedback.className = `feedback-message feedback-${type} bounce-in`;
        feedback.classList.remove('hidden');
    }
    
    function scrollToTop() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    function startTimer() {
        timerInterval = setInterval(() => {
            seconds++;
            updateTimerDisplay();
        }, 1000);
    }
    
    function updateTimerDisplay() {
        let minutes = Math.floor(seconds / 60);
        let secs = seconds % 60;
        document.getElementById('timer').textContent = 
            String(minutes).padStart(2, '0') + ":" + String(secs).padStart(2, '0');
    }
    
    function stopTimer() {
        clearInterval(timerInterval);
        return seconds;
    }
    
    async function finishPractice() {
        const aulaId = document.getElementById('aula-id').value;
        const elapsedTime = stopTimer();
        
        // ‚úÖ CORRE√á√ÉO: CALCULAR XP CORRETAMENTE
        let xpBase = totalXP;
        let revisaoBonus = 0;
        let timeBonus = 0;
        
        if (isReviewMode) {
            // MODO REVIS√ÉO: APENAS 5 XP FIXOS (N√ÉO SOMA XP DAS QUEST√ïES)
            revisaoBonus = parseInt(document.getElementById('xp-revisao').value) || 5;
            totalXP = revisaoBonus; // ‚úÖ CORRE√á√ÉO: S√ì O B√îNUS DE REVIS√ÉO
            xpBase = 0; // Zera o XP das quest√µes no modo revis√£o
            
            console.log(`üìù Modo Revis√£o: XP das quest√µes ignorado, apenas b√¥nus de ${revisaoBonus} XP`);
            
            try {
                await fetch("{% url 'registrar_xp_revisao' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        aula_id: aulaId,
                        xp_revisao: revisaoBonus
                    })
                });
            } catch (error) {
                console.error('‚ùå Erro ao registrar XP da revis√£o:', error);
            }
        } else {
            // MODO NORMAL: XP das quest√µes + b√¥nus por tempo
            const expectedTime = {{ aula.tempo_pratica }} * 60;
            if (elapsedTime < expectedTime * 0.5) timeBonus = 10;
            else if (elapsedTime < expectedTime * 0.8) timeBonus = 5;
            totalXP = xpBase + timeBonus;
            
            console.log(`üéØ Modo Normal: XP Base=${xpBase}, B√¥nus Tempo=${timeBonus}, Total=${totalXP}`);
        }
        
        // ‚úÖ CORRE√á√ÉO: S√ì REGISTRAR NO BANCO SE N√ÉO FOR REVIS√ÉO
        if (!isReviewMode) {
            try {
                const response = await fetch("{% url 'finalizar_pratica' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        aula_id: aulaId,
                        xp_total: totalXP, // ‚úÖ ENVIA O XP CORRETO
                        vidas_restantes: userLives
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    console.log("‚úÖ Pr√°tica finalizada com sucesso! XP:", totalXP);
                }
            } catch (error) {
                console.error('‚ùå Erro ao finalizar pr√°tica:', error);
            }
        }
        
        showResultScreen(totalXP, elapsedTime, timeBonus, revisaoBonus);
    }
    
    function showResultScreen(totalXP, elapsedTime, timeBonus, revisaoBonus = 0) {
        const resultScreen = document.getElementById('result-screen');
        const questionsContainer = document.getElementById('questions-container');
        
        questionsContainer.style.display = 'none';
        resultScreen.classList.remove('hidden');
        
        if (isReviewMode) {
            resultScreen.querySelector('h2').innerHTML = 'üìù Revis√£o Conclu√≠da';
            resultScreen.querySelector('p').textContent = 'Revis√£o dos exerc√≠cios finalizada!';
        }
        
        // ‚úÖ CORRE√á√ÉO: MOSTRAR XP CORRETAMENTE NA TELA
        if (isReviewMode) {
            // No modo revis√£o, mostra apenas o b√¥nus de revis√£o
            document.getElementById('final-xp').textContent = revisaoBonus;
            document.getElementById('time-bonus').textContent = '0';
        } else {
            // No modo normal, mostra XP base + b√¥nus tempo
            document.getElementById('final-xp').textContent = totalXP - timeBonus;
            document.getElementById('time-bonus').textContent = timeBonus;
        }
        
        // ‚úÖ CORRE√á√ÉO: MOSTRAR B√îNUS DE REVIS√ÉO
        if (isReviewMode) {
            document.getElementById('revisao-bonus').textContent = revisaoBonus;
        }
        
        const minutes = Math.floor(elapsedTime / 60);
        const secondsRemaining = elapsedTime % 60;
        document.getElementById('final-time').textContent = 
            String(minutes).padStart(2, '0') + ':' + String(secondsRemaining).padStart(2, '0');
            
        console.log(`üèÅ Tela de Resultados: Total XP=${totalXP}, Tempo=${minutes}:${secondsRemaining}, Revis√£o=${revisaoBonus}`);
    }
    
    function endPracticeDueToLives() {
        stopTimer();
        
        const resultScreen = document.getElementById('result-screen');
        const questionsContainer = document.getElementById('questions-container');
        
        questionsContainer.style.display = 'none';
        resultScreen.classList.remove('hidden');
        
        resultScreen.querySelector('h2').innerHTML = 'üíî Fim da Pr√°tica';
        resultScreen.querySelector('p').textContent = 'Suas vidas acabaram! Tente novamente.';
        
        document.getElementById('final-xp').textContent = totalXP;
        document.getElementById('time-bonus').textContent = '0';
        
        const minutes = Math.floor(seconds / 60);
        const secondsRemaining = seconds % 60;
        document.getElementById('final-time').textContent = 
            String(minutes).padStart(2, '0') + ':' + String(secondsRemaining).padStart(2, '0');
        
        const restartBtn = resultScreen.querySelector('button[onclick="location.reload()"]');
        restartBtn.innerHTML = 'Tentar Novamente üîÑ';
    }
    
    console.log("üöÄ Sistema com Python real (Pyodide) carregado com sucesso!");
</script>
{% endblock %}